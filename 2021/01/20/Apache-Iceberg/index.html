<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">





  <link rel="alternate" href="/atom.xml" title="Matty's Blog" type="application/atom+xml">






<meta name="description" content="本文为 Apache Iceberg 的入门学习笔记。">
<meta property="og:type" content="article">
<meta property="og:title" content="Apache Iceberg">
<meta property="og:url" content="http://yoursite.com/2021/01/20/Apache-Iceberg/index.html">
<meta property="og:site_name" content="Matty&#39;s Blog">
<meta property="og:description" content="本文为 Apache Iceberg 的入门学习笔记。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://yoursite.com/2021/01/20/Apache-Iceberg/Iceberg%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84.png">
<meta property="og:image" content="http://yoursite.com/2021/01/20/Apache-Iceberg/Iceberg_layout.png">
<meta property="og:image" content="http://yoursite.com/2021/01/20/Apache-Iceberg/%E8%AF%BB%E5%86%99%E5%8E%9F%E7%90%86_1.png">
<meta property="og:image" content="http://yoursite.com/2021/01/20/Apache-Iceberg/%E8%AF%BB%E5%86%99%E5%8E%9F%E7%90%86_2.png">
<meta property="og:image" content="http://yoursite.com/2021/01/20/Apache-Iceberg/%E8%AF%BB%E5%86%99%E5%8E%9F%E7%90%86_3.png">
<meta property="og:image" content="http://yoursite.com/2021/01/20/Apache-Iceberg/%E6%89%93%E5%BC%80SQL_Client.png">
<meta property="og:image" content="http://yoursite.com/2021/01/20/Apache-Iceberg/%E5%88%9B%E5%BB%BAhive_catalog%E6%8A%A5%E9%94%99%E7%9A%84%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%951.png">
<meta property="og:image" content="http://yoursite.com/2021/01/20/Apache-Iceberg/%E5%88%9B%E5%BB%BAhive_catalog%E6%88%90%E5%8A%9F.png">
<meta property="og:image" content="http://yoursite.com/2021/01/20/Apache-Iceberg/%E5%88%9B%E5%BB%BAhadoop_catalog%E6%88%90%E5%8A%9F.png">
<meta property="og:image" content="http://yoursite.com/2021/01/20/Apache-Iceberg/%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E6%88%90%E5%8A%9F.png">
<meta property="og:image" content="http://yoursite.com/2021/01/20/Apache-Iceberg/%E6%9F%A5%E8%AF%A2Iceberg%E9%9D%9E%E5%88%86%E5%8C%BA%E8%A1%A8%E6%95%B0%E6%8D%AE.png">
<meta property="og:image" content="http://yoursite.com/2021/01/20/Apache-Iceberg/%E6%9F%A5%E8%AF%A2Iceberg%E5%88%86%E5%8C%BA%E8%A1%A8%E6%95%B0%E6%8D%AE.png">
<meta property="og:image" content="http://yoursite.com/2021/01/20/Apache-Iceberg/%E5%88%9B%E5%BB%BAIceberg%E8%A1%A8%E6%88%90%E5%8A%9F.png">
<meta property="og:image" content="http://yoursite.com/2021/01/20/Apache-Iceberg/%E6%9F%A5%E8%AF%A2Iceberg%E5%AE%9E%E6%97%B6%E5%86%99%E5%85%A5%E7%9A%84%E6%95%B0%E6%8D%AE.png">
<meta property="og:image" content="http://yoursite.com/2021/01/20/Apache-Iceberg/Flink_Sink%E5%8E%9F%E7%90%86.png">
<meta property="og:image" content="http://yoursite.com/2021/01/20/Apache-Iceberg/flink_sink_state%E8%AE%BE%E8%AE%A1.png">
<meta property="og:updated_time" content="2021-06-03T17:04:23.497Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Apache Iceberg">
<meta name="twitter:description" content="本文为 Apache Iceberg 的入门学习笔记。">
<meta name="twitter:image" content="http://yoursite.com/2021/01/20/Apache-Iceberg/Iceberg%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2021/01/20/Apache-Iceberg/">





  <title>Apache Iceberg | Matty's Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Matty's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/01/20/Apache-Iceberg/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="miaowenting">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/2.JPG">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Matty's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Apache Iceberg</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-01-20T16:19:22+08:00">
                2021-01-20
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/DataLake/" itemprop="url" rel="index">
                    <span itemprop="name">DataLake</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/DataLake/Iceberg/" itemprop="url" rel="index">
                    <span itemprop="name">Iceberg</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>本文为 Apache Iceberg 的入门学习笔记。</p>
<a id="more"></a>


<h2 id="Apache-Iceberg-简介"><a href="#Apache-Iceberg-简介" class="headerlink" title="Apache Iceberg 简介"></a>Apache Iceberg 简介</h2><p>官网定义：</p>
<p>Apache Iceberg is an open table format for huge analytic datasets. Iceberg delivers high query performance for tables with tens of petabytes of data, along with atomic commits, concurrent writes, and SQL-compatible table evolution.</p>
<ul>
<li><p>在文件 Format（Parquet/Avro/Orc）之上实现 table 语义<br>支持定义和变更Schema<br>支持 Hidden partition 和 Partition 变更<br>ACID 语义<br>历史版本回溯</p>
</li>
<li><p>特点<br>借助 partition 和 columns 统计信息实现分区裁剪<br>不绑定 HDFS，可拓展到 S3/OSS 等<br>容许多个 Writer 并发写入，乐观锁机制解决冲突</p>
</li>
</ul>
<h2 id="数据布局Layout"><a href="#数据布局Layout" class="headerlink" title="数据布局Layout"></a>数据布局Layout</h2><p><img src="Iceberg%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84.png" alt></p>
<p>Layout 分为数据文件和元数据文件两部分。</p>
<p><img src="Iceberg_layout.png" alt></p>
<ul>
<li><p>数据文件（data files）<br>Iceberg 表真实存储数据的文件，一般存储在 data 目录下，以 “.parquet” 结尾。</p>
</li>
<li><p>清单文件（manifest file）<br>每行都是每个数据文件的详细描述，包括数据文件的状态、文件路径、分区信息、列级别的统计信息（比如每列的最大最小值、空值数等）。通过该文件，可以过滤掉无关数据，提高检索速度。</p>
</li>
<li><p>快照（snapshot）<br>快照代表一张表在某个时刻的状态。每个快照版本包含某个时刻的所有数据文件列表。data files 存储在不同的 manifest files 里， manifest files 存储在一个<br> manifest list 文件里面，而一个 manifest list 文件代表一个快照。</p>
</li>
</ul>
<h2 id="读写原理"><a href="#读写原理" class="headerlink" title="读写原理"></a>读写原理</h2><p><img src="%E8%AF%BB%E5%86%99%E5%8E%9F%E7%90%86_1.png" alt></p>
<p>绿色表示数据文件，蓝色表示 manifest，黄色表示快照。一次 manifest 可以认为是一次 transaction 的写入，m0 对应写了两个文件，分别落到了 Partiiotn-0 、Partition-1，m1 对应也写了两个文件，分别落到了 Partiiotn-1 、Partition-2。对于 S1 来说，是由 m0 和 m1 两个 manifest 组成的。</p>
<p><img src="%E8%AF%BB%E5%86%99%E5%8E%9F%E7%90%86_2.png" alt></p>
<p>基于 1 开始一次新的写入，写了一个 m2 的 transaction，写了一个数据文件 2 到 Partition-1，此时会新增一个 manifest m2 和 Snapshot S2，S2 会引用之前所有的 transaction m0 和 m1。</p>
<p>此时，如果要进行批量读取，就可以从 S1、S2、S3 中选择一个快照读取，比如选择了 S2，就是会把 m0、m1、m2 对应的数据全部 load 出来进行读取。</p>
<p>如果要进行增量读取，从 S0 开始把数据 load 出来，到 S1 的时候，会拿着 S1 的数据减去 S0 的数据得到增量的数据，然后交给计算引擎去做增量处理。</p>
<p><img src="%E8%AF%BB%E5%86%99%E5%8E%9F%E7%90%86_3.png" alt></p>
<h3 id="查询计划"><a href="#查询计划" class="headerlink" title="查询计划"></a>查询计划</h3><p>查询计划是指在表中“查询所需文件”的过程。</p>
<ul>
<li><p>元数据过滤<br>清单文件包括分区数据元组和每个数据文件的列级统计信息。在计划期内，查询谓词会自动转换为分区数据上的谓词，并首先应用于过滤数据文件。接下来，使用列级值计数，<br>空计数，下限和上限来消除与查询谓词不匹配的文件。</p>
</li>
<li><p>snapshot id<br>每个 snapshot id 会关联到一组 manifest files，而每一组 manifest files 包含很多 manifest file 。</p>
</li>
<li><p>manifest files 文件列表<br>每个 manifest file 文件又记录了当前 data 数据块的元数据信息，其中就包含了文件列的最大值和最小值，然后根据这个元数据信息，索引到具体的文件块，从而更快的查询到数据。</p>
</li>
</ul>
<h2 id="Flink-Iceberg-流式入湖"><a href="#Flink-Iceberg-流式入湖" class="headerlink" title="Flink + Iceberg 流式入湖"></a>Flink + Iceberg 流式入湖</h2><h3 id="入门实践"><a href="#入门实践" class="headerlink" title="入门实践"></a>入门实践</h3><p><a href="https://github.com/apache/iceberg/pull/1464/files" target="_blank" rel="noopener">详细参考文档</a></p>
<h4 id="本机启动-Hadoop-和-Hive"><a href="#本机启动-Hadoop-和-Hive" class="headerlink" title="本机启动 Hadoop 和 Hive"></a>本机启动 Hadoop 和 Hive</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动Hadoop</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$HADOOP_HOME</span>/sbin</span><br><span class="line">./start-all.sh</span><br><span class="line">hdfs dfs -ls /</span><br><span class="line">	drwx-wx-wx   - miaowenting staff          0 2021-05-30 23:27 /tmp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动Hive</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$HIVE_HOME</span>/bin</span><br><span class="line">./hive --service metastore &amp;</span><br><span class="line">./hive --service hiveserver2 &amp;</span><br></pre></td></tr></table></figure>

<h4 id="本机启动-Flink"><a href="#本机启动-Flink" class="headerlink" title="本机启动 Flink"></a>本机启动 Flink</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动 Flink</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$FLINK_HOME</span>/bin</span><br><span class="line"></span><br><span class="line">./start-cluster.sh</span><br></pre></td></tr></table></figure>

<h4 id="准备-Flink-SQL-Client-环境"><a href="#准备-Flink-SQL-Client-环境" class="headerlink" title="准备 Flink SQL Client 环境"></a>准备 Flink SQL Client 环境</h4><ul>
<li><p>配置 HADOOP_CLASSPATH 环境变量：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/profile</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> HADOOP_CLASSPATH=`<span class="variable">$HADOOP_HOME</span>/bin/hadoop classpath`</span><br><span class="line"></span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure>
</li>
<li><p>下载运行时jar：<br><a href="https://repo.maven.apache.org/maven2/org/apache/iceberg/iceberg-flink-runtime/" target="_blank" rel="noopener">iceberg-flink-runtime.jar下载地址</a><br><a href="https://repo.maven.apache.org/maven2/org/apache/flink/" target="_blank" rel="noopener">flink-sql-connector-hive.jar下载地址</a></p>
</li>
</ul>
<ul>
<li>启动命令行：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> <span class="variable">$FLINK_HOME</span>/bin</span><br><span class="line"></span><br><span class="line">./sql-client.sh embedded \</span><br><span class="line">    -j /usr/<span class="built_in">local</span>/external/iceberg-flink-runtime-0.10.0.jar \</span><br><span class="line">    -j /usr/<span class="built_in">local</span>/external/flink-sql-connector-hive-2.2.0_2.11-1.11.2.jar \</span><br><span class="line">    shell</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p><img src="%E6%89%93%E5%BC%80SQL_Client.png" alt></p>
<h4 id="创建-Iceberg-的-Catalog"><a href="#创建-Iceberg-的-Catalog" class="headerlink" title="创建 Iceberg 的 Catalog"></a>创建 Iceberg 的 Catalog</h4><h5 id="创建-Hive-Catalog"><a href="#创建-Hive-Catalog" class="headerlink" title="创建 Hive Catalog"></a>创建 Hive Catalog</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">CATALOG</span> hive_catalog <span class="keyword">WITH</span>(</span><br><span class="line">	<span class="string">'type'</span>=<span class="string">'iceberg'</span>,</span><br><span class="line">	<span class="string">'catalog-type'</span>=<span class="string">'hive'</span>,</span><br><span class="line">	<span class="string">'uri'</span>=<span class="string">'thrift://localhost:9083'</span>,</span><br><span class="line">	<span class="string">'clients'</span>=<span class="string">'5'</span>,</span><br><span class="line">	<span class="string">'property-version'</span>=<span class="string">'1'</span>,</span><br><span class="line">	<span class="string">'warehouse'</span>=<span class="string">'hdfs://localhost:9000/user/hive/warehouse'</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>可能出现以下报错：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread &quot;main&quot; org.apache.flink.table.client.SqlClientException: Unexpected exception. This is a bug. Please consider filing an issue.</span><br><span class="line">	at org.apache.flink.table.client.SqlClient.main(SqlClient.java:213)</span><br><span class="line">Caused by: org.apache.flink.table.client.gateway.SqlExecutionException: Could not create execution context.</span><br><span class="line">	at org.apache.flink.table.client.gateway.local.ExecutionContext$Builder.build(ExecutionContext.java:870)</span><br><span class="line">	at org.apache.flink.table.client.gateway.local.LocalExecutor.openSession(LocalExecutor.java:227)</span><br><span class="line">	at org.apache.flink.table.client.SqlClient.start(SqlClient.java:108)</span><br><span class="line">	at org.apache.flink.table.client.SqlClient.main(SqlClient.java:201)</span><br><span class="line">Caused by: java.lang.VerifyError: Stack map does not match the one at exception handler 69</span><br><span class="line">Exception Details:</span><br><span class="line">  Location:</span><br><span class="line">    org/apache/iceberg/hive/HiveCatalog.loadNamespaceMetadata(Lorg/apache/iceberg/catalog/Namespace;)Ljava/util/Map; @69: astore_2</span><br><span class="line">  Reason:</span><br><span class="line">    Type &apos;org/apache/hadoop/hive/metastore/api/NoSuchObjectException&apos; (current frame, stack[0]) is not assignable to &apos;org/apache/thrift/TException&apos; (stack map, stack[0])</span><br><span class="line">  Current Frame:</span><br><span class="line">    bci: @26</span><br><span class="line">    flags: &#123; &#125;</span><br><span class="line">    locals: &#123; &apos;org/apache/iceberg/hive/HiveCatalog&apos;, &apos;org/apache/iceberg/catalog/Namespace&apos; &#125;</span><br><span class="line">    stack: &#123; &apos;org/apache/hadoop/hive/metastore/api/NoSuchObjectException&apos; &#125;</span><br><span class="line">  Stackmap Frame:</span><br><span class="line">    bci: @69</span><br><span class="line">    flags: &#123; &#125;</span><br><span class="line">    locals: &#123; &apos;org/apache/iceberg/hive/HiveCatalog&apos;, &apos;org/apache/iceberg/catalog/Namespace&apos; &#125;</span><br><span class="line">    stack: &#123; &apos;org/apache/thrift/TException&apos; &#125;</span><br><span class="line">  Bytecode:</span><br><span class="line">    0x0000000: 2a2b b700 759a 0015 bb00 c759 12c9 04bd</span><br><span class="line">    0x0000010: 00cb 5903 2b53 b700 cebf 2ab4 0038 2bba</span><br><span class="line">    0x0000020: 0236 0000 b600 9ac0 0238 4d2a 2cb7 023c</span><br><span class="line">    0x0000030: 4eb2 00bd 1302 3e2b 2db9 0204 0100 b900</span><br><span class="line">    0x0000040: c504 002d b04d bb00 c759 2c12 c904 bd00</span><br><span class="line">    0x0000050: cb59 032b 53b7 0229 bf4d bb00 d059 bb00</span><br><span class="line">    0x0000060: d259 b700 d313 022b b600 d92b b600 dc13</span><br><span class="line">    0x0000070: 01a4 b600 d9b6 00e0 2cb7 00e3 bf4d b800</span><br><span class="line">    0x0000080: 40b6 00e6 bb00 d059 bb00 d259 b700 d313</span><br><span class="line">    0x0000090: 022d b600 d92b b600 dc13 01a4 b600 d9b6</span><br><span class="line">    0x00000a0: 00e0 2cb7 00e3 bf                      </span><br><span class="line">  Exception Handler Table:</span><br><span class="line">    bci [26, 68] =&gt; handler: 69</span><br><span class="line">    bci [26, 68] =&gt; handler: 69</span><br><span class="line">    bci [26, 68] =&gt; handler: 89</span><br><span class="line">    bci [26, 68] =&gt; handler: 125</span><br><span class="line">  Stackmap Table:</span><br><span class="line">    same_frame(@26)</span><br><span class="line">    same_locals_1_stack_item_frame(@69,Object[#111])</span><br><span class="line">    same_locals_1_stack_item_frame(@89,Object[#111])</span><br><span class="line">    same_locals_1_stack_item_frame(@125,Object[#113])</span><br><span class="line"></span><br><span class="line">	at org.apache.iceberg.flink.CatalogLoader$HiveCatalogLoader.loadCatalog(CatalogLoader.java:95)</span><br><span class="line">	at org.apache.iceberg.flink.FlinkCatalog.&lt;init&gt;(FlinkCatalog.java:104)</span><br><span class="line">	at org.apache.iceberg.flink.FlinkCatalogFactory.createCatalog(FlinkCatalogFactory.java:132)</span><br><span class="line">	at org.apache.iceberg.flink.FlinkCatalogFactory.createCatalog(FlinkCatalogFactory.java:122)</span><br><span class="line">	at org.apache.flink.table.client.gateway.local.ExecutionContext.createCatalog(ExecutionContext.java:378)</span><br><span class="line">	at org.apache.flink.table.client.gateway.local.ExecutionContext.lambda$null$5(ExecutionContext.java:626)</span><br><span class="line">	at java.util.HashMap.forEach(HashMap.java:1289)</span><br><span class="line">	at org.apache.flink.table.client.gateway.local.ExecutionContext.lambda$initializeCatalogs$6(ExecutionContext.java:625)</span><br><span class="line">	at org.apache.flink.table.client.gateway.local.ExecutionContext.wrapClassLoader(ExecutionContext.java:264)</span><br><span class="line">	at org.apache.flink.table.client.gateway.local.ExecutionContext.initializeCatalogs(ExecutionContext.java:624)</span><br><span class="line">	at org.apache.flink.table.client.gateway.local.ExecutionContext.initializeTableEnvironment(ExecutionContext.java:523)</span><br><span class="line">	at org.apache.flink.table.client.gateway.local.ExecutionContext.&lt;init&gt;(ExecutionContext.java:183)</span><br><span class="line">	at org.apache.flink.table.client.gateway.local.ExecutionContext.&lt;init&gt;(ExecutionContext.java:136)</span><br><span class="line">	at org.apache.flink.table.client.gateway.local.ExecutionContext$Builder.build(ExecutionContext.java:859)</span><br></pre></td></tr></table></figure>

<p>解决办法：</p>
<ol>
<li><p>iceberg-flink-runtime-0.10.0.jar、flink-sql-connector-hive-2.2.0_2.11-1.11.2.jar 不要放在 $FLINK_HOME/lib 目录下</p>
</li>
<li><p>打开 sql-client.sh 文件，在 jar 包启动的地方加上 -noverify 跳过字节码校验。<br><img src="%E5%88%9B%E5%BB%BAhive_catalog%E6%8A%A5%E9%94%99%E7%9A%84%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%951.png" alt></p>
</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">USE</span> <span class="keyword">CATALOG</span> hive_catalog;</span><br></pre></td></tr></table></figure>

<p>type：表示 flink-connector 的连接类型<br>catalog-type：表示创建 catalog 的类型。目前支持 hive 和 hadoop 两种类型<br>uri：Hive metastore 的 thrift URI 地址<br>clients：Hive metastore 客户端线程池大小，默认值为2<br>property-version：Connector 的属性值版本号，当前版本为1，这个值主要用来确保 iceberg connector 的 property 向后兼容</p>
<p><img src="%E5%88%9B%E5%BB%BAhive_catalog%E6%88%90%E5%8A%9F.png" alt></p>
<h5 id="创建-Hadoop-Catalog"><a href="#创建-Hadoop-Catalog" class="headerlink" title="创建 Hadoop Catalog"></a>创建 Hadoop Catalog</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">CATALOG</span> hadoop_catalog <span class="keyword">WITH</span>(</span><br><span class="line">	<span class="string">'type'</span>=<span class="string">'iceberg'</span>,</span><br><span class="line">	<span class="string">'catalog-type'</span>=<span class="string">'hadoop'</span>,</span><br><span class="line">	<span class="string">'warehouse'</span>=<span class="string">'hdfs://localhost:9000/warehouse/path'</span>,</span><br><span class="line">	<span class="string">'property-version'</span>=<span class="string">'1'</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">USE</span> <span class="keyword">CATALOG</span> hadoop_catalog;</span><br></pre></td></tr></table></figure>

<p>warehouse：表示 iceberg 的 metadata 的 data 数据存放的文件路径。</p>
<p><img src="%E5%88%9B%E5%BB%BAhadoop_catalog%E6%88%90%E5%8A%9F.png" alt></p>
<h5 id="创建-Custom-Catalog"><a href="#创建-Custom-Catalog" class="headerlink" title="创建 Custom Catalog"></a>创建 Custom Catalog</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">CATALOG</span> my_catalog <span class="keyword">WITH</span> (</span><br><span class="line">  <span class="string">'type'</span>=<span class="string">'iceberg'</span>,</span><br><span class="line">  <span class="string">'catalog-impl'</span>=<span class="string">'com.my.custom.CatalogImpl'</span>,</span><br><span class="line">  <span class="string">'my-additional-catalog-config'</span>=<span class="string">'my-value'</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h5 id="通过-YAML-统一新增-Catalog"><a href="#通过-YAML-统一新增-Catalog" class="headerlink" title="通过 YAML 统一新增 Catalog"></a>通过 YAML 统一新增 Catalog</h5><p>修改 sql-client-defaults.yaml 文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">catalogs:</span>  <span class="comment"># empty list</span></span><br><span class="line"><span class="attr">   - name:</span> <span class="string">hadoop_catalog</span></span><br><span class="line"><span class="attr">     type:</span> <span class="string">iceberg</span></span><br><span class="line"><span class="attr">     catalog-type:</span> <span class="string">hadoop</span></span><br><span class="line"><span class="attr">     warehouse:</span> <span class="attr">hdfs://localhost:9000/warehouse/path</span></span><br><span class="line"><span class="attr">     property-version:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">   - name:</span> <span class="string">hive_catalog</span></span><br><span class="line"><span class="attr">     type:</span> <span class="string">iceberg</span></span><br><span class="line"><span class="attr">     catalog-type:</span> <span class="string">hive</span></span><br><span class="line"><span class="attr">     uri:</span> <span class="attr">thrift://localhost:9083</span></span><br><span class="line"><span class="attr">     clients:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">     warehouse:</span> <span class="attr">hdfs://localhost:9000/user/hive/warehouse</span></span><br><span class="line"><span class="attr">     property-version:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h4 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> iceberg_db;</span><br><span class="line"></span><br><span class="line"><span class="keyword">USE</span> <span class="string">`iceberg_db`</span>;</span><br></pre></td></tr></table></figure>

<p><img src="%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E6%88%90%E5%8A%9F.png" alt></p>
<h4 id="创建-Iceberg-表"><a href="#创建-Iceberg-表" class="headerlink" title="创建 Iceberg 表"></a>创建 Iceberg 表</h4><ul>
<li>首先要进入到指定的 catalog 和 database 目录下</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">USE</span> <span class="keyword">CATALOG</span> hive_catalog;</span><br><span class="line"></span><br><span class="line"><span class="keyword">USE</span> iceberg_db;</span><br></pre></td></tr></table></figure>

<ul>
<li>创建非分区表</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建 Iceberg 非分区表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> sample_iceberg (</span><br><span class="line">  <span class="keyword">id</span> <span class="built_in">BIGINT</span> <span class="keyword">COMMENT</span> <span class="string">'unique id'</span>,</span><br><span class="line">  <span class="keyword">data</span> <span class="keyword">STRING</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入测试数据1</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> sample_iceberg <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="string">'test1'</span>);</span><br><span class="line"></span><br><span class="line">[INFO] Submitting SQL <span class="keyword">update</span> <span class="keyword">statement</span> <span class="keyword">to</span> the cluster...</span><br><span class="line">[INFO] <span class="keyword">Table</span> <span class="keyword">update</span> <span class="keyword">statement</span> has been successfully submitted <span class="keyword">to</span> the cluster:</span><br><span class="line">Job <span class="keyword">ID</span>: <span class="number">79</span>f18eee231895abd2ab15fbd0641ade</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入测试数据2</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> sample_iceberg <span class="keyword">VALUES</span> (<span class="number">2</span>,<span class="string">'test2'</span>);</span><br><span class="line"></span><br><span class="line">[INFO] Submitting SQL <span class="keyword">update</span> <span class="keyword">statement</span> <span class="keyword">to</span> the cluster...</span><br><span class="line">[INFO] <span class="keyword">Table</span> <span class="keyword">update</span> <span class="keyword">statement</span> has been successfully submitted <span class="keyword">to</span> the cluster:</span><br><span class="line">Job <span class="keyword">ID</span>: c0afa452656f42de5df6bc745fbaf022</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询已插入的数据</span></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> sample_iceberg;</span><br></pre></td></tr></table></figure>

<p><img src="%E6%9F%A5%E8%AF%A2Iceberg%E9%9D%9E%E5%88%86%E5%8C%BA%E8%A1%A8%E6%95%B0%E6%8D%AE.png" alt></p>
<ul>
<li>创建分区表</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建 Iceberg 分区表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> sample_iceberg_partition (</span><br><span class="line">  <span class="keyword">id</span> <span class="built_in">BIGINT</span> <span class="keyword">COMMENT</span> <span class="string">'unique id'</span>,</span><br><span class="line">  <span class="keyword">data</span> <span class="keyword">STRING</span></span><br><span class="line">) </span><br><span class="line">PARTITIONED <span class="keyword">BY</span> (<span class="keyword">data</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入测试数据1</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> sample_iceberg_partition <span class="keyword">PARTITION</span>(<span class="keyword">data</span>=<span class="string">'city'</span>) <span class="keyword">SELECT</span> <span class="number">86</span>;</span><br><span class="line"></span><br><span class="line">[INFO] Submitting SQL <span class="keyword">update</span> <span class="keyword">statement</span> <span class="keyword">to</span> the cluster...</span><br><span class="line">[INFO] <span class="keyword">Table</span> <span class="keyword">update</span> <span class="keyword">statement</span> has been successfully submitted <span class="keyword">to</span> the cluster:</span><br><span class="line">Job <span class="keyword">ID</span>: <span class="number">9</span>ff0581b9b16ee01c0c849c50608f1b2</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询已插入的数据</span></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> sample_iceberg_partition;</span><br></pre></td></tr></table></figure>

<p><img src="%E6%9F%A5%E8%AF%A2Iceberg%E5%88%86%E5%8C%BA%E8%A1%A8%E6%95%B0%E6%8D%AE.png" alt></p>
<ul>
<li>创建带 WITH 参数的表<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">-- 创建表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> sample_iceberg_connector (</span><br><span class="line">	<span class="keyword">id</span> <span class="built_in">BIGINT</span> <span class="keyword">COMMENT</span> <span class="string">'unique id'</span>,</span><br><span class="line">	<span class="keyword">data</span> <span class="keyword">STRING</span></span><br><span class="line">) <span class="keyword">WITH</span> (</span><br><span class="line">	<span class="string">'connector'</span>=<span class="string">'iceberg'</span>,</span><br><span class="line">  <span class="string">'catalog-type'</span>=<span class="string">'hive'</span>,</span><br><span class="line">  <span class="string">'uri'</span>=<span class="string">'thrift://localhost:9083'</span>,</span><br><span class="line">  <span class="string">'clients'</span>=<span class="string">'5'</span>,</span><br><span class="line">  <span class="string">'property-version'</span>=<span class="string">'1'</span>,</span><br><span class="line">  <span class="string">'warehouse'</span>=<span class="string">'hdfs://localhost:9000/warehouse/path'</span>,</span><br><span class="line">	<span class="string">'write.format.default'</span>=<span class="string">'ORC'</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p><img src="%E5%88%9B%E5%BB%BAIceberg%E8%A1%A8%E6%88%90%E5%8A%9F.png" alt></p>
<p>支持 PARTITION BY 子句，用来设置分区字段<br>支持 COMMENT ‘table comment’ 子句<br>支持 WITH(‘key’=’value’,…) 子句，用来设置 table 级别的配置属性</p>
<p>暂不支持 computed column<br>暂不支持 primary key<br>暂不支持定义 watermark</p>
<h4 id="Flink-SQL-写入"><a href="#Flink-SQL-写入" class="headerlink" title="Flink SQL 写入"></a>Flink SQL 写入</h4><ul>
<li><p>修改 flink-conf.yaml 配置文件，配置 checkpoint<br>因为 flink 提交 Iceberg 的信息是在每次 checkpoint 时提交的，所以需要开启 checkpoint</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开启 checkpoint</span></span><br><span class="line"><span class="string">state.backend:</span> <span class="string">filesystem</span></span><br><span class="line"><span class="string">state.backend.async:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">state.backend.fs.memory-threshold:</span> <span class="number">1024</span></span><br><span class="line"><span class="string">state.checkpoints.dir:</span> <span class="attr">hdfs://localhost:9000/flink-checkpoints</span></span><br><span class="line"><span class="string">state.savepoints.dir:</span> <span class="attr">hdfs://localhost:9000/flink-checkpoints</span></span><br><span class="line"><span class="string">state.backend.incremental:</span> <span class="literal">false</span></span><br><span class="line"><span class="string">state.backend.local-recovery:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment"># state.checkpoints.num-retained: 1</span></span><br><span class="line"><span class="string">taskmanager.state.local.root-dirs:</span> <span class="string">none</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># checkpoint 间隔时间</span></span><br><span class="line"><span class="string">execution.checkpointing.interval:</span> <span class="number">10</span><span class="string">s</span></span><br><span class="line"><span class="comment"># checkpoint 失败容忍次数</span></span><br><span class="line"><span class="string">execution.checkpointing.tolerable-failed-checkpoints:</span> <span class="number">10</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>首先要进入到指定的 catalog 和 database 目录下</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">USE</span> <span class="keyword">CATALOG</span> hive_catalog;</span><br><span class="line"></span><br><span class="line"><span class="keyword">USE</span> iceberg_db;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>创建一个 iceberg 的 sink connector</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">-- 创建表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> table_sink_iceberg (</span><br><span class="line">  <span class="keyword">id</span> <span class="built_in">BIGINT</span> <span class="keyword">COMMENT</span> <span class="string">'unique id'</span>,</span><br><span class="line">  <span class="keyword">data</span> <span class="keyword">STRING</span></span><br><span class="line">) <span class="keyword">WITH</span> (</span><br><span class="line">  <span class="string">'connector'</span>=<span class="string">'iceberg'</span>,</span><br><span class="line">  <span class="string">'catalog-type'</span>=<span class="string">'hive'</span>,</span><br><span class="line">  <span class="string">'uri'</span>=<span class="string">'thrift://localhost:9083'</span>,</span><br><span class="line">  <span class="string">'clients'</span>=<span class="string">'5'</span>,</span><br><span class="line">  <span class="string">'property-version'</span>=<span class="string">'1'</span>,</span><br><span class="line">  <span class="string">'warehouse'</span>=<span class="string">'hdfs://localhost:9000/warehouse/path'</span>,</span><br><span class="line">  <span class="string">'write.format.default'</span>=<span class="string">'ORC'</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建一个 datagen 的 source connector</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> table_source_datagen (</span><br><span class="line"> userid <span class="built_in">INT</span>,</span><br><span class="line"> f_random_str <span class="keyword">STRING</span></span><br><span class="line">) <span class="keyword">WITH</span> (</span><br><span class="line"> <span class="string">'connector'</span>=<span class="string">'datagen'</span>,</span><br><span class="line"> <span class="string">'rows-per-second'</span>=<span class="string">'5'</span>,</span><br><span class="line"> <span class="string">'fields.userid.kind'</span>=<span class="string">'random'</span>,</span><br><span class="line"> <span class="string">'fields.userid.min'</span>=<span class="string">'1'</span>,</span><br><span class="line"> <span class="string">'fields.userid.max'</span>=<span class="string">'1000'</span>,</span><br><span class="line"> <span class="string">'fields.f_random_str.length'</span>=<span class="string">'10'</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询 source 数据，会有源源不断的数据输出</span></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> table_source_datagen;</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过设置 execution.type 来切换提交流作业和批作业</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 流式</span></span><br><span class="line"><span class="keyword">SET</span> execution.type = streaming;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 批</span></span><br><span class="line"><span class="keyword">SET</span> execution.type = batch;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>借助流式作业（默认）写入数据到 Apache Iceberg 表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> table_sink_iceberg <span class="keyword">SELECT</span> userid,f_random_str <span class="keyword">FROM</span> table_source_datagen;</span><br><span class="line"></span><br><span class="line">[INFO] Submitting SQL <span class="keyword">update</span> <span class="keyword">statement</span> <span class="keyword">to</span> the cluster...</span><br><span class="line">[INFO] <span class="keyword">Table</span> <span class="keyword">update</span> <span class="keyword">statement</span> has been successfully submitted <span class="keyword">to</span> the cluster:</span><br><span class="line">Job <span class="keyword">ID</span>: <span class="number">52</span>c57f566aa6da61d46ec2fc73b74b59</span><br></pre></td></tr></table></figure>
</li>
<li><p>查询 sink 到 iceberg 表里的数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> table_sink_iceberg;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p><img src="%E6%9F%A5%E8%AF%A2Iceberg%E5%AE%9E%E6%97%B6%E5%86%99%E5%85%A5%E7%9A%84%E6%95%B0%E6%8D%AE.png" alt></p>
<h4 id="DataStream-写入"><a href="#DataStream-写入" class="headerlink" title="DataStream 写入"></a>DataStream 写入</h4><h5 id="批量读取"><a href="#批量读取" class="headerlink" title="批量读取"></a>批量读取</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">StreamExecutionEnvironment env = StreamExecutionEnvironment.createLocalEnvironment();</span><br><span class="line">TableLoader tableLoader = TableLoader.fromHadooptable(<span class="string">"hdfs://nn:8020/warehouse/path"</span>);</span><br><span class="line">DataStream&lt;RowData&gt; batch = FlinkSource.forRowData()</span><br><span class="line">     .env(env)</span><br><span class="line">     .tableLoader(loader)</span><br><span class="line">     .streaming(<span class="keyword">false</span>)</span><br><span class="line">     .build();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Print all records to stdout.</span></span><br><span class="line">batch.print();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Submit and execute this batch read job.</span></span><br><span class="line">env.execute(<span class="string">"Test Iceberg Batch Read"</span>);</span><br></pre></td></tr></table></figure>

<h5 id="流式读取"><a href="#流式读取" class="headerlink" title="流式读取"></a>流式读取</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">StreamExecutionEnvironment env = StreamExecutionEnvironment.createLocalEnvironment();</span><br><span class="line">TableLoader tableLoader = TableLoader.fromHadoopTable(<span class="string">"hdfs://nn:8020/warehouse/path"</span>);</span><br><span class="line">DataStream&lt;RowData&gt; stream = FlinkSource.forRowData()</span><br><span class="line">     .env(env)</span><br><span class="line">     .tableLoader(loader)</span><br><span class="line">     .streaming(<span class="keyword">true</span>)</span><br><span class="line">     .startSnapshotId(<span class="number">3821550127947089987L</span>)</span><br><span class="line">     .build();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Print all records to stdout.</span></span><br><span class="line">stream.print();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Submit and execute this streaming read job.</span></span><br><span class="line">env.execute(<span class="string">"Test Iceberg streaming Read"</span>);</span><br></pre></td></tr></table></figure>

<h5 id="追加写入"><a href="#追加写入" class="headerlink" title="追加写入"></a>追加写入</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">StreamExecutionEnvironment env = ...;</span><br><span class="line"></span><br><span class="line">DataStream&lt;RowData&gt; input = ... ;</span><br><span class="line">Configuration hadoopConf = <span class="keyword">new</span> Configuration();</span><br><span class="line">TableLoader tableLoader = TableLoader.fromHadoopTable(<span class="string">"hdfs://nn:8020/warehouse/path"</span>, hadoopConf);</span><br><span class="line"></span><br><span class="line">FlinkSink.forRowData(input)</span><br><span class="line">    .tableLoader(tableLoader)</span><br><span class="line">    .build();</span><br><span class="line"></span><br><span class="line">env.execute(<span class="string">"Test Iceberg DataStream"</span>);</span><br></pre></td></tr></table></figure>

<h5 id="覆盖写入"><a href="#覆盖写入" class="headerlink" title="覆盖写入"></a>覆盖写入</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">StreamExecutionEnvironment env = ...;</span><br><span class="line"></span><br><span class="line">DataStream&lt;RowData&gt; input = ... ;</span><br><span class="line">Configuration hadoopConf = <span class="keyword">new</span> Configuration();</span><br><span class="line">TableLoader tableLoader = TableLoader.fromHadoopTable(<span class="string">"hdfs://nn:8020/warehouse/path"</span>, hadoopConf);</span><br><span class="line"></span><br><span class="line">FlinkSink.forRowData(input)</span><br><span class="line">    .tableLoader(tableLoader)</span><br><span class="line">    .overwrite(<span class="keyword">true</span>)</span><br><span class="line">    .build();</span><br><span class="line"></span><br><span class="line">env.execute(<span class="string">"Test Iceberg DataStream"</span>);</span><br></pre></td></tr></table></figure>

<h4 id="修改表属性"><a href="#修改表属性" class="headerlink" title="修改表属性"></a>修改表属性</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="keyword">sample</span> <span class="keyword">SET</span> (<span class="string">'write.format.default'</span>=<span class="string">'avro'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="keyword">sample</span> <span class="keyword">RENAME</span> <span class="keyword">TO</span> <span class="string">`hive_catalog.default.new_sample`</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>Flink SQL 目前支持修改 iceberg 表的相关属性</li>
<li>Flink SQL 暂不支持添加列、修改列、删除列的操作，但可以通过 Iceberg Java API 来完成</li>
</ul>
<h4 id="删除表、库和-Catalog"><a href="#删除表、库和-Catalog" class="headerlink" title="删除表、库和 Catalog"></a>删除表、库和 Catalog</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">--  删除表</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">sample</span>；</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除库</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">DATABASE</span> test_db;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除 catalog</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">CATALOG</span> hive_catalog;</span><br></pre></td></tr></table></figure>

<h3 id="Flink-Sink-写入原理"><a href="#Flink-Sink-写入原理" class="headerlink" title="Flink Sink 写入原理"></a>Flink Sink 写入原理</h3><p><img src="Flink_Sink%E5%8E%9F%E7%90%86.png" alt></p>
<ul>
<li><p>IcebergStreamWriter<br>主要用来写入记录到对应的 avro、parquet、orc 文件，生成一个对应的 Iceberg datafile，并发送给下游算子。</p>
</li>
<li><p>IcebergFilesCommitter<br>为每个 checkpointId 维护了一个 datafile 文件列表，即 Map&lt;Long,List<datafile>&gt;，这样即使中间有某个 checkpoint 的 transaction 提交失败了，<br>它的 datafile 文件仍然维护在 State 中，依然可以通过后续的 checkpoint 来提交数据到 Iceberg 表中。</datafile></p>
</li>
</ul>
<p><img src="flink_sink_state%E8%AE%BE%E8%AE%A1.png" alt></p>
<p>Flink Sink State 改进：</p>
<ol>
<li><p>多个不同的 Flink Job 写入同一个 Iceberg 表时，如何保证写入数据的正确性？</p>
</li>
<li><p>在云端环境下，metastore 所在的数据中心和日志数据中心是两个数据中心。这时候，可能导致 Commit Transaction 到 Iceberg 经常失败的现象，长期失败会导致 State 膨胀。<br>如何解决这个问题。</p>
</li>
</ol>
<h3 id="Flink-Sink-小文件处理"><a href="#Flink-Sink-小文件处理" class="headerlink" title="Flink Sink 小文件处理"></a>Flink Sink 小文件处理</h3><ul>
<li><p>小数据量的合并<br>在 IcebergFilesCommitter 之后添加一个 Compactor 算子，用来实现少量小文件的频繁合并。</p>
</li>
<li><p>大数据量的合并<br>设计 Flink Batch 作业，对接 Iceberg 的 RewriteDataFilesAction 来实现表内的大数据合并。</p>
</li>
</ul>
<h2 id="社区规划"><a href="#社区规划" class="headerlink" title="社区规划"></a>社区规划</h2><ol>
<li><p>预计将在下个 Apache Iceberg Release 中支持：<br>a. Flink Sink 流式入湖和批量入湖<br>b. Flink Streaming Reader<br>c. Flink Batch Reader</p>
</li>
<li><p>Flink + Iceberg 对小文件的处理<br>a. Committer 任务之后添加 Compactor 算子，专门处理少量数据的 compaction<br>b. 设计 Flink 批任务来处理大数据量的 compaction</p>
</li>
<li><p>对接 Iceberg 的 row-level delete 功能<br>a. 通过 Flink 实现 CDC 日志的实时写入和分析<br>b. 通过 Flink 实现 CDC 日志的增量拉取<br>c. Flink + Iceberg 支持批量的数据更新</p>
</li>
<li><p>更加完善的 Flink SQL 支持<br>a. 更富的 Flink DDL 支持，例如支持增删改 column<br>b. 往 Flink 社区讨论支持 hidden partition</p>
</li>
<li><p>通过 SQL extension 来完成日常数据管理<br>a. 在 Icebeg 内实现 compaction 语法和命令<br>b. SQL 查看 history、snapshot、manifest、files 文件</p>
</li>
</ol>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://blog.51cto.com/u_15023245/2619826" target="_blank" rel="noopener">基于 Flink+Iceberg 构建企业级实时数据湖 - 文章</a><br><a href="https://www.bilibili.com/video/BV14A411J7e6?p=4" target="_blank" rel="noopener">基于 Flink+Iceberg 构建企业级实时数据湖 - 视频</a><br><a href="https://www.yuque.com/deadwind/fusion/iqc65z?language=zh-cn" target="_blank" rel="noopener">Apache Iceberg调研</a><br><a href="https://www.bilibili.com/video/av929015385/" target="_blank" rel="noopener">Apache Iceberg 0.11.0 最新解读视频，胡争</a><br><a href="https://www.cnblogs.com/swordfall/p/14548574.html#auto_id_0" target="_blank" rel="noopener">Flink集成Iceberg简介</a><br><a href="https://github.com/apache/iceberg/blob/master/site/docs/flink.md" target="_blank" rel="noopener">Flink+Iceberg 社区使用文档</a><br><a href="https://blog.csdn.net/joniers/article/details/116590366" target="_blank" rel="noopener">Flink+iceberg 环境搭建及问题处理</a><br><a href="https://cloud.tencent.com/developer/article/1727735" target="_blank" rel="noopener">Flink集成数据湖之实时数据写入 Iceberg</a><br><a href="https://mp.weixin.qq.com/s/2MxyxOYrHi5HWmkKtXYjBg" target="_blank" rel="noopener">Flink + Iceberg 在去哪儿的实时数仓实践</a></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2021/01/20/初识数据湖/" rel="next" title="初识数据湖">
                <i class="fa fa-chevron-left"></i> 初识数据湖
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2021/02/01/2020年终个人总结/" rel="prev" title="2020年终个人总结">
                2020年终个人总结 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/2.JPG" alt="miaowenting">
            
              <p class="site-author-name" itemprop="name">miaowenting</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">51</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">27</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/miaowenting" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://ci.apache.org/projects/flink/flink-docs-stable/" title="flink文档" target="_blank">flink文档</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href title="flink社区" target="_blank">flink社区</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Apache-Iceberg-简介"><span class="nav-number">1.</span> <span class="nav-text">Apache Iceberg 简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据布局Layout"><span class="nav-number">2.</span> <span class="nav-text">数据布局Layout</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#读写原理"><span class="nav-number">3.</span> <span class="nav-text">读写原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#查询计划"><span class="nav-number">3.1.</span> <span class="nav-text">查询计划</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Flink-Iceberg-流式入湖"><span class="nav-number">4.</span> <span class="nav-text">Flink + Iceberg 流式入湖</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#入门实践"><span class="nav-number">4.1.</span> <span class="nav-text">入门实践</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#本机启动-Hadoop-和-Hive"><span class="nav-number">4.1.1.</span> <span class="nav-text">本机启动 Hadoop 和 Hive</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#本机启动-Flink"><span class="nav-number">4.1.2.</span> <span class="nav-text">本机启动 Flink</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#准备-Flink-SQL-Client-环境"><span class="nav-number">4.1.3.</span> <span class="nav-text">准备 Flink SQL Client 环境</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建-Iceberg-的-Catalog"><span class="nav-number">4.1.4.</span> <span class="nav-text">创建 Iceberg 的 Catalog</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#创建-Hive-Catalog"><span class="nav-number">4.1.4.1.</span> <span class="nav-text">创建 Hive Catalog</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#创建-Hadoop-Catalog"><span class="nav-number">4.1.4.2.</span> <span class="nav-text">创建 Hadoop Catalog</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#创建-Custom-Catalog"><span class="nav-number">4.1.4.3.</span> <span class="nav-text">创建 Custom Catalog</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#通过-YAML-统一新增-Catalog"><span class="nav-number">4.1.4.4.</span> <span class="nav-text">通过 YAML 统一新增 Catalog</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建数据库"><span class="nav-number">4.1.5.</span> <span class="nav-text">创建数据库</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建-Iceberg-表"><span class="nav-number">4.1.6.</span> <span class="nav-text">创建 Iceberg 表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Flink-SQL-写入"><span class="nav-number">4.1.7.</span> <span class="nav-text">Flink SQL 写入</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#DataStream-写入"><span class="nav-number">4.1.8.</span> <span class="nav-text">DataStream 写入</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#批量读取"><span class="nav-number">4.1.8.1.</span> <span class="nav-text">批量读取</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#流式读取"><span class="nav-number">4.1.8.2.</span> <span class="nav-text">流式读取</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#追加写入"><span class="nav-number">4.1.8.3.</span> <span class="nav-text">追加写入</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#覆盖写入"><span class="nav-number">4.1.8.4.</span> <span class="nav-text">覆盖写入</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#修改表属性"><span class="nav-number">4.1.9.</span> <span class="nav-text">修改表属性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#删除表、库和-Catalog"><span class="nav-number">4.1.10.</span> <span class="nav-text">删除表、库和 Catalog</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Flink-Sink-写入原理"><span class="nav-number">4.2.</span> <span class="nav-text">Flink Sink 写入原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Flink-Sink-小文件处理"><span class="nav-number">4.3.</span> <span class="nav-text">Flink Sink 小文件处理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#社区规划"><span class="nav-number">5.</span> <span class="nav-text">社区规划</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考资料"><span class="nav-number">6.</span> <span class="nav-text">参考资料</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">miaowenting</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
