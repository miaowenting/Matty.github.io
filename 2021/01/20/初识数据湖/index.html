<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">





  <link rel="alternate" href="/atom.xml" title="Matty's Blog" type="application/atom+xml">






<meta name="description" content="对于数据湖的入门者，本文记录一下对数据湖的初步认识。">
<meta property="og:type" content="article">
<meta property="og:title" content="初识数据湖">
<meta property="og:url" content="http://yoursite.com/2021/01/20/初识数据湖/index.html">
<meta property="og:site_name" content="Matty&#39;s Blog">
<meta property="og:description" content="对于数据湖的入门者，本文记录一下对数据湖的初步认识。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://yoursite.com/2021/01/20/初识数据湖/%E6%95%B0%E6%8D%AE%E6%B9%96%E5%9F%BA%E6%9C%AC%E8%83%BD%E5%8A%9B%E7%A4%BA%E6%84%8F.png">
<meta property="og:image" content="http://yoursite.com/2021/01/20/初识数据湖/%E5%88%9D%E8%AF%86%E6%95%B0%E6%8D%AE%E6%B9%96.png">
<meta property="og:image" content="http://yoursite.com/2021/01/20/初识数据湖/%E6%95%B0%E6%8D%AE%E6%B9%96%E7%9A%84%E4%B8%80%E8%88%AC4%E5%B1%82%E6%9E%B6%E6%9E%84.png">
<meta property="og:image" content="http://yoursite.com/2021/01/20/初识数据湖/%E5%9C%BA%E6%99%AF1_%E6%9E%84%E5%BB%BA%E5%AE%9E%E6%97%B6Data_pipeline.png">
<meta property="og:image" content="http://yoursite.com/2021/01/20/初识数据湖/%E5%9C%BA%E6%99%AF%E4%BA%8C_CDC%E6%95%B0%E6%8D%AE%E5%AE%9E%E6%97%B6%E6%91%84%E5%85%A5%E5%B0%84%E5%87%BA.png">
<meta property="og:image" content="http://yoursite.com/2021/01/20/初识数据湖/%E5%9C%BA%E6%99%AF%E4%B8%89_%E8%BF%91%E5%AE%9E%E6%97%B6%E5%9C%BA%E6%99%AF%E7%9A%84%E6%89%B9%E6%B5%81%E7%BB%9F%E4%B8%80.png">
<meta property="og:image" content="http://yoursite.com/2021/01/20/初识数据湖/%E5%9C%BA%E6%99%AF%E4%B8%89_%E8%BF%91%E5%AE%9E%E6%97%B6%E5%9C%BA%E6%99%AF%E7%9A%84%E6%89%B9%E6%B5%81%E7%BB%9F%E4%B8%802.png">
<meta property="og:image" content="http://yoursite.com/2021/01/20/初识数据湖/%E5%9C%BA%E6%99%AF%E5%9B%9B_%E4%BB%8EIceberg%E5%8E%86%E5%8F%B2%E6%95%B0%E6%8D%AE%E5%90%AF%E5%8A%A8Flink%E4%BB%BB%E5%8A%A1.png">
<meta property="og:image" content="http://yoursite.com/2021/01/20/初识数据湖/%E5%9C%BA%E6%99%AF%E4%BA%94_%E9%80%9A%E8%BF%87Iceberg%E6%95%B0%E6%8D%AE%E6%9D%A5%E8%AE%A2%E6%AD%A3%E5%AE%9E%E6%97%B6%E8%81%9A%E5%90%88%E7%BB%93%E6%9E%9C.png">
<meta property="og:image" content="http://yoursite.com/2021/01/20/初识数据湖/Delta_Hudi_Iceberg%E4%B8%89%E5%A4%A7%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE%E5%AF%B9%E6%AF%94%E6%80%BB%E7%BB%93%E5%9B%BE.png">
<meta property="og:image" content="http://yoursite.com/2021/01/20/初识数据湖/%E6%95%B0%E6%8D%AE%E6%B9%96%E5%8F%82%E8%80%83%E6%9E%B6%E6%9E%84%E7%A4%BA%E6%84%8F.png">
<meta property="og:image" content="http://yoursite.com/2021/01/20/初识数据湖/AWS%E6%95%B0%E6%8D%AE%E6%B9%96%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.png">
<meta property="og:image" content="http://yoursite.com/2021/01/20/初识数据湖/%E5%8D%8E%E4%B8%BA%E6%95%B0%E6%8D%AE%E6%B9%96%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.png">
<meta property="og:image" content="http://yoursite.com/2021/01/20/初识数据湖/%E9%98%BF%E9%87%8C%E4%BA%91%E6%95%B0%E6%8D%AE%E6%B9%96%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.png">
<meta property="og:image" content="http://yoursite.com/2021/01/20/初识数据湖/Azure%E6%95%B0%E6%8D%AE%E6%B9%96%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.png">
<meta property="og:updated_time" content="2021-06-03T17:41:32.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="初识数据湖">
<meta name="twitter:description" content="对于数据湖的入门者，本文记录一下对数据湖的初步认识。">
<meta name="twitter:image" content="http://yoursite.com/2021/01/20/初识数据湖/%E6%95%B0%E6%8D%AE%E6%B9%96%E5%9F%BA%E6%9C%AC%E8%83%BD%E5%8A%9B%E7%A4%BA%E6%84%8F.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2021/01/20/初识数据湖/">





  <title>初识数据湖 | Matty's Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Matty's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/01/20/初识数据湖/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="miaowenting">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/2.JPG">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Matty's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">初识数据湖</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-01-20T16:19:22+08:00">
                2021-01-20
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/DataLake/" itemprop="url" rel="index">
                    <span itemprop="name">DataLake</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>对于数据湖的入门者，本文记录一下对数据湖的初步认识。</p>
<a id="more"></a>

<h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p>数据湖是个什么概念呢？一般来说把一家企业产生的数据维护在一个平台内，这个平台我们称之为“数据湖”。</p>
<p>个人认为数据湖应该是一种不断演进中、可扩展的大数据存储、处理、分析的基础设施。以数据为导向，实现任意来源、任意规模、任意类型数据的全量获取、全量存储、多模式处理与全生命周期管理；并通过与各类外部异构数据源的交互集成，支持各类企业级应用。</p>
<p><img src="%E6%95%B0%E6%8D%AE%E6%B9%96%E5%9F%BA%E6%9C%AC%E8%83%BD%E5%8A%9B%E7%A4%BA%E6%84%8F.png" alt></p>
<p>看下面这幅图，这个湖的数据来源多种多样，有的可能是结构化数据，有的可能是非结构化数据，有的甚至是二进制数据。有一拨人站在湖的入口，用设备在检测水质，这对应着数据湖上的流处理作业；有一拨抽水机从湖里抽水，这对应着数据湖的批处理作业；还有一批人在船头钓鱼或者在岸上捕鱼，这对应着数据科学家从数据湖中通过机器学习的手段提取价值。<br><img src="%E5%88%9D%E8%AF%86%E6%95%B0%E6%8D%AE%E6%B9%96.png" alt></p>
<p>总结起来，数据湖主要有 4 个方面的特点：</p>
<ul>
<li><p>存储原始数据，这些原始数据的来源非常丰富<br>结构化数据<br>半结构化数据<br>非结构化数据<br>二进制数据（图片等）</p>
</li>
<li><p>支持多种计算模型<br>批处理<br>流计算<br>交互式分析<br>机器学习</p>
</li>
<li><p>有完善的数据管理能力<br>能做到多种数据源接入<br>时间不同数据之间的连接<br>支持 Schema 管理<br>支持权限管理</p>
</li>
<li><p>灵活的底层存储<br>一般用 S3/OSS/HDFS 这种廉价的分布式文件系统<br>支持 Parquet/Avro/Orc 文件格式<br>支持数据缓存加速<br>满足对应场景的数据分析需求</p>
</li>
</ul>
<p>那么，开源的数据湖架构一般是什么样的呢？一般分为四层：</p>
<ul>
<li>最底层是廉价、弹性可扩展的分布式文件系统，云上用户 S3 和 OSS 这种对象存储用的更多一些，毕竟价格便宜很多；非云上用户一般采用自己维护的 HDFS。</li>
<li>第二层是数据加速层。提供本地数据缓存（多块 SSD）和元数据加速服务。数据湖架构是一个存储计算彻底分离的架构，如果所有的数据访问都远程读取文件系统上的数据，那么性能和成本开销很大。如果能把经常访问到的一些热点数据缓存在计算节点本地，这就非常自然的实现了冷热分离，一方面能获取到不错的本地读取性能，另一方面还节省了远程访问的带宽。这一层里边，通常会选择开源的 alluxio，或者选择阿里云上的 Jindofs。</li>
<li>第三层就是 Table Format 层，提供面向用户的主表级语义。要是把一些数据文件封装成一个有业务语义的 table，提供 ACID、snapshot、schema、partition 等表级别的语义。一般对应着开源的 Delta、Iceberg、Hudi 等项目。对一些用户来说，他们认为 Delta、Iceberg、Hudi 这些就是数据湖，其实这几个项目只是数据湖这个架构里边的一环，只是因为它们离用户最近，屏蔽了底层的很多细节，所以才会造成这样的误解。数据湖和数据中台一样，是一种架构理念，而不是专指某一个技术。</li>
<li>最上层就是不同计算场景的计算引擎了，满足不同的分析需求。开源的一般有 Spark、Flink、Hive、Presto、Hive MR 等，这一批计算引擎可以同时访问同一张数据湖的表。</li>
</ul>
<p><img src="%E6%95%B0%E6%8D%AE%E6%B9%96%E7%9A%84%E4%B8%80%E8%88%AC4%E5%B1%82%E6%9E%B6%E6%9E%84.png" alt></p>
<h3 id="数据湖-vs-数据仓库"><a href="#数据湖-vs-数据仓库" class="headerlink" title="数据湖 vs 数据仓库"></a>数据湖 vs 数据仓库</h3><p>比较数据来源于 AWS。</p>
<table>
<thead>
<tr>
<th>特性</th>
<th>数据仓库</th>
<th>数据湖</th>
</tr>
</thead>
<tbody><tr>
<td>数据</td>
<td>来自事务系统、运营数据库和业务线应用程序的关系数据</td>
<td>来自 IoT设备、网站、移动应用程序、社交媒体和企业应用程序的非关系和关系数据</td>
</tr>
<tr>
<td>Schema</td>
<td>设计在数据仓库实施之前（写入型Schema）</td>
<td>写入在分析时（读取型Schema）</td>
</tr>
<tr>
<td>性价比</td>
<td>更快查询结果会带来较高存储成本</td>
<td>更快查询结果只需较低存储成本</td>
</tr>
<tr>
<td>数据质量</td>
<td>可作为重要事实依据的高度监管数据</td>
<td>任何可以或无法进行监管的数据（例如原始数据）</td>
</tr>
<tr>
<td>用户</td>
<td>业务分析师</td>
<td>数据科学家、数据开发人员和业务分析师（使用监管数据）</td>
</tr>
<tr>
<td>分析</td>
<td>批处理报告、BI和可视化</td>
<td>机器学习、预测分析、数据发现和分析</td>
</tr>
</tbody></table>
<h3 id="Flink数据湖业务场景"><a href="#Flink数据湖业务场景" class="headerlink" title="Flink数据湖业务场景"></a>Flink数据湖业务场景</h3><h4 id="场景一-构建实时Data-Pipeline"><a href="#场景一-构建实时Data-Pipeline" class="headerlink" title="场景一: 构建实时Data Pipeline"></a>场景一: 构建实时Data Pipeline</h4><p><img src="%E5%9C%BA%E6%99%AF1_%E6%9E%84%E5%BB%BA%E5%AE%9E%E6%97%B6Data_pipeline.png" alt></p>
<p>首先，Flink+Iceberg 最经典的一个应用场景就是构建实时的 Data Pipeline。业务端产生大量的日志数据，被导入到 Kafka 这样的消息队列，运用 Flink 流计算引擎执行 ETL 后，导入到 Apache Iceberg 原始表中。有一些业务场景需要直接跑分析作业来分析原始表的数据，而另外一些业务需要对数据做进一步的提纯，那么我们可以再起一个 Flink 作业从 Apache Iceberg 表中消费增量数据，经过处理之后写到到提纯之后的 Iceberg 表中。此时，可能还有业务需要对数据做进一步的聚合，那么我们继续在 Iceberg 表上启动增量 Flink 作业，将聚合之后的数据结果写入到聚合表中。</p>
<p>有人可能会提出质疑，这个场景好像通过 Flink+Hive 也能实现。Flink+Hive 的确可以实现，但写入到 Hive 的数据更多的是为了实现数仓的数据分析，而不是为了做增量拉取。一般来说，Hive 的增量写入是以 partition 为单位，时间是 15min 以上，Flink 长期高频率地写入会造成 partition 膨胀。而 Iceberg 允许实现 1min 甚至 30s 的增量写入，这样就可以大大提高了端到端数据的实时性，上层的分析作业可以看到更新的数据，下游的增量作业也可以读取到更新的数据。</p>
<ul>
<li><p>核心优势：<br>可以借助 Flink 实现数据 exactly-once 语义地入湖和出湖<br>新写入数据可以在 checkpoint 周期内可见<br>可以方便地构建 data pipeline，满足不同业务层的数据加工和分析需求</p>
</li>
<li><p>对比 Hive 方案：<br>hive 的增量写入以 partition 为单位，长期高频率的 checkpoint 写入，会导致 hive partition 的膨胀<br>本质上 hive 的增量写入和消费粒度都太大，实时性无法比肩 iceberg</p>
</li>
</ul>
<h4 id="场景二-CDC数据实时摄入摄出"><a href="#场景二-CDC数据实时摄入摄出" class="headerlink" title="场景二: CDC数据实时摄入摄出"></a>场景二: CDC数据实时摄入摄出</h4><p><img src="%E5%9C%BA%E6%99%AF%E4%BA%8C_CDC%E6%95%B0%E6%8D%AE%E5%AE%9E%E6%97%B6%E6%91%84%E5%85%A5%E5%B0%84%E5%87%BA.png" alt></p>
<p>第二个经典的场景，就是可以用 Flink+Iceberg 分析来自 MySQL 等关系型数据库的 binlog 等。</p>
<p>一方面，Flink 已经原生的支持 CDC 数据解析，一条 binlog 数据通过 flink-cdc-connector 拉取之后，自动转换成 Flink runtime 能识别的 insert、delete、update_before、update_after 四种消息，供用户进一步的实时计算。</p>
<p>另一方面，Iceberg 已经较为完善的实现了 equality delete 功能，也就是用户定义好到删除的 record，直接写到 Iceberg 表内就可以删除对应的行，本身就是为了实现数据湖的流式删除。在 Iceberg 未来的版本中，用户将不需要设计任何额外的业务字段，不用写几行代码就可以完成 binlog 流式入湖到 Iceberg （社区 PR 已经提供了一个 Flink 写入 CDC 数据的原型）。</p>
<p>此外，CDC 数据成功入湖 Iceberg 之后，常见的计算引擎 Presto、Spark、Hive 等，都可以实时的读取到 Iceberg 表中最新的数据。</p>
<h3 id="场景三-近实时场景的流批统一"><a href="#场景三-近实时场景的流批统一" class="headerlink" title="场景三: 近实时场景的流批统一"></a>场景三: 近实时场景的流批统一</h3><p><img src="%E5%9C%BA%E6%99%AF%E4%B8%89_%E8%BF%91%E5%AE%9E%E6%97%B6%E5%9C%BA%E6%99%AF%E7%9A%84%E6%89%B9%E6%B5%81%E7%BB%9F%E4%B8%80.png" alt></p>
<p>第三个经典场景是近实时场景的批流统一。在常用的 lambda 架构中，有一条实时链路和一条离线链路。实时链路一般由 Flink、Kafka、HBase 这些组件构建而成，离线链路一般会用到 Parquet、Spark等组件。这里边涉及到的计算组件和存储组件非常多，系统维护成本和业务开发成本都非常高。有很多场景，它们的实时性要求并没有那么苛刻，例如可以放松到分钟级别，这种场景我们称之为近实时场景。那么，我们是不是可以通过 Flink+Iceberg 来优化我们常用的 lambda 架构呢？</p>
<p><img src="%E5%9C%BA%E6%99%AF%E4%B8%89_%E8%BF%91%E5%AE%9E%E6%97%B6%E5%9C%BA%E6%99%AF%E7%9A%84%E6%89%B9%E6%B5%81%E7%BB%9F%E4%B8%802.png" alt></p>
<p>我们可以用 Flink+Iceberg 把整个架构优化成上图所示。实时的数据通过 Flink 写入到 Iceberg 表中，近实时链路可以通过 Flink 计算增量数据，离线链路也可以通过 Flink 批计算读取整个快照做全局分析，得到对应的分析结果，供不同场景下的用户读取和分析。经过这种改进之后，我们把计算引擎统一成了 Flink，把存储组件统一成了 Iceberg，整个系统的维护开发成本大大降低。</p>
<h4 id="场景四-从-Iceberg-历史数据启动-Flink-任务"><a href="#场景四-从-Iceberg-历史数据启动-Flink-任务" class="headerlink" title="场景四: 从 Iceberg 历史数据启动 Flink 任务"></a>场景四: 从 Iceberg 历史数据启动 Flink 任务</h4><p><img src="%E5%9C%BA%E6%99%AF%E5%9B%9B_%E4%BB%8EIceberg%E5%8E%86%E5%8F%B2%E6%95%B0%E6%8D%AE%E5%90%AF%E5%8A%A8Flink%E4%BB%BB%E5%8A%A1.png" alt></p>
<p>第四个场景，是采用 Iceberg 全量数据和 Kafka 的增量数据来 Bootstrap 新的 Flink 作业。我们现有的流作业在线上跑着，突然有一天某个业务方跑过来说，他们遇到一个新的计算场景，需要设计一个新的 Flink 作业，跑一遍去年一年的历史数据，跑完之后再对接到正在产生的 Kafka 增量数据。那么，这时候应该怎么办呢？</p>
<p>我们依然可以采用常见的 lamnda 架构，实时链路通过 Kafka -&gt; Flink -&gt; Iceberg 实时写入到数据湖，由于 Kafka 成本较高，保留最近 7 天数据即可，Iceberg 存储成本较低，可以存储全量的历史数据（按照 checkpoint 拆分成多个数据区间）。启动解析 Flink 作业的时候，只需要去拉取 Iceberg 的数据，跑完之后平滑的对接到 Kafka 数据即可。</p>
<h4 id="场景五-通过-Iceberg-数据来订正实时聚合结果"><a href="#场景五-通过-Iceberg-数据来订正实时聚合结果" class="headerlink" title="场景五: 通过 Iceberg 数据来订正实时聚合结果"></a>场景五: 通过 Iceberg 数据来订正实时聚合结果</h4><p><img src="%E5%9C%BA%E6%99%AF%E4%BA%94_%E9%80%9A%E8%BF%87Iceberg%E6%95%B0%E6%8D%AE%E6%9D%A5%E8%AE%A2%E6%AD%A3%E5%AE%9E%E6%97%B6%E8%81%9A%E5%90%88%E7%BB%93%E6%9E%9C.png" alt></p>
<p>第五个场景，和第四个场景类似。同样是在 lambda 架构下，实时链路由于事件丢失或者到达顺序的问题，可能导致流计算结果不一定完全准确，这时候一般都需要全量的历史数据来订正实时计算的结果。而 Iceberg 可以很好的充当这个角色，因为它可以高性价比的管理好历史数据。</p>
<h3 id="Why-Iceberg"><a href="#Why-Iceberg" class="headerlink" title="Why Iceberg"></a>Why Iceberg</h3><h4 id="Delta-vs-Hudi-vs-Iceberg"><a href="#Delta-vs-Hudi-vs-Iceberg" class="headerlink" title="Delta vs Hudi vs Iceberg"></a>Delta vs Hudi vs Iceberg</h4><p><img src="Delta_Hudi_Iceberg%E4%B8%89%E5%A4%A7%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE%E5%AF%B9%E6%AF%94%E6%80%BB%E7%BB%93%E5%9B%BE.png" alt></p>
<table>
<thead>
<tr>
<th>Items</th>
<th>Open Source Delta</th>
<th>Apache Iceberg</th>
<th>Apache Hudi</th>
</tr>
</thead>
<tbody><tr>
<td>Open Source Time</td>
<td>2019/04/12</td>
<td>2018/11/06(incubation)</td>
<td>2019/01/17(incubation)</td>
</tr>
<tr>
<td>Github Star</td>
<td>2800+</td>
<td>692</td>
<td>1400+</td>
</tr>
<tr>
<td>Releases</td>
<td>5</td>
<td>5</td>
<td>48</td>
</tr>
<tr>
<td>ACID</td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr>
<td>Isolation Level</td>
<td>Write/Snapshot serialization</td>
<td>Write serialization</td>
<td>Snapshot serialization</td>
</tr>
<tr>
<td>Time Travel</td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr>
<td>Row-level DELETE(batch)</td>
<td>Yes</td>
<td>Ongoing</td>
<td>No</td>
</tr>
<tr>
<td>Row-level DELETE(streaming)</td>
<td>No</td>
<td>Ongoing</td>
<td>Yes</td>
</tr>
<tr>
<td>Abstracted Schema</td>
<td>No</td>
<td>Yes</td>
<td>No</td>
</tr>
<tr>
<td>Engine Pluggable</td>
<td>No</td>
<td>Yes</td>
<td>No</td>
</tr>
<tr>
<td>Open File Format</td>
<td>Yes</td>
<td>Yes</td>
<td>Yes(Data) + No(Log)</td>
</tr>
<tr>
<td>Filter push down</td>
<td>No</td>
<td>Yes</td>
<td>No</td>
</tr>
<tr>
<td>Auto-Compaction</td>
<td>No</td>
<td>Ongoing</td>
<td>Yes</td>
</tr>
<tr>
<td>Python support</td>
<td>Yes</td>
<td>Yes</td>
<td>No</td>
</tr>
<tr>
<td>File Encryption</td>
<td>No</td>
<td>Yes</td>
<td>No</td>
</tr>
</tbody></table>
<h4 id="Flink-为何选择-Apache-Iceberg"><a href="#Flink-为何选择-Apache-Iceberg" class="headerlink" title="Flink: 为何选择 Apache Iceberg"></a>Flink: 为何选择 Apache Iceberg</h4><ol>
<li>Iceberg 的设计和 Flink 数据湖的需求最匹配</li>
</ol>
<ul>
<li>完美解耦计算引擎和文件格式两层，便于接入多样化的计算引擎和文件格式</li>
<li>正确的完成了 Table Format这一层的功能需求</li>
<li>更容易成为 Table Format 层的事实标准</li>
</ul>
<ol start="2">
<li>两个项目的长远规划相似</li>
</ol>
<ul>
<li>Apache Iceberg：打造流批一体的数据湖存储层</li>
<li>Apache Flink：打造流批一体的计算引擎</li>
<li>两者合力打造流批一体的数据湖架构</li>
</ul>
<ol start="3">
<li>强大的社区资源</li>
</ol>
<ul>
<li>Apache Iceberg 始自 Netflix。Netflix 最早是 All In Cloud 的互联网巨头之一，也是最早在线上生产环境运行 Flink/Spark+Iceberg 这套数据湖方案的公司</li>
<li>支撑着 Apple、LinkedIn、Adobe、腾讯、网易等多家互联网巨头 PB 级的生产数据</li>
<li>严苛的文档审核、代码审核及测试设计。拥有来自其他 Apache项目的1个VP、7个PMC、4个Committer</li>
</ul>
<p>Delta 和 Hudi 跟 Spark 的代码路径绑定太深，尤其是写入路径。毕竟当时这两个项目设计之初，都多多少少把 Spark 作为它们默认的计算引擎了。而 Apache Iceberg 非常坚定，总值就是要做一个通用化设计的 Table Format。因此它完美的解耦了计算引擎和底下的存储系统，便于多样化计算引擎和文件格式，可以说正确的完成了数据湖架构中的 Table Format 这一层的实现。我们认为它也更容易成为 Table Format 层的开源事实标准。</p>
<p>另一方面，Apache Iceberg 正在朝着批流一体的数据湖存储层发展， manifest 和 snapshot 的设计，有效的隔离不同 transaction 的变更，非常方便批处理和增量计算。而我们知道 Apache Flink 已经是流批一体的计算引擎，可以说这二者的长远规划完美匹配，未来二者将合力打造流批一体的数据湖架构。</p>
<p>最后，我们还发现 Apache Iceberg 这个项目背后的社区资源非常丰富。在国外，Netflix、Apple、Linkedin、Adobe 等公司都有 PB 级别的生产数据运行在 Apache Iceberg 上；在国内，腾讯这样的巨头也有非常庞大的数据跑在 Apache Iceberg 之上，他们最大的一个业务每天有几十T的增量数据写入到 Iceberg。社区成员同样非常资深和多样化，拥有来自其他项目的 7 位 Apache PMC，1位 VP。在代码和设计的 review 上，也非常苛刻，一个稍微大点的 PR 涉及 100+ 的 comment 很常见，这些都使得 Apache Iceberg 的设计+代码质量比较高。</p>
<p>正是基于以上考虑，Apache Flink 最终选择了 Apache Iceberg 作为第一个数据湖接入项目。</p>
<h2 id="数据湖基本架构"><a href="#数据湖基本架构" class="headerlink" title="数据湖基本架构"></a>数据湖基本架构</h2><p><img src="%E6%95%B0%E6%8D%AE%E6%B9%96%E5%8F%82%E8%80%83%E6%9E%B6%E6%9E%84%E7%A4%BA%E6%84%8F.png" alt></p>
<p>上图所示是一个数据湖系统的参考架构。对于一个典型的数据湖而言，它与大数据平台相同的地方在于它也具备超大规模数据所需的存储和计算能力，能提供多模式的数据处理能力；增强点在于数据湖提供了更为完善的数据管理能力，具体体现在：</p>
<ul>
<li><p>更强大的数据接入能力<br>对各类异构数据源的定义管理能力，以及对于外部数据源相关数据的抽取迁移能力，抽取迁移的数据包括外部数据源的元数据与实际存储的数据。</p>
</li>
<li><p>更强大的数据管理能力<br>可分为基本管理能力和扩展管理能力。基本管理能力包括对各类元数据的管理、数据访问控制、数据资产管理，是一个数据湖系统所必须的。扩展管理能力包括任务管理、流程编排以及数据质量、数据治理相关的能力。任务管理和流程编排主要用来管理、编排、调度、监测在数据湖系统中处理数据的各类任务，通常情况下，数据湖构建者会通过读取数据湖的相关元数据，来实现与数据湖系统的融合。而数据质量和数据治理则是更为复杂的问题，一般情况下，数据湖系统不会直接提供相关功能，但是会开放各类接口或元数据，供有能力的企业/组织与已有的数据治理软件集成或者做定制开发。</p>
</li>
<li><p>可共享的元数据<br>数据湖中的各类计算引擎会与数据湖中的数据深度融合，而融合的基础就是数据湖的元数据。好的数据湖系统，计算引擎在处理数据时，能从元数据中直接获取数据存储位置、数据格式、数据模式、数据分布等信息，然后直接进行数据处理，而无需进行人工/编程干预。更进一步，好的数据湖系统还可以对数据湖中的数据进行访问控制，控制的力度可以做到“库表列行”等不同级别。</p>
</li>
</ul>
<p> “集中式存储”更多的是业务概念上的集中，本质上希望一个企业组织内部能在一个明确统一的地方进行沉淀。事实上，数据湖的存储应该是一类可按需扩展的分布式文件系统，大多数数据湖实践中也是推荐采用 S3/OSS/HDFS 等分布式文件系统作为数据湖的统一存储。</p>
<h2 id="各个厂商的数据湖解决方案"><a href="#各个厂商的数据湖解决方案" class="headerlink" title="各个厂商的数据湖解决方案"></a>各个厂商的数据湖解决方案</h2><h3 id="AWS"><a href="#AWS" class="headerlink" title="AWS"></a>AWS</h3><p><img src="AWS%E6%95%B0%E6%8D%AE%E6%B9%96%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.png" alt></p>
<h3 id="华为"><a href="#华为" class="headerlink" title="华为"></a>华为</h3><p><img src="%E5%8D%8E%E4%B8%BA%E6%95%B0%E6%8D%AE%E6%B9%96%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.png" alt></p>
<h3 id="阿里云"><a href="#阿里云" class="headerlink" title="阿里云"></a>阿里云</h3><p><img src="%E9%98%BF%E9%87%8C%E4%BA%91%E6%95%B0%E6%8D%AE%E6%B9%96%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.png" alt></p>
<h3 id="Azure"><a href="#Azure" class="headerlink" title="Azure"></a>Azure</h3><p><img src="Azure%E6%95%B0%E6%8D%AE%E6%B9%96%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.png" alt></p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://zhuanlan.zhihu.com/p/142756094" target="_blank" rel="noopener">“新晋网红”数据湖到底该如何理解？</a><br><a href="https://blog.51cto.com/u_15023245/2619826" target="_blank" rel="noopener">基于 Flink+Iceberg 构建企业级实时数据湖 - 文章</a><br><a href="https://www.bilibili.com/video/BV14A411J7e6?p=4" target="_blank" rel="noopener">基于 Flink+Iceberg 构建企业级实时数据湖 - 视频</a><br><a href="https://help.aliyun.com/document_detail/70378.html?spm=5176.21620736.J_5253785160.6.731041d2lYoMlv" target="_blank" rel="noopener">阿里云 云原生数据湖分析 DLA 帮助文档</a></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2021/01/10/晚熟的人/" rel="next" title="晚熟的人">
                <i class="fa fa-chevron-left"></i> 晚熟的人
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2021/01/20/Apache-Iceberg/" rel="prev" title="Apache Iceberg">
                Apache Iceberg <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/2.JPG" alt="miaowenting">
            
              <p class="site-author-name" itemprop="name">miaowenting</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">74</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">33</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/miaowenting" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://ci.apache.org/projects/flink/flink-docs-stable/" title="flink文档" target="_blank">flink文档</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href title="flink社区" target="_blank">flink社区</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#概念"><span class="nav-number">1.</span> <span class="nav-text">概念</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#数据湖-vs-数据仓库"><span class="nav-number">1.1.</span> <span class="nav-text">数据湖 vs 数据仓库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Flink数据湖业务场景"><span class="nav-number">1.2.</span> <span class="nav-text">Flink数据湖业务场景</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#场景一-构建实时Data-Pipeline"><span class="nav-number">1.2.1.</span> <span class="nav-text">场景一: 构建实时Data Pipeline</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#场景二-CDC数据实时摄入摄出"><span class="nav-number">1.2.2.</span> <span class="nav-text">场景二: CDC数据实时摄入摄出</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#场景三-近实时场景的流批统一"><span class="nav-number">1.3.</span> <span class="nav-text">场景三: 近实时场景的流批统一</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#场景四-从-Iceberg-历史数据启动-Flink-任务"><span class="nav-number">1.3.1.</span> <span class="nav-text">场景四: 从 Iceberg 历史数据启动 Flink 任务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#场景五-通过-Iceberg-数据来订正实时聚合结果"><span class="nav-number">1.3.2.</span> <span class="nav-text">场景五: 通过 Iceberg 数据来订正实时聚合结果</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Why-Iceberg"><span class="nav-number">1.4.</span> <span class="nav-text">Why Iceberg</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Delta-vs-Hudi-vs-Iceberg"><span class="nav-number">1.4.1.</span> <span class="nav-text">Delta vs Hudi vs Iceberg</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Flink-为何选择-Apache-Iceberg"><span class="nav-number">1.4.2.</span> <span class="nav-text">Flink: 为何选择 Apache Iceberg</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据湖基本架构"><span class="nav-number">2.</span> <span class="nav-text">数据湖基本架构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#各个厂商的数据湖解决方案"><span class="nav-number">3.</span> <span class="nav-text">各个厂商的数据湖解决方案</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#AWS"><span class="nav-number">3.1.</span> <span class="nav-text">AWS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#华为"><span class="nav-number">3.2.</span> <span class="nav-text">华为</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#阿里云"><span class="nav-number">3.3.</span> <span class="nav-text">阿里云</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Azure"><span class="nav-number">3.4.</span> <span class="nav-text">Azure</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考资料"><span class="nav-number">4.</span> <span class="nav-text">参考资料</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">miaowenting</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
