<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Matty&#39;s Blog</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2021-07-05T11:12:29.570Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>miaowenting</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Flink源码剖析-flink-streaming-java_ProcessFunction</title>
    <link href="http://yoursite.com/2021/07/05/Flink%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90-flink-streaming-java-ProcessFunction/"/>
    <id>http://yoursite.com/2021/07/05/Flink源码剖析-flink-streaming-java-ProcessFunction/</id>
    <published>2021-07-05T11:05:08.000Z</published>
    <updated>2021-07-05T11:12:29.570Z</updated>
    
    <content type="html"><![CDATA[<div id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <div class="hbe-input-container">  <input type="password" id="hbePass" placeholder="" />    <label for="hbePass">Hey, password is required here.</label>    <div class="bottom-line"></div>  </div>  <script id="hbeData" type="hbeData" data-hmacdigest="01153083c6d8698f9a02df416d4b0aa8d48e8a397e1f373c7996a8f9302865a7">49f7eb9bea6cd6a47e660ee8aad95e5fd65e2b87547d9ea2df2fa54ec1de99c0ab62e07f1ad7330285224520fc3fe6ca39499eac81d0d2b79d6e1e0b25e7a43cffe3ed45e0d2801aa681491b4062450cc09da150720007660d494590d3d7f36a8334460655741889111ba49ac3427417eb40bd2ae2cee82d21e8e0bc50d0032a5762e3613332cae04f48a87e6e267a306afc2f2afffc18ab0d54a8eeafe6993fbcece649e8a12c0fd9c605dd69aabfcf9164aac1b0d6ecd8efe14c747a35e39a7910580a103bfd60000b7e76c158b36b8a5e8b1d88aa5a7a5862c3885c6dc76f2751e0fc3a377455a275996369ee9d5d04173ed33a0deffe2977206eba3a6f96b264e0413f623eaec374e42897511e2a064fbb80a0d44149fa0fdd8b3190047b3614a548f70602d87653cd0fd574ab4702c92fb820245341b0a3665ccc51511782068331d309af1d294dd66d01ab5dde0d0695822320a28abff890445f5c74db113449b43cff627796231fd8d11f98bf6c0bb3b69d31d9ac26fc00de018068b66234bc5e76fde49b74697682d4acb2e4bec7ed2b3acb7e2d1058078e8a4293ad8cbf5c3630f0db65f9c2ef62e33ce50745121246fd20019f4dab510a1427b4d844c940f6e57883ded5a0f723bf6312f48396717825f2aff253aac786b31a25de460c66439bcc2ee3ce1cd0b029c6f52dfb124931406e2a8f86074f6d127325a43f02bd2c8da6b3315d28bc219b79ab7b622937fc7e82aa8f6c09224b16c1a36420a8083e4e07d80bd8b4fbb83ea3c62d54a9b0f3671fa7c47d15cb069d676c360c8f3628e7e4309141b549e52a601dffb20c430bbaa105f5a5add4dab71e469cd69324c0d7bebed346f45172ebd7e736374e75d1e562321fb00f1e031b592bcaefee10429d6a6ce2039f5e4b0e1fef081876b49e75997a11e5ddc56ea7770fa3443ac3c974b2e5ffe19dd80cdf8e91345bbf516ce660f64009244ec59761bd30793994a5b5214ae4574b851b8229e4533b655c9236ce22719d9b781bfe06c3e2acb27b861113f1fb5814d8c0082f16908375147c66af605198af2c85e283eb02448894b47ca9866ff916c745cd6632920c1ffc2566e3744454ffbb0766bd4c59935c14d163a91c976f9de59cd52aa66c5dd5b4066f23e80d3d5e390e1ab50fa8f0e815ae87d46aa91cd7ceacd13cc98258a86c632ba4b197a47ef4f5312a1e983b9fe3528e228443e78d82e2af1490846a2db1fb1aa4111db74d71e065db414b88a19501ea1cd524db0a74ad49be146103f7f87d990496657c22fe3ff524cbe33d717ea36795cc7dbee0aa8f139f5551492bb77b67e3c098660095a0657b273dc2bb649a324e5f5b3f7208cb4d6fe2e8749fc88729177b2a7f9c831502ec66db5a5ab1759cee5f2cd423f3ed5a50ab4f2445427a2831e290a91345bb94dc74851b5085b4ec339789010ea153d2bb8334c06c14fdb09b31c28b43af4c06277f2b0fb92a375eda217a7c3299447609b123033368de00cafa70e319540ae4a665245510f1b39922fc0f4b41d16334d9c3d2d1e3aca93ed01c43b38de703372e52cef8cab92216f4e4e66aa010720e9afc70</script></div><script src="/lib/blog-encrypt.js"></script><link href="/css/blog-encrypt.css" rel="stylesheet" type="text/css">]]></content>
    
    <summary type="html">
    
      Here&#39;s something encrypted, password is required to continue reading.
    
    </summary>
    
      <category term="Flink" scheme="http://yoursite.com/categories/Flink/"/>
    
    
  </entry>
  
  <entry>
    <title>Apache Pulsar</title>
    <link href="http://yoursite.com/2021/05/25/Apache-Pulsar/"/>
    <id>http://yoursite.com/2021/05/25/Apache-Pulsar/</id>
    <published>2021-05-25T05:09:47.000Z</published>
    <updated>2021-06-14T12:05:13.699Z</updated>
    
    <content type="html"><![CDATA[<p>本文为 Apache Pulsar 的入门学习笔记。 </p><p>企业在考虑部署实时消息系统时，总体硬件成本很重要的。Kafka 是基于磁盘存储数据的，存储成本较高。<br>而 Pulsar Broker 不直接存储数据，而是使用 Apache BookKeeper 来存储数据。数据发送/接收和存储的解耦使得 BookKeeper 可以在运行在独立的物理计算机或容器上。</p><p>当新生事物出现有两种角度去观察它，要么把它看小，要么把它放大。对 Apache Pulsar，把它看小的角度通常是”Apache Pulsar 只是一个新的消息队列而已”，或者“Apache Pulsar 只是一个新的数据管道而已”，“队列系统早就有了，只是 Apache Pulsar 更具扩展性也能解决某些场景问题而已，基本没啥本质区别”。很明显上述认识都不对，Apache Pulsar 在消息、流、数据管理和技术基础设施层面都有技术演进，详看正文。</p><a id="more"></a><h2 id="Pulsar-兴起的原因"><a href="#Pulsar-兴起的原因" class="headerlink" title="Pulsar 兴起的原因"></a>Pulsar 兴起的原因</h2><p>消息队列的发展史：<br><img src="%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%8F%91%E5%B1%95%E5%8F%B2.png" alt></p><p>在 pulsar 之前，消息系统主要有两个应用场景：</p><ul><li>应用之间的解耦缓冲，出现了大量的MQ。</li><li>随着流计算的兴起，Kafka 被大量使用。   </li></ul><p><img src="pulsar%E4%B9%8B%E5%89%8D.png" alt></p><p>未来实时技术设施建设通常有以下3大趋势：</p><ul><li>消息系统的融合</li><li>批流存储融合</li><li>云原生</li></ul><h3 id="Converged-Messaging-消息系统的融合"><a href="#Converged-Messaging-消息系统的融合" class="headerlink" title="Converged Messaging 消息系统的融合"></a>Converged Messaging 消息系统的融合</h3><ul><li>Queuing 模式<br>应用系统消息处理；<br>系统间异步通信；<br>常用的有 RocketMQ、RabbitMQ、AMQP、JMS；</li></ul><ul><li>Streaming 模式<br>流通常用在数据流水线里，数据量较大，高吞吐量；<br>常用的有 Kafka、Kinesis；</li></ul><ul><li>Queuing vs Streaming</li></ul><p>队列和流通常用于不同的应用场景下。<br><img src="Queuing_vs_Streaming.png" alt></p><ul><li>Queuing + Streaming</li></ul><p>队列和流本身是做不到完全隔离的，队列中的数据通常需要通过流导入到数仓中。</p><p><img src="Queuing+Streaming.png" alt></p><p>一个业务系统通常需要使用多个消息系统，举例如下：</p><p>刚开始做业务的时候，创建了两个微服务，如果两个微服务之间需要通信，就会拉一个消息队列（RabbitMQ、ActiveMQ等）进来。随着业务的增长，需要接入一些 IoT 设备，使用 MQTT broker 去查一些 IoT 设备。此时业务需要对 IoT 设备进行流计算计数等处理，此时就会引入 Kafka，所有数据通过 Kafka Connector 集中汇聚到 Kafka，做集中的流计算处理。同时流计算的处理结果，可能需要写回 MQTT 或者其他业务系统。</p><p><img src="%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%9C%A8%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF%E4%B8%AD%E7%9A%84%E5%B8%B8%E8%A7%81%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F.png" alt></p><p>此时调用链路和数据存储方式是比较混乱的，业务人员可能不知道从哪里取数：</p><p><img src="%E5%A4%9A%E7%A7%8D%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9A%84%E4%BD%BF%E7%94%A8%E5%AF%BC%E8%87%B4%E7%B3%BB%E7%BB%9F%E4%B9%8B%E9%97%B4%E4%B8%80%E5%9B%A2%E4%B9%B1%E9%BA%BB.png" alt></p><p>Pulsar = Queues + Streams 的融合：</p><p><img src="Pulsar=Queues+Streams%E7%9A%84%E8%9E%8D%E5%90%88.png" alt></p><p>据调研，有42%的用户在考虑用 Pulsar 替换业务中使用的2种及以上的消息队列。</p><h3 id="Unified-Batch-and-Event-Stream-Storage-批流存储融合"><a href="#Unified-Batch-and-Event-Stream-Storage-批流存储融合" class="headerlink" title="Unified Batch and Event-Stream Storage 批流存储融合"></a>Unified Batch and Event-Stream Storage 批流存储融合</h3><p>传统的数据库处理，就是不停的插入数据，再用 SQL 批量查询出数据：</p><p><img src="%E4%BC%A0%E7%BB%9F%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%84%E7%90%86%E5%BA%94%E7%94%A8.png" alt></p><p>举一个快递员送餐的例子，用户一旦下单，他最关心的是餐什么时候能送到？<br>不仅要看当前的实时位置信息，还需要结合历史经验数据中天气、交通等因素对送餐速度的影响：</p><p><img src="%E5%BF%AB%E9%80%92%E5%91%98%E9%80%81%E9%A4%90%E6%A1%88%E4%BE%8B_%E5%AE%9E%E6%97%B6%E4%BD%8D%E7%BD%AE.png" alt></p><p><img src="%E5%BF%AB%E9%80%92%E5%91%98%E9%80%81%E9%A4%90%E6%A1%88%E4%BE%8B_%E5%AE%9E%E6%97%B6%E4%BD%8D%E7%BD%AE_%E7%BB%93%E5%90%88%E5%8E%86%E5%8F%B2%E7%BB%8F%E9%AA%8C%E6%95%B0%E6%8D%AE.png" alt></p><p>Pulsar = 批 + 流 的存储融合：</p><p><img src="Pulsar%E7%9A%84%E6%89%B9%E6%B5%81%E5%AD%98%E5%82%A8%E8%9E%8D%E5%90%88%E5%AE%9E%E7%8E%B0.png" alt></p><h3 id="Cloud-Native-Operations-以云原生的方式部署和运维"><a href="#Cloud-Native-Operations-以云原生的方式部署和运维" class="headerlink" title="Cloud-Native Operations 以云原生的方式部署和运维"></a>Cloud-Native Operations 以云原生的方式部署和运维</h3><p>Cloud Native Computing Foundation，云原生计算基金会。<br><code>Cloud native technologies empower organizations to build and run scalable applications in modern, dynamic environments such as public, private, and hybrid cloud. Containers, service meshes, microservices, immutable infrastructure, and declarative APIs exemplify this approach.</code></p><p><img src="%E4%BA%91%E5%8E%9F%E7%94%9F%E7%B3%BB%E7%BB%9F%E6%A6%82%E5%BF%B5.png" alt></p><ul><li>Kubernets ，应该是跑在 k8s</li><li>Infinite，可以支持无限扩容</li><li>Serverless，业务服务是无状态的，可随时扩展</li><li>Multi Tenant，支持多租户</li><li>Geo Replicated，支持运行在不同的云厂商上，并且可以支持在不同的云厂商之间复制服务</li><li>Elastic</li><li>Secure and reliable，协议和数据存储应该是加密的，端到端的传输也是加密的</li><li>API-driven operations，透出统一的 API 服务</li></ul><p>Pulsar 的 Hot data、Warm data、Cold data 存储分离：<br><img src="data_tiering_and_io_isolation.png" alt></p><p>据调研，有50%的用户倾向于部署在 k8s/Cloud。</p><h2 id="Apache-Pulsar-简介"><a href="#Apache-Pulsar-简介" class="headerlink" title="Apache Pulsar 简介"></a>Apache Pulsar 简介</h2><p>综上，Pulsar 可以很容易的运行在 k8s 上，同时能集成多种云厂商作为其层级存储。Pulsar 提供了队列和流的统一模型，同时通过 Protocol Handler 的方式支持了其他消息系统的协议，如 Kafka Clients、AMQP Clients、MQTT Clients。这些都使得 Pulsar 完美的成为消息、流、存储融合的解决方案。<br><img src="pulsar%E7%9A%84%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84%E5%9B%BE.png" alt></p><h3 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h3><ul><li><p>计算与存储分离<br>Pulsar 的 Producer 和 Consumer 都与 broker 相连接，broker 作为无状态服务，可以横向扩缩容，扩缩容时不会影响数据的整体生产和消费；broker 不存储数据，数据存储在 broker 的下一层，即 bookie 中，实现了计算与存储分离。<br><img src="pulsar%E7%9A%84%E4%BA%91%E5%8E%9F%E7%94%9F%E6%9E%B6%E6%9E%84.png" alt></p></li><li><p>节点对等，独立扩展，弹性水平扩容<br>对于云端产品而言，Pulsar 无需重平衡即可实现 broker 扩缩容。相比之下，Kafka 扩缩容前需要先进行重平衡操作，可能会导致集群负载较高，也会对整体服务产生影响。其次，Pulsar topic 分区也可以实现无限扩容，扩容之后，通过负载均衡策略自动平衡整个分片和流量。</p></li><li><p>Pulsar 多租户<br>Pulsar 原生支持多租户。在日志服务中也有租户的概念，每一条产品线属于一个租户，实现了产品线之间的数据隔离。Pulsar 集群支持数百万个 topic，整个 topic 也通过租户实现了隔离，在租户级别，Pulsar 实现了存储配额、消息过期删除、隔离策略等优越特性，且支持单独的认证和授权机制。<br><img src="pulsar%E6%94%AF%E6%8C%81%E5%A4%9A%E7%A7%9F%E6%88%B7.png" alt></p></li><li><p>负载均衡策略<br>Pulsar 在命名空间级别有 bundle 的概念，如果当前 broker 负载较高，bundle 会通过管理 topic 分区策略进行 bundle split 的操作，自动将子分区均衡到其他负载较低的 broker 上。在创建 topic 时，Pulsar 也会自动把 topic 优先分配到当前负载较低的 broker 上。</p></li></ul><ul><li><p>Pulsar IO 模型<br>写入操作中，broker 并发向 BookKeeper 写入数据；当 bookie 向 broker 反馈数据写入成功时，在 broker 层面，内部只维护一个队列。如果当前的消费模式是实时消费，则可以直接从 broker 获取数据，无需经过 bookie 查询，从而提升消息吞吐量。在 append 读场景中，查询历史数据才需要查询 bookie； append 读还支持数据卸载功能，即将数据卸载到其他存储介质中（比如 HDFS），实现冷存历史数据。</p></li><li><p>Topic 创建、生产与消费<br>在控制台创建 topic 后，将 topic 信息和租户信息记录到 etcd 和 MySQL 中，producer 和 consumer 两类服务会监听 etcd。producer 类服务，监听创建或删除 topic 的内部操作。consumer 服务监听到创建 topic 操作后，对应的服务会连接到 Pulsar topic，实时消费 topic 上的数据。 producer 开始接收数据，并判断应该向哪一个 topic 写入数据，consumer 消费数据并在判断后写入，或转存再写入到 ES 等其他存储中。</p></li><li><p>Topic 逻辑抽象<br>Pulsar 有3个级别：topic、命名空间和租户。在日志服务中，topic 对应 Pulsar 逻辑上的分片，命名空间对应 Pulsar 逻辑上的 topic。通过将整体概念往上提一层，实现了两个功能，一是动态增加和减少分片数量，二是在后台启动的 Flink 任务可以消费单个项目级别的数据。<br><img src="Pulsar%E7%9A%84topic%E9%80%BB%E8%BE%91%E6%8A%BD%E8%B1%A1.png" alt></p></li><li><p>消息订阅模型<br>Pulsar 提供四种消息订阅模型：</p><ol><li>独占模式（Exclusive）：当有多个 consumer 使用同一个订阅名称订阅 topic 时，只有一个 consumer 可以消费数据。</li><li>故障转移模式（Failover）：当多个 consumer 通过同一个订阅名称订阅 topic 时，如果某一个 consumer 出现故障或连接中断，Pulsar 会自动切换到下一个 consumer，实现单点消费。</li><li>共享模式（Shared）：应用比较广泛的一个模型，如果启动多个 consumer，但只通过一个订阅者订阅 topic 信息，Pulsar 会通过轮询方式依次向 consumer 发送数据；如果某一个 consumer 宕机或连接中断，则消息会被轮询到下一个 consumer 中。LogHub 使用的就是共享订阅模型，整个 Hub 运行在容器中，可以根据整体负载或其他指标动态扩缩容消费端。</li><li>Keyed_Shared 消息订阅模式：通过 Key Hash 方式保持数据消费的一致性。</li></ol></li><li><p>Broker 故障恢复<br>由于 broker 无状态，所以某一个 broker 宕机对整体的生产和消费没有任何影响，同时会有一个新的 broker 担任 owner 的角色，从 Zookeeper 中获取 topic 元数据，并自动演进到新 owner 中，数据的存储层也不会发生变化。此外，无需拷贝 topic 内的数据，避免数据冗余。</p></li><li><p>Bookie 故障恢复<br>bookie 层使用分片存储信息。由于 bookie 本身有多副本机制，当某个 bookie 出现故障时，系统会从其他 bookie 读取对应分片的信息，并进行重平衡，因此整个 bookie 的写入不会受到影响，保证整个 topic 的可用性。</p></li><li><p>原生跨地域复制<br><img src="pulsar%E6%94%AF%E6%8C%81%E5%8E%9F%E7%94%9F%E8%B7%A8%E5%9C%B0%E5%9F%9F%E5%A4%8D%E5%88%B6.png" alt></p></li></ul><h3 id="数据视图"><a href="#数据视图" class="headerlink" title="数据视图"></a>数据视图</h3><p>pulsar视图之topic_partiiton分区：</p><p><img src="pulsar%E6%95%B0%E6%8D%AE%E8%A7%86%E5%9B%BE_topic_partition%E5%88%86%E5%8C%BA.png" alt></p><p>pulsar视图之partiiton_segment分片：</p><p><img src="pulsar%E6%95%B0%E6%8D%AE%E8%A7%86%E5%9B%BE_partition_segment%E5%88%86%E7%89%87.png" alt></p><p>pulsar计算历史数据：</p><ul><li>获取 Segments 列表</li><li>选择需要扫描的 Segments</li><li>使用 Segments reader 直接访问 Segments</li></ul><p><img src="pulsar%E8%AE%A1%E7%AE%97%E5%8E%86%E5%8F%B2%E6%95%B0%E6%8D%AE.png" alt></p><p>pulsar计算实时数据：</p><ul><li>使用 Pulsar broker 的接口：Pub/Sub API </li></ul><p><img src="pulsar%E8%AE%A1%E7%AE%97%E5%AE%9E%E6%97%B6%E6%95%B0%E6%8D%AE.png" alt></p><h3 id="功能完整性"><a href="#功能完整性" class="headerlink" title="功能完整性"></a>功能完整性</h3><p>Pulsar 是一个完整的消息和流融合的产品：</p><p><img src="pulsar%E7%9A%84%E5%AE%8C%E6%95%B4%E6%80%A7.png" alt></p><h3 id="高吞吐量"><a href="#高吞吐量" class="headerlink" title="高吞吐量"></a>高吞吐量</h3><p><img src="pulsar%E9%AB%98%E5%90%9E%E5%90%90.png" alt></p><h3 id="稳定的低延时"><a href="#稳定的低延时" class="headerlink" title="稳定的低延时"></a>稳定的低延时</h3><p>pulsar 的时延基本稳定在 5～10ms 之间，Kafka 随着partitions数据的增多，时延会升高。<br><img src="pulsar%E7%A8%B3%E5%AE%9A%E7%9A%84%E4%BD%8E%E5%BB%B6%E6%97%B6%E7%89%B9%E6%80%A7.png" alt></p><h3 id="生态社区支持"><a href="#生态社区支持" class="headerlink" title="生态社区支持"></a>生态社区支持</h3><p><img src="pulsar%E7%9A%84%E7%94%9F%E6%80%81%E6%94%AF%E6%8C%81.png" alt></p><h3 id="Cloud-offerings"><a href="#Cloud-offerings" class="headerlink" title="Cloud offerings"></a>Cloud offerings</h3><p>StreamNative Cloud<br>Apache Pulsar as a Service</p><p>除了阿里云，还会部署到 Google Cloud、Microsoft Azure、亚马逊、腾讯云等。</p><h3 id="Roadmap"><a href="#Roadmap" class="headerlink" title="Roadmap"></a>Roadmap</h3><ul><li>Pulsar Transaction (2.7.0 developer preview)，2.7.2 中已支持</li><li>Function Mesh</li><li>Auto-Scaling Topic Partitions</li><li>Pulsar No-keeper</li><li>Columnar Tiered Storage</li></ul><h2 id="Pulsar-vs-Kafka-vs-RocketMQ"><a href="#Pulsar-vs-Kafka-vs-RocketMQ" class="headerlink" title="Pulsar vs Kafka vs RocketMQ"></a>Pulsar vs Kafka vs RocketMQ</h2><table>    <tr>        <td>分类</td>        <td>对比项</td>        <td>RocketMQ</td>        <td>Kafka</td>        <td>Pulsar</td>    </tr>    <tr>        <td>定位</td>        <td></td>        <td>轻量级数据处理平台</td>        <td>分布式事件流平台</td>        <td>云原生的分布式数据处理平台</td>    </tr>    <tr>        <td rowspan="11">基础功能对比</td>        <td>消费模式</td>        <td>推、拉</td>        <td>拉</td>        <td>推</td>    </tr>    <tr>        <td>订阅模式</td>        <td>点对点，发布订阅</td>        <td>发布订阅</td>        <td>发布订阅，点对点</td>    </tr>    <tr>        <td>消息存储</td>        <td>支持，较高</td>        <td>支持，较高</td>        <td>支持，较高</td>    </tr>    <tr>        <td>多租户</td>        <td>不支持</td>        <td>不支持</td>        <td>支持</td>    </tr>    <tr>        <td>写入性能</td>        <td>好</td>        <td>非常好</td>        <td>非常好</td>    </tr>    <tr>        <td>消费性能</td>        <td>好</td>        <td>非常好</td>        <td>非常好</td>    </tr>    <tr>        <td>稳定性</td>        <td>好</td>        <td>分区过多或扩容时，写入性能下降</td>        <td>分区较多时，性能稳定</td>    </tr>    <tr>        <td>支持topic数量</td>        <td>单机5万队列，支撑较好</td>        <td>单机超过 60+ topic，负载升高</td>        <td>5万topic，性能稳定</td>    </tr>    <tr>        <td>消息优先级</td>        <td>支持</td>        <td>不支持</td>        <td>不支持</td>    </tr>    <tr>        <td>死信队列</td>        <td>支持</td>        <td>不支持</td>        <td>支持</td>    </tr>    <tr>        <td>消息TTL</td>        <td>支持</td>        <td>支持</td>        <td>支持</td>    </tr>    <tr>        <td>可靠性对比</td>        <td>可靠性</td>        <td>很好</td>        <td>很好</td>        <td>很好</td>    </tr>    <tr>        <td rowspan="2">优缺点对比</td>        <td>优点</td>        <td>            高吞吐量，低延迟;<br>            支持顺序消息，事务等，功能较全;<br>            不受分区限制，水平扩展能力强;        </td>        <td>            高吞吐量，低延迟，高可用，高容错;<br>            生态较好，大数据领域使用较广;<br>        </td>        <td>            高吞吐量，低延迟，高可靠，高容错;<br>            计算存储分离，水平扩展和不需要重平衡;<br>            支持的 topic 分区数可达百万级;        </td>    </tr>    <tr>        <td>缺点</td>        <td>            吞吐量不如Kafka;<br>            不支持 master 主动切换，客户端只支持java;        </td>        <td>            集群消费受分区数目限制;<br>            单机 partition 过多，性能下降明显;<br>            重平衡对生产运行影响较大;        </td>        <td>            使用案例较少;<br>            社区文档不成熟;        </td>    </tr></table><h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><ol><li>Pulsar 在日志服务中的应用</li></ol><p>日志服务系统的最底层是数据采集工具，我们基于开源的数据采集工具（如 Logstash、Flume、Beats）进行了定制化开发。数据存储中日志池是一个逻辑概念，对应于 Pulsar 中的 topic。日志服务系统的上层为查询分析和业务应用，查询分析指在日志服务的工作台进行检索分析，或通过 SQL 语法进行查询；业务应用指在控制台定制仪表盘和图表，实现实时告警等。<br>查询分析和业务应用都支持数据转存，即把日志数据转存到存储介质或价格较低的存储设备中，如基于 KS3 的对象存储、ElasticSearch 集群或 Kafka。</p><p><img src="Pulsar%E5%9C%A8%E6%97%A5%E5%BF%97%E6%9C%8D%E5%8A%A1%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8.png" alt></p><ol start="2"><li><p>计费平台、支付平台、交易系统</p></li><li><p>Worker Queue / Push Notifications /  Task Queue</p></li><li><p>Unified Messaging Backbone (Queuing + Streaming)</p></li><li><p>IoT 车联网、物联网领域</p></li><li><p>Unified Data Processing - Flink</p></li></ol><h2 id="Flink-和-Pulsar-的批流融合"><a href="#Flink-和-Pulsar-的批流融合" class="headerlink" title="Flink 和 Pulsar 的批流融合"></a>Flink 和 Pulsar 的批流融合</h2><p>Flink 角色：</p><ul><li>对批流处理提供统一的模型和 API</li><li>处理大规模的历史数据和低延迟的实时数据</li></ul><p>Pulsar 角色：</p><ul><li>提供对批流数据的统一存储视图</li><li>通过层级存储提供无限的流存储</li><li>提供统一的消费模型</li></ul><p>pulsar flink connector 目前还没有合并到 flink 仓库，维护在单独的仓库中：<a href="https://github.com/streamnative/pulsar-flink" target="_blank" rel="noopener">pulsar-flink github地址</a></p><ul><li>Pulsar Schema<br>第一种是常见的消息元数据，包括消息的key、消息产生时间、或其他元数据的信息。Primitive Schema:</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root</span><br><span class="line">|-- value: double (nullable = false)</span><br><span class="line">|-- __key: binary (nullable = true)</span><br><span class="line">|-- __topic: string (nullable = true)</span><br><span class="line">|-- __messageId: binary (nullable = true)</span><br><span class="line">|-- __publishTime: timestamp (nullable = true)</span><br><span class="line">|-- __eventTime: timestamp (nullable = true)</span><br></pre></td></tr></table></figure><p>第二种是对消息的内容的数据结构的描述，常见的是 Avro 格式，用户访问的时候就可以通过 Schema 知道每个消息对应的数据结构。Avro Schema:</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Foo</span>(<span class="params">i: <span class="type">Int</span>, f: <span class="type">Float</span>, bar: <span class="type">Bar</span></span>)</span></span><br><span class="line"><span class="class"><span class="title">case</span> <span class="title">class</span> <span class="title">Bar</span>(<span class="params">b: <span class="type">Boolean</span>, s: <span class="type">String</span></span>)</span></span><br><span class="line"><span class="class"><span class="title">val</span> <span class="title">s</span> </span>= <span class="type">Schema</span>.<span class="type">AVRO</span>(<span class="type">Foo</span>.getClass)</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root</span><br><span class="line">|-- i: integer (nullable = false)</span><br><span class="line">|-- f: float (nullable = false)</span><br><span class="line">|-- bar: struct (nullable = true)</span><br><span class="line">|    |-- b: boolean (nullable = false)</span><br><span class="line">|    |-- s: string (nullable = false)</span><br><span class="line">|-- __key: binary (nullable = true)</span><br><span class="line">|-- __topic: string (nullable = true)</span><br><span class="line">|-- __messageId: binary (nullable = true)</span><br><span class="line">|-- __publishTime: timestamp (nullable = true)</span><br><span class="line">|-- __eventTime: timestamp (nullable = true)</span><br></pre></td></tr></table></figure><ul><li>Pulsar Source<br>有了 Schema ，就可以把它作为一个 source：</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">StreamExecutionEnvironment see = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">Properties props = <span class="keyword">new</span> Properties();</span><br><span class="line">props.setProperty(<span class="string">"topic"</span>,<span class="string">"test-source-topic"</span>);</span><br><span class="line">props.setProperty(<span class="string">"partitiondiscoveryintervalmillis"</span>,<span class="string">"5000"</span>);</span><br><span class="line"></span><br><span class="line">FlinkPulsarSource&lt;String&gt; source =</span><br><span class="line"><span class="keyword">new</span> FlinkPulsarSource&lt;&gt;(serviceUrl, adminUrl, <span class="keyword">new</span> SimpleStringSchema(), props);</span><br><span class="line"></span><br><span class="line"><span class="comment">// or setStartFromLatest, setStartFromSpecificOffsets, setStartFromSubscription</span></span><br><span class="line">source.setStartFromEarliest();</span><br><span class="line"></span><br><span class="line">DataStream&lt;String&gt; stream = see.addSource(source);</span><br><span class="line"></span><br><span class="line">see.execute();</span><br></pre></td></tr></table></figure><ul><li>Pulsar Sink<br>也可以把 Flink 计算的结果返回给 Pulsar：</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">FlinkPulsarSink&lt;Person&gt; sink = <span class="keyword">new</span> FlinkPulsarSink(</span><br><span class="line">serviceUrl,</span><br><span class="line">adminUrl,</span><br><span class="line">Optional.of(topic),</span><br><span class="line">props,</span><br><span class="line">TopicKeyExtractor.NULL,</span><br><span class="line">Person.class,</span><br><span class="line">RecordSchemaType.AVRO</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">stream.addSink(sink);</span><br></pre></td></tr></table></figure><ul><li>Metadata</li></ul><table><thead><tr><th>元数据</th><th>数据类型</th><th>描述</th><th>R/W</th></tr></thead><tbody><tr><td>topic</td><td>STRING NOT NULL</td><td>Pulsar 消息所在的 topic 名称</td><td>R ｜</td></tr><tr><td>messageId</td><td>BYTES NOT NULL</td><td>Pulsar 消息Id</td><td>R ｜</td></tr><tr><td>sequenceId</td><td>BIGINT NOT NULL</td><td>Pulsar 消息的序列号</td><td>R ｜</td></tr><tr><td>publishTime</td><td>TIMESTAMP(3) WITH TIME ZONE NOT NULL</td><td>Pulsar 消息的发布时间</td><td>R ｜</td></tr><tr><td>eventTime</td><td>TIMESTAMP(3) WITH TIME ZONE NOT NULL</td><td>Pulsar 消息的生成时间</td><td>R/W ｜</td></tr><tr><td>properties</td><td>Map&lt;STRING,STRING&gt; NOT NULL</td><td>Pulsar 消息的扩展信息</td><td>R/W ｜</td></tr></tbody></table><ul><li>Stream Tables<br>有了 source 和 sink 的支持，就自然能支持 table。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">StreamExecutionEnvironment see = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">see.setParallelism(<span class="number">1</span>);</span><br><span class="line">StreamTableEnvironment tEnv = StreamTableEnvironment.create(see);</span><br><span class="line"></span><br><span class="line">String topic  = <span class="string">""</span>;</span><br><span class="line">String topicName = <span class="string">"pulsarTable"</span>;</span><br><span class="line"></span><br><span class="line">TableSchame tSchema = TableSchame.builder().field(<span class="string">"value"</span>, DataTypes.BOOLEAN()).build();</span><br><span class="line"></span><br><span class="line">tEnv.connect(</span><br><span class="line"><span class="keyword">new</span> Pulsar()</span><br><span class="line">.urls(getServiceUrl(), getAdminUrl())</span><br><span class="line">.topic(topic)</span><br><span class="line">.setStartFromEarliest()</span><br><span class="line">.property(PulsarOptions.PARTITION_DISCOVERY_INTERVAL_MS_OPTION_KEY, <span class="string">"5000"</span>))</span><br><span class="line">     .withSchema(<span class="keyword">new</span> Schema().schema(tSchema))</span><br><span class="line">     .inAppendMode()</span><br><span class="line">     .createTemporaryTable(tableName);</span><br><span class="line"></span><br><span class="line">Table t = tEnv.sqlQuery(<span class="string">"select `value` from "</span> + tableName);</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> table_pulsar (</span><br><span class="line">...</span><br><span class="line">) <span class="keyword">WITH</span> (</span><br><span class="line"><span class="string">'connector'</span>=<span class="string">'pulsar'</span>,</span><br><span class="line"><span class="string">'topic'</span>=<span class="string">'persist://public/default/topic123'</span>,</span><br><span class="line"><span class="string">'key.format'</span>=<span class="string">'raw'</span>,</span><br><span class="line"><span class="string">'key.fields'</span>=<span class="string">'key'</span>,</span><br><span class="line"><span class="string">'value.format'</span>=<span class="string">'avro'</span>,</span><br><span class="line"><span class="string">'service-url'</span>=<span class="string">'pulsar://localhost:6650'</span>,</span><br><span class="line"><span class="string">'admin-url'</span>=<span class="string">'http://localhost:8080'</span>,</span><br><span class="line"><span class="string">'scan.startup.mode'</span>=<span class="string">'earliest'</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure><ul><li>Pulsar Catalog</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">catalog:</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">pulsarcatalog</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">pulsar</span></span><br><span class="line"><span class="attr">    default-database:</span> <span class="string">tn/ns</span></span><br><span class="line">    <span class="string">service.url:</span>  <span class="string">"pulsar://localhost:6650"</span></span><br><span class="line">    <span class="string">admin.url:</span> <span class="string">"http://localhost:8080"</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tableEnv.useCatalog(<span class="string">"pulsarcatalog"</span>);</span><br><span class="line">tableEnv.useDatabase<span class="string">"public/default"</span>);</span><br><span class="line">tableEnv.scan<span class="string">"topic0"</span>);</span><br></pre></td></tr></table></figure><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Flink SQL&gt; USE CATALOG pulsarcatalog;</span><br><span class="line">Flink SQL&gt; USE `public/default`;</span><br><span class="line">Flink SQL&gt; SELECT * FROM topic0;</span><br></pre></td></tr></table></figure><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="http://pulsar.apache.org/" target="_blank" rel="noopener">Pulsar 官网</a><br><a href="http://pulsar.apache.org/en/powered-by/" target="_blank" rel="noopener">Pulsar 社区</a><br><a href="https://segmentfault.com/a/1190000023087253" target="_blank" rel="noopener">Apache Pulsar 分层存储帮你省钱</a><br><a href="https://developer.aliyun.com/article/784282?spm=a2c6h.13148508.0.0.6dce4f0eQtZ5Kx" target="_blank" rel="noopener">Flink 和 Pulsar 的批流融合 文章</a><br><a href="https://www.bilibili.com/video/BV11X4y1P7PD?from=search&seid=4562849170423649332" target="_blank" rel="noopener">Flink 和 Pulsar 的批流融合 视频</a><br><a href="https://www.bilibili.com/video/BV12U4y1b7Tr?from=search&seid=4562849170423649332" target="_blank" rel="noopener">Apache Pulsar 在腾讯大数据场景下的落地实践 视频</a><br><a href="https://www.bilibili.com/video/BV1da4y1p7pv?from=search&seid=4562849170423649332" target="_blank" rel="noopener">Pulsar Summit Asia 2020 主题演讲：大融合：消息、流、存储三位一体（郭斯杰）</a><br><a href="https://www.bilibili.com/video/BV1HK4y1S7aF?from=search&seid=4562849170423649332" target="_blank" rel="noopener">Apache Pulsar 消息、流和存储的融合 视频</a><br><a href="https://mp.weixin.qq.com/s/N7JJYLv8p-dzgZfpkA1CEg" target="_blank" rel="noopener">RocketMQ 淘汰倒计时！这个新一代消息中间件，腾讯、华为都用疯了？</a><br><a href="https://mp.weixin.qq.com/s/84HsT9SFlBF7EZhiQBj-Rw" target="_blank" rel="noopener">为了处理日均TB级数据量，金山云选择用 Pulsar 实现日志服务</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;本文为 Apache Pulsar 的入门学习笔记。 &lt;/p&gt;
&lt;p&gt;企业在考虑部署实时消息系统时，总体硬件成本很重要的。Kafka 是基于磁盘存储数据的，存储成本较高。&lt;br&gt;而 Pulsar Broker 不直接存储数据，而是使用 Apache BookKeeper 来存储数据。数据发送/接收和存储的解耦使得 BookKeeper 可以在运行在独立的物理计算机或容器上。&lt;/p&gt;
&lt;p&gt;当新生事物出现有两种角度去观察它，要么把它看小，要么把它放大。对 Apache Pulsar，把它看小的角度通常是”Apache Pulsar 只是一个新的消息队列而已”，或者“Apache Pulsar 只是一个新的数据管道而已”，“队列系统早就有了，只是 Apache Pulsar 更具扩展性也能解决某些场景问题而已，基本没啥本质区别”。很明显上述认识都不对，Apache Pulsar 在消息、流、数据管理和技术基础设施层面都有技术演进，详看正文。&lt;/p&gt;
    
    </summary>
    
      <category term="MQ" scheme="http://yoursite.com/categories/MQ/"/>
    
      <category term="Pulsar" scheme="http://yoursite.com/categories/MQ/Pulsar/"/>
    
    
  </entry>
  
  <entry>
    <title>Mac单机安装Apache Pulsar</title>
    <link href="http://yoursite.com/2021/05/25/Mac%E5%8D%95%E6%9C%BA%E5%AE%89%E8%A3%85Apache-Pulsar/"/>
    <id>http://yoursite.com/2021/05/25/Mac单机安装Apache-Pulsar/</id>
    <published>2021-05-25T05:09:47.000Z</published>
    <updated>2021-06-14T12:16:47.602Z</updated>
    
    <content type="html"><![CDATA[<p>本文记录一下 Mac 本机安装 Pulsar 的过程。单机安装 Pulsar， ZooKeeper 和 BookKeeper 会和 Pulsar 运行在同一个 JVM 进程中。</p><a id="more"></a><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p>Mac：10.15.7<br>JDK：1.8.0_151<br>Pulsar：2.7.2</p><h2 id="本机单机安装-Pulsar"><a href="#本机单机安装-Pulsar" class="headerlink" title="本机单机安装 Pulsar"></a>本机单机安装 Pulsar</h2><h3 id="下载并解压"><a href="#下载并解压" class="headerlink" title="下载并解压"></a>下载并解压</h3><p>从官网下载解压到某个目录下：</p><ul><li>bin：pulsar 的命令行</li><li>conf：pulsar 的配置文件，包括 broker、 ZooKeeper 的配置文件等</li><li>examples：pulsar functions 示例 jar 包</li><li>lib：pulsar 的依赖包目录</li><li>license：license 文件</li></ul><p>并在 /etc/profile 设置环境变量：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export PULSAR_HOME=/usr/local/pulsar</span><br><span class="line">export PATH=$PATH:$PULSAR_HOME/bin</span><br></pre></td></tr></table></figure><p>使环境变量生效：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure><h3 id="修改-Pulsar-配置"><a href="#修改-Pulsar-配置" class="headerlink" title="修改 Pulsar 配置"></a>修改 Pulsar 配置</h3><h4 id="修改-pulsar-env-sh-文件"><a href="#修改-pulsar-env-sh-文件" class="headerlink" title="修改 pulsar_env.sh 文件"></a>修改 pulsar_env.sh 文件</h4><p>默认的 JVM 内存为 2G，可以通过更改配置项：<code>PULSAR_MEM</code> </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Extra options to be passed to the jvm</span></span><br><span class="line">PULSAR_MEM=<span class="variable">$&#123;PULSAR_MEM:-"-Xms2g -Xmx2g -XX:MaxDirectMemorySize=4g"&#125;</span></span><br></pre></td></tr></table></figure><h3 id="安装内置-Connectors"><a href="#安装内置-Connectors" class="headerlink" title="安装内置 Connectors"></a>安装内置 Connectors</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> <span class="variable">$PULSAR_HOME</span></span><br><span class="line"></span><br><span class="line">mkdir connectors</span><br><span class="line"></span><br><span class="line">mv pulsar-io-aerospike-2.7.2.nar <span class="variable">$PULSAR_HOME</span>/connectors</span><br></pre></td></tr></table></figure><h3 id="安装-tiered-storage-offloaders"><a href="#安装-tiered-storage-offloaders" class="headerlink" title="安装 tiered storage offloaders"></a>安装 tiered storage offloaders</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> <span class="variable">$PULSAR_HOME</span></span><br><span class="line"></span><br><span class="line">mkdir offloaders</span><br><span class="line"></span><br><span class="line">tar xvfz apache-pulsar-offloaders-2.7.2-bin.tar.gz</span><br><span class="line"></span><br><span class="line">mv apache-pulsar-offloaders-2.7.2/offloaders <span class="variable">$PULSAR_HOME</span>/offloaders</span><br></pre></td></tr></table></figure><h3 id="启动-pulsar-服务"><a href="#启动-pulsar-服务" class="headerlink" title="启动 pulsar 服务"></a>启动 pulsar 服务</h3><p>前台 standalone 启动 pulsar：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$PULSAR_HOME</span>/bin/pulsar standalone</span><br></pre></td></tr></table></figure><p>后台 standalone 启动 pulsar：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$PULSAR_HOME</span>/bin/pulsar-daemon start standalone</span><br></pre></td></tr></table></figure><p>运行 pulsar 之后会在 pulsar 安装目录下生成以下 3 个目录：</p><ul><li>data： ZooKeeper 和 BookKeeper 的数据存储目录</li><li>instances： pulsar functions 生成的实例</li><li>logs： 安装启动日志文件目录</li></ul><h3 id="使用-pulsar-客户端"><a href="#使用-pulsar-客户端" class="headerlink" title="使用 pulsar 客户端"></a>使用 pulsar 客户端</h3><h4 id="消费数据"><a href="#消费数据" class="headerlink" title="消费数据"></a>消费数据</h4><ul><li>消费 pulsar 数据命令行，topic 名称为 my-topic，订阅名称为 first-subscription：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$PULSAR_HOME</span>/bin/pulsar-client consume my-topic -s <span class="string">"first-subscription"</span></span><br><span class="line"></span><br><span class="line">18:43:27.492 [pulsar-client-io-1-1] INFO  org.apache.pulsar.client.impl.ConsumerImpl - [my-topic][first-subscription] Subscribing to topic on cnx [id: 0xb385e78b, L:/127.0.0.1:58963 - R:localhost/127.0.0.1:6650], consumerId 0</span><br></pre></td></tr></table></figure><h4 id="生产数据"><a href="#生产数据" class="headerlink" title="生产数据"></a>生产数据</h4><ul><li>向 my-topic 中生产一条数据为 “hello-pulsar”：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$PULSAR_HOME</span>/bin/pulsar-client produce my-topic --messages <span class="string">"hello-pulsar"</span></span><br><span class="line"></span><br><span class="line">18:43:53.354 [main] INFO  org.apache.pulsar.client.cli.PulsarClientTool - 1 messages successfully produced</span><br></pre></td></tr></table></figure><p>此时，pulsar consume 命令窗口会消费到数据：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">----- got message -----</span><br><span class="line">key:[null], properties:[], content:hello-pulsar</span><br></pre></td></tr></table></figure><h3 id="关闭-pulsar-服务"><a href="#关闭-pulsar-服务" class="headerlink" title="关闭 pulsar 服务"></a>关闭 pulsar 服务</h3><p>前台 standalone 启动的 pulsar：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Ctrl + C</span><br></pre></td></tr></table></figure><p>后台 standalone 启动的 pulsar：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$PULSAR_HOME</span>/bin/pulsar-daemon stop standalone</span><br></pre></td></tr></table></figure><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="http://pulsar.apache.org/" target="_blank" rel="noopener">Pulsar 官网</a><br><a href="https://www.jianshu.com/p/728d07918f49?utm_campaign=maleskine&utm_content=note&utm_medium=seo_notes&utm_source=recommendation" target="_blank" rel="noopener">Pulsar-安装部署 简书</a><br><a href="https://archive.apache.org/dist/pulsar/" target="_blank" rel="noopener">Pulsar 安装包下载地址</a><br><a href="https://archive.apache.org/dist/pulsar/pulsar-2.7.2/connectors/" target="_blank" rel="noopener">Pulsar-2.7.2 Connectors 安装包下载地址</a><br><a href="https://archive.apache.org/dist/pulsar/pulsar-2.7.2/" target="_blank" rel="noopener">Pulsar-2.7.2 tiered storage offloaders 安装包下载地址</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;本文记录一下 Mac 本机安装 Pulsar 的过程。单机安装 Pulsar， ZooKeeper 和 BookKeeper 会和 Pulsar 运行在同一个 JVM 进程中。&lt;/p&gt;
    
    </summary>
    
      <category term="MQ" scheme="http://yoursite.com/categories/MQ/"/>
    
      <category term="Pulsar" scheme="http://yoursite.com/categories/MQ/Pulsar/"/>
    
    
  </entry>
  
  <entry>
    <title>Hologres</title>
    <link href="http://yoursite.com/2021/05/25/Hologres/"/>
    <id>http://yoursite.com/2021/05/25/Hologres/</id>
    <published>2021-05-25T04:56:14.000Z</published>
    <updated>2021-06-09T18:37:17.964Z</updated>
    
    <content type="html"><![CDATA[<div id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <div class="hbe-input-container">  <input type="password" id="hbePass" placeholder="" />    <label for="hbePass">Hey, password is required here.</label>    <div class="bottom-line"></div>  </div>  <script id="hbeData" type="hbeData" data-hmacdigest="6d6d7b14a4649e5354ce73346a0232a70b189e00e9a1c47cde82ee091a6eae06">49f7eb9bea6cd6a47e660ee8aad95e5f73cac4e1b520f2f05987d67f416cec10d8c2add8935a4ae2fb7082d916f36e1d3b1ed1fb7bcc4a12e137188f59446abb2793b486bccbe4623c71e641069af1d03b6d7448688f68fd44135d03359ccd28f09c7d65ba42a4d058f4476b96d7f174862b5dc8cec10b8e87ab53a12373a7741c79476ae3c1fd3c456dad1afb3ec00c8777d5797b087436a5537340778a18315f36208c648a0cae72ad59853f82248d9e473db4ca18a536804bb210390995b7043036537b0454d8fad45a3641d00f66a542cea104544daebc48572cf799db379a2580f829a171227e4d9967ed65224ff9f797b18f794c37f4bc6af45bcba76401af3e932c5441d6ea6a548c81198973257ce16d90c9f98f76aaebfb07db5685</script></div><script src="/lib/blog-encrypt.js"></script><link href="/css/blog-encrypt.css" rel="stylesheet" type="text/css">]]></content>
    
    <summary type="html">
    
      Here&#39;s something encrypted, password is required to continue reading.
    
    </summary>
    
      <category term="OLAP" scheme="http://yoursite.com/categories/OLAP/"/>
    
      <category term="Hologres" scheme="http://yoursite.com/categories/OLAP/Hologres/"/>
    
    
  </entry>
  
  <entry>
    <title>关于大数据发展趋势的思考与总结</title>
    <link href="http://yoursite.com/2021/05/24/%E5%85%B3%E4%BA%8E%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%8F%91%E5%B1%95%E8%B6%8B%E5%8A%BF%E7%9A%84%E6%80%9D%E8%80%83%E4%B8%8E%E6%80%BB%E7%BB%93/"/>
    <id>http://yoursite.com/2021/05/24/关于大数据发展趋势的思考与总结/</id>
    <published>2021-05-24T07:30:57.000Z</published>
    <updated>2021-06-06T17:05:37.972Z</updated>
    
    <content type="html"><![CDATA[<p>现代企业的大数据平台大多是基于 Hadoop 构建的”一存多算”的多元化架构，以 HDFS 为统一存储，通过 Spark、HBase、Flink、Presto 等多种计算引擎满足不同场景的处理需求。<br>如今，高弹性和可扩展的计算与存储俨然已经非常成熟了，未来云原生、一体化将是大数据的技术发展趋势，并且依附于小程序IoT等业务载体，以 Saas 带动 IaaS 必将成为大势所趋。</p><a id="more"></a><h2 id="云原生"><a href="#云原生" class="headerlink" title="云原生"></a>云原生</h2><p>上云已经成为企业数字化的共识，上云之后如何用好云是当前大家的重点讨论和思考，如果仍然按照过去线下机房的模式去部署和使用大数据，不仅无法获得云计算的红利，甚至在成本效率上可能面临诸多不适。所以，以”存储计算分离+弹性Serverless”为代表的云原生大数据架构，实现存储的计算伸缩、资源弹性按需使用，大幅提升资源利用率、系统运维灵活性，成为接下来的主要趋势。在阿里云平台，以 Lindorm (兼容HDFS、HBase等多摸的 Serverless 存储) + DLA (提供 Spark、Presto等多模态的 Serverless 计算)向企业提供了云原生的大数据最佳实践。</p><h2 id="一体化"><a href="#一体化" class="headerlink" title="一体化"></a>一体化</h2><p>开源大数据技术在经过十多年的快速发展，在采集、存储、计算、调度、管理等各个方面的整体版图已经相当完善，同时面向各个场景的存储计算引擎也呈现百花齐放的景象，但这也加大了用户的使用门槛和维护复杂度，多种系统的一体化也越来越成为下一个大的发展趋势，比如多种模型数据库的一体化、大数据与数据库的一体化、批计算与流计算的一体化、数据湖与数据仓库的一体化等，这些技术上的整合，可以帮助企业更加经济高效的用好数据。</p><ul><li><p>结果的批流一体<br>用户不需要关心批或者流，在用户提交查询的时候得到的结果就是截止那一刻的统计结果。</p></li><li><p>存储的批流一体：统计场景<br>如 Hologres<br>高性能的实时/批量 append 和 update 的能力，读写互不影响，比如目前比较火的数据湖的概念<br>增量订阅读取、批量读取的能力，类似 Apache Pulsar<br>和 OLAP 引擎（impala、presto、clickhouse）对接的能力，列式存储具备较强 SCAN 和 filter 的能力</p></li><li><p>计算引擎的批流一体<br>一套代码搞定批流统计场景，降低开发运维成本</p></li></ul><h2 id="SaaS-带动-IaaS"><a href="#SaaS-带动-IaaS" class="headerlink" title="SaaS 带动 IaaS"></a>SaaS 带动 IaaS</h2><p>与美国相比，中国的云计算市场是”本末倒置”的。美国是以 SaaS 为主，中国现在还是以 IaaS 为主，处于大建数据中心阶段。</p><p>但数据中心里躺着的那些服务器是需要用户买单的，而 SaaS 应用是消耗这些服务器的不二法门。用 SaaS 带动 IaaS，是主流云厂商非常重要的竞争策略。阿里云力推的”云钉一体”就是一个典型案例，可以预见，腾讯云、华为云都将走这一条路。</p><p>要有足够繁荣的生态，才能消耗那些躺在数据中心里的上百万台云服务器。不然，服务器利用率上不去，盲目上规模无异于自杀。</p><p>虽然业内对阿里云+钉钉、腾讯云+企业微信的组合介绍已经很多了，但他们的手里还有第二张王牌。支付宝是阿里云手里的第二张王牌，微信是腾讯云手里的第二张王牌。</p><p>在 PC 时代，大一点的企业以及政府、学校等机构都有一个官方网站，是这些机构对外进行品牌展示、办理业务的窗口。在移动互联网时代，手机替换了电脑。人们越来越多用手机来了解信息和办理业务，网页端的官方网站日渐式微。</p><p>随着 5G 网络的建设普及，小程序将成为 PC 时代”官网”一样的存在。并且，小程序的互动性、及时性会更强。大量的企业和政府单位，将通过小程序的方式来进行信息传递、业务办理，并与用户进行直接、实时的沟通。</p><p>一旦小程序更多地承载业务场景，那其承载的信息流和业务流将出现指数级增长，这需要消耗大量的计算、网络资源，也将成为消耗云计算的关键渠道。</p><p>届时，得小程序者得云计算天下。</p><p>谁会是小程序的赢家，第一是微信，第二是支付宝。百度、华为、字节跳动都得靠边站，UCloud、青云这些云计算小巨头更没戏，而支付宝将成为政府服务的主要渠道，越来越多的政府事务将会可以通过支付宝办理。</p><p>通过手机办理政府业务，将成为大势所趋。并且，没必要每个政府部门都开发一款 App。比如个人所得税 APP，一年也就用一两次。像这类应用，本身业务场景不复杂，通过小程序来实现完全可以。随着 5G 网络的成熟，小程序的流畅度会进一步提升，能够承载的业务场景也会更多。</p><p>支付宝很可能会垄断政府对外业务，随之而来的，阿里云则可能会垄断政务云市场。政府不仅要关注内部系统，更重要的是要与公民进行交互，而这需要一个国民级的 APP 来进行承载。<br>这个国民级 APP，主要是支付宝，其次是微信。</p><p>前端通过支付宝来作为政府服务窗口，后端通过阿里云承载政务云系统，并且实现不同政府部门业务系统和数据的打通，将是未来的发展趋势。因此，阿里云在政务云的市场份额会进一步扩大，这对 UCloud 这样的小巨头而言不是个好消息。</p><p>另一方面，微信小程序的发展空间则更大，并且不局限于政务领域。将来，大部分企业对外服务的主阵地都将由官网转移到微信小程序上。与之配套的，腾讯云很可能会成为最大的赢家。</p><p>以这个角度来看，阿里云可以通过钉钉+支付宝来构建应用生态，腾讯云可以借助微信+企业微信来构建应用生态，以 SaaS 带动 IaaS 消耗。这是横跨C端和B端的顶级巨头玩法，UCloud完全没有可能建立这样的生态系统。未来，UCloud面临阿里云、腾讯云的生态战压力会越来越大。</p><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://www.infoq.cn/article/0vipwxcltrcc85xojnxe" target="_blank" rel="noopener">阿里为什么要做多模数据库？</a><br><a href="http://www.woshipm.com/it/2795621.html" target="_blank" rel="noopener">小程序生态之路：阿里向左，腾讯向右 – 行业深度战略分析报告</a><br><a href="https://mp.weixin.qq.com/s/1sn6zkNUa7lkR4H_Cij0yw" target="_blank" rel="noopener">UCloud，创业公司死磕公有云的悲壮</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;现代企业的大数据平台大多是基于 Hadoop 构建的”一存多算”的多元化架构，以 HDFS 为统一存储，通过 Spark、HBase、Flink、Presto 等多种计算引擎满足不同场景的处理需求。&lt;br&gt;如今，高弹性和可扩展的计算与存储俨然已经非常成熟了，未来云原生、一体化将是大数据的技术发展趋势，并且依附于小程序IoT等业务载体，以 Saas 带动 IaaS 必将成为大势所趋。&lt;/p&gt;
    
    </summary>
    
      <category term="思考总结" scheme="http://yoursite.com/categories/%E6%80%9D%E8%80%83%E6%80%BB%E7%BB%93/"/>
    
    
  </entry>
  
  <entry>
    <title>Presto技术内幕</title>
    <link href="http://yoursite.com/2021/03/04/Presto%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95/"/>
    <id>http://yoursite.com/2021/03/04/Presto技术内幕/</id>
    <published>2021-03-03T17:18:43.000Z</published>
    <updated>2021-06-14T12:03:46.022Z</updated>
    
    <content type="html"><![CDATA[<div id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <div class="hbe-input-container">  <input type="password" id="hbePass" placeholder="" />    <label for="hbePass">Hey, password is required here.</label>    <div class="bottom-line"></div>  </div>  <script id="hbeData" type="hbeData" data-hmacdigest="42deb763f239dd8df9f2339ff653c170bb58b531ec6dd5de8597ce3580d3e56d">843055208f22868ddd45c42da67b5455f4e407510ece7e4a5c1116e1b3af88df21c25ed2e6ade1cbc16bd5688aae665ad1744a4431b068531ff0d1a5febbf6f54a61eb8ba36d4ca121942564b40f7d029cd5913c922a83b991a55783fc5adb89fa680cb2785c3cd8f337d440060f67477de4d798073c3654a178a5ab644732bce773bede502af0ada5fafd79dc44288a1b32952a2d7672b60e290b7f7886261641532f85c409a83af6bbb320db5ffa0e531c0b457a0e298a25ba6cabc9643b41017de42dcd7ede61d25a347bea2ab8985b091d453ec6e5bcf14836d49d35c0ba38f057349e28059fdcd539983e0e7e8449da6d042d41d3d330668549c14dc533bb0d4065b2080fa2b56017afbf639c0b5b67b5a802b3d89c69594254a96988888b2df470b6b7413d321a34a0a9eac02ac0e171906a6bae6bff59b842ade239a23e3eb66fc78061d4e72a41bc1349dd29341d2f544ed31c549ad18237a824a58efe07b6d748f87337be94beb05c32a624865e56b18fb13856e5f849738937fa90028b7e16c81156ab50738e28fcd851b17796a7043ab820016715cd8b52c06581a66e734c4f8d05ceccb6f0b2b4893a66199da5ac756dfa170ce3cf907a728883000fee8e7da41e60c48d96cdb514aeb15343405dab951d70d9bd583fd03ea018e10754bf239e5739a2de20d726aeab23da8912507471cc8bfb03d73b0aa7560d93730194598f82206a0b4e2ded6ba9fa8d72f1f3f94fc55a4380111e957eeb4b612acf6d7f0438bc9a28ac1cf393791353c9f234a8edd61216840c99f5b94e254d730a0fc0e381ac2365e4ead1d8f1e260906eb5fa785a25ebf6a4521f313739f8dc3cc68c84ecc7f91d7f7f6eb05bce6a7cf2cc14a807f36ee29522c6ea4c861714af2b929afa1dab38311bc3a0ab2f833f67ddcd97a9b86473798d94119e6b0b74e7ed7cfecb4acacb1f9c02d0b6ba78f541dfc86a8de200a2229684b998cd4679c9e4d7d61a8cd50a13ce93f0d7cca4bc6d0e1104ecdd1c14f33bcd395371efa07718b6bd6995ea9ad8d4dab28e0b9426059e1c71bd492fabe2370d49340c94ca25fc7b2cd44e14ff10e8de3a343676fcc114e49960133006bdad7bb0f494adb7909cf41e97b670c585faca9085dffa3ac99fccbdd09b7dd34492786679ec7d365fcaba82efe8c8c5858e6e49a6cff1e6f81ecf4b1a9c164d168d77069d3212ba73749decb599ec1ee1e2242e989c29fc45f3917ff360070aa624612e9575b5194b1c228d2f6a1701a01502e2e7c197da193719a7baa56e482564086a182804f2fdb5c52dc025ca92f7c767c1c8cdf15678a8bde8bad5ecee20bc417dbf76b34e3d17befed33782b1fe664dc4cc96fd01a20157aaec6723d1288a8289e0daf03ec7e2c16921fd6526b16652953d87cc9774058a77af1a41b060caf55ccff8bd57d7b5d2efce1cef635fef1bdeb5479373a1fa1b4a5374039b225e5a0a8e2e7c821ae98f914dfcbca6f656db5265137b2ce34156fcdaa2890da197a379c90027acc3ec979e23aed67dee24a4fafd07fa9c88f5b05da7b58927451238cc6825e184784465862a8cda55c9c5b45d8daa3787029edccca6058df11f834d6462c95969456f01b6e1ce32d812ef37da0caa6510a79202f589ddf04a2d574071c29aa4b74e5049db5640b0738e618158b8685ca5f57f0e2e891006b7ffbc28ae1ef98a16d2bd3350bb4a8d8b68041f87dc622a16c53cb9b273cf2bdfe1b8fb54df24407a3ad8aec654df414789b19d170eca413605f685a2f61be0fa29c8c77b7a98beaa000d6723095c229086c4b4c4d211ceadadd4d4bf0febf9d1f0f2f9f12ad52601eda5a12b9e7a2d83bcd265ebfb204192a36a2780ffaf11c7198c81b73085701af2f04ca63645e3cc198d99a883df7e6398685d6ab06eefa6f2d5ecc4dd06b05fe95433e27409134906facabdf4e98945910053d5c61d7b020662a58e4ffc8b1ccb0ac5fd50ff2f99db167695e8e15b1ae7cc74f360570849473ef5cd0b5080e5a3e7929c286ce8636c4c71ad5eb09ed3911d87f9355aba5802a3a58745c7d9ce8dba6d89826f8c1c85d3add7f7cb369d904882f08428dc8d2bc10bb6e8542be126f82c07357a770bb90e8b2c545ce6d1189e04d75e6d1bfd070d31b5b42720aeb194b4c710ed5f28957f6aeaeb0a76529941cdc3f2db08a9905ca57b33d6b167a63315dd95a9a95e7d64b424aa771e6f5030d5fec36a178bbf5704dd82b8a523413e2cedf77e1789ecb6aacbc5af4b6cc1dbdce40e2bd37aa42b1bbc8aa408b4cde448562d071c0a343b34bfb2c1e1aa6acda490c5b16f59e7003f4bd9f73e245247503fab4e0869704bee725984fa8e40d35cc79fe08f05eb963749ce5043f6f3a77cd21f5459d14bfbb3a34b88d9a023e97afafceefb2d9d4474ba5cbcd2c74640b60b5f7c2242361501df36a9b3a1bd2362e020b5d89cf11a6d2c7dbd9477a16c775f15e388e8bcb955020f9776a4be813db14f902bb1bfdc3c1f45c5ee0bcba38413c640e4cd330c7c0848dcedd0febcd9fd77d2e0179cfa933cdb5a7961277764aafa4497ea23a2f1b9e1cb8d203c06b063d2fcdee4c7d8f8c0788e7a77cf3a47bfa50edc3746138b1ef1ce20c02f0a33a68d1a6c2183aba72035e25f5f447af68c81bb6f1c5168f6c5f5af98d0259e311dc896e2cb4924ae17347742686af8815c149bf35da6082da5ef31476e4defbccabf85dab2b23ac3c41f8d7103df28f4b138f83544b05c07feb87513562f8893854644291b22862c95a9d7477a13163904ab7b5623ec40f77e9609ccf6e2ae80bf99d757215075b1cfae02cb4efbbead9ef7167dbc670bb74bb4576e6d8c32437c96fc5bfcf2a73941b185c934acb15c55b803d2631c9a005ba203871f56718d64d60ffe093e5d9ba214295e638010044aa8013c2ef8cda287ee04bd194bbf25509f6193e3cfd418472b9851201e5ed60887e660e85342925b57802eda429dcc4c0403356f784d5b80112082475f8a6469c0757318a5d6d320c757a63b2c62b42d1f022b50d0d9ee79c777f534df9c1ba15f001c1e88fd01d4d52a438b78796f15598c6a55fe743f45cc8ea09d2a260bdee81136207c5ec2faab333d9579d0002520d433b761991f8c97f86f0e454ad48e9445f1fd2a77c3caefc585b275eb05fd21ec32ed244305242de019e8c08d39f86cd5422f7326e225a6fa41c6311f2a8018f3ff40eeafa13452dec34f261164f79536a07cc4eaf22664009da334028ad648897bd16009753142170a839f3d31720470bbf3bedd8cc7d225a4eb6ac855ec45f0b68b6c87442f8d636230f1d70ca15e7803058bb0ab6378ac3b079352689ad2287d94f88663a5eb55fa0dde1eff21f83aaabbbb86ea1d845762e9b4bc3c1de93be328fdc5ba412cbe775dc514a02e305ecc7259fda1520f72a785f56b5774d14f4a1672134639fd73263a2adee4af9910be06ccaaf7022a8092d9d0bc897006f5b76267a89ec402b438259039ce65a77ad239a8552216b0dcf7e18f9fbaf4b5ed2a4dc3135ce669eb4dd75203a19294ddd584258e732c401204ac1e1b22dc65470298981582c190ea9beddbe554d7b998944d730ec959395b13ed307b84bd5861facb1c8be9bff13425268a681de4aa01321f82a8b66f3ee8</script></div><script src="/lib/blog-encrypt.js"></script><link href="/css/blog-encrypt.css" rel="stylesheet" type="text/css">]]></content>
    
    <summary type="html">
    
      Here&#39;s something encrypted, password is required to continue reading.
    
    </summary>
    
      <category term="OLAP" scheme="http://yoursite.com/categories/OLAP/"/>
    
      <category term="Presto" scheme="http://yoursite.com/categories/OLAP/Presto/"/>
    
    
  </entry>
  
  <entry>
    <title>初识Presto(Trino)</title>
    <link href="http://yoursite.com/2021/03/04/%E5%88%9D%E8%AF%86Presto(Trino)/"/>
    <id>http://yoursite.com/2021/03/04/初识Presto(Trino)/</id>
    <published>2021-03-03T17:17:43.000Z</published>
    <updated>2021-06-07T16:25:34.039Z</updated>
    
    <content type="html"><![CDATA[<p>  本文为 Presto 的入门学习笔记。 Presto 是一个开源的分布式 SQL 查询引擎，它是为了高效查询不同系统和各种规模的数据源而从头开始设计和编写的一套系统。<br>  由于开源纷争，Presto 现已更名为 Trino。</p><a id="more"></a><h2 id="Presto-简介"><a href="#Presto-简介" class="headerlink" title="Presto 简介"></a>Presto 简介</h2><h3 id="背景及发展"><a href="#背景及发展" class="headerlink" title="背景及发展"></a>背景及发展</h3><p>Hadoop 提供的大数据解决方案使用的是 MR 计算框架，这种计算框架适用于大数据的离线和批量计算，因为该计算框架强调的是吞吐率而不是计算效率，所以其不能满足大数据快速实时 Ad-Hoc 查询计算的性能要求。</p><p>因此，开源社区和各大互联网公司纷纷进行大数据实时 Ad-Hoc 查询计算产品的研发 ， Facebook 于2012年秋季开始开发 Presto，目前该产品已经在超过 1000 名 Facebook 雇员中使用，每天运行超过 30000 个查询，每日查询数据量在 1PB 级别。Facebook 称 Presto 的性能比 Hive 要好上 10 倍还多，2013年 Facebook 正式宣布开源 Presto。</p><h3 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h3><ul><li><p>多数据源<br>目前 Presto 可以支持 Mysql、PostgreSql、Cassandra、Hive、Kafka、JMX、Iceberg 等多种 Connector，并且可以支持分库分表以及快速读取的功能。</p></li><li><p>支持 SQL<br>Presto 已经可以完全支持 ANSI SQL，并提供了一个 SQL Shell 给用户，用户可以直接使用 ANSI SQL 进行数据查询和计算。</p></li><li><p>扩展性<br>开发人员可以很容易的开发出适用于自己特定数据源的 Connector，并且可以使用 SQL 语句查询和分析自定义 Connector 中的数据。</p></li><li><p>混合计算<br>每种类型的数据源都对应于一种特定类型的 Connector，用户可以根据业务需要在 Presto 中针对于一种类型的 Connector 配置一个或多个 Catalog 并查询其中的数据，用户可以混合多个 Catalog 进行 join 查询和计算。</p></li><li><p>高性能<br>经过 Facebook 和 京东商城的测试，Presto 的查询平均性能是 Hive 的10倍以上。</p></li><li><p>流水线<br>由于 Presto 是基于 pipeline 进行设计的，因此在进行海量数据处理的过程中，终端用户不用等到所有的数据都处理完毕才能看到结果，而是可以像自来水管道一样，一旦开始计算，就可以立即产生一部分结果数据，并且结果数据会一部分接一部分地呈现在终端客户面前。</p></li></ul><h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><h4 id="Presto-服务进程"><a href="#Presto-服务进程" class="headerlink" title="Presto 服务进程"></a>Presto 服务进程</h4><ul><li><p>Coordinator<br>Coordinator 服务进程部署于集群中一个单独的节点上，是整个 Presto 集群的管理节点。主要用于接收客户端提交的查询，查询语句解析，生成查询执行计划、Stage、Task，对生成的 Task 进行调度。<br>此外，Coordinator 还对集群中的所有 Worker 进行管理，是整个 Presto 集群的 Master 进程，该进程既与 Worker 进行通信从而获得最新的 Worker 信息，又与 Client 进行通信，从而接收查询请求。</p></li><li><p>Worker<br>在每个 Worker 节点上都存在一个 Worker 服务进程，主要进行数据的处理以及 Task 的执行。Worker 进程每隔一定的时间会向 Coordinator 上的 restful<br>服务发送心跳。当客户端提交一个查询时，Coordinator 则会从当前存活的 Worker 列表中选择出合适的 Worker 节点去运行 Task。Worker 在执行每个 Task 时会进一步对当前 Task 读入的每个 Split 进行一系列的操作和处理。</p></li></ul><h4 id="Presto-模型"><a href="#Presto-模型" class="headerlink" title="Presto 模型"></a>Presto 模型</h4><ul><li>Connector</li></ul><p>使 Presto 适配一个数据源，每一个 Catalog 对应于一个特定的连接器。</p><ul><li>Catalog</li></ul><p>定义连接到一个数据源的细节，它包含了 Schema 并配置了一个连接器来使用。</p><ul><li>Schema</li></ul><p>组织表的一种方式。Catalog 和 Schema 一起定义了一个集合的表，这些表可以查询。</p><ul><li>Table</li></ul><p>表是无序的行的集合。这些行内容被组织成带有数据类型的有名称的列。</p><h4 id="Presto-查询执行模型"><a href="#Presto-查询执行模型" class="headerlink" title="Presto 查询执行模型"></a>Presto 查询执行模型</h4><p>在 Presto 中一次查询执行会被分解为多个 Stage ，Stage 与 Stage 之间是有前后依赖关系的。每个 Stage 内部又会被分解为多个 Task，属于每个 Stage 的 Task 被均分在每个 Worker 上并行执行。在每个 Task 内部又会被分解为多个 Driver ，每个 Driver 负责处理一个 Split ，而且每个 Driver 由一系列前后相连的 Operator 组成，这里的每个 Operator 都代表针对于一个 Split 的操作。</p><ul><li><p>Statement<br>Statement 语句，指的是终端用户输入的用文字表示的 SQL 语句，由子句（Clause）、表达式（Expression）和断言（Predicate）组成。</p></li><li><p>Query<br>Query 即查询执行。当 Presto 接收一个 SQL 语句并执行时，会解析该 SQL 语句，将其转变成一个查询执行和相关的查询执行计划。一个查询执行代表可以在 Presto 集群中运行的查询，是由运行在各个 Worker 上且各自之间相互关联的阶段（Stage）组成的。<br>查询执行是为了完成 SQL 语句所表述的查询而实例化的配置信息、组件、查询执行计划和优化信息等。一个查询执行由 Stage、Task、Driver、Split、Operator 和 DataSource 组成，</p></li><li><p>Stage<br>Stage 即查询执行阶段。当 Presto 运行 Query 时，Presto 会将一个 Query 拆分成具有层级关系的多个 Stage，一个 Stage 就代表查询计划的一部分。</p></li><li><p>Exchange<br>Presto 的 Stage 是通过 Exchange 来连接另一个 Stage 的，Exchange 用于完成有上下游关系的 Stage 之间的数据交换。</p></li><li><p>Task<br>Stage 并不会在 Presto 集群中实际运行，仅代表针对于一个 SQL 语句查询执行计划中的一部分查询的执行过程，只是用来对查询执行计划进行管理和建模。Stage 在逻辑上又被分为一系列的 Task，这些 Task 则需要实际运行在 Presto 的各个 Worker 节点上。</p></li><li><p>Driver<br>一个 Task 包含一个或多个 Driver。一个 Driver 其实就是作用于一个 Split 的一系列 Operator 的集合。因此一个 Driver 用于处理一个 Split，并且生成相应的输出，这些输出由 Task 收集并传送给下游 Stage 中的一个 Task。一个 Driver 拥有一个输入和一个输出。</p></li><li><p>Operator<br>一个 Operator 代表一个 Split 的一种操作，例如过滤、加权、转换等。一个 Operator 依次读取一个 Split 中的数据，将 Operator 所代表的计算和操作作用于 Split 的数据上，并产生输出。每个 Operator 均会以 Page 为最小处理单位分别读取输入数据和产生输出数据。Operator 每次只会读取一个 Page 对象，相应地，每次也只会产生一个 Page 对象。</p></li><li><p>Split<br>Split 即分片。一个分片是一个大的数据集中的一个小的子集。而 Driver 则是作用于一个分片上的一系列操作的集合，而每个节点上运行的 Task，又包含多个 Driver，从而一个 Task 可以处理多个 Split。</p></li><li><p>Page<br>Page 是 Presto 中处理的最小数据单元。一个 Page 对象包含多个 Block 对象，每个 Block 对象是一个字节数组，存储一个字段的若干行。多个 Block 横切的一行是真实的一行数据。一个 Page 最大为 1MB ，最多 16 * 1024 行数据。</p></li></ul><h3 id="Presto-使用场景"><a href="#Presto-使用场景" class="headerlink" title="Presto 使用场景"></a>Presto 使用场景</h3><h4 id="单一的-SQL-分析访问点"><a href="#单一的-SQL-分析访问点" class="headerlink" title="单一的 SQL 分析访问点"></a>单一的 SQL 分析访问点</h4><p>作为一个消费者和分析师，你可能会遇到数不清的问题：</p><ul><li>有时你甚至不知道数据在哪儿，只有凭借公司某个部门的内部知识或者组织内多年的工作经验，你才能找到正确的数据。</li><li>为了查询多个数据库，你需要使用不同的连接和运行多种 SQL 方言的不同查询。这些查询看起来相似，行为上却不同。</li><li>若不使用数据仓库，就无法使用查询合并来自不同系统的数据。</li></ul><p>可以使用 Presto 对接这些数据库，使用一个 SQL 标准来查询所有的系统。所有的仪表盘和分析工具以及其他商业智能系统都可以指向一个系统 – Presto，并访问组织当中的所有数据。</p><h4 id="数据仓库和数据源系统的访问点"><a href="#数据仓库和数据源系统的访问点" class="headerlink" title="数据仓库和数据源系统的访问点"></a>数据仓库和数据源系统的访问点</h4><p>当一个组织需要更好的理解和分析存放在无数 RDBMS 中的数据时，就可以创建和维护数据仓库系统。从多个系统中抽取的数据通过一个复杂的 ETL 过程，最终进入一个严格受控的、巨大的数据仓库。</p><p>尽管数据仓库在很多情况下非常有用，但作为一个数据分析师，你会面临很多新问题：</p><ul><li>除了原来的那些数据库，你的工具和查询现在又多了一个数据接入点。</li><li>你今天就要用的数据还没放入数据仓库。加载数据的过程痛苦、昂贵又困难重重重。</li></ul><p>Presto 允许你添加任何数据仓库作为数据源，就像其他关系数据库一样。如果想深入研究数据仓库的查询，可以在 Presto 里直接完成，也可以在这里访问数据仓库及其源数据库系统，甚至可以编写将它们组合在一起查询。</p><h4 id="提供对任何内容的-SQL-访问"><a href="#提供对任何内容的-SQL-访问" class="headerlink" title="提供对任何内容的 SQL 访问"></a>提供对任何内容的 SQL 访问</h4><p>Presto 允许将所有支持的系统作为数据源进行连接。它使用标准的 ANSI SQL 和使用 SQL 的所有工具对外暴露要查询的数据。</p><h4 id="联邦查询"><a href="#联邦查询" class="headerlink" title="联邦查询"></a>联邦查询</h4><p>将所有的数据孤岛都暴露给 Presto 是向理解数据迈出的一大步。可以使用 SQL 和标准工具来联邦查询所有内容。 在一个语句中引用并使用不同数据库和模式的 SQL 查询，这些数据库和 Schema 来自于完全不同的系统。在同一条 SQL 查询中，可以查询 Presto 中可用的所有数据源。</p><h4 id="虚拟数据仓库的语义层"><a href="#虚拟数据仓库的语义层" class="headerlink" title="虚拟数据仓库的语义层"></a>虚拟数据仓库的语义层</h4><p>数据仓库系统为用户创造了巨大的价值，对组织来说确实一个负担。</p><ul><li>运行和维护数据仓库是一个巨大且昂贵的项目。</li><li>需要专门的团队运行与管理数据仓库和相关的 ETL 过程。</li><li>将数据导入数据仓库需要用户执行繁琐的操作，并且通常非常耗时。</li></ul><p>Presto 可用作虚拟仓库。使用这一工具和标准的 ANSI SQL ，就可以定义语义层。一旦所有的数据库都设置成 Presto 的数据源，就可以直接查询它们。Presto 提供了查询这些数据库所需的计算能力。使用 SQL 和 Presto 支持的函数和运算符，可以直接从数据源获得想要的数据。在使用数据进行分析之前，无需复制、移动或转换它们。</p><h4 id="数据湖查询引擎"><a href="#数据湖查询引擎" class="headerlink" title="数据湖查询引擎"></a>数据湖查询引擎</h4><p>在数据被存储到数据湖的存储系统时，并没有特别考虑接下来应该如何访问它们，Presto 可以使它们成为有用的数据仓库。现代数据湖通常使用 HDFS 以外的其他对象存储系统，这些系统来自云供应商或其他开源项目。 Presto 能使用 Hive 连接器连接它们，无论数据在哪里、如何存储，都可以在数据湖上使用基于 SQL 的数据分析。</p><h4 id="SQL-转换和-ETL"><a href="#SQL-转换和-ETL" class="headerlink" title="SQL 转换和 ETL"></a>SQL 转换和 ETL</h4><p>Presto 也可用于迁移数据，它所提供的丰富的 SQL 函数，可以查询数据，转换数据，并将数据写入同一个数据源或任何其他数据源。</p><h4 id="更快的响应带来更好的数据见解"><a href="#更快的响应带来更好的数据见解" class="headerlink" title="更快的响应带来更好的数据见解"></a>更快的响应带来更好的数据见解</h4><p>复杂的问题和海量数据集带来了诸多限制。将数据复制并加载到数据仓库并在其中分析它们的整个过程会过于昂贵。计算可能消耗太多的计算资源而无法处理全部数据，或者要消耗数天才能得到答案。</p><p>Presto 一开始就避免了数据复制。Presto 的并行计算和重度优化通常能为数据分析带来性能提升。</p><p>如果原来需要 3 天的查询现在只需要 15 分钟就可以完成，那么执行这个查询便是有价值的。从这些结果中获得的知识可以执行更多的查询。</p><h2 id="安装和配置-Presto"><a href="#安装和配置-Presto" class="headerlink" title="安装和配置 Presto"></a>安装和配置 Presto</h2><h3 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn -T2C install -DskipTests</span><br></pre></td></tr></table></figure><h3 id="服务端部署"><a href="#服务端部署" class="headerlink" title="服务端部署"></a>服务端部署</h3><ul><li>从编译后的源码中拷贝jar和配置文件</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mkdir /usr/<span class="built_in">local</span>/presto</span><br><span class="line"></span><br><span class="line">cp -r ～workspace/presto/presto-server/target/presto-server-0.255-SNAPSHOT /usr/<span class="built_in">local</span>/presto</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/presto/presto-server-0.255-SNAPSHOT</span><br><span class="line"></span><br><span class="line">cp ～workspace/presto/presto-server/target/presto-main/etc ./presto-server-0.255-SNAPSHOT/</span><br><span class="line"></span><br><span class="line">ln -s presto-server-0.255-SNAPSHOT server</span><br></pre></td></tr></table></figure><ul><li>设置环境变量</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/profile</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> PRESTO_SERVER_HOME=/usr/<span class="built_in">local</span>/presto/server</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$PRESTO_SERVER_HOME</span>/bin</span><br><span class="line"></span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure><ul><li>修改 config.properties</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">coordinator=true</span><br><span class="line">node-scheduler.include-coordinator=true</span><br><span class="line">http-server.http.port=8086</span><br><span class="line">discovery-server.enabled=true</span><br><span class="line">discovery.uri=http://localhost:8086</span><br></pre></td></tr></table></figure><ul><li>修改 node.properties</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">node.id=562e42e2-e874-431f-8da5-cb779744cf7c</span><br><span class="line">node.data-dir=/usr/local/presto/data</span><br><span class="line">catalog.config-dir=/usr/local/presto/server/etc/catalog</span><br><span class="line">plugin.dir=/usr/local/presto/server/plugin</span><br><span class="line">node.server-log-file=/usr/local/presto/server/var/log/server.log</span><br><span class="line">node.launcher-log-file=/usr/local/presto/server/var/log/launcher.log</span><br></pre></td></tr></table></figure><ul><li>修改 jvm.config</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">-server</span><br><span class="line">-Xmx4G</span><br><span class="line">-XX:-UseBiasedLocking</span><br><span class="line">-XX:+UseG1GC</span><br><span class="line">-XX:+ExplicitGCInvokesConcurrent</span><br><span class="line">-XX:+HeapDumpOnOutOfMemoryError</span><br><span class="line">-XX:+UseGCOverheadLimit</span><br><span class="line">-XX:+ExitOnOutOfMemoryError</span><br><span class="line">-XX:ReservedCodeCacheSize=512M</span><br></pre></td></tr></table></figure><ul><li>修改 log.properties</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com.facebook.presto=INFO</span><br></pre></td></tr></table></figure><ul><li>后台启动</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$PRESTO_SERVER_HOME</span>/bin/launcher start</span><br></pre></td></tr></table></figure><ul><li>前台启动</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$PRESTO_SERVER_HOME</span>/bin/launcher run</span><br></pre></td></tr></table></figure><p>[Presto Web UI] <code>http://localhost:8086/ui/)</code></p><p><img src="Presto%E6%9C%AC%E5%9C%B0%E5%90%AF%E5%8A%A8%E7%9A%84Web_UI.png" alt></p><h3 id="Presto-CLI"><a href="#Presto-CLI" class="headerlink" title="Presto CLI"></a>Presto CLI</h3><ul><li>从编译后的源码中拷贝jar</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/presto</span><br><span class="line"></span><br><span class="line">mkdir -p cli/lib</span><br><span class="line"></span><br><span class="line">cp ～workspace/presto/presto-cli/target/presto-cli-0.255-SNAPSHOT-executable.jar /usr/<span class="built_in">local</span>/presto/cli/lib</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/presto/cli/lib</span><br><span class="line"></span><br><span class="line">mv presto-cli-0.255-SNAPSHOT-executable.jar presto</span><br><span class="line"></span><br><span class="line">chmod +x presto</span><br></pre></td></tr></table></figure><ul><li>设置环境变量</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/profile</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> PRESTO_CLI_HOME=/usr/<span class="built_in">local</span>/presto/cli</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$PRESTO_CLI_HOME</span>/lib</span><br><span class="line"></span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure><ul><li>运行 cli 并查看其版本</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">presto --version</span><br><span class="line">Presto CLI 0.255-SNAPSHOT-9095346</span><br></pre></td></tr></table></figure><ul><li>启动 cli</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">presto --server localhost:8086</span><br></pre></td></tr></table></figure><ul><li>额外诊断，打印调试信息</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">presto --debug</span><br></pre></td></tr></table></figure><ul><li>执行查询</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">presto --server localhost:8086 --catalog tpch --schema sf1 --execute <span class="string">'select nationkey,name,regionkey from nation limit 5'</span></span><br><span class="line"><span class="string">"0"</span>,<span class="string">"ALGERIA"</span>,<span class="string">"0"</span></span><br><span class="line"><span class="string">"1"</span>,<span class="string">"ARGENTINA"</span>,<span class="string">"1"</span></span><br><span class="line"><span class="string">"2"</span>,<span class="string">"BRAZIL"</span>,<span class="string">"1"</span></span><br><span class="line"><span class="string">"3"</span>,<span class="string">"CANADA"</span>,<span class="string">"1"</span></span><br><span class="line"><span class="string">"4"</span>,<span class="string">"EGYPT"</span>,<span class="string">"4"</span></span><br></pre></td></tr></table></figure><h3 id="简单-SQL-语法"><a href="#简单-SQL-语法" class="headerlink" title="简单 SQL 语法"></a>简单 SQL 语法</h3><ul><li>查看 catalogs</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">presto&gt; show catalogs;</span><br><span class="line">  Catalog   </span><br><span class="line">------------</span><br><span class="line"> blackhole  </span><br><span class="line"> druid      </span><br><span class="line"> example    </span><br><span class="line"> hive       </span><br><span class="line"> jmx        </span><br><span class="line"> localfile  </span><br><span class="line"> memory     </span><br><span class="line"> mysql      </span><br><span class="line"> pinot      </span><br><span class="line"> postgresql </span><br><span class="line"> raptor     </span><br><span class="line"> sqlserver  </span><br><span class="line"> system     </span><br><span class="line"> tpcds      </span><br><span class="line"> tpch       </span><br><span class="line">(15 rows)</span><br><span class="line"></span><br><span class="line">Query 20210606_141818_00009_4qtix, FINISHED, 1 node</span><br><span class="line">Splits: 19 total, 19 <span class="keyword">done</span> (100.00%)</span><br><span class="line">0:00 [0 rows, 0B] [0 rows/s, 0B/s]</span><br></pre></td></tr></table></figure><ul><li>查看 tpch Connector 的 schemas</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">presto&gt; show schemas from tpch;</span><br><span class="line">       Schema       </span><br><span class="line">--------------------</span><br><span class="line"> information_schema </span><br><span class="line"> sf1                </span><br><span class="line"> sf100              </span><br><span class="line"> sf1000             </span><br><span class="line"> sf10000            </span><br><span class="line"> sf100000           </span><br><span class="line"> sf300              </span><br><span class="line"> sf3000             </span><br><span class="line"> sf30000            </span><br><span class="line"> tiny               </span><br><span class="line">(10 rows)</span><br><span class="line"></span><br><span class="line">Query 20210606_142008_00010_4qtix, FINISHED, 1 node</span><br><span class="line">Splits: 19 total, 19 <span class="keyword">done</span> (100.00%)</span><br><span class="line">0:00 [10 rows, 119B] [141 rows/s, 1.65KB/s]</span><br></pre></td></tr></table></figure><ul><li>查看 tpch.sf1 的 tables</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">presto&gt; show tables from tpch.sf1;</span><br><span class="line">  Table   </span><br><span class="line">----------</span><br><span class="line"> customer </span><br><span class="line"> lineitem </span><br><span class="line"> nation   </span><br><span class="line"> orders   </span><br><span class="line"> part     </span><br><span class="line"> partsupp </span><br><span class="line"> region   </span><br><span class="line"> supplier </span><br><span class="line">(8 rows)</span><br><span class="line"></span><br><span class="line">Query 20210606_142111_00011_4qtix, FINISHED, 1 node</span><br><span class="line">Splits: 19 total, 19 <span class="keyword">done</span> (100.00%)</span><br><span class="line">0:00 [8 rows, 158B] [85 rows/s, 1.66KB/s]</span><br></pre></td></tr></table></figure><ul><li>查看 tpch.sf1.nation 表中的实际数据</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">presto&gt; select count(name) from tpch.sf1.nation;</span><br><span class="line"> _col0 </span><br><span class="line">-------</span><br><span class="line">    25 </span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">Query 20210606_142214_00012_4qtix, FINISHED, 1 node</span><br><span class="line">Splits: 21 total, 21 <span class="keyword">done</span> (100.00%)</span><br><span class="line">0:00 [25 rows, 0B] [358 rows/s, 0B/s]</span><br></pre></td></tr></table></figure><ul><li>选择使用特定 schema</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">presto&gt; use tpch.sf1;</span><br><span class="line">USE</span><br></pre></td></tr></table></figure><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p>《Presto实战》<br>《Presto技术内幕》</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;  本文为 Presto 的入门学习笔记。 Presto 是一个开源的分布式 SQL 查询引擎，它是为了高效查询不同系统和各种规模的数据源而从头开始设计和编写的一套系统。&lt;br&gt;  由于开源纷争，Presto 现已更名为 Trino。&lt;/p&gt;
    
    </summary>
    
      <category term="OLAP" scheme="http://yoursite.com/categories/OLAP/"/>
    
      <category term="Presto" scheme="http://yoursite.com/categories/OLAP/Presto/"/>
    
    
  </entry>
  
  <entry>
    <title>2020年终个人总结</title>
    <link href="http://yoursite.com/2021/02/01/2020%E5%B9%B4%E7%BB%88%E4%B8%AA%E4%BA%BA%E6%80%BB%E7%BB%93/"/>
    <id>http://yoursite.com/2021/02/01/2020年终个人总结/</id>
    <published>2021-02-01T06:00:40.000Z</published>
    <updated>2021-05-24T06:03:41.127Z</updated>
    
    <content type="html"><![CDATA[<div id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <div class="hbe-input-container">  <input type="password" id="hbePass" placeholder="" />    <label for="hbePass">Hey, password is required here.</label>    <div class="bottom-line"></div>  </div>  <script id="hbeData" type="hbeData" data-hmacdigest="e8cb66f1889d332bb7f8280f899753257c5a0c67d437076bd79091327dff4dee">49f7eb9bea6cd6a47e660ee8aad95e5f339e339538ece7d1e61ba075caa7780d</script></div><script src="/lib/blog-encrypt.js"></script><link href="/css/blog-encrypt.css" rel="stylesheet" type="text/css">]]></content>
    
    <summary type="html">
    
      Here&#39;s something encrypted, password is required to continue reading.
    
    </summary>
    
      <category term="随笔" scheme="http://yoursite.com/categories/%E9%9A%8F%E7%AC%94/"/>
    
    
  </entry>
  
  <entry>
    <title>Apache Iceberg</title>
    <link href="http://yoursite.com/2021/01/20/Apache-Iceberg/"/>
    <id>http://yoursite.com/2021/01/20/Apache-Iceberg/</id>
    <published>2021-01-20T08:19:22.000Z</published>
    <updated>2021-06-03T17:41:27.756Z</updated>
    
    <content type="html"><![CDATA[<p>本文为 Apache Iceberg 的入门学习笔记。</p><a id="more"></a><h2 id="Apache-Iceberg-简介"><a href="#Apache-Iceberg-简介" class="headerlink" title="Apache Iceberg 简介"></a>Apache Iceberg 简介</h2><p>官网定义：</p><p>Apache Iceberg is an open table format for huge analytic datasets. Iceberg delivers high query performance for tables with tens of petabytes of data, along with atomic commits, concurrent writes, and SQL-compatible table evolution.</p><ul><li><p>在文件 Format（Parquet/Avro/Orc）之上实现 table 语义<br>支持定义和变更Schema<br>支持 Hidden partition 和 Partition 变更<br>ACID 语义<br>历史版本回溯</p></li><li><p>特点<br>借助 partition 和 columns 统计信息实现分区裁剪<br>不绑定 HDFS，可拓展到 S3/OSS 等<br>容许多个 Writer 并发写入，乐观锁机制解决冲突</p></li></ul><h2 id="数据布局Layout"><a href="#数据布局Layout" class="headerlink" title="数据布局Layout"></a>数据布局Layout</h2><p><img src="Iceberg%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84.png" alt></p><p>Layout 分为数据文件和元数据文件两部分。</p><p><img src="Iceberg_layout.png" alt></p><ul><li><p>数据文件（data files）<br>Iceberg 表真实存储数据的文件，一般存储在 data 目录下，以 “.parquet” 结尾。</p></li><li><p>清单文件（manifest file）<br>每行都是每个数据文件的详细描述，包括数据文件的状态、文件路径、分区信息、列级别的统计信息（比如每列的最大最小值、空值数等）。通过该文件，可以过滤掉无关数据，提高检索速度。</p></li><li><p>快照（snapshot）<br>快照代表一张表在某个时刻的状态。每个快照版本包含某个时刻的所有数据文件列表。data files 存储在不同的 manifest files 里， manifest files 存储在一个<br> manifest list 文件里面，而一个 manifest list 文件代表一个快照。</p></li></ul><h2 id="读写原理"><a href="#读写原理" class="headerlink" title="读写原理"></a>读写原理</h2><p><img src="%E8%AF%BB%E5%86%99%E5%8E%9F%E7%90%86_1.png" alt></p><p>绿色表示数据文件，蓝色表示 manifest，黄色表示快照。一次 manifest 可以认为是一次 transaction 的写入，m0 对应写了两个文件，分别落到了 Partiiotn-0 、Partition-1，m1 对应也写了两个文件，分别落到了 Partiiotn-1 、Partition-2。对于 S1 来说，是由 m0 和 m1 两个 manifest 组成的。</p><p><img src="%E8%AF%BB%E5%86%99%E5%8E%9F%E7%90%86_2.png" alt></p><p>基于 1 开始一次新的写入，写了一个 m2 的 transaction，写了一个数据文件 2 到 Partition-1，此时会新增一个 manifest m2 和 Snapshot S2，S2 会引用之前所有的 transaction m0 和 m1。</p><p>此时，如果要进行批量读取，就可以从 S1、S2、S3 中选择一个快照读取，比如选择了 S2，就是会把 m0、m1、m2 对应的数据全部 load 出来进行读取。</p><p>如果要进行增量读取，从 S0 开始把数据 load 出来，到 S1 的时候，会拿着 S1 的数据减去 S0 的数据得到增量的数据，然后交给计算引擎去做增量处理。</p><p><img src="%E8%AF%BB%E5%86%99%E5%8E%9F%E7%90%86_3.png" alt></p><h3 id="查询计划"><a href="#查询计划" class="headerlink" title="查询计划"></a>查询计划</h3><p>查询计划是指在表中“查询所需文件”的过程。</p><ul><li><p>元数据过滤<br>清单文件包括分区数据元组和每个数据文件的列级统计信息。在计划期内，查询谓词会自动转换为分区数据上的谓词，并首先应用于过滤数据文件。接下来，使用列级值计数，<br>空计数，下限和上限来消除与查询谓词不匹配的文件。</p></li><li><p>snapshot id<br>每个 snapshot id 会关联到一组 manifest files，而每一组 manifest files 包含很多 manifest file 。</p></li><li><p>manifest files 文件列表<br>每个 manifest file 文件又记录了当前 data 数据块的元数据信息，其中就包含了文件列的最大值和最小值，然后根据这个元数据信息，索引到具体的文件块，从而更快的查询到数据。</p></li></ul><h2 id="Flink-Iceberg-流式入湖"><a href="#Flink-Iceberg-流式入湖" class="headerlink" title="Flink + Iceberg 流式入湖"></a>Flink + Iceberg 流式入湖</h2><h3 id="入门实践"><a href="#入门实践" class="headerlink" title="入门实践"></a>入门实践</h3><p><a href="https://github.com/apache/iceberg/pull/1464/files" target="_blank" rel="noopener">详细参考文档</a></p><h4 id="本机启动-Hadoop-和-Hive"><a href="#本机启动-Hadoop-和-Hive" class="headerlink" title="本机启动 Hadoop 和 Hive"></a>本机启动 Hadoop 和 Hive</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动Hadoop</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$HADOOP_HOME</span>/sbin</span><br><span class="line">./start-all.sh</span><br><span class="line">hdfs dfs -ls /</span><br><span class="line">drwx-wx-wx   - miaowenting staff          0 2021-05-30 23:27 /tmp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动Hive</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$HIVE_HOME</span>/bin</span><br><span class="line">./hive --service metastore &amp;</span><br><span class="line">./hive --service hiveserver2 &amp;</span><br></pre></td></tr></table></figure><h4 id="本机启动-Flink"><a href="#本机启动-Flink" class="headerlink" title="本机启动 Flink"></a>本机启动 Flink</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动 Flink</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$FLINK_HOME</span>/bin</span><br><span class="line"></span><br><span class="line">./start-cluster.sh</span><br></pre></td></tr></table></figure><h4 id="准备-Flink-SQL-Client-环境"><a href="#准备-Flink-SQL-Client-环境" class="headerlink" title="准备 Flink SQL Client 环境"></a>准备 Flink SQL Client 环境</h4><ul><li>配置 HADOOP_CLASSPATH 环境变量：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/profile</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> HADOOP_CLASSPATH=`<span class="variable">$HADOOP_HOME</span>/bin/hadoop classpath`</span><br><span class="line"></span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure><ul><li>下载运行时jar：<br><a href="https://repo.maven.apache.org/maven2/org/apache/iceberg/iceberg-flink-runtime/" target="_blank" rel="noopener">iceberg-flink-runtime.jar下载地址</a><br><a href="https://repo.maven.apache.org/maven2/org/apache/flink/" target="_blank" rel="noopener">flink-sql-connector-hive.jar下载地址</a></li></ul><ul><li>启动命令行：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> <span class="variable">$FLINK_HOME</span>/bin</span><br><span class="line"></span><br><span class="line">./sql-client.sh embedded \</span><br><span class="line">    -j /usr/<span class="built_in">local</span>/external/iceberg-flink-runtime-0.10.0.jar \</span><br><span class="line">    -j /usr/<span class="built_in">local</span>/external/flink-sql-connector-hive-2.2.0_2.11-1.11.2.jar \</span><br><span class="line">    shell</span><br></pre></td></tr></table></figure><p><img src="%E6%89%93%E5%BC%80SQL_Client.png" alt></p><h4 id="创建-Iceberg-的-Catalog"><a href="#创建-Iceberg-的-Catalog" class="headerlink" title="创建 Iceberg 的 Catalog"></a>创建 Iceberg 的 Catalog</h4><h5 id="创建-Hive-Catalog"><a href="#创建-Hive-Catalog" class="headerlink" title="创建 Hive Catalog"></a>创建 Hive Catalog</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">CATALOG</span> hive_catalog <span class="keyword">WITH</span>(</span><br><span class="line"><span class="string">'type'</span>=<span class="string">'iceberg'</span>,</span><br><span class="line"><span class="string">'catalog-type'</span>=<span class="string">'hive'</span>,</span><br><span class="line"><span class="string">'uri'</span>=<span class="string">'thrift://localhost:9083'</span>,</span><br><span class="line"><span class="string">'clients'</span>=<span class="string">'5'</span>,</span><br><span class="line"><span class="string">'property-version'</span>=<span class="string">'1'</span>,</span><br><span class="line"><span class="string">'warehouse'</span>=<span class="string">'hdfs://localhost:9000/user/hive/warehouse'</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>可能出现以下报错：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread &quot;main&quot; org.apache.flink.table.client.SqlClientException: Unexpected exception. This is a bug. Please consider filing an issue.</span><br><span class="line">at org.apache.flink.table.client.SqlClient.main(SqlClient.java:213)</span><br><span class="line">Caused by: org.apache.flink.table.client.gateway.SqlExecutionException: Could not create execution context.</span><br><span class="line">at org.apache.flink.table.client.gateway.local.ExecutionContext$Builder.build(ExecutionContext.java:870)</span><br><span class="line">at org.apache.flink.table.client.gateway.local.LocalExecutor.openSession(LocalExecutor.java:227)</span><br><span class="line">at org.apache.flink.table.client.SqlClient.start(SqlClient.java:108)</span><br><span class="line">at org.apache.flink.table.client.SqlClient.main(SqlClient.java:201)</span><br><span class="line">Caused by: java.lang.VerifyError: Stack map does not match the one at exception handler 69</span><br><span class="line">Exception Details:</span><br><span class="line">  Location:</span><br><span class="line">    org/apache/iceberg/hive/HiveCatalog.loadNamespaceMetadata(Lorg/apache/iceberg/catalog/Namespace;)Ljava/util/Map; @69: astore_2</span><br><span class="line">  Reason:</span><br><span class="line">    Type &apos;org/apache/hadoop/hive/metastore/api/NoSuchObjectException&apos; (current frame, stack[0]) is not assignable to &apos;org/apache/thrift/TException&apos; (stack map, stack[0])</span><br><span class="line">  Current Frame:</span><br><span class="line">    bci: @26</span><br><span class="line">    flags: &#123; &#125;</span><br><span class="line">    locals: &#123; &apos;org/apache/iceberg/hive/HiveCatalog&apos;, &apos;org/apache/iceberg/catalog/Namespace&apos; &#125;</span><br><span class="line">    stack: &#123; &apos;org/apache/hadoop/hive/metastore/api/NoSuchObjectException&apos; &#125;</span><br><span class="line">  Stackmap Frame:</span><br><span class="line">    bci: @69</span><br><span class="line">    flags: &#123; &#125;</span><br><span class="line">    locals: &#123; &apos;org/apache/iceberg/hive/HiveCatalog&apos;, &apos;org/apache/iceberg/catalog/Namespace&apos; &#125;</span><br><span class="line">    stack: &#123; &apos;org/apache/thrift/TException&apos; &#125;</span><br><span class="line">  Bytecode:</span><br><span class="line">    0x0000000: 2a2b b700 759a 0015 bb00 c759 12c9 04bd</span><br><span class="line">    0x0000010: 00cb 5903 2b53 b700 cebf 2ab4 0038 2bba</span><br><span class="line">    0x0000020: 0236 0000 b600 9ac0 0238 4d2a 2cb7 023c</span><br><span class="line">    0x0000030: 4eb2 00bd 1302 3e2b 2db9 0204 0100 b900</span><br><span class="line">    0x0000040: c504 002d b04d bb00 c759 2c12 c904 bd00</span><br><span class="line">    0x0000050: cb59 032b 53b7 0229 bf4d bb00 d059 bb00</span><br><span class="line">    0x0000060: d259 b700 d313 022b b600 d92b b600 dc13</span><br><span class="line">    0x0000070: 01a4 b600 d9b6 00e0 2cb7 00e3 bf4d b800</span><br><span class="line">    0x0000080: 40b6 00e6 bb00 d059 bb00 d259 b700 d313</span><br><span class="line">    0x0000090: 022d b600 d92b b600 dc13 01a4 b600 d9b6</span><br><span class="line">    0x00000a0: 00e0 2cb7 00e3 bf                      </span><br><span class="line">  Exception Handler Table:</span><br><span class="line">    bci [26, 68] =&gt; handler: 69</span><br><span class="line">    bci [26, 68] =&gt; handler: 69</span><br><span class="line">    bci [26, 68] =&gt; handler: 89</span><br><span class="line">    bci [26, 68] =&gt; handler: 125</span><br><span class="line">  Stackmap Table:</span><br><span class="line">    same_frame(@26)</span><br><span class="line">    same_locals_1_stack_item_frame(@69,Object[#111])</span><br><span class="line">    same_locals_1_stack_item_frame(@89,Object[#111])</span><br><span class="line">    same_locals_1_stack_item_frame(@125,Object[#113])</span><br><span class="line"></span><br><span class="line">at org.apache.iceberg.flink.CatalogLoader$HiveCatalogLoader.loadCatalog(CatalogLoader.java:95)</span><br><span class="line">at org.apache.iceberg.flink.FlinkCatalog.&lt;init&gt;(FlinkCatalog.java:104)</span><br><span class="line">at org.apache.iceberg.flink.FlinkCatalogFactory.createCatalog(FlinkCatalogFactory.java:132)</span><br><span class="line">at org.apache.iceberg.flink.FlinkCatalogFactory.createCatalog(FlinkCatalogFactory.java:122)</span><br><span class="line">at org.apache.flink.table.client.gateway.local.ExecutionContext.createCatalog(ExecutionContext.java:378)</span><br><span class="line">at org.apache.flink.table.client.gateway.local.ExecutionContext.lambda$null$5(ExecutionContext.java:626)</span><br><span class="line">at java.util.HashMap.forEach(HashMap.java:1289)</span><br><span class="line">at org.apache.flink.table.client.gateway.local.ExecutionContext.lambda$initializeCatalogs$6(ExecutionContext.java:625)</span><br><span class="line">at org.apache.flink.table.client.gateway.local.ExecutionContext.wrapClassLoader(ExecutionContext.java:264)</span><br><span class="line">at org.apache.flink.table.client.gateway.local.ExecutionContext.initializeCatalogs(ExecutionContext.java:624)</span><br><span class="line">at org.apache.flink.table.client.gateway.local.ExecutionContext.initializeTableEnvironment(ExecutionContext.java:523)</span><br><span class="line">at org.apache.flink.table.client.gateway.local.ExecutionContext.&lt;init&gt;(ExecutionContext.java:183)</span><br><span class="line">at org.apache.flink.table.client.gateway.local.ExecutionContext.&lt;init&gt;(ExecutionContext.java:136)</span><br><span class="line">at org.apache.flink.table.client.gateway.local.ExecutionContext$Builder.build(ExecutionContext.java:859)</span><br></pre></td></tr></table></figure><p>解决办法：</p><ol><li><p>iceberg-flink-runtime-0.10.0.jar、flink-sql-connector-hive-2.2.0_2.11-1.11.2.jar 不要放在 $FLINK_HOME/lib 目录下</p></li><li><p>打开 sql-client.sh 文件，在 jar 包启动的地方加上 -noverify 跳过字节码校验。<br><img src="%E5%88%9B%E5%BB%BAhive_catalog%E6%8A%A5%E9%94%99%E7%9A%84%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%951.png" alt></p></li></ol><p>type：表示 flink-connector 的连接类型<br>catalog-type：表示创建 catalog 的类型。目前支持 hive 和 hadoop 两种类型<br>uri：Hive metastore 的 thrift URI 地址<br>clients：Hive metastore 客户端线程池大小，默认值为2<br>property-version：Connector 的属性值版本号，当前版本为1，这个值主要用来确保 iceberg connector 的 property 向后兼容</p><p><img src="%E5%88%9B%E5%BB%BAhive_catalog%E6%88%90%E5%8A%9F.png" alt></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">USE</span> <span class="keyword">CATALOG</span> hive_catalog;</span><br></pre></td></tr></table></figure><h5 id="创建-Hadoop-Catalog"><a href="#创建-Hadoop-Catalog" class="headerlink" title="创建 Hadoop Catalog"></a>创建 Hadoop Catalog</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">CATALOG</span> hadoop_catalog <span class="keyword">WITH</span>(</span><br><span class="line"><span class="string">'type'</span>=<span class="string">'iceberg'</span>,</span><br><span class="line"><span class="string">'catalog-type'</span>=<span class="string">'hadoop'</span>,</span><br><span class="line"><span class="string">'warehouse'</span>=<span class="string">'hdfs://localhost:9000/warehouse/path'</span>,</span><br><span class="line"><span class="string">'property-version'</span>=<span class="string">'1'</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">USE</span> <span class="keyword">CATALOG</span> hadoop_catalog;</span><br></pre></td></tr></table></figure><p>warehouse：表示 iceberg 的 metadata 的 data 数据存放的文件路径。</p><p><img src="%E5%88%9B%E5%BB%BAhadoop_catalog%E6%88%90%E5%8A%9F.png" alt></p><h5 id="创建-Custom-Catalog"><a href="#创建-Custom-Catalog" class="headerlink" title="创建 Custom Catalog"></a>创建 Custom Catalog</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">CATALOG</span> my_catalog <span class="keyword">WITH</span> (</span><br><span class="line">  <span class="string">'type'</span>=<span class="string">'iceberg'</span>,</span><br><span class="line">  <span class="string">'catalog-impl'</span>=<span class="string">'com.my.custom.CatalogImpl'</span>,</span><br><span class="line">  <span class="string">'my-additional-catalog-config'</span>=<span class="string">'my-value'</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure><h5 id="通过-YAML-统一新增-Catalog"><a href="#通过-YAML-统一新增-Catalog" class="headerlink" title="通过 YAML 统一新增 Catalog"></a>通过 YAML 统一新增 Catalog</h5><p>修改 sql-client-defaults.yaml 文件：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">catalogs:</span>  <span class="comment"># empty list</span></span><br><span class="line"><span class="attr">   - name:</span> <span class="string">hadoop_catalog</span></span><br><span class="line"><span class="attr">     type:</span> <span class="string">iceberg</span></span><br><span class="line"><span class="attr">     catalog-type:</span> <span class="string">hadoop</span></span><br><span class="line"><span class="attr">     warehouse:</span> <span class="attr">hdfs://localhost:9000/warehouse/path</span></span><br><span class="line"><span class="attr">     property-version:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">   - name:</span> <span class="string">hive_catalog</span></span><br><span class="line"><span class="attr">     type:</span> <span class="string">iceberg</span></span><br><span class="line"><span class="attr">     catalog-type:</span> <span class="string">hive</span></span><br><span class="line"><span class="attr">     uri:</span> <span class="attr">thrift://localhost:9083</span></span><br><span class="line"><span class="attr">     clients:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">     warehouse:</span> <span class="attr">hdfs://localhost:9000/user/hive/warehouse</span></span><br><span class="line"><span class="attr">     property-version:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure><h4 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> iceberg_db;</span><br><span class="line"></span><br><span class="line"><span class="keyword">USE</span> <span class="string">`iceberg_db`</span>;</span><br></pre></td></tr></table></figure><p><img src="%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E6%88%90%E5%8A%9F.png" alt></p><h4 id="创建-Iceberg-表"><a href="#创建-Iceberg-表" class="headerlink" title="创建 Iceberg 表"></a>创建 Iceberg 表</h4><ul><li>首先要进入到指定的 catalog 和 database 目录下</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">USE</span> <span class="keyword">CATALOG</span> hive_catalog;</span><br><span class="line"></span><br><span class="line"><span class="keyword">USE</span> iceberg_db;</span><br></pre></td></tr></table></figure><ul><li>创建非分区表</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建 Iceberg 非分区表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> sample_iceberg (</span><br><span class="line">  <span class="keyword">id</span> <span class="built_in">BIGINT</span> <span class="keyword">COMMENT</span> <span class="string">'unique id'</span>,</span><br><span class="line">  <span class="keyword">data</span> <span class="keyword">STRING</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入测试数据1</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> sample_iceberg <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="string">'test1'</span>);</span><br><span class="line"></span><br><span class="line">[INFO] Submitting SQL <span class="keyword">update</span> <span class="keyword">statement</span> <span class="keyword">to</span> the cluster...</span><br><span class="line">[INFO] <span class="keyword">Table</span> <span class="keyword">update</span> <span class="keyword">statement</span> has been successfully submitted <span class="keyword">to</span> the cluster:</span><br><span class="line">Job <span class="keyword">ID</span>: <span class="number">79</span>f18eee231895abd2ab15fbd0641ade</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入测试数据2</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> sample_iceberg <span class="keyword">VALUES</span> (<span class="number">2</span>,<span class="string">'test2'</span>);</span><br><span class="line"></span><br><span class="line">[INFO] Submitting SQL <span class="keyword">update</span> <span class="keyword">statement</span> <span class="keyword">to</span> the cluster...</span><br><span class="line">[INFO] <span class="keyword">Table</span> <span class="keyword">update</span> <span class="keyword">statement</span> has been successfully submitted <span class="keyword">to</span> the cluster:</span><br><span class="line">Job <span class="keyword">ID</span>: c0afa452656f42de5df6bc745fbaf022</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询已插入的数据</span></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> sample_iceberg;</span><br></pre></td></tr></table></figure><p><img src="%E6%9F%A5%E8%AF%A2Iceberg%E9%9D%9E%E5%88%86%E5%8C%BA%E8%A1%A8%E6%95%B0%E6%8D%AE.png" alt></p><ul><li>创建分区表</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建 Iceberg 分区表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> sample_iceberg_partition (</span><br><span class="line">  <span class="keyword">id</span> <span class="built_in">BIGINT</span> <span class="keyword">COMMENT</span> <span class="string">'unique id'</span>,</span><br><span class="line">  <span class="keyword">data</span> <span class="keyword">STRING</span></span><br><span class="line">) </span><br><span class="line">PARTITIONED <span class="keyword">BY</span> (<span class="keyword">data</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入测试数据1</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> sample_iceberg_partition <span class="keyword">PARTITION</span>(<span class="keyword">data</span>=<span class="string">'city'</span>) <span class="keyword">SELECT</span> <span class="number">86</span>;</span><br><span class="line"></span><br><span class="line">[INFO] Submitting SQL <span class="keyword">update</span> <span class="keyword">statement</span> <span class="keyword">to</span> the cluster...</span><br><span class="line">[INFO] <span class="keyword">Table</span> <span class="keyword">update</span> <span class="keyword">statement</span> has been successfully submitted <span class="keyword">to</span> the cluster:</span><br><span class="line">Job <span class="keyword">ID</span>: <span class="number">9</span>ff0581b9b16ee01c0c849c50608f1b2</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询已插入的数据</span></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> sample_iceberg_partition;</span><br></pre></td></tr></table></figure><p><img src="%E6%9F%A5%E8%AF%A2Iceberg%E5%88%86%E5%8C%BA%E8%A1%A8%E6%95%B0%E6%8D%AE.png" alt></p><ul><li>创建带 WITH 参数的表</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">-- 创建表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> sample_iceberg_connector (</span><br><span class="line"><span class="keyword">id</span> <span class="built_in">BIGINT</span> <span class="keyword">COMMENT</span> <span class="string">'unique id'</span>,</span><br><span class="line"><span class="keyword">data</span> <span class="keyword">STRING</span></span><br><span class="line">) <span class="keyword">WITH</span> (</span><br><span class="line"><span class="string">'connector'</span>=<span class="string">'iceberg'</span>,</span><br><span class="line">  <span class="string">'catalog-type'</span>=<span class="string">'hive'</span>,</span><br><span class="line">  <span class="string">'uri'</span>=<span class="string">'thrift://localhost:9083'</span>,</span><br><span class="line">  <span class="string">'clients'</span>=<span class="string">'5'</span>,</span><br><span class="line">  <span class="string">'property-version'</span>=<span class="string">'1'</span>,</span><br><span class="line">  <span class="string">'warehouse'</span>=<span class="string">'hdfs://localhost:9000/warehouse/path'</span>,</span><br><span class="line"><span class="string">'write.format.default'</span>=<span class="string">'ORC'</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure><p><img src="%E5%88%9B%E5%BB%BAIceberg%E8%A1%A8%E6%88%90%E5%8A%9F.png" alt></p><p>支持 PARTITION BY 子句，用来设置分区字段<br>支持 COMMENT ‘table comment’ 子句<br>支持 WITH(‘key’=’value’,…) 子句，用来设置 table 级别的配置属性</p><p>暂不支持 computed column<br>暂不支持 primary key<br>暂不支持定义 watermark</p><h4 id="Flink-SQL-写入"><a href="#Flink-SQL-写入" class="headerlink" title="Flink SQL 写入"></a>Flink SQL 写入</h4><ul><li>修改 flink-conf.yaml 配置文件，配置 checkpoint<br>因为 flink 提交 Iceberg 的信息是在每次 checkpoint 时提交的，所以需要开启 checkpoint</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开启 checkpoint</span></span><br><span class="line"><span class="string">state.backend:</span> <span class="string">filesystem</span></span><br><span class="line"><span class="string">state.backend.async:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">state.backend.fs.memory-threshold:</span> <span class="number">1024</span></span><br><span class="line"><span class="string">state.checkpoints.dir:</span> <span class="attr">hdfs://localhost:9000/flink-checkpoints</span></span><br><span class="line"><span class="string">state.savepoints.dir:</span> <span class="attr">hdfs://localhost:9000/flink-checkpoints</span></span><br><span class="line"><span class="string">state.backend.incremental:</span> <span class="literal">false</span></span><br><span class="line"><span class="string">state.backend.local-recovery:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment"># state.checkpoints.num-retained: 1</span></span><br><span class="line"><span class="string">taskmanager.state.local.root-dirs:</span> <span class="string">none</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># checkpoint 间隔时间</span></span><br><span class="line"><span class="string">execution.checkpointing.interval:</span> <span class="number">10</span><span class="string">s</span></span><br><span class="line"><span class="comment"># checkpoint 失败容忍次数</span></span><br><span class="line"><span class="string">execution.checkpointing.tolerable-failed-checkpoints:</span> <span class="number">10</span></span><br></pre></td></tr></table></figure><ul><li>首先要进入到指定的 catalog 和 database 目录下</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">USE</span> <span class="keyword">CATALOG</span> hive_catalog;</span><br><span class="line"></span><br><span class="line"><span class="keyword">USE</span> iceberg_db;</span><br></pre></td></tr></table></figure><ul><li>创建一个 iceberg 的 sink connector</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">-- 创建表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> table_sink_iceberg (</span><br><span class="line">  <span class="keyword">id</span> <span class="built_in">BIGINT</span> <span class="keyword">COMMENT</span> <span class="string">'unique id'</span>,</span><br><span class="line">  <span class="keyword">data</span> <span class="keyword">STRING</span></span><br><span class="line">) <span class="keyword">WITH</span> (</span><br><span class="line">  <span class="string">'connector'</span>=<span class="string">'iceberg'</span>,</span><br><span class="line">  <span class="string">'catalog-type'</span>=<span class="string">'hive'</span>,</span><br><span class="line">  <span class="string">'uri'</span>=<span class="string">'thrift://localhost:9083'</span>,</span><br><span class="line">  <span class="string">'clients'</span>=<span class="string">'5'</span>,</span><br><span class="line">  <span class="string">'property-version'</span>=<span class="string">'1'</span>,</span><br><span class="line">  <span class="string">'warehouse'</span>=<span class="string">'hdfs://localhost:9000/warehouse/path'</span>,</span><br><span class="line">  <span class="string">'write.format.default'</span>=<span class="string">'ORC'</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure><ul><li>创建一个 datagen 的 source connector</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> table_source_datagen (</span><br><span class="line"> userid <span class="built_in">INT</span>,</span><br><span class="line"> f_random_str <span class="keyword">STRING</span></span><br><span class="line">) <span class="keyword">WITH</span> (</span><br><span class="line"> <span class="string">'connector'</span>=<span class="string">'datagen'</span>,</span><br><span class="line"> <span class="string">'rows-per-second'</span>=<span class="string">'5'</span>,</span><br><span class="line"> <span class="string">'fields.userid.kind'</span>=<span class="string">'random'</span>,</span><br><span class="line"> <span class="string">'fields.userid.min'</span>=<span class="string">'1'</span>,</span><br><span class="line"> <span class="string">'fields.userid.max'</span>=<span class="string">'1000'</span>,</span><br><span class="line"> <span class="string">'fields.f_random_str.length'</span>=<span class="string">'10'</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询 source 数据，会有源源不断的数据输出</span></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> table_source_datagen;</span><br></pre></td></tr></table></figure><ul><li>通过设置 execution.type 来切换提交流作业和批作业</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 流式</span></span><br><span class="line"><span class="keyword">SET</span> execution.type = streaming;</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 批</span></span><br><span class="line"><span class="keyword">SET</span> execution.type = batch;</span><br></pre></td></tr></table></figure><ul><li>借助流式作业（默认）写入数据到 Apache Iceberg 表</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> table_sink_iceberg <span class="keyword">SELECT</span> userid,f_random_str <span class="keyword">FROM</span> table_source_datagen;</span><br><span class="line"></span><br><span class="line">[INFO] Submitting SQL <span class="keyword">update</span> <span class="keyword">statement</span> <span class="keyword">to</span> the cluster...</span><br><span class="line">[INFO] <span class="keyword">Table</span> <span class="keyword">update</span> <span class="keyword">statement</span> has been successfully submitted <span class="keyword">to</span> the cluster:</span><br><span class="line">Job <span class="keyword">ID</span>: <span class="number">52</span>c57f566aa6da61d46ec2fc73b74b59</span><br></pre></td></tr></table></figure><ul><li>查询 sink 到 iceberg 表里的数据</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> table_sink_iceberg;</span><br></pre></td></tr></table></figure><p><img src="%E6%9F%A5%E8%AF%A2Iceberg%E5%AE%9E%E6%97%B6%E5%86%99%E5%85%A5%E7%9A%84%E6%95%B0%E6%8D%AE.png" alt></p><h4 id="DataStream-写入"><a href="#DataStream-写入" class="headerlink" title="DataStream 写入"></a>DataStream 写入</h4><h5 id="批量读取"><a href="#批量读取" class="headerlink" title="批量读取"></a>批量读取</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">StreamExecutionEnvironment env = StreamExecutionEnvironment.createLocalEnvironment();</span><br><span class="line">TableLoader tableLoader = TableLoader.fromHadooptable(<span class="string">"hdfs://nn:8020/warehouse/path"</span>);</span><br><span class="line">DataStream&lt;RowData&gt; batch = FlinkSource.forRowData()</span><br><span class="line">     .env(env)</span><br><span class="line">     .tableLoader(loader)</span><br><span class="line">     .streaming(<span class="keyword">false</span>)</span><br><span class="line">     .build();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Print all records to stdout.</span></span><br><span class="line">batch.print();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Submit and execute this batch read job.</span></span><br><span class="line">env.execute(<span class="string">"Test Iceberg Batch Read"</span>);</span><br></pre></td></tr></table></figure><h5 id="流式读取"><a href="#流式读取" class="headerlink" title="流式读取"></a>流式读取</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">StreamExecutionEnvironment env = StreamExecutionEnvironment.createLocalEnvironment();</span><br><span class="line">TableLoader tableLoader = TableLoader.fromHadoopTable(<span class="string">"hdfs://nn:8020/warehouse/path"</span>);</span><br><span class="line">DataStream&lt;RowData&gt; stream = FlinkSource.forRowData()</span><br><span class="line">     .env(env)</span><br><span class="line">     .tableLoader(loader)</span><br><span class="line">     .streaming(<span class="keyword">true</span>)</span><br><span class="line">     .startSnapshotId(<span class="number">3821550127947089987L</span>)</span><br><span class="line">     .build();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Print all records to stdout.</span></span><br><span class="line">stream.print();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Submit and execute this streaming read job.</span></span><br><span class="line">env.execute(<span class="string">"Test Iceberg streaming Read"</span>);</span><br></pre></td></tr></table></figure><h5 id="追加写入"><a href="#追加写入" class="headerlink" title="追加写入"></a>追加写入</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">StreamExecutionEnvironment env = ...;</span><br><span class="line"></span><br><span class="line">DataStream&lt;RowData&gt; input = ... ;</span><br><span class="line">Configuration hadoopConf = <span class="keyword">new</span> Configuration();</span><br><span class="line">TableLoader tableLoader = TableLoader.fromHadoopTable(<span class="string">"hdfs://nn:8020/warehouse/path"</span>, hadoopConf);</span><br><span class="line"></span><br><span class="line">FlinkSink.forRowData(input)</span><br><span class="line">    .tableLoader(tableLoader)</span><br><span class="line">    .build();</span><br><span class="line"></span><br><span class="line">env.execute(<span class="string">"Test Iceberg DataStream"</span>);</span><br></pre></td></tr></table></figure><h5 id="覆盖写入"><a href="#覆盖写入" class="headerlink" title="覆盖写入"></a>覆盖写入</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">StreamExecutionEnvironment env = ...;</span><br><span class="line"></span><br><span class="line">DataStream&lt;RowData&gt; input = ... ;</span><br><span class="line">Configuration hadoopConf = <span class="keyword">new</span> Configuration();</span><br><span class="line">TableLoader tableLoader = TableLoader.fromHadoopTable(<span class="string">"hdfs://nn:8020/warehouse/path"</span>, hadoopConf);</span><br><span class="line"></span><br><span class="line">FlinkSink.forRowData(input)</span><br><span class="line">    .tableLoader(tableLoader)</span><br><span class="line">    .overwrite(<span class="keyword">true</span>)</span><br><span class="line">    .build();</span><br><span class="line"></span><br><span class="line">env.execute(<span class="string">"Test Iceberg DataStream"</span>);</span><br></pre></td></tr></table></figure><h4 id="修改表属性"><a href="#修改表属性" class="headerlink" title="修改表属性"></a>修改表属性</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="keyword">sample</span> <span class="keyword">SET</span> (<span class="string">'write.format.default'</span>=<span class="string">'avro'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="keyword">sample</span> <span class="keyword">RENAME</span> <span class="keyword">TO</span> <span class="string">`hive_catalog.default.new_sample`</span>;</span><br></pre></td></tr></table></figure><ul><li>Flink SQL 目前支持修改 iceberg 表的相关属性</li><li>Flink SQL 暂不支持添加列、修改列、删除列的操作，但可以通过 Iceberg Java API 来完成</li></ul><h4 id="删除表、库和-Catalog"><a href="#删除表、库和-Catalog" class="headerlink" title="删除表、库和 Catalog"></a>删除表、库和 Catalog</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">--  删除表</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">sample</span>；</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除库</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">DATABASE</span> test_db;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除 catalog</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">CATALOG</span> hive_catalog;</span><br></pre></td></tr></table></figure><h3 id="Flink-Sink-写入原理"><a href="#Flink-Sink-写入原理" class="headerlink" title="Flink Sink 写入原理"></a>Flink Sink 写入原理</h3><p><img src="Flink_Sink%E5%8E%9F%E7%90%86.png" alt></p><ul><li><p>IcebergStreamWriter<br>主要用来写入记录到对应的 avro、parquet、orc 文件，生成一个对应的 Iceberg datafile，并发送给下游算子。</p></li><li><p>IcebergFilesCommitter<br>为每个 checkpointId 维护了一个 datafile 文件列表，即 Map&lt;Long,List<datafile>&gt;，这样即使中间有某个 checkpoint 的 transaction 提交失败了，<br>它的 datafile 文件仍然维护在 State 中，依然可以通过后续的 checkpoint 来提交数据到 Iceberg 表中。</datafile></p></li></ul><p><img src="flink_sink_state%E8%AE%BE%E8%AE%A1.png" alt></p><p>Flink Sink State 改进：</p><ol><li><p>多个不同的 Flink Job 写入同一个 Iceberg 表时，如何保证写入数据的正确性？</p></li><li><p>在云端环境下，metastore 所在的数据中心和日志数据中心是两个数据中心。这时候，可能导致 Commit Transaction 到 Iceberg 经常失败的现象，长期失败会导致 State 膨胀。<br>如何解决这个问题。</p></li></ol><h3 id="Flink-Sink-小文件处理"><a href="#Flink-Sink-小文件处理" class="headerlink" title="Flink Sink 小文件处理"></a>Flink Sink 小文件处理</h3><ul><li><p>小数据量的合并<br>在 IcebergFilesCommitter 之后添加一个 Compactor 算子，用来实现少量小文件的频繁合并。</p></li><li><p>大数据量的合并<br>设计 Flink Batch 作业，对接 Iceberg 的 RewriteDataFilesAction 来实现表内的大数据合并。</p></li></ul><h2 id="社区规划"><a href="#社区规划" class="headerlink" title="社区规划"></a>社区规划</h2><ol><li><p>预计将在下个 Apache Iceberg Release 中支持：<br>a. Flink Sink 流式入湖和批量入湖<br>b. Flink Streaming Reader<br>c. Flink Batch Reader</p></li><li><p>Flink + Iceberg 对小文件的处理<br>a. Committer 任务之后添加 Compactor 算子，专门处理少量数据的 compaction<br>b. 设计 Flink 批任务来处理大数据量的 compaction</p></li><li><p>对接 Iceberg 的 row-level delete 功能<br>a. 通过 Flink 实现 CDC 日志的实时写入和分析<br>b. 通过 Flink 实现 CDC 日志的增量拉取<br>c. Flink + Iceberg 支持批量的数据更新</p></li><li><p>更加完善的 Flink SQL 支持<br>a. 更富的 Flink DDL 支持，例如支持增删改 column<br>b. 往 Flink 社区讨论支持 hidden partition</p></li><li><p>通过 SQL extension 来完成日常数据管理<br>a. 在 Icebeg 内实现 compaction 语法和命令<br>b. SQL 查看 history、snapshot、manifest、files 文件</p></li></ol><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://blog.51cto.com/u_15023245/2619826" target="_blank" rel="noopener">基于 Flink+Iceberg 构建企业级实时数据湖 - 文章</a><br><a href="https://www.bilibili.com/video/BV14A411J7e6?p=4" target="_blank" rel="noopener">基于 Flink+Iceberg 构建企业级实时数据湖 - 视频</a><br><a href="https://www.yuque.com/deadwind/fusion/iqc65z?language=zh-cn" target="_blank" rel="noopener">Apache Iceberg调研</a><br><a href="https://www.bilibili.com/video/av929015385/" target="_blank" rel="noopener">Apache Iceberg 0.11.0 最新解读视频，胡争</a><br><a href="https://www.cnblogs.com/swordfall/p/14548574.html#auto_id_0" target="_blank" rel="noopener">Flink集成Iceberg简介</a><br><a href="https://github.com/apache/iceberg/blob/master/site/docs/flink.md" target="_blank" rel="noopener">Flink+Iceberg 社区使用文档</a><br><a href="https://blog.csdn.net/joniers/article/details/116590366" target="_blank" rel="noopener">Flink+iceberg 环境搭建及问题处理</a><br><a href="https://cloud.tencent.com/developer/article/1727735" target="_blank" rel="noopener">Flink集成数据湖之实时数据写入 Iceberg</a><br><a href="https://mp.weixin.qq.com/s/2MxyxOYrHi5HWmkKtXYjBg" target="_blank" rel="noopener">Flink + Iceberg 在去哪儿的实时数仓实践</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;本文为 Apache Iceberg 的入门学习笔记。&lt;/p&gt;
    
    </summary>
    
      <category term="DataLake" scheme="http://yoursite.com/categories/DataLake/"/>
    
      <category term="Iceberg" scheme="http://yoursite.com/categories/DataLake/Iceberg/"/>
    
    
  </entry>
  
  <entry>
    <title>初识数据湖</title>
    <link href="http://yoursite.com/2021/01/20/%E5%88%9D%E8%AF%86%E6%95%B0%E6%8D%AE%E6%B9%96/"/>
    <id>http://yoursite.com/2021/01/20/初识数据湖/</id>
    <published>2021-01-20T08:19:22.000Z</published>
    <updated>2021-06-03T17:41:32.764Z</updated>
    
    <content type="html"><![CDATA[<p>对于数据湖的入门者，本文记录一下对数据湖的初步认识。</p><a id="more"></a><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p>数据湖是个什么概念呢？一般来说把一家企业产生的数据维护在一个平台内，这个平台我们称之为“数据湖”。</p><p>个人认为数据湖应该是一种不断演进中、可扩展的大数据存储、处理、分析的基础设施。以数据为导向，实现任意来源、任意规模、任意类型数据的全量获取、全量存储、多模式处理与全生命周期管理；并通过与各类外部异构数据源的交互集成，支持各类企业级应用。</p><p><img src="%E6%95%B0%E6%8D%AE%E6%B9%96%E5%9F%BA%E6%9C%AC%E8%83%BD%E5%8A%9B%E7%A4%BA%E6%84%8F.png" alt></p><p>看下面这幅图，这个湖的数据来源多种多样，有的可能是结构化数据，有的可能是非结构化数据，有的甚至是二进制数据。有一拨人站在湖的入口，用设备在检测水质，这对应着数据湖上的流处理作业；有一拨抽水机从湖里抽水，这对应着数据湖的批处理作业；还有一批人在船头钓鱼或者在岸上捕鱼，这对应着数据科学家从数据湖中通过机器学习的手段提取价值。<br><img src="%E5%88%9D%E8%AF%86%E6%95%B0%E6%8D%AE%E6%B9%96.png" alt></p><p>总结起来，数据湖主要有 4 个方面的特点：</p><ul><li><p>存储原始数据，这些原始数据的来源非常丰富<br>结构化数据<br>半结构化数据<br>非结构化数据<br>二进制数据（图片等）</p></li><li><p>支持多种计算模型<br>批处理<br>流计算<br>交互式分析<br>机器学习</p></li><li><p>有完善的数据管理能力<br>能做到多种数据源接入<br>时间不同数据之间的连接<br>支持 Schema 管理<br>支持权限管理</p></li><li><p>灵活的底层存储<br>一般用 S3/OSS/HDFS 这种廉价的分布式文件系统<br>支持 Parquet/Avro/Orc 文件格式<br>支持数据缓存加速<br>满足对应场景的数据分析需求</p></li></ul><p>那么，开源的数据湖架构一般是什么样的呢？一般分为四层：</p><ul><li>最底层是廉价、弹性可扩展的分布式文件系统，云上用户 S3 和 OSS 这种对象存储用的更多一些，毕竟价格便宜很多；非云上用户一般采用自己维护的 HDFS。</li><li>第二层是数据加速层。提供本地数据缓存（多块 SSD）和元数据加速服务。数据湖架构是一个存储计算彻底分离的架构，如果所有的数据访问都远程读取文件系统上的数据，那么性能和成本开销很大。如果能把经常访问到的一些热点数据缓存在计算节点本地，这就非常自然的实现了冷热分离，一方面能获取到不错的本地读取性能，另一方面还节省了远程访问的带宽。这一层里边，通常会选择开源的 alluxio，或者选择阿里云上的 Jindofs。</li><li>第三层就是 Table Format 层，提供面向用户的主表级语义。要是把一些数据文件封装成一个有业务语义的 table，提供 ACID、snapshot、schema、partition 等表级别的语义。一般对应着开源的 Delta、Iceberg、Hudi 等项目。对一些用户来说，他们认为 Delta、Iceberg、Hudi 这些就是数据湖，其实这几个项目只是数据湖这个架构里边的一环，只是因为它们离用户最近，屏蔽了底层的很多细节，所以才会造成这样的误解。数据湖和数据中台一样，是一种架构理念，而不是专指某一个技术。</li><li>最上层就是不同计算场景的计算引擎了，满足不同的分析需求。开源的一般有 Spark、Flink、Hive、Presto、Hive MR 等，这一批计算引擎可以同时访问同一张数据湖的表。</li></ul><p><img src="%E6%95%B0%E6%8D%AE%E6%B9%96%E7%9A%84%E4%B8%80%E8%88%AC4%E5%B1%82%E6%9E%B6%E6%9E%84.png" alt></p><h3 id="数据湖-vs-数据仓库"><a href="#数据湖-vs-数据仓库" class="headerlink" title="数据湖 vs 数据仓库"></a>数据湖 vs 数据仓库</h3><p>比较数据来源于 AWS。</p><table><thead><tr><th>特性</th><th>数据仓库</th><th>数据湖</th></tr></thead><tbody><tr><td>数据</td><td>来自事务系统、运营数据库和业务线应用程序的关系数据</td><td>来自 IoT设备、网站、移动应用程序、社交媒体和企业应用程序的非关系和关系数据</td></tr><tr><td>Schema</td><td>设计在数据仓库实施之前（写入型Schema）</td><td>写入在分析时（读取型Schema）</td></tr><tr><td>性价比</td><td>更快查询结果会带来较高存储成本</td><td>更快查询结果只需较低存储成本</td></tr><tr><td>数据质量</td><td>可作为重要事实依据的高度监管数据</td><td>任何可以或无法进行监管的数据（例如原始数据）</td></tr><tr><td>用户</td><td>业务分析师</td><td>数据科学家、数据开发人员和业务分析师（使用监管数据）</td></tr><tr><td>分析</td><td>批处理报告、BI和可视化</td><td>机器学习、预测分析、数据发现和分析</td></tr></tbody></table><h3 id="Flink数据湖业务场景"><a href="#Flink数据湖业务场景" class="headerlink" title="Flink数据湖业务场景"></a>Flink数据湖业务场景</h3><h4 id="场景一-构建实时Data-Pipeline"><a href="#场景一-构建实时Data-Pipeline" class="headerlink" title="场景一: 构建实时Data Pipeline"></a>场景一: 构建实时Data Pipeline</h4><p><img src="%E5%9C%BA%E6%99%AF1_%E6%9E%84%E5%BB%BA%E5%AE%9E%E6%97%B6Data_pipeline.png" alt></p><p>首先，Flink+Iceberg 最经典的一个应用场景就是构建实时的 Data Pipeline。业务端产生大量的日志数据，被导入到 Kafka 这样的消息队列，运用 Flink 流计算引擎执行 ETL 后，导入到 Apache Iceberg 原始表中。有一些业务场景需要直接跑分析作业来分析原始表的数据，而另外一些业务需要对数据做进一步的提纯，那么我们可以再起一个 Flink 作业从 Apache Iceberg 表中消费增量数据，经过处理之后写到到提纯之后的 Iceberg 表中。此时，可能还有业务需要对数据做进一步的聚合，那么我们继续在 Iceberg 表上启动增量 Flink 作业，将聚合之后的数据结果写入到聚合表中。</p><p>有人可能会提出质疑，这个场景好像通过 Flink+Hive 也能实现。Flink+Hive 的确可以实现，但写入到 Hive 的数据更多的是为了实现数仓的数据分析，而不是为了做增量拉取。一般来说，Hive 的增量写入是以 partition 为单位，时间是 15min 以上，Flink 长期高频率地写入会造成 partition 膨胀。而 Iceberg 允许实现 1min 甚至 30s 的增量写入，这样就可以大大提高了端到端数据的实时性，上层的分析作业可以看到更新的数据，下游的增量作业也可以读取到更新的数据。</p><ul><li><p>核心优势：<br>可以借助 Flink 实现数据 exactly-once 语义地入湖和出湖<br>新写入数据可以在 checkpoint 周期内可见<br>可以方便地构建 data pipeline，满足不同业务层的数据加工和分析需求</p></li><li><p>对比 Hive 方案：<br>hive 的增量写入以 partition 为单位，长期高频率的 checkpoint 写入，会导致 hive partition 的膨胀<br>本质上 hive 的增量写入和消费粒度都太大，实时性无法比肩 iceberg</p></li></ul><h4 id="场景二-CDC数据实时摄入摄出"><a href="#场景二-CDC数据实时摄入摄出" class="headerlink" title="场景二: CDC数据实时摄入摄出"></a>场景二: CDC数据实时摄入摄出</h4><p><img src="%E5%9C%BA%E6%99%AF%E4%BA%8C_CDC%E6%95%B0%E6%8D%AE%E5%AE%9E%E6%97%B6%E6%91%84%E5%85%A5%E5%B0%84%E5%87%BA.png" alt></p><p>第二个经典的场景，就是可以用 Flink+Iceberg 分析来自 MySQL 等关系型数据库的 binlog 等。</p><p>一方面，Flink 已经原生的支持 CDC 数据解析，一条 binlog 数据通过 flink-cdc-connector 拉取之后，自动转换成 Flink runtime 能识别的 insert、delete、update_before、update_after 四种消息，供用户进一步的实时计算。</p><p>另一方面，Iceberg 已经较为完善的实现了 equality delete 功能，也就是用户定义好到删除的 record，直接写到 Iceberg 表内就可以删除对应的行，本身就是为了实现数据湖的流式删除。在 Iceberg 未来的版本中，用户将不需要设计任何额外的业务字段，不用写几行代码就可以完成 binlog 流式入湖到 Iceberg （社区 PR 已经提供了一个 Flink 写入 CDC 数据的原型）。</p><p>此外，CDC 数据成功入湖 Iceberg 之后，常见的计算引擎 Presto、Spark、Hive 等，都可以实时的读取到 Iceberg 表中最新的数据。</p><h3 id="场景三-近实时场景的流批统一"><a href="#场景三-近实时场景的流批统一" class="headerlink" title="场景三: 近实时场景的流批统一"></a>场景三: 近实时场景的流批统一</h3><p><img src="%E5%9C%BA%E6%99%AF%E4%B8%89_%E8%BF%91%E5%AE%9E%E6%97%B6%E5%9C%BA%E6%99%AF%E7%9A%84%E6%89%B9%E6%B5%81%E7%BB%9F%E4%B8%80.png" alt></p><p>第三个经典场景是近实时场景的批流统一。在常用的 lambda 架构中，有一条实时链路和一条离线链路。实时链路一般由 Flink、Kafka、HBase 这些组件构建而成，离线链路一般会用到 Parquet、Spark等组件。这里边涉及到的计算组件和存储组件非常多，系统维护成本和业务开发成本都非常高。有很多场景，它们的实时性要求并没有那么苛刻，例如可以放松到分钟级别，这种场景我们称之为近实时场景。那么，我们是不是可以通过 Flink+Iceberg 来优化我们常用的 lambda 架构呢？</p><p><img src="%E5%9C%BA%E6%99%AF%E4%B8%89_%E8%BF%91%E5%AE%9E%E6%97%B6%E5%9C%BA%E6%99%AF%E7%9A%84%E6%89%B9%E6%B5%81%E7%BB%9F%E4%B8%802.png" alt></p><p>我们可以用 Flink+Iceberg 把整个架构优化成上图所示。实时的数据通过 Flink 写入到 Iceberg 表中，近实时链路可以通过 Flink 计算增量数据，离线链路也可以通过 Flink 批计算读取整个快照做全局分析，得到对应的分析结果，供不同场景下的用户读取和分析。经过这种改进之后，我们把计算引擎统一成了 Flink，把存储组件统一成了 Iceberg，整个系统的维护开发成本大大降低。</p><h4 id="场景四-从-Iceberg-历史数据启动-Flink-任务"><a href="#场景四-从-Iceberg-历史数据启动-Flink-任务" class="headerlink" title="场景四: 从 Iceberg 历史数据启动 Flink 任务"></a>场景四: 从 Iceberg 历史数据启动 Flink 任务</h4><p><img src="%E5%9C%BA%E6%99%AF%E5%9B%9B_%E4%BB%8EIceberg%E5%8E%86%E5%8F%B2%E6%95%B0%E6%8D%AE%E5%90%AF%E5%8A%A8Flink%E4%BB%BB%E5%8A%A1.png" alt></p><p>第四个场景，是采用 Iceberg 全量数据和 Kafka 的增量数据来 Bootstrap 新的 Flink 作业。我们现有的流作业在线上跑着，突然有一天某个业务方跑过来说，他们遇到一个新的计算场景，需要设计一个新的 Flink 作业，跑一遍去年一年的历史数据，跑完之后再对接到正在产生的 Kafka 增量数据。那么，这时候应该怎么办呢？</p><p>我们依然可以采用常见的 lamnda 架构，实时链路通过 Kafka -&gt; Flink -&gt; Iceberg 实时写入到数据湖，由于 Kafka 成本较高，保留最近 7 天数据即可，Iceberg 存储成本较低，可以存储全量的历史数据（按照 checkpoint 拆分成多个数据区间）。启动解析 Flink 作业的时候，只需要去拉取 Iceberg 的数据，跑完之后平滑的对接到 Kafka 数据即可。</p><h4 id="场景五-通过-Iceberg-数据来订正实时聚合结果"><a href="#场景五-通过-Iceberg-数据来订正实时聚合结果" class="headerlink" title="场景五: 通过 Iceberg 数据来订正实时聚合结果"></a>场景五: 通过 Iceberg 数据来订正实时聚合结果</h4><p><img src="%E5%9C%BA%E6%99%AF%E4%BA%94_%E9%80%9A%E8%BF%87Iceberg%E6%95%B0%E6%8D%AE%E6%9D%A5%E8%AE%A2%E6%AD%A3%E5%AE%9E%E6%97%B6%E8%81%9A%E5%90%88%E7%BB%93%E6%9E%9C.png" alt></p><p>第五个场景，和第四个场景类似。同样是在 lambda 架构下，实时链路由于事件丢失或者到达顺序的问题，可能导致流计算结果不一定完全准确，这时候一般都需要全量的历史数据来订正实时计算的结果。而 Iceberg 可以很好的充当这个角色，因为它可以高性价比的管理好历史数据。</p><h3 id="Why-Iceberg"><a href="#Why-Iceberg" class="headerlink" title="Why Iceberg"></a>Why Iceberg</h3><h4 id="Delta-vs-Hudi-vs-Iceberg"><a href="#Delta-vs-Hudi-vs-Iceberg" class="headerlink" title="Delta vs Hudi vs Iceberg"></a>Delta vs Hudi vs Iceberg</h4><p><img src="Delta_Hudi_Iceberg%E4%B8%89%E5%A4%A7%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE%E5%AF%B9%E6%AF%94%E6%80%BB%E7%BB%93%E5%9B%BE.png" alt></p><table><thead><tr><th>Items</th><th>Open Source Delta</th><th>Apache Iceberg</th><th>Apache Hudi</th></tr></thead><tbody><tr><td>Open Source Time</td><td>2019/04/12</td><td>2018/11/06(incubation)</td><td>2019/01/17(incubation)</td></tr><tr><td>Github Star</td><td>2800+</td><td>692</td><td>1400+</td></tr><tr><td>Releases</td><td>5</td><td>5</td><td>48</td></tr><tr><td>ACID</td><td>Yes</td><td>Yes</td><td>Yes</td></tr><tr><td>Isolation Level</td><td>Write/Snapshot serialization</td><td>Write serialization</td><td>Snapshot serialization</td></tr><tr><td>Time Travel</td><td>Yes</td><td>Yes</td><td>Yes</td></tr><tr><td>Row-level DELETE(batch)</td><td>Yes</td><td>Ongoing</td><td>No</td></tr><tr><td>Row-level DELETE(streaming)</td><td>No</td><td>Ongoing</td><td>Yes</td></tr><tr><td>Abstracted Schema</td><td>No</td><td>Yes</td><td>No</td></tr><tr><td>Engine Pluggable</td><td>No</td><td>Yes</td><td>No</td></tr><tr><td>Open File Format</td><td>Yes</td><td>Yes</td><td>Yes(Data) + No(Log)</td></tr><tr><td>Filter push down</td><td>No</td><td>Yes</td><td>No</td></tr><tr><td>Auto-Compaction</td><td>No</td><td>Ongoing</td><td>Yes</td></tr><tr><td>Python support</td><td>Yes</td><td>Yes</td><td>No</td></tr><tr><td>File Encryption</td><td>No</td><td>Yes</td><td>No</td></tr></tbody></table><h4 id="Flink-为何选择-Apache-Iceberg"><a href="#Flink-为何选择-Apache-Iceberg" class="headerlink" title="Flink: 为何选择 Apache Iceberg"></a>Flink: 为何选择 Apache Iceberg</h4><ol><li>Iceberg 的设计和 Flink 数据湖的需求最匹配</li></ol><ul><li>完美解耦计算引擎和文件格式两层，便于接入多样化的计算引擎和文件格式</li><li>正确的完成了 Table Format这一层的功能需求</li><li>更容易成为 Table Format 层的事实标准</li></ul><ol start="2"><li>两个项目的长远规划相似</li></ol><ul><li>Apache Iceberg：打造流批一体的数据湖存储层</li><li>Apache Flink：打造流批一体的计算引擎</li><li>两者合力打造流批一体的数据湖架构</li></ul><ol start="3"><li>强大的社区资源</li></ol><ul><li>Apache Iceberg 始自 Netflix。Netflix 最早是 All In Cloud 的互联网巨头之一，也是最早在线上生产环境运行 Flink/Spark+Iceberg 这套数据湖方案的公司</li><li>支撑着 Apple、LinkedIn、Adobe、腾讯、网易等多家互联网巨头 PB 级的生产数据</li><li>严苛的文档审核、代码审核及测试设计。拥有来自其他 Apache项目的1个VP、7个PMC、4个Committer</li></ul><p>Delta 和 Hudi 跟 Spark 的代码路径绑定太深，尤其是写入路径。毕竟当时这两个项目设计之初，都多多少少把 Spark 作为它们默认的计算引擎了。而 Apache Iceberg 非常坚定，总值就是要做一个通用化设计的 Table Format。因此它完美的解耦了计算引擎和底下的存储系统，便于多样化计算引擎和文件格式，可以说正确的完成了数据湖架构中的 Table Format 这一层的实现。我们认为它也更容易成为 Table Format 层的开源事实标准。</p><p>另一方面，Apache Iceberg 正在朝着批流一体的数据湖存储层发展， manifest 和 snapshot 的设计，有效的隔离不同 transaction 的变更，非常方便批处理和增量计算。而我们知道 Apache Flink 已经是流批一体的计算引擎，可以说这二者的长远规划完美匹配，未来二者将合力打造流批一体的数据湖架构。</p><p>最后，我们还发现 Apache Iceberg 这个项目背后的社区资源非常丰富。在国外，Netflix、Apple、Linkedin、Adobe 等公司都有 PB 级别的生产数据运行在 Apache Iceberg 上；在国内，腾讯这样的巨头也有非常庞大的数据跑在 Apache Iceberg 之上，他们最大的一个业务每天有几十T的增量数据写入到 Iceberg。社区成员同样非常资深和多样化，拥有来自其他项目的 7 位 Apache PMC，1位 VP。在代码和设计的 review 上，也非常苛刻，一个稍微大点的 PR 涉及 100+ 的 comment 很常见，这些都使得 Apache Iceberg 的设计+代码质量比较高。</p><p>正是基于以上考虑，Apache Flink 最终选择了 Apache Iceberg 作为第一个数据湖接入项目。</p><h2 id="数据湖基本架构"><a href="#数据湖基本架构" class="headerlink" title="数据湖基本架构"></a>数据湖基本架构</h2><p><img src="%E6%95%B0%E6%8D%AE%E6%B9%96%E5%8F%82%E8%80%83%E6%9E%B6%E6%9E%84%E7%A4%BA%E6%84%8F.png" alt></p><p>上图所示是一个数据湖系统的参考架构。对于一个典型的数据湖而言，它与大数据平台相同的地方在于它也具备超大规模数据所需的存储和计算能力，能提供多模式的数据处理能力；增强点在于数据湖提供了更为完善的数据管理能力，具体体现在：</p><ul><li><p>更强大的数据接入能力<br>对各类异构数据源的定义管理能力，以及对于外部数据源相关数据的抽取迁移能力，抽取迁移的数据包括外部数据源的元数据与实际存储的数据。</p></li><li><p>更强大的数据管理能力<br>可分为基本管理能力和扩展管理能力。基本管理能力包括对各类元数据的管理、数据访问控制、数据资产管理，是一个数据湖系统所必须的。扩展管理能力包括任务管理、流程编排以及数据质量、数据治理相关的能力。任务管理和流程编排主要用来管理、编排、调度、监测在数据湖系统中处理数据的各类任务，通常情况下，数据湖构建者会通过读取数据湖的相关元数据，来实现与数据湖系统的融合。而数据质量和数据治理则是更为复杂的问题，一般情况下，数据湖系统不会直接提供相关功能，但是会开放各类接口或元数据，供有能力的企业/组织与已有的数据治理软件集成或者做定制开发。</p></li><li><p>可共享的元数据<br>数据湖中的各类计算引擎会与数据湖中的数据深度融合，而融合的基础就是数据湖的元数据。好的数据湖系统，计算引擎在处理数据时，能从元数据中直接获取数据存储位置、数据格式、数据模式、数据分布等信息，然后直接进行数据处理，而无需进行人工/编程干预。更进一步，好的数据湖系统还可以对数据湖中的数据进行访问控制，控制的力度可以做到“库表列行”等不同级别。</p></li></ul><p> “集中式存储”更多的是业务概念上的集中，本质上希望一个企业组织内部能在一个明确统一的地方进行沉淀。事实上，数据湖的存储应该是一类可按需扩展的分布式文件系统，大多数数据湖实践中也是推荐采用 S3/OSS/HDFS 等分布式文件系统作为数据湖的统一存储。</p><h2 id="各个厂商的数据湖解决方案"><a href="#各个厂商的数据湖解决方案" class="headerlink" title="各个厂商的数据湖解决方案"></a>各个厂商的数据湖解决方案</h2><h3 id="AWS"><a href="#AWS" class="headerlink" title="AWS"></a>AWS</h3><p><img src="AWS%E6%95%B0%E6%8D%AE%E6%B9%96%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.png" alt></p><h3 id="华为"><a href="#华为" class="headerlink" title="华为"></a>华为</h3><p><img src="%E5%8D%8E%E4%B8%BA%E6%95%B0%E6%8D%AE%E6%B9%96%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.png" alt></p><h3 id="阿里云"><a href="#阿里云" class="headerlink" title="阿里云"></a>阿里云</h3><p><img src="%E9%98%BF%E9%87%8C%E4%BA%91%E6%95%B0%E6%8D%AE%E6%B9%96%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.png" alt></p><h3 id="Azure"><a href="#Azure" class="headerlink" title="Azure"></a>Azure</h3><p><img src="Azure%E6%95%B0%E6%8D%AE%E6%B9%96%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.png" alt></p><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://zhuanlan.zhihu.com/p/142756094" target="_blank" rel="noopener">“新晋网红”数据湖到底该如何理解？</a><br><a href="https://blog.51cto.com/u_15023245/2619826" target="_blank" rel="noopener">基于 Flink+Iceberg 构建企业级实时数据湖 - 文章</a><br><a href="https://www.bilibili.com/video/BV14A411J7e6?p=4" target="_blank" rel="noopener">基于 Flink+Iceberg 构建企业级实时数据湖 - 视频</a><br><a href="https://help.aliyun.com/document_detail/70378.html?spm=5176.21620736.J_5253785160.6.731041d2lYoMlv" target="_blank" rel="noopener">阿里云 云原生数据湖分析 DLA 帮助文档</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;对于数据湖的入门者，本文记录一下对数据湖的初步认识。&lt;/p&gt;
    
    </summary>
    
      <category term="DataLake" scheme="http://yoursite.com/categories/DataLake/"/>
    
    
  </entry>
  
  <entry>
    <title>晚熟的人</title>
    <link href="http://yoursite.com/2021/01/10/%E6%99%9A%E7%86%9F%E7%9A%84%E4%BA%BA/"/>
    <id>http://yoursite.com/2021/01/10/晚熟的人/</id>
    <published>2021-01-10T05:58:40.000Z</published>
    <updated>2021-05-25T03:58:10.703Z</updated>
    
    <content type="html"><![CDATA[<p>就一直晚熟下去… 没有什么不好</p><a id="more"></a><p>于创作来说，不能过早地固步自封，不能过早的使自己的风格固化，<br>就是要不断地求新求变，努力试图突破自己，要不断的成长。<br>工作中，不必急功急利，保持学习热情，所有好运都会如期而至。<br>你成熟的越晚，说明创作创新的过程延续的越长。</p><p>于人性来说，本性善良的人都晚熟，并且是被”劣人”催熟的，后来虽然开窍了，<br>但也仍然善良与赤诚，不断地寻找同类，最后却成了最孤独的一个。<br>开窍了，就不能啥事都往外喷了，积蓄能量，厚积薄发。<br>你成熟的越晚，善良延续的越长，孤独而自省。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;就一直晚熟下去… 没有什么不好&lt;/p&gt;
    
    </summary>
    
      <category term="随笔" scheme="http://yoursite.com/categories/%E9%9A%8F%E7%AC%94/"/>
    
    
  </entry>
  
  <entry>
    <title>Apache Hudi</title>
    <link href="http://yoursite.com/2021/01/04/Apache-Hudi/"/>
    <id>http://yoursite.com/2021/01/04/Apache-Hudi/</id>
    <published>2021-01-03T17:17:31.000Z</published>
    <updated>2021-06-03T17:20:29.161Z</updated>
    
    <content type="html"><![CDATA[<div id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <div class="hbe-input-container">  <input type="password" id="hbePass" placeholder="" />    <label for="hbePass">Hey, password is required here.</label>    <div class="bottom-line"></div>  </div>  <script id="hbeData" type="hbeData" data-hmacdigest="7a13309d1b18da83d67f5e813bed9016874b53ac96444e0b19c070fd7d3e3d3a">e3562aa68b223e1c03dd60eecfbb4ec09217adc47939c9407bb5553f1a72086f64fcd5c1b773522b005f8a6763d76e309f4c1ee334b15d045936244f7d81e4378a898228740a8f021aca889558b5fcf250e987f1d87bc7598458b2c26c14e64519492805f4dcb9d5de0b8407389e58af8749934a2d92e9049c61fa40228742e2f30b5136ed25d014a22b58798c9bdbb7fda6505bbf327818b5335b53972af3435eb718167710ebe128e7d22c09f0e40d</script></div><script src="/lib/blog-encrypt.js"></script><link href="/css/blog-encrypt.css" rel="stylesheet" type="text/css">]]></content>
    
    <summary type="html">
    
      Here&#39;s something encrypted, password is required to continue reading.
    
    </summary>
    
      <category term="DataLake" scheme="http://yoursite.com/categories/DataLake/"/>
    
      <category term="Hudi" scheme="http://yoursite.com/categories/DataLake/Hudi/"/>
    
    
  </entry>
  
  <entry>
    <title>Flink源码剖析-flink-table-runtime-blink_TopN</title>
    <link href="http://yoursite.com/2020/09/30/Flink%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90-flink-table-runtime-blink-TopN/"/>
    <id>http://yoursite.com/2020/09/30/Flink源码剖析-flink-table-runtime-blink-TopN/</id>
    <published>2020-09-30T08:35:54.000Z</published>
    <updated>2020-10-10T05:58:06.371Z</updated>
    
    <content type="html"><![CDATA[<p>本文将基于 flink <code>release-1.11</code> 源码，简单分析下 TopN function 的实现。</p><a id="more"></a><p><img src="TopNFunction%E7%B1%BB%E7%BB%A7%E6%89%BF%E5%85%B3%E7%B3%BB%E5%9B%BE.png" alt></p><h2 id="AbstractTopNFunction"><a href="#AbstractTopNFunction" class="headerlink" title="AbstractTopNFunction"></a>AbstractTopNFunction</h2><p>AbstractTopNFunction 中有如下属性，定义 sortKey selector 和 comparator，rankEnd 相关参数：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// we set default topN size to 100</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> DEFAULT_TOPN_SIZE = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The util to compare two sortKey equals to each other.</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 生成 sortKey 比较器实例类的工具类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> GeneratedRecordComparator generatedSortKeyComparator;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * sortKey 比较器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> Comparator&lt;RowData&gt; sortKeyComparator;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> generateUpdateBefore;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 是否输出排序序号</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> outputRankNumber;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 输入的数据类型</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> RowDataTypeInfo inputRowType;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * key selector，选择 RowData 中的哪一个字段来排序</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> KeySelector&lt;RowData, RowData&gt; sortKeySelector;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * key 上下文，获取当前处理数据的 key</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> KeyContext keyContext;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 是否是固定的 TopN 集合大小</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> isConstantRankEnd;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * rankStart 值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> rankStart;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * rankEnd 在 RowData 中的下标</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> rankEndIndex;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * rankEnd 值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">long</span> rankEnd;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * java.util.Function，从 RowData 的某一个位置获取 rankEnd</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> Function&lt;RowData, Long&gt; rankEndFetcher;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 记录 rankEnd，可能随着输入数据动态变化</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> ValueState&lt;Long&gt; rankEndState;</span><br><span class="line"><span class="keyword">private</span> Counter invalidCounter;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 当 TopN 需要输出排位序号时，会用到这个对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> JoinedRowData outputRow;</span><br><span class="line"></span><br><span class="line"><span class="comment">// metrics</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">long</span> hitCount = <span class="number">0L</span>;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">long</span> requestCount = <span class="number">0L</span>;</span><br></pre></td></tr></table></figure><p>AbstractTopNFunction 的 <code>open()</code> 方法主要从状态后端获取 rankEndState，并初始化类属性： </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">(Configuration parameters)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"><span class="keyword">super</span>.open(parameters);</span><br><span class="line">initCleanupTimeState(<span class="string">"RankFunctionCleanupTime"</span>);</span><br><span class="line">outputRow = <span class="keyword">new</span> JoinedRowData();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!isConstantRankEnd) &#123;</span><br><span class="line"><span class="comment">// 从状态后端读取当前 rankEnd 值</span></span><br><span class="line">ValueStateDescriptor&lt;Long&gt; rankStateDesc = <span class="keyword">new</span> ValueStateDescriptor&lt;&gt;(<span class="string">"rankEnd"</span>, Types.LONG);</span><br><span class="line">rankEndState = getRuntimeContext().getState(rankStateDesc);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// compile comparator</span></span><br><span class="line"><span class="comment">// classLoader 加载 key comparator 类</span></span><br><span class="line">sortKeyComparator = generatedSortKeyComparator.newInstance(getRuntimeContext().getUserCodeClassLoader());</span><br><span class="line"><span class="comment">// 把确定不需要的对象直接赋值为 null</span></span><br><span class="line">generatedSortKeyComparator = <span class="keyword">null</span>;</span><br><span class="line">invalidCounter = getRuntimeContext().getMetricGroup().counter(<span class="string">"topn.invalidTopSize"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// initialize rankEndFetcher</span></span><br><span class="line"><span class="keyword">if</span> (!isConstantRankEnd) &#123;</span><br><span class="line">LogicalType rankEndIdxType = inputRowType.getLogicalTypes()[rankEndIndex];</span><br><span class="line"><span class="keyword">switch</span> (rankEndIdxType.getTypeRoot()) &#123;</span><br><span class="line"><span class="keyword">case</span> BIGINT:</span><br><span class="line">rankEndFetcher = (RowData row) -&gt; row.getLong(rankEndIndex);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> INTEGER:</span><br><span class="line">rankEndFetcher = (RowData row) -&gt; (<span class="keyword">long</span>) row.getInt(rankEndIndex);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> SMALLINT:</span><br><span class="line">rankEndFetcher = (RowData row) -&gt; (<span class="keyword">long</span>) row.getShort(rankEndIndex);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">LOG.error(<span class="string">"variable rank index column must be long, short or int type, while input type is &#123;&#125;"</span>,</span><br><span class="line">rankEndIdxType.getClass().getName());</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(</span><br><span class="line"><span class="string">"variable rank index column must be long type, while input type is "</span> +</span><br><span class="line">rankEndIdxType.getClass().getName());</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>AbstractTopNFunction 的 <code>initRankEnd()</code> 方法根据 input row 来动态获取 rankEnd ：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Initialize rank end.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> row input record</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> rank end</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">long</span> <span class="title">initRankEnd</span><span class="params">(RowData row)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (isConstantRankEnd) &#123;</span><br><span class="line"><span class="keyword">return</span> rankEnd;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">Long rankEndValue = rankEndState.value();</span><br><span class="line"><span class="keyword">long</span> curRankEnd = rankEndFetcher.apply(row);</span><br><span class="line"><span class="keyword">if</span> (rankEndValue == <span class="keyword">null</span>) &#123;</span><br><span class="line">rankEnd = curRankEnd;</span><br><span class="line"><span class="comment">// 同步更新到状态后端</span></span><br><span class="line">rankEndState.update(rankEnd);</span><br><span class="line"><span class="keyword">return</span> rankEnd;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">rankEnd = rankEndValue;</span><br><span class="line"><span class="keyword">if</span> (rankEnd != curRankEnd) &#123;</span><br><span class="line"><span class="comment">// increment the invalid counter when the current rank end not equal to previous rank end</span></span><br><span class="line">invalidCounter.inc();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> rankEnd;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>AbstractTopNFunction 的 <code>checkSortKeyInBufferRange()</code> 方法来判断 input row 是否应该被放到其 key 对应的 TopBuffer 中：</p><ol><li>将 input row 与 TopBuffer 中的最后一个 entry 比较，comparator 返回 true 则将 input row 丢到 TopBuffer 中；</li><li>comparator 返回 false，当前 TopBuffer 中的 entry 个数还没有达到默认的 TopN size，也将 input row 丢到 TopBuffer 中。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Checks whether the record should be put into the buffer.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> sortKey sortKey to test</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> buffer  buffer to add</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> true if the record should be put into the buffer.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">checkSortKeyInBufferRange</span><span class="params">(RowData sortKey, TopNBuffer buffer)</span> </span>&#123;</span><br><span class="line">Comparator&lt;RowData&gt; comparator = buffer.getSortKeyComparator();</span><br><span class="line">Map.Entry&lt;RowData, Collection&lt;RowData&gt;&gt; worstEntry = buffer.lastEntry();</span><br><span class="line"><span class="keyword">if</span> (worstEntry == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="comment">// return true if the buffer is empty. TopNBuffer 是空的，直接返回 true</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">RowData worstKey = worstEntry.getKey();</span><br><span class="line"><span class="comment">//执行 TopN 比较器</span></span><br><span class="line"><span class="keyword">int</span> compare = comparator.compare(sortKey, worstKey);</span><br><span class="line"><span class="keyword">if</span> (compare &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="comment">// 如果满足条件，可以放到 TopNBuffer 中</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// 到达的数据条数还没有达到默认的 TopN 大小 100，也可以放到 TopNBuffer 中</span></span><br><span class="line"><span class="keyword">return</span> buffer.getCurrentTopNum() &lt; getDefaultTopNSize();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><p>AbstractTopNFunction 的 <code>createOutputRow()</code> 方法用于构建 output row，区分带不带 rank 序号：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 构建 output row</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> inputRow input row</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> rank     排位序号</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> rowKind  描述一行 changelog 的行为种类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="doctag">@link</span> RowData&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> RowData <span class="title">createOutputRow</span><span class="params">(RowData inputRow, <span class="keyword">long</span> rank, RowKind rowKind)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (outputRankNumber) &#123;</span><br><span class="line"><span class="comment">// 需要输出 rank number</span></span><br><span class="line">GenericRowData rankRow = <span class="keyword">new</span> GenericRowData(<span class="number">1</span>);</span><br><span class="line"><span class="comment">// 第 0 个字段设置为排位序号，将 rank 专门放置在一个 RowData 中</span></span><br><span class="line">rankRow.setField(<span class="number">0</span>, rank);</span><br><span class="line"></span><br><span class="line">outputRow.replace(inputRow, rankRow);</span><br><span class="line">outputRow.setRowKind(rowKind);</span><br><span class="line"><span class="keyword">return</span> outputRow;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">inputRow.setRowKind(rowKind);</span><br><span class="line"><span class="keyword">return</span> inputRow;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="AppendOnlyTopNFunction"><a href="#AppendOnlyTopNFunction" class="headerlink" title="AppendOnlyTopNFunction"></a>AppendOnlyTopNFunction</h2><p>AppendOnlyTopNFunction 中有如下属性，状态后端 MapState 和本地堆内存 TopNBuffer 结合使用：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * sortKey 字段类型</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> RowDataTypeInfo sortKeyType;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * input row 的序列化类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> TypeSerializer&lt;RowData&gt; inputRowSer;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> cacheSize;</span><br><span class="line"></span><br><span class="line"><span class="comment">// a map state stores mapping from sort key to records list which is in topN</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * sortKey &lt;-&gt; 在 TopN 中的 RowData list</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> MapState&lt;RowData, List&lt;RowData&gt;&gt; dataState;</span><br><span class="line"></span><br><span class="line"><span class="comment">// the buffer stores mapping from sort key to records list, a heap mirror to dataState</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 当前 sortKey 对应的 TopNBuffer</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> TopNBuffer buffer;</span><br><span class="line"></span><br><span class="line"><span class="comment">// the kvSortedMap stores mapping from partition key to it's buffer</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * sortKey &lt;-&gt; TopNBuffer</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> Map&lt;RowData, TopNBuffer&gt; kvSortedMap;</span><br></pre></td></tr></table></figure><p>AppendOnlyTopNFunction 的 <code>open()</code> 方法中从状态后端中获取当前 key 的 TopN list：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">(Configuration parameters)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"><span class="keyword">super</span>.open(parameters);</span><br><span class="line"><span class="comment">// LRU的缓存大小=总的缓存大小/topN的缓存大小</span></span><br><span class="line"><span class="keyword">int</span> lruCacheSize = Math.max(<span class="number">1</span>, (<span class="keyword">int</span>) (cacheSize / getDefaultTopNSize()));</span><br><span class="line"><span class="comment">// 根据 key 缓存 LRU list</span></span><br><span class="line">kvSortedMap = <span class="keyword">new</span> LRUMap&lt;&gt;(lruCacheSize);</span><br><span class="line">LOG.info(<span class="string">"Top&#123;&#125; operator is using LRU caches key-size: &#123;&#125;"</span>, getDefaultTopNSize(), lruCacheSize);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据 key 记录当前的 TopN list</span></span><br><span class="line"><span class="comment">// RowDataTypeInfo</span></span><br><span class="line">ListTypeInfo&lt;RowData&gt; valueTypeInfo = <span class="keyword">new</span> ListTypeInfo&lt;&gt;(inputRowType);</span><br><span class="line">MapStateDescriptor&lt;RowData, List&lt;RowData&gt;&gt; mapStateDescriptor = <span class="keyword">new</span> MapStateDescriptor&lt;&gt;(</span><br><span class="line"><span class="string">"data-state-with-append"</span>, sortKeyType, valueTypeInfo);</span><br><span class="line">dataState = getRuntimeContext().getMapState(mapStateDescriptor);</span><br><span class="line"></span><br><span class="line"><span class="comment">// metrics</span></span><br><span class="line">registerMetric(kvSortedMap.size() * getDefaultTopNSize());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>AppendOnlyTopNFunction 的 <code>processElement()</code> 方法处理数据，判断当前 input row 是否可以丢到 TopNBuffer 中：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processElement</span><span class="params">(RowData input, Context context, Collector&lt;RowData&gt; out)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"><span class="comment">// 获取当前时间，记录在上下文的计时器中</span></span><br><span class="line"><span class="keyword">long</span> currentTime = context.timerService().currentProcessingTime();</span><br><span class="line"><span class="comment">// register state-cleanup timer</span></span><br><span class="line">registerProcessingCleanupTimer(context, currentTime);</span><br><span class="line"></span><br><span class="line">initHeapStates();</span><br><span class="line">initRankEnd(input);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从输入的数据中抽取 sortKey</span></span><br><span class="line">RowData sortKey = sortKeySelector.getKey(input);</span><br><span class="line"><span class="comment">// check whether the sortKey is in the topN range</span></span><br><span class="line"><span class="comment">// 根据 sortKey 判断当前数据是否应该被放到 TopNBuffer 中</span></span><br><span class="line"><span class="keyword">if</span> (checkSortKeyInBufferRange(sortKey, buffer)) &#123;</span><br><span class="line"><span class="comment">// insert sort key into buffer</span></span><br><span class="line">buffer.put(sortKey, inputRowSer.copy(input));</span><br><span class="line">Collection&lt;RowData&gt; inputs = buffer.get(sortKey);</span><br><span class="line"><span class="comment">// update data state</span></span><br><span class="line"><span class="comment">// copy a new collection to avoid mutating state values, see CopyOnWriteStateMap,</span></span><br><span class="line"><span class="comment">// otherwise, the result might be corrupt.</span></span><br><span class="line"><span class="comment">// don't need to perform a deep copy, because RowData elements will not be updated</span></span><br><span class="line"><span class="comment">// 同步记录到 MapState 中</span></span><br><span class="line">dataState.put(sortKey, <span class="keyword">new</span> ArrayList&lt;&gt;(inputs));</span><br><span class="line"><span class="keyword">if</span> (outputRankNumber || hasOffset()) &#123;</span><br><span class="line"><span class="comment">// the without-number-algorithm can't handle topN with offset,</span></span><br><span class="line"><span class="comment">// so use the with-number-algorithm to handle offset</span></span><br><span class="line">processElementWithRowNumber(sortKey, input, out);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">processElementWithoutRowNumber(input, out);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>AppendOnlyTopNFunction 的 <code>initHeapStates()</code> 是在处理 input row 之前，在堆内存中初始化 TopNBuffer，并将状态后端存储的 TopN list 设置到 TopNBuffer 中：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initHeapStates</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">requestCount += <span class="number">1</span>;</span><br><span class="line"><span class="comment">// 从 KeyContext 中获取当前的key</span></span><br><span class="line">RowData currentKey = (RowData) keyContext.getCurrentKey();</span><br><span class="line"><span class="comment">// 取出 key 对应的 TopNBuffer</span></span><br><span class="line">buffer = kvSortedMap.get(currentKey);</span><br><span class="line"><span class="keyword">if</span> (buffer == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="comment">// buffer 为 null，则为此 key 构建 TopNBuffer，为其设置 key comparator</span></span><br><span class="line">buffer = <span class="keyword">new</span> TopNBuffer(sortKeyComparator, ArrayList::<span class="keyword">new</span>);</span><br><span class="line">kvSortedMap.put(currentKey, buffer);</span><br><span class="line"><span class="comment">// restore buffer</span></span><br><span class="line"><span class="comment">// 读取 state 中记录的 TopN list，塞到这个 TopNBuffer 里</span></span><br><span class="line">Iterator&lt;Map.Entry&lt;RowData, List&lt;RowData&gt;&gt;&gt; iter = dataState.iterator();</span><br><span class="line"><span class="keyword">if</span> (iter != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line">Map.Entry&lt;RowData, List&lt;RowData&gt;&gt; entry = iter.next();</span><br><span class="line">RowData sortKey = entry.getKey();</span><br><span class="line">List&lt;RowData&gt; values = entry.getValue();</span><br><span class="line"><span class="comment">// the order is preserved</span></span><br><span class="line">buffer.putAll(sortKey, values);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// buffer 不为 null，记录命中一次 TopNBuffer 缓存</span></span><br><span class="line">hitCount += <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>AppendOnlyTopNFunction 的 <code>processElementWithoutRowNumber()</code> 方法是处理丢到 TopNBuffer 中的 input row，决定这条数据是否被 Delete ： </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processElementWithoutRowNumber</span><span class="params">(RowData input, Collector&lt;RowData&gt; out)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"><span class="comment">// remove retired element</span></span><br><span class="line"><span class="comment">// 当前 TopNBuffer 中缓存的数据条数大于 TopN 的 N</span></span><br><span class="line"><span class="keyword">if</span> (buffer.getCurrentTopNum() &gt; rankEnd) &#123;</span><br><span class="line">Map.Entry&lt;RowData, Collection&lt;RowData&gt;&gt; lastEntry = buffer.lastEntry();</span><br><span class="line">RowData lastKey = lastEntry.getKey();</span><br><span class="line">Collection&lt;RowData&gt; lastList = lastEntry.getValue();</span><br><span class="line">RowData lastElement = buffer.lastElement();</span><br><span class="line"><span class="keyword">int</span> size = lastList.size();</span><br><span class="line"><span class="comment">// remove last one</span></span><br><span class="line"><span class="keyword">if</span> (size &lt;= <span class="number">1</span>) &#123;</span><br><span class="line"><span class="comment">// 移除最后一个元素</span></span><br><span class="line">buffer.removeAll(lastKey);</span><br><span class="line">dataState.remove(lastKey);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// 移除大于 TopN 的 N 之后的元素</span></span><br><span class="line">buffer.removeLast();</span><br><span class="line"><span class="comment">// last element has been removed from lastList, we have to copy a new collection</span></span><br><span class="line"><span class="comment">// for lastList to avoid mutating state values, see CopyOnWriteStateMap,</span></span><br><span class="line"><span class="comment">// otherwise, the result might be corrupt.</span></span><br><span class="line"><span class="comment">// don't need to perform a deep copy, because RowData elements will not be updated</span></span><br><span class="line"><span class="comment">// 更新状态后端</span></span><br><span class="line">dataState.put(lastKey, <span class="keyword">new</span> ArrayList&lt;&gt;(lastList));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (size == <span class="number">0</span> || input.equals(lastElement)) &#123;</span><br><span class="line"><span class="comment">// input 的数据和 TopNBuffer 中的最后一个元素相同，则直接返回</span></span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// lastElement shouldn't be null</span></span><br><span class="line">collectDelete(out, lastElement);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// it first appears in the TopN, send INSERT message</span></span><br><span class="line">collectInsert(out, input);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="AppendOnlyTopNFunctionTest"><a href="#AppendOnlyTopNFunctionTest" class="headerlink" title="AppendOnlyTopNFunctionTest"></a>AppendOnlyTopNFunctionTest</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Tests for &#123;<span class="doctag">@link</span> AppendOnlyTopNFunction&#125;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppendOnlyTopNFunctionTest</span> <span class="keyword">extends</span> <span class="title">TopNFunctionTestBase</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> AbstractTopNFunction <span class="title">createFunction</span><span class="params">(RankType rankType, RankRange rankRange,</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">boolean</span> generateUpdateBefore, <span class="keyword">boolean</span> outputRankNumber)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> AppendOnlyTopNFunction(minTime.toMilliseconds(),</span><br><span class="line">maxTime.toMilliseconds(),</span><br><span class="line">inputRowType,</span><br><span class="line">sortKeyComparator,</span><br><span class="line">sortKeySelector,</span><br><span class="line">rankType,</span><br><span class="line">rankRange,</span><br><span class="line">generateUpdateBefore,</span><br><span class="line">outputRankNumber,</span><br><span class="line">cacheSize);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testVariableRankRange</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">AbstractTopNFunction func = createFunction(RankType.ROW_NUMBER,</span><br><span class="line"><span class="comment">// 指定数据的第2个字段值为 rankEnd，动态指定 TopN 集合的大小</span></span><br><span class="line"><span class="keyword">new</span> VariableRankRange(<span class="number">1</span>),</span><br><span class="line"><span class="keyword">true</span>,</span><br><span class="line"><span class="comment">// 不用输出 topN 的排序序号</span></span><br><span class="line"><span class="keyword">false</span>);</span><br><span class="line"><span class="comment">// 将 TopNFunction 包装进 KeyedProcessOperator</span></span><br><span class="line">OneInputStreamOperatorTestHarness&lt;RowData, RowData&gt; testHarness = createTestHarness(func);</span><br><span class="line"><span class="comment">// 测试类准备工作</span></span><br><span class="line">testHarness.open();</span><br><span class="line"></span><br><span class="line"><span class="comment">// KeyedProcessOperator 作为 input operator 模拟处理数据</span></span><br><span class="line">testHarness.processElement(insertRecord(<span class="string">"book"</span>, <span class="number">2L</span>, <span class="number">12</span>)); <span class="comment">// 开始处理(book,2,12)，key 为 book，rankEnd 为 2，加入 TopN 集合</span></span><br><span class="line">testHarness.processElement(insertRecord(<span class="string">"book"</span>, <span class="number">2L</span>, <span class="number">19</span>)); <span class="comment">// 开始处理(book,2,19)，key 为 book，rankEnd 为 2，加入 TopN 集合</span></span><br><span class="line">testHarness.processElement(insertRecord(<span class="string">"book"</span>, <span class="number">2L</span>, <span class="number">11</span>)); <span class="comment">// 开始处理(book,2,11)，key 为 book，rankEnd 为 2，超出 TopN 集合容量，因此需要先删除 (book,2,19)，留下 2 个较小的</span></span><br><span class="line">testHarness.processElement(insertRecord(<span class="string">"fruit"</span>, <span class="number">1L</span>, <span class="number">33</span>)); <span class="comment">// 开始处理(fruit,1,33)，key 为 fruit，rankEnd 为 1，加入 TopN 集合</span></span><br><span class="line">testHarness.processElement(insertRecord(<span class="string">"fruit"</span>, <span class="number">1L</span>, <span class="number">44</span>)); <span class="comment">// 开始处理(fruit,1,44)，key 为 fruit，rankEnd 为 1，44 &gt; 33，直接过滤掉</span></span><br><span class="line">testHarness.processElement(insertRecord(<span class="string">"fruit"</span>, <span class="number">1L</span>, <span class="number">22</span>)); <span class="comment">// 开始处理(fruit,1,22)，key 为 fruit，rankEnd 为 1，超出 TopN 集合容量，因此需要先删除 (fruit,1,33)，留下 1 个较小的</span></span><br><span class="line">testHarness.close();</span><br><span class="line"></span><br><span class="line">ConcurrentLinkedQueue&lt;Object&gt; output = testHarness.getOutput();</span><br><span class="line"><span class="keyword">for</span> (Object o : output) &#123;</span><br><span class="line">StreamRecord streamRecord = (StreamRecord) o;</span><br><span class="line">System.out.println(<span class="string">"Output element -&gt; "</span> + streamRecord.getValue());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">List&lt;Object&gt; expectedOutput = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="comment">// ("book", 2L, 12)</span></span><br><span class="line">expectedOutput.add(insertRecord(<span class="string">"book"</span>, <span class="number">2L</span>, <span class="number">12</span>));</span><br><span class="line"><span class="comment">// ("book", 2L, 19)</span></span><br><span class="line">expectedOutput.add(insertRecord(<span class="string">"book"</span>, <span class="number">2L</span>, <span class="number">19</span>));</span><br><span class="line"><span class="comment">// ("book", 2L, 11)</span></span><br><span class="line">expectedOutput.add(deleteRecord(<span class="string">"book"</span>, <span class="number">2L</span>, <span class="number">19</span>));</span><br><span class="line">expectedOutput.add(insertRecord(<span class="string">"book"</span>, <span class="number">2L</span>, <span class="number">11</span>));</span><br><span class="line"><span class="comment">// ("fruit", 1L, 33)</span></span><br><span class="line">expectedOutput.add(insertRecord(<span class="string">"fruit"</span>, <span class="number">1L</span>, <span class="number">33</span>));</span><br><span class="line"><span class="comment">// ("fruit", 1L, 44)</span></span><br><span class="line"><span class="comment">// ("fruit", 1L, 22)</span></span><br><span class="line">expectedOutput.add(deleteRecord(<span class="string">"fruit"</span>, <span class="number">1L</span>, <span class="number">33</span>));</span><br><span class="line">expectedOutput.add(insertRecord(<span class="string">"fruit"</span>, <span class="number">1L</span>, <span class="number">22</span>));</span><br><span class="line">assertorWithoutRowNumber</span><br><span class="line">.assertOutputEquals(<span class="string">"output wrong."</span>, expectedOutput, testHarness.getOutput());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">TopNFunctionTestBase</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// key 比较器的类加载工具类，生成一个 key 比较器实例</span></span><br><span class="line">    <span class="keyword">static</span> GeneratedRecordComparator sortKeyComparator = <span class="keyword">new</span> GeneratedRecordComparator(<span class="string">""</span>, <span class="string">""</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]) &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1434685115916728955L</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RecordComparator <span class="title">newInstance</span><span class="params">(ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// compare(RowData o1, RowData o2) 方法中比较 o1 和 o2 的第 0 个元素，从小到大比较</span></span><br><span class="line"><span class="keyword">return</span> IntRecordComparator.INSTANCE;</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">TopNFunctionTestBase</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> sortKeyIdx = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// key 选择器，比较 RowData 中的第 2 位置的元素</span></span><br><span class="line">BinaryRowDataKeySelector sortKeySelector = <span class="keyword">new</span> BinaryRowDataKeySelector(<span class="keyword">new</span> <span class="keyword">int</span>[]&#123;sortKeyIdx&#125;,</span><br><span class="line">inputRowType.getLogicalTypes());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输出结果为：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Output element -&gt; +I(book,2,12)   </span><br><span class="line">Output element -&gt; +I(book,2,19)   </span><br><span class="line">Output element -&gt; -D(book,2,19)    </span><br><span class="line">Output element -&gt; +I(book,2,11)   </span><br><span class="line">Output element -&gt; +I(fruit,1,33)  </span><br><span class="line">Output element -&gt; -D(fruit,1,33)  </span><br><span class="line">Output element -&gt; +I(fruit,1,22)</span><br></pre></td></tr></table></figure><h2 id="RetractableTopNFunction"><a href="#RetractableTopNFunction" class="headerlink" title="RetractableTopNFunction"></a>RetractableTopNFunction</h2><p>内部使用 TreeMap 进行 TopN 排序，可以对数据执行撤回操作，RowKind.UPDATE_BEFORE（-U）。</p><p>RetractableTopNFunction 中有如下属性，记录相同的 RowData 列表，使用 sortedMap 来进行 TopN 排序：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// a map state stores mapping from sort key to records list</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * RowData &lt;-&gt;  相同的 RowData list，状态后端远程维护</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> MapState&lt;RowData, List&lt;RowData&gt;&gt; dataState;</span><br><span class="line"></span><br><span class="line"><span class="comment">// a sorted map stores mapping from sort key to records count</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * RowData &lt;-&gt; 对应的记录个数，ValueState 中记录有序的 RowData</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> ValueState&lt;SortedMap&lt;RowData, Long&gt;&gt; treeMap;</span><br></pre></td></tr></table></figure><p>RetractableTopNFunction 中的 <code>processElement()</code> 方法，按照数据的 RowKind 分别执行 emit 和 retract 操作：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processElement</span><span class="params">(RowData input, Context ctx, Collector&lt;RowData&gt; out)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"><span class="keyword">long</span> currentTime = ctx.timerService().currentProcessingTime();</span><br><span class="line"><span class="comment">// register state-cleanup timer</span></span><br><span class="line">registerProcessingCleanupTimer(ctx, currentTime);</span><br><span class="line">initRankEnd(input);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从状态后端中获取有序 RowData 的集合</span></span><br><span class="line">SortedMap&lt;RowData, Long&gt; sortedMap = treeMap.value();</span><br><span class="line"><span class="keyword">if</span> (sortedMap == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="comment">// 如果为 null，则新建一个，指定 sortKey comparator</span></span><br><span class="line">sortedMap = <span class="keyword">new</span> TreeMap&lt;&gt;(sortKeyComparator);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">RowData sortKey = sortKeySelector.getKey(input);</span><br><span class="line"><span class="comment">// RowKind.INSERT 或 RowKind.UPDATE_AFTER</span></span><br><span class="line"><span class="keyword">boolean</span> isAccumulate = RowDataUtil.isAccumulateMsg(input);</span><br><span class="line"><span class="comment">// erase row kind for further state accessing</span></span><br><span class="line">input.setRowKind(RowKind.INSERT);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (isAccumulate) &#123;</span><br><span class="line"><span class="comment">// update sortedMap，记录当前 sortKey 的记录数到状态后端</span></span><br><span class="line"><span class="keyword">if</span> (sortedMap.containsKey(sortKey)) &#123;</span><br><span class="line">sortedMap.put(sortKey, sortedMap.get(sortKey) + <span class="number">1</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">sortedMap.put(sortKey, <span class="number">1L</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// emit</span></span><br><span class="line"><span class="keyword">if</span> (outputRankNumber || hasOffset()) &#123;</span><br><span class="line"><span class="comment">// the without-number-algorithm can't handle topN with offset,</span></span><br><span class="line"><span class="comment">// so use the with-number-algorithm to handle offset</span></span><br><span class="line">emitRecordsWithRowNumber(sortedMap, sortKey, input, out);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">emitRecordsWithoutRowNumber(sortedMap, sortKey, input, out);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 同步更新到状态后端</span></span><br><span class="line"><span class="comment">// update data state</span></span><br><span class="line">List&lt;RowData&gt; inputs = dataState.get(sortKey);</span><br><span class="line"><span class="keyword">if</span> (inputs == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="comment">// the sort key is never seen</span></span><br><span class="line">inputs = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">&#125;</span><br><span class="line">inputs.add(input);</span><br><span class="line">dataState.put(sortKey, inputs);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// emit updates first，先输出 update 操作，-U 代表执行撤回操作</span></span><br><span class="line"><span class="keyword">if</span> (outputRankNumber || hasOffset()) &#123;</span><br><span class="line"><span class="comment">// the without-number-algorithm can't handle topN with offset,</span></span><br><span class="line"><span class="comment">// so use the with-number-algorithm to handle offset</span></span><br><span class="line">retractRecordWithRowNumber(sortedMap, sortKey, input, out);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">retractRecordWithoutRowNumber(sortedMap, sortKey, input, out);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// and then update sortedMap</span></span><br><span class="line"><span class="keyword">if</span> (sortedMap.containsKey(sortKey)) &#123;</span><br><span class="line"><span class="keyword">long</span> count = sortedMap.get(sortKey) - <span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span> (count == <span class="number">0</span>) &#123;</span><br><span class="line">sortedMap.remove(sortKey);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">sortedMap.put(sortKey, count);</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (sortedMap.isEmpty()) &#123;</span><br><span class="line"><span class="keyword">if</span> (lenient) &#123;</span><br><span class="line">LOG.warn(STATE_CLEARED_WARN_MSG);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(STATE_CLEARED_WARN_MSG);</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line"><span class="string">"Can not retract a non-existent record. This should never happen."</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 更新状态后端中记录的 sortedMap</span></span><br><span class="line">treeMap.update(sortedMap);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>RetractableTopNFunction 中的 <code>emitRecordsWithRowNumber()</code> 方法正常输出排序行：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">emitRecordsWithRowNumber</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">SortedMap&lt;RowData, Long&gt; sortedMap, RowData sortKey, RowData inputRow, Collector&lt;RowData&gt; out)</span></span></span><br><span class="line"><span class="function"><span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">Iterator&lt;Map.Entry&lt;RowData, Long&gt;&gt; iterator = sortedMap.entrySet().iterator();</span><br><span class="line"><span class="keyword">long</span> currentRank = <span class="number">0L</span>;</span><br><span class="line">RowData currentRow = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">boolean</span> findsSortKey = <span class="keyword">false</span>;</span><br><span class="line"><span class="keyword">while</span> (iterator.hasNext() &amp;&amp; isInRankEnd(currentRank)) &#123;</span><br><span class="line">Map.Entry&lt;RowData, Long&gt; entry = iterator.next();</span><br><span class="line">RowData key = entry.getKey();</span><br><span class="line"><span class="keyword">if</span> (!findsSortKey &amp;&amp; key.equals(sortKey)) &#123;</span><br><span class="line">currentRank += entry.getValue();</span><br><span class="line">currentRow = inputRow;</span><br><span class="line"><span class="comment">// 从 sortedMap 中找到当前的 sortKey</span></span><br><span class="line">findsSortKey = <span class="keyword">true</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (findsSortKey) &#123;</span><br><span class="line">List&lt;RowData&gt; inputs = dataState.get(key);</span><br><span class="line"><span class="keyword">if</span> (inputs == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="comment">// Skip the data if it's state is cleared because of state ttl.</span></span><br><span class="line"><span class="keyword">if</span> (lenient) &#123;</span><br><span class="line">LOG.warn(STATE_CLEARED_WARN_MSG);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(STATE_CLEARED_WARN_MSG);</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> (i &lt; inputs.size() &amp;&amp; isInRankEnd(currentRank)) &#123;</span><br><span class="line">RowData prevRow = inputs.get(i); <span class="comment">// 取出前一个row</span></span><br><span class="line">collectUpdateBefore(out, prevRow, currentRank);</span><br><span class="line">collectUpdateAfter(out, currentRow, currentRank); <span class="comment">//输出当前行</span></span><br><span class="line">currentRow = prevRow; <span class="comment">// 前一行赋给当前行</span></span><br><span class="line">currentRank += <span class="number">1</span>;</span><br><span class="line">i++;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">currentRank += entry.getValue();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (isInRankEnd(currentRank)) &#123;</span><br><span class="line"><span class="comment">// there is no enough elements in Top-N, emit INSERT message for the new record.</span></span><br><span class="line">collectInsert(out, currentRow, currentRank);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>RetractableTopNFunction 中的 <code>retractRecordWithRowNumber()</code> 方法将撤回行从 sortedMap 中移除，并更新前一行的排位输出：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">retractRecordWithRowNumber</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">SortedMap&lt;RowData, Long&gt; sortedMap, RowData sortKey, RowData inputRow, Collector&lt;RowData&gt; out)</span></span></span><br><span class="line"><span class="function"><span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">Iterator&lt;Map.Entry&lt;RowData, Long&gt;&gt; iterator = sortedMap.entrySet().iterator();</span><br><span class="line"><span class="keyword">long</span> currentRank = <span class="number">0L</span>;</span><br><span class="line">RowData prevRow = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">boolean</span> findsSortKey = <span class="keyword">false</span>;</span><br><span class="line"><span class="keyword">while</span> (iterator.hasNext() &amp;&amp; isInRankEnd(currentRank)) &#123;</span><br><span class="line">Map.Entry&lt;RowData, Long&gt; entry = iterator.next();</span><br><span class="line">RowData key = entry.getKey();</span><br><span class="line"><span class="keyword">if</span> (!findsSortKey &amp;&amp; key.equals(sortKey)) &#123;</span><br><span class="line">List&lt;RowData&gt; inputs = dataState.get(key);</span><br><span class="line"><span class="keyword">if</span> (inputs == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="comment">// Skip the data if it's state is cleared because of state ttl.</span></span><br><span class="line"><span class="keyword">if</span> (lenient) &#123;</span><br><span class="line">LOG.warn(STATE_CLEARED_WARN_MSG);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(STATE_CLEARED_WARN_MSG);</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">Iterator&lt;RowData&gt; inputIter = inputs.iterator();</span><br><span class="line"><span class="keyword">while</span> (inputIter.hasNext() &amp;&amp; isInRankEnd(currentRank)) &#123;</span><br><span class="line">RowData currentRow = inputIter.next();</span><br><span class="line"><span class="keyword">if</span> (!findsSortKey &amp;&amp; equaliser.equals(currentRow, inputRow)) &#123;</span><br><span class="line">prevRow = currentRow;</span><br><span class="line">findsSortKey = <span class="keyword">true</span>;</span><br><span class="line">inputIter.remove();</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (findsSortKey) &#123;</span><br><span class="line">collectUpdateBefore(out, prevRow, currentRank);</span><br><span class="line">collectUpdateAfter(out, currentRow, currentRank);</span><br><span class="line">prevRow = currentRow;</span><br><span class="line">&#125;</span><br><span class="line">currentRank += <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (inputs.isEmpty()) &#123;</span><br><span class="line">dataState.remove(key); <span class="comment">// 将撤回的行从 sortedMap 中移除</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">dataState.put(key, inputs);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (findsSortKey) &#123;</span><br><span class="line">List&lt;RowData&gt; inputs = dataState.get(key);</span><br><span class="line"><span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> (i &lt; inputs.size() &amp;&amp; isInRankEnd(currentRank)) &#123;</span><br><span class="line">RowData currentRow = inputs.get(i); <span class="comment">// 上一行作为当前行</span></span><br><span class="line"><span class="comment">// 处理上一条数据</span></span><br><span class="line">collectUpdateBefore(out, prevRow, currentRank);</span><br><span class="line"><span class="comment">// 输出当前行</span></span><br><span class="line">collectUpdateAfter(out, currentRow, currentRank);</span><br><span class="line">prevRow = currentRow;</span><br><span class="line">currentRank += <span class="number">1</span>;</span><br><span class="line">i++;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">currentRank += entry.getValue();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (isInRankEnd(currentRank)) &#123;</span><br><span class="line"><span class="comment">// there is no enough elements in Top-N, emit DELETE message for the retract record.</span></span><br><span class="line">collectDelete(out, prevRow, currentRank);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="RetractableTopNFunctionTest"><a href="#RetractableTopNFunctionTest" class="headerlink" title="RetractableTopNFunctionTest"></a>RetractableTopNFunctionTest</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Tests for &#123;<span class="doctag">@link</span> RetractableTopNFunction&#125;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RetractableTopNFunctionTest</span> <span class="keyword">extends</span> <span class="title">TopNFunctionTestBase</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> AbstractTopNFunction <span class="title">createFunction</span><span class="params">(RankType rankType, RankRange rankRange,</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">boolean</span> generateUpdateBefore, <span class="keyword">boolean</span> outputRankNumber)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> RetractableTopNFunction(</span><br><span class="line">minTime.toMilliseconds(),</span><br><span class="line">maxTime.toMilliseconds(),</span><br><span class="line">inputRowType,</span><br><span class="line">sortKeyComparator,</span><br><span class="line">sortKeySelector,</span><br><span class="line">rankType,</span><br><span class="line">rankRange,</span><br><span class="line">generatedEqualiser,</span><br><span class="line">generateUpdateBefore,</span><br><span class="line">outputRankNumber);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testProcessRetractMessageWithNotGenerateUpdateBefore</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">AbstractTopNFunction func = createFunction(RankType.ROW_NUMBER,</span><br><span class="line"><span class="comment">// 固定的 TopN 集合大小，1～2</span></span><br><span class="line"><span class="keyword">new</span> ConstantRankRange(<span class="number">1</span>, <span class="number">2</span>),</span><br><span class="line"><span class="keyword">false</span>,</span><br><span class="line"><span class="comment">// 输出 TopN 的排序序号</span></span><br><span class="line"><span class="keyword">true</span>);</span><br><span class="line">OneInputStreamOperatorTestHarness&lt;RowData, RowData&gt; testHarness = createTestHarness(func);</span><br><span class="line">testHarness.open();</span><br><span class="line">testHarness.processElement(insertRecord(<span class="string">"book"</span>, <span class="number">1L</span>, <span class="number">12</span>));</span><br><span class="line">testHarness.processElement(insertRecord(<span class="string">"book"</span>, <span class="number">2L</span>, <span class="number">19</span>));</span><br><span class="line">testHarness.processElement(insertRecord(<span class="string">"book"</span>, <span class="number">4L</span>, <span class="number">11</span>));</span><br><span class="line">testHarness.processElement(updateBeforeRecord(<span class="string">"book"</span>, <span class="number">1L</span>, <span class="number">12</span>));</span><br><span class="line">testHarness.processElement(insertRecord(<span class="string">"book"</span>, <span class="number">5L</span>, <span class="number">11</span>));</span><br><span class="line">testHarness.processElement(insertRecord(<span class="string">"fruit"</span>, <span class="number">4L</span>, <span class="number">33</span>));</span><br><span class="line">testHarness.processElement(insertRecord(<span class="string">"fruit"</span>, <span class="number">3L</span>, <span class="number">44</span>));</span><br><span class="line">testHarness.processElement(insertRecord(<span class="string">"fruit"</span>, <span class="number">5L</span>, <span class="number">22</span>));</span><br><span class="line">testHarness.close();</span><br><span class="line"></span><br><span class="line">ConcurrentLinkedQueue&lt;Object&gt; output = testHarness.getOutput();</span><br><span class="line"><span class="keyword">for</span> (Object o : output) &#123;</span><br><span class="line">StreamRecord streamRecord = (StreamRecord) o;</span><br><span class="line">System.out.println(<span class="string">"Output element -&gt; "</span> + streamRecord.getValue());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">List&lt;Object&gt; expectedOutput = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="comment">// ("book", 1L, 12)</span></span><br><span class="line"><span class="comment">// sortedMap -&gt; [("book", 1L, 12)]</span></span><br><span class="line">expectedOutput.add(insertRecord(<span class="string">"book"</span>, <span class="number">1L</span>, <span class="number">12</span>, <span class="number">1L</span>));</span><br><span class="line"><span class="comment">// ("book", 2L, 19)</span></span><br><span class="line"><span class="comment">// sortedMap -&gt; [("book", 1L, 12)],[("book", 2L, 19)]</span></span><br><span class="line">expectedOutput.add(insertRecord(<span class="string">"book"</span>, <span class="number">2L</span>, <span class="number">19</span>, <span class="number">2L</span>));</span><br><span class="line"><span class="comment">// ("book", 4L, 11)</span></span><br><span class="line"><span class="comment">// sortedMap -&gt; [("book", 4L, 11)],[("book", 1L, 12)],[("book", 2L, 19)]</span></span><br><span class="line">expectedOutput.add(updateAfterRecord(<span class="string">"book"</span>, <span class="number">4L</span>, <span class="number">11</span>, <span class="number">1L</span>));</span><br><span class="line">expectedOutput.add(updateAfterRecord(<span class="string">"book"</span>, <span class="number">1L</span>, <span class="number">12</span>, <span class="number">2L</span>));</span><br><span class="line"><span class="comment">// UB ("book", 1L, 12)，撤回即将 ("book", 1L ,12) 从 sortedMap 中移除，("book", 2L, 19)的排序被更新为 2</span></span><br><span class="line"><span class="comment">// sortedMap -&gt; [("book", 4L, 11)],[("book", 2L, 19)]</span></span><br><span class="line">expectedOutput.add(updateAfterRecord(<span class="string">"book"</span>, <span class="number">2L</span>, <span class="number">19</span>, <span class="number">2L</span>));</span><br><span class="line"><span class="comment">// ("book", 5L, 11)</span></span><br><span class="line"><span class="comment">// sortedMap -&gt; [("book", 4L, 11),("book", 5L, 11)],[("book", 2L, 19)]，("book", 5L, 11) 的排序被更新为 2</span></span><br><span class="line">expectedOutput.add(updateAfterRecord(<span class="string">"book"</span>, <span class="number">5L</span>, <span class="number">11</span>, <span class="number">2L</span>));</span><br><span class="line"><span class="comment">// ("fruit", 4L, 33)</span></span><br><span class="line"><span class="comment">// ("fruit", 3L, 44)</span></span><br><span class="line">expectedOutput.add(insertRecord(<span class="string">"fruit"</span>, <span class="number">4L</span>, <span class="number">33</span>, <span class="number">1L</span>));</span><br><span class="line">expectedOutput.add(insertRecord(<span class="string">"fruit"</span>, <span class="number">3L</span>, <span class="number">44</span>, <span class="number">2L</span>));</span><br><span class="line"><span class="comment">// ("fruit", 5L, 22)</span></span><br><span class="line">expectedOutput.add(updateAfterRecord(<span class="string">"fruit"</span>, <span class="number">5L</span>, <span class="number">22</span>, <span class="number">1L</span>));</span><br><span class="line">expectedOutput.add(updateAfterRecord(<span class="string">"fruit"</span>, <span class="number">4L</span>, <span class="number">33</span>, <span class="number">2L</span>));</span><br><span class="line">assertorWithRowNumber.assertOutputEquals(<span class="string">"output wrong."</span>, expectedOutput, testHarness.getOutput());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输出结果如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Output element -&gt; +I&#123;row1=+I(book,1,12), row2=+I(1)&#125;</span><br><span class="line">Output element -&gt; +I&#123;row1=+I(book,2,19), row2=+I(2)&#125;</span><br><span class="line">Output element -&gt; +U&#123;row1=+I(book,4,11), row2=+I(1)&#125;</span><br><span class="line">Output element -&gt; +U&#123;row1=+I(book,1,12), row2=+I(2)&#125;</span><br><span class="line">Output element -&gt; +U&#123;row1=+I(book,2,19), row2=+I(2)&#125;</span><br><span class="line">Output element -&gt; +U&#123;row1=+I(book,5,11), row2=+I(2)&#125;</span><br><span class="line">Output element -&gt; +I&#123;row1=+I(fruit,4,33), row2=+I(1)&#125;</span><br><span class="line">Output element -&gt; +I&#123;row1=+I(fruit,3,44), row2=+I(2)&#125;</span><br><span class="line">Output element -&gt; +U&#123;row1=+I(fruit,5,22), row2=+I(1)&#125;</span><br><span class="line">Output element -&gt; +U&#123;row1=+I(fruit,4,33), row2=+I(2)&#125;</span><br></pre></td></tr></table></figure><h2 id="UpdatableTopNFunction"><a href="#UpdatableTopNFunction" class="headerlink" title="UpdatableTopNFunction"></a>UpdatableTopNFunction</h2><p>支持更新流，是 RetractableTopNFunction 的简单实现版本，输入流中不能包含 DELETE 和 UPDATE_BEFORE 操作。</p><h3 id="UpdatableTopNFunctionTest"><a href="#UpdatableTopNFunctionTest" class="headerlink" title="UpdatableTopNFunctionTest"></a>UpdatableTopNFunctionTest</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Tests for &#123;<span class="doctag">@link</span> UpdatableTopNFunction&#125;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UpdatableTopNFunctionTest</span> <span class="keyword">extends</span> <span class="title">TopNFunctionTestBase</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> AbstractTopNFunction <span class="title">createFunction</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">RankType rankType,</span></span></span><br><span class="line"><span class="function"><span class="params">RankRange rankRange,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="keyword">boolean</span> generateUpdateBefore,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="keyword">boolean</span> outputRankNumber)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> UpdatableTopNFunction(</span><br><span class="line">minTime.toMilliseconds(),</span><br><span class="line">maxTime.toMilliseconds(),</span><br><span class="line">inputRowType,</span><br><span class="line">rowKeySelector,</span><br><span class="line">sortKeyComparator,</span><br><span class="line">sortKeySelector,</span><br><span class="line">rankType,</span><br><span class="line">rankRange,</span><br><span class="line">generateUpdateBefore,</span><br><span class="line">outputRankNumber,</span><br><span class="line">cacheSize);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testVariableRankRange</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">AbstractTopNFunction func = createFunction(RankType.ROW_NUMBER,</span><br><span class="line"><span class="comment">// TopN 的集合大小随着数据动态变化</span></span><br><span class="line"><span class="keyword">new</span> VariableRankRange(<span class="number">1</span>),</span><br><span class="line"><span class="keyword">true</span>,</span><br><span class="line"><span class="keyword">false</span>);</span><br><span class="line">OneInputStreamOperatorTestHarness&lt;RowData, RowData&gt; testHarness = createTestHarness(func);</span><br><span class="line">testHarness.open();</span><br><span class="line">testHarness.processElement(insertRecord(<span class="string">"book"</span>, <span class="number">2L</span>, <span class="number">19</span>));</span><br><span class="line">testHarness.processElement(updateAfterRecord(<span class="string">"book"</span>, <span class="number">2L</span>, <span class="number">18</span>));</span><br><span class="line">testHarness.processElement(insertRecord(<span class="string">"fruit"</span>, <span class="number">1L</span>, <span class="number">44</span>));</span><br><span class="line">testHarness.processElement(updateAfterRecord(<span class="string">"fruit"</span>, <span class="number">1L</span>, <span class="number">33</span>));</span><br><span class="line">testHarness.processElement(updateAfterRecord(<span class="string">"fruit"</span>, <span class="number">1L</span>, <span class="number">22</span>));</span><br><span class="line">testHarness.close();</span><br><span class="line"></span><br><span class="line">ConcurrentLinkedQueue&lt;Object&gt; output = testHarness.getOutput();</span><br><span class="line"><span class="keyword">for</span> (Object o : output) &#123;</span><br><span class="line">StreamRecord streamRecord = (StreamRecord) o;</span><br><span class="line">System.out.println(<span class="string">"Output element -&gt; "</span> + streamRecord.getValue());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">List&lt;Object&gt; expectedOutput = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">expectedOutput.add(insertRecord(<span class="string">"book"</span>, <span class="number">2L</span>, <span class="number">19</span>));</span><br><span class="line">expectedOutput.add(updateBeforeRecord(<span class="string">"book"</span>, <span class="number">2L</span>, <span class="number">19</span>));</span><br><span class="line">expectedOutput.add(updateAfterRecord(<span class="string">"book"</span>, <span class="number">2L</span>, <span class="number">18</span>));</span><br><span class="line">expectedOutput.add(insertRecord(<span class="string">"fruit"</span>, <span class="number">1L</span>, <span class="number">44</span>));</span><br><span class="line">expectedOutput.add(updateBeforeRecord(<span class="string">"fruit"</span>, <span class="number">1L</span>, <span class="number">44</span>));</span><br><span class="line">expectedOutput.add(updateAfterRecord(<span class="string">"fruit"</span>, <span class="number">1L</span>, <span class="number">33</span>));</span><br><span class="line">expectedOutput.add(updateBeforeRecord(<span class="string">"fruit"</span>, <span class="number">1L</span>, <span class="number">33</span>));</span><br><span class="line">expectedOutput.add(updateAfterRecord(<span class="string">"fruit"</span>, <span class="number">1L</span>, <span class="number">22</span>));</span><br><span class="line">assertorWithoutRowNumber</span><br><span class="line">.assertOutputEquals(<span class="string">"output wrong."</span>, expectedOutput, testHarness.getOutput());</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输出结果如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Output element -&gt; +I(book,2,19)</span><br><span class="line">Output element -&gt; -U(book,2,19)</span><br><span class="line">Output element -&gt; +U(book,2,18)</span><br><span class="line">Output element -&gt; +I(fruit,1,44)</span><br><span class="line">Output element -&gt; -U(fruit,1,44)</span><br><span class="line">Output element -&gt; +U(fruit,1,33)</span><br><span class="line">Output element -&gt; -U(fruit,1,33)</span><br><span class="line">Output element -&gt; +U(fruit,1,22)</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;本文将基于 flink &lt;code&gt;release-1.11&lt;/code&gt; 源码，简单分析下 TopN function 的实现。&lt;/p&gt;
    
    </summary>
    
      <category term="Flink" scheme="http://yoursite.com/categories/Flink/"/>
    
    
  </entry>
  
  <entry>
    <title>Flink部署-flink-on-kubernetes</title>
    <link href="http://yoursite.com/2020/09/29/Flink%E9%83%A8%E7%BD%B2-flink-on-kubernetes/"/>
    <id>http://yoursite.com/2020/09/29/Flink部署-flink-on-kubernetes/</id>
    <published>2020-09-29T07:23:17.000Z</published>
    <updated>2021-06-22T07:45:56.236Z</updated>
    
    <content type="html"><![CDATA[<p>kubernetes 是目前非常流行的容器编排系统，在其之上可以运行 web 服务、大数据处理等各类应用。这些应用被打包在非常轻量的容器中，我们通过声明的方式来告知 kubernetes 要如何部署和扩容这些程序，并对外提供服务。flink on kubernetes 可以得到一个健壮和高可扩的数据处理应用，并且能够更安全的和其他服务共享一个 kubernetes 集群。</p><p>本文将记录使用 kubernetes 部署 flink 应用的步骤。</p><a id="more"></a><h2 id="Mac-安装-Docker"><a href="#Mac-安装-Docker" class="headerlink" title="Mac 安装 Docker"></a>Mac 安装 Docker</h2><p>Docker Desktop 下载地址：<a href="https://www.docker.com/get-started" target="_blank" rel="noopener">Docker 官网</a><br>注册 DockerID 并登录。</p><p>安装 docker 命令行：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> brew install docker</span></span><br></pre></td></tr></table></figure><h2 id="Minikube-搭建-Kubernetes-实验环境"><a href="#Minikube-搭建-Kubernetes-实验环境" class="headerlink" title="Minikube 搭建 Kubernetes 实验环境"></a>Minikube 搭建 Kubernetes 实验环境</h2><p>可以参考：<a href="https://kubernetes.io/docs/setup/learning-environment/minikube/#quickstart" target="_blank" rel="noopener">Kubernetes 官网</a></p><h3 id="安装-Minikube"><a href="#安装-Minikube" class="headerlink" title="安装 Minikube"></a>安装 Minikube</h3><ol><li><p>校验 MacOS 是否支持虚拟化，运行如下命令出现 ‘VMX’：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sysctl -a | grep -E --color <span class="string">'machdep.cpu.features|VMX'</span></span></span><br></pre></td></tr></table></figure></li><li><p>安装 kubectl 命令</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl -LO <span class="string">"https://storage.googleapis.com/kubernetes-release/release/<span class="variable">$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)</span>/bin/darwin/amd64/kubectl"</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> chmod +x ./kubectl</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo mv ./kubectl /usr/<span class="built_in">local</span>/bin/kubectl</span></span><br></pre></td></tr></table></figure><p> 或者直接使用 Homebrew 安装：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> brew install kubectl </span></span><br><span class="line"><span class="meta">$</span><span class="bash"> brew install kubernetes-cli</span></span><br></pre></td></tr></table></figure><p> 查看是否安装成功：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl version --client</span></span><br><span class="line">Client Version: version.Info&#123;Major:"1", Minor:"19", GitVersion:"v1.19.2", GitCommit:"f5743093fd1c663cb0cbc89748f730662345d44d", GitTreeState:"clean", BuildDate:"2020-09-16T13:41:02Z", GoVersion:"go1.15", Compiler:"gc", Platform:"darwin/amd64"&#125;</span><br></pre></td></tr></table></figure></li><li><p>安装 VirtualBox<br>VirtualBox 下载地址：<a href="https://www.virtualbox.org/wiki/Downloads" target="_blank" rel="noopener">VirtualBox 官网</a></p></li></ol><ol start="4"><li><p>安装 minikube</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl -Lo minikube https://storage.googleapis.com/minikube/releases/latest/minikube-darwin-amd64 &amp;&amp; chmod +x minikube</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo mv minikube /usr/<span class="built_in">local</span>/bin</span></span><br></pre></td></tr></table></figure><p> 或者直接使用 Homebrew 安装：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> brew install minikube</span></span><br></pre></td></tr></table></figure></li><li><p>执行 minikube start<br>该命令会下载 kubelet 和 kubeadm 程序，并构建一个完整的 k8s 集群。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> minikube start</span></span><br></pre></td></tr></table></figure></li><li><p>查看 k8s pods<br>Minikube 已经将命令 kubectl 指向虚拟机中的 k8s 集群了。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get pods -A</span></span><br><span class="line">kube-system   coredns-f9fd979d6-xjht6                           1/1     Running   0          5h14m</span><br><span class="line">kube-system   etcd-minikube                                     1/1     Running   0          5h14m</span><br><span class="line">kube-system   kube-apiserver-minikube                           1/1     Running   0          5h14m</span><br><span class="line">kube-system   kube-controller-manager-minikube                  1/1     Running   0          5h14m</span><br><span class="line">kube-system   kube-proxy-ff8m8                                  1/1     Running   0          5h14m</span><br><span class="line">kube-system   kube-scheduler-minikube                           1/1     Running   0          5h14m</span><br><span class="line">kube-system   storage-provisioner                               1/1     Running   0          5h14m</span><br></pre></td></tr></table></figure></li></ol><h2 id="Flink-实时处理-demo"><a href="#Flink-实时处理-demo" class="headerlink" title="Flink 实时处理 demo"></a>Flink 实时处理 demo</h2><p>我们可以编写一个简单的实时处理脚本，该脚本会从某个端口中读取文本，分割为单词，并且每 5 秒钟打印一次每个单词出现的次数。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;Tuple2&lt;String, Integer&gt;&gt; dataStream = env</span><br><span class="line">    .socketTextStream(<span class="string">"192.168.99.1"</span>, <span class="number">9999</span>)</span><br><span class="line">    .flatMap(<span class="keyword">new</span> Splitter())</span><br><span class="line">    .keyBy(<span class="number">0</span>)</span><br><span class="line">    .timeWindow(Time.seconds(<span class="number">5</span>))</span><br><span class="line">    .sum(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">dataStream.print();</span><br><span class="line"></span><br><span class="line">env.execute(<span class="string">"Window WordCount"</span>);</span><br></pre></td></tr></table></figure><p>K8s 容器中的程序可以通过 IP 192.168.99.1 来访问 Minikube 宿主机上的服务。</p><p>demo 下载：<a href="flink-on-kubernetes-0.0.1-SNAPSHOT-jar-with-dependencies.jar">flink-on-kubernetes-0.0.1-SNAPSHOT-jar-with-dependencies.jar</a></p><h2 id="构建-Docker-容器镜像"><a href="#构建-Docker-容器镜像" class="headerlink" title="构建 Docker 容器镜像"></a>构建 Docker 容器镜像</h2><p>flink 提供了一个官方的容器镜像，可以从 <a href="https://hub.docker.com/_/flink?tab=tags&page=1&name=1.8.1-scala_2.12" target="_blank" rel="noopener">DockerHub</a> 上下载镜像。<br>官方镜像的 <a href="https://github.com/docker-flink/docker-flink/blob/master/1.8/scala_2.12-debian/Dockerfile" target="_blank" rel="noopener">Dockerfile</a>，以 <code>1.8.1-scala_2.12</code> 为例，大致内容如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">FROM openjdk:8-jre</span><br><span class="line">ENV FLINK_HOME=/opt/flink</span><br><span class="line">ENV PATH=$FLINK_HOME/bin:$PATH</span><br><span class="line">RUN groupadd --system --gid=9999 flink &amp;&amp; \</span><br><span class="line">    useradd --system --home-dir $FLINK_HOME --uid=9999 --gid=flink flink</span><br><span class="line">WORKDIR $FLINK_HOME</span><br><span class="line"></span><br><span class="line">RUN useradd flink &amp;&amp; \</span><br><span class="line">  wget -O flink.tgz &quot;$FLINK_TGZ_URL&quot; &amp;&amp; \</span><br><span class="line">  tar -xf flink.tgz</span><br><span class="line">ENTRYPOINT [&quot;/docker-entrypoint.sh&quot;]</span><br></pre></td></tr></table></figure><p>主要做了以下几件事情：</p><ul><li>将 OpenJDK 1.8 作为基础镜像</li><li>下载并安装 flink 至 /opt/flink 目录中</li><li>添加 flink 用户和组等</li></ul><p>下面我们以 flink:1.8.1-scala_2.12 作为基础镜像，编写新的 Dockerfile，将打包好的任务 jar 包放置进去。此外，新版 flink 已将 hadoop 依赖从官方发行版本中剥离，因此在打包镜像的时候也要包含进去。<br>Hadoop jar 下载：<a href="flink-shaded-hadoop-2-uber-2.8.3-7.0.jar">flink-shaded-hadoop-2-uber-2.8.3-7.0.jar</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">FROM flink:1.8.1-scala_2.12</span><br><span class="line"></span><br><span class="line">ARG hadoop_jar</span><br><span class="line">ARG job_jar</span><br><span class="line"></span><br><span class="line">ENV FLINK_CONF=$FLINK_HOME/conf/flink-conf.yaml</span><br><span class="line"></span><br><span class="line">RUN set -x &amp;&amp; \</span><br><span class="line">  sed -i -e &quot;s/jobmanager\.heap\.size:.*/jobmanager.heap.size: 128m/g&quot; $FLINK_CONF &amp;&amp; \</span><br><span class="line">  sed -i -e &quot;s/taskmanager\.heap\.size:.*/taskmanager.heap.size: 256m/g&quot; $FLINK_CONF</span><br><span class="line"></span><br><span class="line">COPY --chown=flink:flink $hadoop_jar $job_jar $FLINK_HOME/lib/</span><br><span class="line"></span><br><span class="line">USER flink</span><br></pre></td></tr></table></figure><p>将 docker 命令行指向 Minikube 中的 Docker 服务，这样打印出来的镜像才能被 k8s 使用：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">eval</span> $(minikube docker-env)</span></span><br></pre></td></tr></table></figure><p>移动到 Dockerfile 所在目录，开始构建镜像：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker build \</span></span><br><span class="line">  --build-arg hadoop_jar=flink-shaded-hadoop-2-uber-2.8.3-7.0.jar \</span><br><span class="line">  --build-arg job_jar=flink-on-kubernetes-0.0.1-SNAPSHOT-jar-with-dependencies.jar \</span><br><span class="line">  --tag flink-on-kubernetes:0.0.1 .</span><br></pre></td></tr></table></figure><p>镜像打包完毕，可用于部署：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker image ls</span></span><br><span class="line">REPOSITORY                           TAG                                              IMAGE ID            CREATED             SIZE</span><br><span class="line">flink-on-kubernetes                  0.0.1                                            ed4dfaf07cfe        5 hours ago         618MB</span><br></pre></td></tr></table></figure><h2 id="部署-JobManager"><a href="#部署-JobManager" class="headerlink" title="部署 JobManager"></a>部署 JobManager</h2><p><code>jobmanager.yml</code> ：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Job</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">$&#123;JOB&#125;-jobmanager</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">flink</span></span><br><span class="line"><span class="attr">        instance:</span> <span class="string">$&#123;JOB&#125;-jobmanager</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      restartPolicy:</span> <span class="string">OnFailure</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">jobmanager</span></span><br><span class="line"><span class="attr">        image:</span> <span class="attr">flink-on-kubernetes:0.0.1</span></span><br><span class="line"><span class="attr">        command:</span> <span class="string">["/opt/flink/bin/standalone-job.sh"]</span></span><br><span class="line"><span class="attr">        args:</span> <span class="string">["start-foreground",</span></span><br><span class="line">               <span class="string">"-Djobmanager.rpc.address=$&#123;JOB&#125;-jobmanager"</span><span class="string">,</span></span><br><span class="line">               <span class="string">"-Dparallelism.default=1"</span><span class="string">,</span></span><br><span class="line">               <span class="string">"-Dblob.server.port=6124"</span><span class="string">,</span></span><br><span class="line">               <span class="string">"-Dqueryable-state.server.ports=6125"</span><span class="string">,</span></span><br><span class="line">               <span class="string">"-Dstate.savepoints.dir=hdfs://192.168.99.1:9000/flink/savepoints/"</span><span class="string">,</span></span><br><span class="line">               <span class="string">]</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">6123</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">rpc</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">6124</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">blob</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">6125</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">query</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">8081</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">ui</span></span><br></pre></td></tr></table></figure><ul><li>${JOB} 变量可以使用 <code>envsubst</code> 命令来替换</li><li>容器的入口修改为 <code>standalone-job.sh</code></li><li>JobManager 的 rpc 地址修改为了 k8s Service 的名称，集群中的其他组件将通过这个名称来访问 JobManager。</li><li>为 Flink Blob Server &amp; Queryable State Server 指定默认端口号</li></ul><p>使用 <code>kubectl</code> 命令创建 JobManager pod，并查看状态：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">export</span> JOB=flink-on-kubernetes</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> envsubst &lt;jobmanager.yml | kubectl create -f -</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl get pod</span></span><br><span class="line">NAME                                              READY   STATUS    RESTARTS   AGE</span><br><span class="line">flink-on-kubernetes-jobmanager-dzhcs              1/1     Running   0          77m</span><br></pre></td></tr></table></figure><p>创建一个 k8s Service 把 JobManager 的端口开放出来，以便 TaskManager 前来注册。<br><code>service.yml</code>：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">$&#123;JOB&#125;-jobmanager</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">flink</span></span><br><span class="line"><span class="attr">    instance:</span> <span class="string">$&#123;JOB&#125;-jobmanager</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">rpc</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">6123</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">blob</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">6124</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">query</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">6125</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">ui</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">8081</span></span><br></pre></td></tr></table></figure><p>使用 <code>kubectl</code> 命令创建 JobManager service，并查看状态：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> envsubst &lt;service.yml | kubectl create -f -</span></span><br><span class="line"><span class="meta">$</span><span class="bash">  kubectl get service</span></span><br><span class="line">NAME                             TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                                                       AGE</span><br><span class="line">flink-on-kubernetes-jobmanager   NodePort    10.104.157.70   &lt;none&gt;        6123:30261/TCP,6124:31158/TCP,6125:30509/TCP,8081:30262/TCP   89m</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> minikube service <span class="variable">$JOB</span>-jobmanager --url</span></span><br><span class="line">http://192.168.99.100:30261</span><br><span class="line">http://192.168.99.100:31158</span><br><span class="line">http://192.168.99.100:30509</span><br><span class="line">http://192.168.99.100:30262</span><br></pre></td></tr></table></figure><p><img src="JobManager%E9%80%8F%E5%87%BA%E7%9A%84Dashboard.png" alt></p><h2 id="部署-TaskManager"><a href="#部署-TaskManager" class="headerlink" title="部署 TaskManager"></a>部署 TaskManager</h2><p><code>taskmanager.yml</code> ：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">$&#123;JOB&#125;-taskmanager</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">flink</span></span><br><span class="line"><span class="attr">      instance:</span> <span class="string">$&#123;JOB&#125;-taskmanager</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">flink</span></span><br><span class="line"><span class="attr">        instance:</span> <span class="string">$&#123;JOB&#125;-taskmanager</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">taskmanager</span></span><br><span class="line"><span class="attr">        image:</span> <span class="attr">flink-on-kubernetes:0.0.1</span></span><br><span class="line"><span class="attr">        command:</span> <span class="string">["/opt/flink/bin/taskmanager.sh"]</span></span><br><span class="line"><span class="attr">        args:</span> <span class="string">["start-foreground",</span> <span class="string">"-Djobmanager.rpc.address=$&#123;JOB&#125;-jobmanager"</span><span class="string">]</span></span><br></pre></td></tr></table></figure><p>使用 <code>kubectl</code> 命令创建 TaskManager pod，并查看状态：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get pod</span></span><br><span class="line">NAME                                              READY   STATUS    RESTARTS   AGE</span><br><span class="line">flink-on-kubernetes-jobmanager-dzhcs              1/1     Running   0          77m</span><br><span class="line">flink-on-kubernetes-taskmanager-64b7cc4bf-9t6cr   1/1     Running   2          77m</span><br></pre></td></tr></table></figure><p>至此，Flink 脚本集群已经在运行中了。在监听终端下输入如下内容：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> nc -lk 9999</span></span><br><span class="line">hello world</span><br><span class="line">hello flink</span><br></pre></td></tr></table></figure><p>打开另一个终端，查看 TaskManager 的标准输出日志：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl logs -f -l instance=<span class="variable">$JOB</span>-taskmanager</span></span><br><span class="line">(hello,2)</span><br><span class="line">(flink,1)</span><br><span class="line">(world,1)</span><br></pre></td></tr></table></figure><p><img src="taskmanager%E7%BB%9F%E8%AE%A1%E5%8D%95%E8%AF%8D%E7%9A%84%E6%A0%87%E5%87%86%E8%BE%93%E5%87%BA%E6%97%A5%E5%BF%97.png" alt></p><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://developer.aliyun.com/article/784822?spm=a2c6h.13148508.0.0.5be54f0eC7Xfxo" target="_blank" rel="noopener">唯品会：在 Flink 容器化与平台化上的建设实践</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;kubernetes 是目前非常流行的容器编排系统，在其之上可以运行 web 服务、大数据处理等各类应用。这些应用被打包在非常轻量的容器中，我们通过声明的方式来告知 kubernetes 要如何部署和扩容这些程序，并对外提供服务。flink on kubernetes 可以得到一个健壮和高可扩的数据处理应用，并且能够更安全的和其他服务共享一个 kubernetes 集群。&lt;/p&gt;
&lt;p&gt;本文将记录使用 kubernetes 部署 flink 应用的步骤。&lt;/p&gt;
    
    </summary>
    
      <category term="Flink" scheme="http://yoursite.com/categories/Flink/"/>
    
    
  </entry>
  
  <entry>
    <title>数仓建模</title>
    <link href="http://yoursite.com/2020/08/30/%E6%95%B0%E4%BB%93%E5%BB%BA%E6%A8%A1/"/>
    <id>http://yoursite.com/2020/08/30/数仓建模/</id>
    <published>2020-08-30T07:17:02.000Z</published>
    <updated>2021-06-22T17:28:00.539Z</updated>
    
    <content type="html"><![CDATA[<div id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <div class="hbe-input-container">  <input type="password" id="hbePass" placeholder="" />    <label for="hbePass">Hey, password is required here.</label>    <div class="bottom-line"></div>  </div>  <script id="hbeData" type="hbeData" data-hmacdigest="8b02a26ae91df31399bfab935a8e6c1d0331b355f0097f2d7fa6d44c4d767ae3">52ce8ee04fbea785151db66d7ca81742037774d12080f4ad76f05739c4649a561618f37444bafcb741e667215e119e94d8fa72474b313c2efcb0204ba3ee62d9db958e7193056ac0b14dc861fcbb383cefe5348e328ca91b2c59547f24d74a6ab86280f6c85f1d010cdbbbf5d7354319881bf3fed7c2ddcb57b2055dc07343bbf1cd293180ff94e831c014d06536b2e781b3849ad8ad4b5ffd7564a9ede9e1c3e19ca2563ccc17481844b35d54549a7df24b945de7816309acbd1c3e23e2aa624520f7e746ef899cc2281d4a6f0505e3ca2d489267b61221cf7b59ade83ddb1645663cea4436c5667e3ba54bc6a2309d59d18e39d2a02e2e8775274e83c736cdd8be916e150dd9d49f6a444221bd337725481adfb779d145d7c111f6e2ead6875bb33c95f7c5285b5af11ee419c897f9b82270fb70b0e843c2167011ac569711a0fdcbd792e9f414cb5e07db8352161cbc408788a8df0bec95a7ee3e7d0a7b505ab6b5735d38e7afe9a6f33b1b16782a57190b48a9b18ea5a4996e8557f5e27ea330a2b2380c28a9d89a11180983c07aa215ce5920f91dc740ffc6391bc61edc4ff31aedb38b02890134edc35b08bf07e2598686bba30e45d4bcd6ccff90fdcbee1c7c6e5dd6d7f0ed956d1efe3414b862a5eeeaaa67910427c1265ea687ffc148852b608a030774d52bd0fbd5390aef7b115bcbd3558b3a2ca52c665b4bdca0405d480ac883a41af64892f36b3f8bfd52a1479ba04266f53ce1848f0a8bdd9a4e5dfcfebe418894459c9db8c7a3f9dc6e9fd1f8f0375d5ff7b13296092c811fbdc5a468b6a3e622525f35501233ef4035e9a96610123d173fcf28173bd7383d3d6a4c4aa9d5212ec1af7084269308ad66ffc4148a6b5d13dab18454d8822d7784a4de396c10844a0f7dc01798693aa72acdee0db67d932498e22b93f253448b69e718155c152c873513a13c0a4817af58d39b03f12d3d0997db9b047a523c8d563d0c0adf86124d1bdcda45a9d584910f9861db999b9c69cb8ed4a536049111574d811d1c35a0999ef2ce52d49ff0fbeec57198bc03562356adeeb0b4927a2fd1d49c3c5779264a787aa3a39034f72ac310264d9febd91cea16ef3f718a44e71d83342985ab336e04d51445e3aaf06d31503276b9e70cc04dd437961c8bee42b7c492ba4440021676d5a0c7927f7210613a6bc03c1003cc5c5d0c8c0e55022e352e3c01df5ead045b497a1da65ad3225cfd33343460c13e4b4ee3f7a6b670c92911436bd026c52799b5f043cd356504b4a99f1e6ebf54afdb76354a9d5ae902f5c3c979445cfdd75bd3727da4da55cdc85b9c6ead0ba7f37cf9395f2f6bcfaf8cceaa71ceb888e833f74b7524e61d5e3ec83f16193befb3344c8b841f64b596399d35157bda0e7a75eb0ecdd4ef403b91c792fb971c1d8f56017cf76c337e0f8de9461aa4f9e1ac6908f4d217517ae610e6a4cf4db1b8fb4ca520e1269d4214d863ab27c23f09ba1f096956b1c9cdd450ab99d18febf211e918dfa6e76a96131840a017f91921482b0af88d50b7f9b3eec0af8a427bd37fd473ce6dc8bbd75ab36201ce4a7aa1bea96b8ae0a74ef4d853113ac11dd286f2104ff64094238db39de0b892ff96974919424ff09aee4d2d71cbc3cd460fed9d4814f10ddb225db6f469e0f8d9983617d1273c77380bae228638a137739cb29abcc4cbf25055bc73e5dc03f7485f9ce6c2ae5ba5098603b4e57fb4cf5b9e9601058d01de7a6f963e38d3241c4a75bd71e9b7df0a75c359ce2db728fe636197dfc51a6293f7fc20c44721bafdfe0c6d0d55e04d7b20cb4e6b23455be90a28d92976a719134be5b90c0a89fcd2dc98de80cb739d49129d3ccd8c55dc24e30ad7fe120d0f0072a601a760f6dab12bf3898018e7500d47529bb61fb8e412dbcb944f5ef63bd0d74596332d28f7b5d0fcdc2693434c7e736ba3f235d4e72389012a5a58ece13e830d1690b1413b577f9ba9724615e699d9a31ae1052a6fcb070069164d840d41a56db57b8e7685b2c7bc2e5b802fa6a1700ce65544ba544269e15972fea7a104dcde9a02744a6e78cb252dd11286632c91063ce71d7bc31c68f9d87a5a9ef300b1a666ce5355442f2d1723b639aca81bafec8debafe723184faadd60ebcc40cf6d4ffefc21867a588b04920a2d24f6892d02454035ff1ac2440668337334fad62b15bedb9d09dc6e46d2d128bc3b57bec65d826343322455c3a84cabe96a71c29de0b9d89a9e99f977138d550a54bba516f37cb5e889d50e20897852330c253427ac2b4a724a26360a4da17bafe7ff1353e6d577b1a61f5fcf5174ebe107ff0a15d155da2714570d972e7a830c8d225ff7097b282c80c1c948c77a6f2f65fdcead1e194ae4f575a7c984833f77c6cce41f83e0c54b6fc0f62ffb23445859a7823ebf18b6bd59e34e81dbe5bb3578f1217d43c636cc2b68e1aaf4356e9b035bf5a525684b7094b6f72499f2a56910d3d29552238d21981e4e3496f70d04bc3120c0b90da08bb5ba2c87d342ebd518dcac9a5eabe6a9002a329711cedaee11eca2815e2625a09e473018ea911be317448f39f38ada795a9da8f285f969cca2f42eb1b74676d11ae40aebaaf0fe6ac92b2b7f5a9e8848207b0894cc93665732be97b2499df4102a1b9f8692dd31fcfdd4f6bf24a5f30614b4266f1f32a3ef020529fcbe86a92c712498e687fa67dc85b62cdd87995bc1921e8eb615f5926f77bce2cbac0b3c7be5ec69acffbfd5ea0246a3824802b16522feca7c61483508ddf18f5c8f6ce3313123c90b68bdb9a8226b3e80fb7e713e342207c54d92400ffb12cc86bc12272e94653eb295e669aca91b27cadc1f23d3744fd24c15545a9a04b08a022f3bf1c098ee5a1313c7c03f437f30f09a96454e252c99c696d7ada7ea39e0771cdaed518cf53962cf929b827732845fae734c9dab13ed53aa32c972f39b98320b8728e376f893b4c61ad31d610ca5087acb4cd520ca2c928e84b586d6eab2f07ce84e08a9889f3af8c0fa1da57aa47092e712bbc9b31efe7cc9518dba8774383357aa7ca0abda349b1098b78edb85ae4b5a487e189bc83a75a390c5a495b4c5c118a0753259f217c13b47830a00ba7b2f29939476790ab626df9879adace1bb25a6c615247de143d797b9cd48c97b06ad7bdde946f665a7174cecdaaf9bebb6ef2f32f4794c8954d878339d26cba91312b667d5677e41b23ff0443e382e42547d3dbd21675a5bf6a8ad84fba91259191f533cff72a2917790a5b2df407e9fffca889d21c83a545bcb84a1004def6bab7d6eef2e911343066e3e92ac52bdfd4f1edfbd1d3cac038c996b694beaedd612c0b8fc86e16e2fc0a9e63d575399db0447b2346cc740dc31568b613c5a72bd08ef51af3e389231827d67e57b72a89df7043e18e9a6edff9232e3ba647205f85f9ae56af8923bcaaecefbcb3d5086f89046f72e9434c532f4aab024186a784cef9e0d4ba85154c1d5cb3b845224b2b6e588993c46e0c677ccc87643c81d72653d1c2f74f0d85d5c0facb6e385d6b04b879116103785d38a4d89e0081268b23b173182d5554b6876182b1e0e6d2610259c10b9d1bef5508dfb93600c96d7e116fd22f538ee53181601d54e800bf511712dd837f6096ef3b1d2e4938f198abba7012d30b29b7662f02327f4635ada849a203067caaac63509216e9b1512bdf78e7aaa1150a620d3a0f3626f90892060554dfdc05d7bbeef92e45817fc78a52176bac9bbcddb1e128663fd4e1c3eb34b4bacd256ff90c63d045781f92df1aa30ba8c7dddeed4c34ba1495afcfcbea22df922ea519fd57e603221258014b62ca5310debc86ca764a441b22e9eb8210490c3a87ed10119f33e10698daa125298ae61b080372f826c23dd4e6a73baaeaaeb06716042778c49678ef8de737a9cce1d09bf973b9f8153c3f3c800e353bb997d5dd15d98774a08d0f59e3d444019e15eb2e944e0e5412aac7eb1304588593772886dd781b4ec13ddcf4275ab05f4d1c97c33f8e8d9a07c9e94d349c4d7f6bd177418777150ea34a0c9085d951f7f3d51e2279d9828cb32ae158acd93ef7f1fa161b1321d5076998f54eac851ed9fbddf7dcc59c24e38bd76e0da8abe7fdea5e55078d897d3e74a78e39aa9d2e709f9ae47c18521c9233090a617c724e23c0e60ed98edf83f6a71dc87269d24c867b755a62f9bf8644b77ea22cff434e985b6f03f32c27c4c44c1d90f7ba85150652a26feb01a3d5735df2cff6d6e35ac64b83c7964293825efc921d61c31579c4a40fa9a47d2af1321f6369eeec57d1a741b99e66b1906b2ca3d75cc9cfd3a4821808707f6effb1889cc91acce2a286b6ab5de5c20f73e8bc43598a21e6bf0cb3c4d9ec4450abe87cd635a26dbba2830d3d673cc4cce16bc80606eacce99a9918efc149b53c559923b1254eb4a68ddd85321db801f2b61240d17c9f8f06852ae66f800793fd84294ce859694035bf531be88fc774463c65a7d07da931a0ed401de7abe0416102ccaf46034f3221b4cd8b49724eccaa14602ebbac7fd70a473ba0280807223092e9ec9c56a41e53a8689749ac92321592efe4f1c963aa47a8abb6f204147cdacba0aa54ccf0e4c9644a8080d3cc76262021d721f1f7d97ccf2427470cfaa87a8ad431c6dbc9785fcd944527fb39bebf0e0382a9f07b85358f1185229054950230afe9b4e1516c3e4e70fd0269e39a77131aaabf8a8dbce2ef95b76855e9eb93f60f96f099624b08993d8f7f494dc1631aa9b3cf4d78d8100a00935af534b755ad6458b899a8388e72d2e2267f6bc56d4b3b5e33cf26f4e65cff77849e7713a29eac491885a9ec17a98265ac9a92571d5b36a7fc94d3038cb4ea96e7f0e945336080f1c3893a78762366ca1533fbdfcd5613f30318e81a84493850d5fa9f285ff02395b78cda1868604c9114fe9c6256abefa028781824d8d366691d2a921f64ff828ac25269f5f65e4cf4ae1c3eff6ec94b3fb16b0aae2f9088ab7728e416c1bf2a928a0f2287b1e8da3ce81a175dce02843ed2c0bada039cfe03202aaecf977fe011dd40a4f11256f66666349b893fb39ba1b08c52637e2953169a46b5b3fa9524db5d8d11feb2fe8791d7c3028ee24fb71795a7566a75e3cad000e51db5d5fdfd80ed5a9a40665fa5aa261c0b2f425d551415d0e53cd189b0d33f10f8434c65a3dfe4b3507c8e440bff4732d289c5641490df62591e4d9d0607fd4d7ebc9002f1a28bfe9564f84818f3067a43469ec5676a0d4c4f74f7a19aff2dc29ed08619d23aa073dbb63666e3a1f0334b48bb982661caff666c643fcf375fa002fb4fc2034b4d189d0e787f9978812ba56f740bb503e111b84ff9e266e5e7764426b4084d1e0cc0b1d86d77ced33b9cc46d6729e395ab59a9fa753e0327ef03c2d3943f796e41a1f132f6ea73cc42dda727acb8a489cc333dc06ac10809e9992f2ebc3c5d49c7bc8d7352770f4a65acb6b0baf9ea719d10bf357d8a030d5efd7df5421bab3e4b41f4fac026d3be3a1df849fcb7f8daee2fd7cb29ece1de8d47a525587bfe9aaa8c952a6668c00e3fc8a176f1d749c1a3c8766f18f03fa5c595c6e2eb0f79e06caecde57887a6ef864be7b71fbda49eb2e4d185af6e6a6909a25ae91519cbcb13ff15d1fe5846f8d57137a4f13d6576b49cf7347481246467753191679978cea026b987ff813475a4ad3d9c6a3068af7fbc3b6cbc66d0c5fe84dd856503db00f664695365abe58bc76dbec0bf18c9609ef2ca635a004bdfd76e41ada263638b009f2411c0f668fa1c9dc61974ad20592a1c7e19f56e494152b9b01b0ea694667958e8e28bb24cd92052fae0a00b74cfba7193232454027c02f2e2dc1d058d6b0e433b7743eaecef6ac62d2d13ea6491b36149c2ef9a8a71810149de02937a6e59d07b227b9c6acf6c76f22a1f4b6cc22eb3f62e3cdce4bc51348fabce9f3b55c26eeacc8c98914a0c8113c0d0acde9a5be20b2c0d7787374053b8601f508289080232bda0519c9b65c45ec576dd17d2cde1b9717b27a71254ddbf2a155084eccac4943d3ec7a008507367d56639f181ca296319aed03426db315b97a6cafea3c992574e0ccb6c1a9a01101a69a30df55d46fef71ff61978aa28f10e08d9a439aef45bcf58ad6a24da6fbf164e35568b405a7546f08e58f19957e0d8c0560332c522e1501b90ef3de1deaf8d4da0e897da98c806f6bb6ec0d72940c2fa9587770255ef1958337ba2f4c09dab92758e4c0cb501bf65dd4de13da721d4bb79e66085c6d0056cae69933c8e7078f896bef1e0517a6e82b19d72e2215269acb0116750cd50c047bbf5f14a040c0b197b02250d33d550bcbcb68e034cdad713513e51313e8e96ad536a1eaa772b7f662eb47e585704ad6383776f5f280c588cf604fc7790c24bce9c8a4c9f3b19b96e00bcee40397688fb80be9ff2ce7c95fbc06e9503a3c2d9536bbaafb83abf02259799da3744dfa66e6d355529809d85408a9f92ac252b189201332420ad04a5cb8f4c7782343f3ab49d7805eeaa059339ba42d8cdb7f1ae741272dfaf62088050870654995b20e6f9929f5c6c1ee06c778ff5be2db8c6d9b987f621fe2d0d30d744620f78e4e8338c058e8fcd39dcde9cdbf32c7e686cd9d924e0f9fa8d92633376f743fd00d0daf0be364e79dafb76a0cb5e97984e28da547c0c76148bada778f410a3cc197c6009063f839fcdd4f1800ff5bbac739b8e2752d8befe5e70204d6728a1a490c93c176ad2b0b25bced925c3bd2719c4de015173c3d878ae919e1ec30dfc9530deae18f599d3c8982406570d566e99982091c26170599fb13215f18239b0d92c16264364bb186f737067396736bd4f4c88ca995a7b53cc6c6c4f445d54b0a8b6faf37c9d6b13b7055800680e3402da5318963b6c5b4ccd75201d00f7181566d329ab13a4d870550bdf380e2d75e6161d568c7bc194a361480231db88bba102163bdb2cda9b02343320d1cbc4d114b2afb4adf30540dc3a85ce56740ac50e51e72f17abbec022f5b8acac98bcfac55a63517f56d2aaf722aff3242850e9edfdbcb8fe8e00420e6212a14f6dbb81a48d584517c5eba7aa2398e7472e7cb3704fe601e9a770909a795f57240c8b1c2014b4265282036caae80e81e046be4334dfcad7ee2f1723b0e925e615ec1f465603402b819fc2965d5fd03498e52c9cd73b15da4ca3c57712432254f10a3eaec98a192a99070883457352618f88bfc2b05f8219d385127fcbcd3a5daf907aab9d2fe0c50a63776ba2ed3fe0f84e8db253378d712c235019db770cec8da94d66817b623c491c3bd617fcae93647362d40dc48ac17b5f608b70843e7d2e464ff9ba90df045240f3cbf93e2401a08b2523db56f2d7580b66312ebcec0b8a7be5722aba8a2bcffffbd7dec420e1e9441b98a8086654fe0fc49b1da6cef866d3100109c4e6cb79a31d704c11bc4557a8caea03946274f0366e896715c8c238d0cc1bb0e6fac4e9caf7fbc9140ea684b0daa966059612c220f0e0e341af8fc4eba91276bd5cb3f5a4b380c1cff7182e90b17ebb14218d7fa2eef6cda2ece3718fdbfc2b32a2a5a4144c3c0524dda5eb76df56326a117f0f3f92a7df10e2ce18a7dc59117f65b1cf486804201036b0893d5b4127535b81bbbe1eea00108fc075209141d7bad0e243f477df47d95c36df6b3f9d77d1ea70775bdd7a843e93df50bc6f849d09e8d13637a98a9fe883c016ed5a132d84718030f8178c66ad878b5ab36b07f0599e6578365e64bae82633387565d15ea0f85281e515e7a6460f32a57d76aeb86182f6bcb730f48ff14e2b49358cd4b8ded0e322dd56f1fe72c5718174fd5abfe5213f0894919d87d4ebb7ce5e96b402227ece4d0e0dcdc28c8a345efb81ebf7a14ba4803ed2775a9a557998cab0f2bdd77e82fe49e72bfd30566c3941017ef09ca18d025a7451db02c2c00711bb64c50da1320188e7e17a91e512ec791cf62f4b4d04dae42e304c08fb3f347b8bd852741ffd58157eb62f6b43f0eb68d5dbbd31782210453cfdc2f8be572bb2e7babf7a89710e6e1c1964136242bbb404a5e6aac1219d4d6091b741c21d8f5701cc58b850995694cf081e6533aa42eddb0d2723457c0d84261b993e16b7b48b74bc09b593753520df38899fc9aec845436529b2262c78d6339ec667d097f88fffa166f8c9934663023abf961b98669212a23784c457f8bfedb94d70ea35eb61d11795258b992b77aad730f768b13a04db1fbaf5ec43a16cae2e9baec902fbaca5686a29d14c3c52ffcfacd54f677fc45cb38ae4e893b7932857faa2e662913c8bf140921721312bd1fc561317332f3432f81738a36364f6da6425a40d943f1df9b80647a3160550fac384ef7214653005e121a0efe96c452f9e1f46c39128bfe0fb25aa231048e0d3f353e9fb6c943e24797c879ff49cb4bcea51e3787771a3bba3c258a178fb3952ce5bf0502c6387a71250f4a08fb3a442e84be3259b956694ff12e8cc4f07ea102fe91fa8cfdd429333ebd8f411dae4801c6a82e832c9eccf29988f3d9eb51f2983feffe28cfa2b1e9f69877a3bee8ee9d75663ed1341cee81eadd3c70fad9e9f052895c05e407da07096a6336c0467bf207b26308e9033eba3611cc3e8227c0e83bd18f0292dfd764eeb6b26a3be9a4dc6c14bcedd85a9945bae428be9672715b6239549ec9a18ab2d69bbddd071f08a19ae0c37bc93e85085a22a2e0d0e5f73d34866c1a6318c44b44273180e338fedfad93fa06dc9e83ed91d0c3734eb63f2acf16a5650fc5dceea2da9af8bcdca12c0f3e60ad88b6196507aab7eb494761a8a6772e08debdba163b0ed07aa0d8003b90de7a3536ce36ab37ff595664f13e0ae31337428277700ef49f8245cc0e2226d4de04d17bbc283a2bcce76325b393029f7092a1fb3e7fda5df0e3c39d5bd9fccc068fecfbde4a87f79548a5683038310ac5e898b540232c14043e92c687f3d1b5adb64e9b2d969492f0654f1886ec7ac3929d0d787894f13338717d04a866a1be74626b79ef80a0ab10076e1dcdcb1b95fb76bee22031c22e59decf2f720f56a3374b825661c3d21ca8987bdaedab55d75e3afd7a1fba00f7bf6480fe7181d7c502e8ce1481b4db3fe023f6e9613d1410c4f55ccdeb62f480d7634b93ec943fefead89fcf089dc6db4d40f3d52a66e43f9de77cd6eef039de7099678a224771f01a3d9a12637c66511274835b1211359ca2e05605263f4e15f049ce2e60084aaf10d9f7828c05d51cda18b0ad122aab2a57f0905019c5835b3b800f884b6d353005fdda964cee570d95bc7082170e6b110a0806d232c12288b7cabd7e1030e23a8442def29932ad4a95106135110ca739a7cc584e94839d7594e78815c12973d9db4f66dcec1cf6aed1a2c8109ca0f6abff20144cad813000ddfbd163790bc84023233be672c8c8a3235682e5a8167d0f52176998801210766a2873bcb301625fe81513fc6a9348737a2b49d2d22f90b04414d8f95d9eaa4eafa73e53357c5cf6d0589a6a51f8513a0184de935fa0596d00a74d7f80b9e840cc308b9e31f2391b8960b53f4b510c45e412cd41eb4741e2e87f3d0c8a3e66dca0a6504a3c89a0f7fa348c6e2fe24bc16f220984c9826b7d77dc15104746d8969cc003a3ff8df75333000c557326ca661717d44cce2a5af1465684b4e8579421384e9d12e31e77ece7e9e7ea723741e683213b5fa5e33a775bd51aa03552fb4b93cf16f6f66f62ee7c6c4f90eb9e003574dabb62cddc10be48331a2c7f37dedc7e7717a40db80d90c3f422ffd838f4e7c38baf59abe5bad9004f7f17c5204d1ec7208a949c8d903e5d1f3d0edced4bccbc60f7851228ef7c765092fd4a1f64deeafbd181f335226ec7ec3d050e30011c3ff501444162cc1b96b55310efabf5468232159fa9428daf2ba43807d4ec9db2d92a01b71069506b88493ee35bec513ddd8b17b006e16b63fac918788a3dd9aae4b438325236b694c60c8afc43fe92cef8a4809c73dc516e36f03c55931d36417ce76f14a02d82fb04d1bb5d37450a99d3ebcad85ac205d994acb6cf6faa10fb82bfa3329d9dde92d5c7e01db9aad8cf32dea9cc4c753455429073f0f46297d0812e613c35412b61b6885ec359662e0611e482398842874508ccb2bde3743fbd2e59a61c8d1bc21dd57668d24a2ecdacd9c566ffb491a9a80871de440d0a31fde600b4c48b771589a486f68e2a203170f469fc71fe6a72ae94f6c93cf0d39b490e8e157da6f6d3f6530e82503fe1e3159e1bb6a6d767424c4eff93cb119902c2af97c8939273d4ea95797df3a19fe9bb938aaba0e57969c72286ed3340adf5666f8c3f3e993edca08f91be5e760ee442fb35ad6e6e277f66009023e5016fe654fae4d6ce512c7077b05961d5ca8b6c3f5b67491383521d4317b44c530441e25200cc8f99ca3fb20e376d86c719012996eb106b53f1c82792ec03e307b0c6686cd764bed83d8908c02fff738df5d4b8560f09263f6f7853a4673e005fed378ae3b616fcaae6015c40b990eb335a9bbc2eccb8699f8ea777bb8cb8c702e5956a284984f83940aa05d6156210641d2fad771ad3cb4c333cfad755d24057755fa430485f7c86c6ea2d23990581cf08fc5d747085377bb13fbc76aed5d88d6aee2b5367a10e2b5b879d1626dbda3a736dbc10d7e6d2b7ce6e51caa35dbe110033da788d2a9f62e84043e92bf33bdcdd54b981514481e9c7cc1cc6d0c6294b675faaf9ddc34fd3d48340d4acae1aa67cb26b9498ea2e8c4017cd2e050181808f6a5cfb4ecd9f5b0801f41e3087e47bb42768c1c143dc26a304e9fc244689a4858b85328c538d70ca2db4030b0d47b7519e816d22e9d9095f0906da2888e4ea48c67996b4ca4345700a20183c7fc41532e657c38a3e5a9dd3aee09350357f7283a23100fca879d6d0f8cbb39f099c6fd94a9c702673c550810a4a900682b579c14657b07974cc34991e8c28711120337abeb035c285c832ece1d420a4e641e7447aabcbbbd3192d799f1cd7c4fc0eae34532ac816f6d8cd4c9a46e713fecafbdc1a35e41f448a164ac93c534e59da1824e055184634148e22de5a71cd36143153d19568870a2ab6db780f1be63684de5f77af9b3d634654d6a574678eef12100813a633176d4c201dbc118b52d175bdbe6101118e7ee35cdaad0c192c90c7448e802593789e7214585e2a704c8b5abbc8f5a2dc467f861e61aa804f26de8905ced6e9eacdc9231becc61998abe7b536455196efb75dac0300f38086b34df5aff39cf2e37b65c7f1a544d022e5bd53ed4325adc2f92a29b849f5ebd30a5f54a6340a7247e6f4abae2334c93d3687b8a122a1e653ab38861616afd374840d4bc5c785c9642d280432e6863a9e6ddf28656f59b89430ae9c2ab0093b0c18f49e51406a25c537bac52082be6052c58b78242d3d449332a3d41252041c76f4482261a57fd996e75e34fb555e4a2aa5255502af2d1431cf39a086d064e66e83a05766644dd62322bd15d484cca55c1b87a9412df2351b7f36ebbf01727d0217b38205d446a42f8869109e26ca6f8def37d33355fd2df1c1ac242f3e45ba912786d051600470e701b145febe0b002cad4b8eb82b0477bf1b926a7994a1ef41546795ec36e68d0e62842cc4fa5d075a860dffe9a570da182da6bd36b6425c77be712b06bfc6186c1cdfa7a274425489e876f656c77a41bbaa4868f1f7f5de0039303f144c1a4d46054104242d580dbf3f9ebdc4ee78f317478262c91c883e9846635a954179243374d2a6d1204e64bd5ac3bc3d8b7fef4ac71775dd1e01018f4b0eeef81d8106b30b36e43af897116ba825b004e0a700a3e3291d667dbac998c22f2189a95a3ffe01c626aa584d3e2ed8b3498637cf9581f1167a70b6f4dbc0431e0057728f254f28285d10df1108b36ae3e05ff2f0aba7dcd97cd06ca1cfa80aae4475745e760034dab9f84a74cca6a313aba21b8f37e92cace3dfbf365e5ec6b80081c6d497caf9e6b764f5127a4734df031d0d4794d6c15167eea7013cca3dd78fd7ae1f0c0b70dbfb2f487a882d866efd28430215a227f0e1f762ab45c51bf429506a2451f01b117289b118f61424019ac7884e9a218c255985025d2d7ef875b98427309b47fc9f3b39018ba55a3493c7378744ebd02a6eb46ae28bb84b4e10e66d1c957d436dc0f2fb6ac97ae12e69d283d492c7c490d303adf8f9432bd1b2c0f3659093b394b6b89ef70236b8a6822be3177605df4c50a9443ff66abb09a279a1e34eb47f30dd997c4484c2dfbeec8ec46741f749ed4e83a230513cf90c8b38550a9dc333ffa5b43bdca65d7e3ca5fcaea68333afa0c9c57ea9e62a32cfdfb659420921c51f743edf79957d1c77049006e2fb42e8b9b81584dfd38782e0d85c3cafd62181e877a24fa1abdca9ca51f411587ca585363968afd418e586c5f3a7564a6604112cd25c0d80439563efc0ac0a9735f539f99dcbb7416c945e53b7c52ed52bf97b9ae89e5ebfde1d24ab0fb10cd977d0d2791ebafd3dab37b0ebf6d4b535fb43d137ebd8128ecb6f5aa1f4c49c580c9f5f1ab06f24ae3fc95f7d567924017f35a3d52f18b62451e37623568fcf3ee9f8da23cc05458db1aef62c347406bcb3e8ee0b7bea4829a9c6fe78d0ca9fe1b49d3718b1c21eadac215aa806a1bd8f44206c3fbf4f9d80f691eb55769952b3695911aeed64bba06e8d13c8a1cad035ae16780c9994e5b517604280ef3616751351fe3151bd21ac702ec70960edbae059af165a7e3a23a0b2a590f7a15e8f9051236202608576874df597397346ac745c68110e11987daa83b45cf2d8ecc80d1f968324ae7026e762528776af53712ebdaab721747f75ae818f4cd8231a115a2d989c861080802cb2b79132b7efbab26d85b98eb5c8754b51fad84324cd4a87d25c089f0b2b2f152d9fd7fb7f831f314b458db320dd64e590389ad2af36dd0e8990d8dd03bb794a5f31ded30345b321faa951bb0b177da152448c35b95ec88dcf10b0e60e056d6dc0faae7f477debdd946c3c6bb9fb40e5b838af374dce217701ee75222ac40870b4a7d1b5190da1c18f8a2cee8ffb0566e22392d6cb9395d4f62024e6fc3bf0bea8a74666adcdf1a7bf0cc6d5887dca9f0be16f69bd71c6ed166bc575c6c25777e65faa3a42481ac978d609a0600e27c180b907f7954bc5a7fb096ad1f3a432f54e36a0e0856b6a847230a7e7f5f0b4d8259a631f8a46efe29edc27d8b784a8ae4f4b7eabd64d1d30ba1dc3bca04cb0a0e2d1659541b8e9bc35c8965097569d15d79d2c7ab4b563d4ab770ae2faa1d7d9172dc4b721d0a86155e0397c40c60cc1c3f7b6787e4e16a5483dc26ef6e035f8a4fda41305f82b670c7a1192996f7f2580e003fba847931dcefe15bc0199a30f24bcd7fd828b2b0cc6f129e5027de2cbe687d3d07b77cd002c8dfbc2b549bd039fc90b4119687f709f78acb70c863f97f84a841d802f7f0942d7e8a72862dba7175e9280f4bb09981b1a689931890f3eb32b0c3c6d8d2e0c85a5e6485e6158377f920658f0d89b5723d678545c94aac300dfc06343f8e647e70c63176c899cfae62b5a4b4f2bb26a4bd059ef4151f88cc402f5087a26b46815c1a3288c145b211df5c150fd29e74f5781fa16e32357c619a106e4c5edaf20118404d033b348cabd4e63b795d276e89a6a69ec1d934941124eea4dbb86d3c814bc8f514b189e87dc3623c9a03f9138166b708db47708fce0e060507f287776251afefc12849a5c2c5216a83d6577461ab17ac6a6f4f7ff209b8137e6f19f9d87f335f09d841ab5e9ea7a4afd7df181a5aacb949a77baddcda594f09c14d68c353070dcf441108163a55e32c6e89fac671e7afbf610b8edea9d42c1fcfeff399aaf827b8eb77dea78c01863ed6c566a3572453ca61b409517c558aa253458749367a4e4e1631a4837bb36075a0153810e41dd3eef72059bce0950d36c5096e6c59d585dc07efa00f38a8e4e61b364c9a44caecf3e8b30c4dae6ef1eaf91530ee2e8ba158ec149583d942cf499872264509e0d8e6f2e87dc61acbd965d9f3bd44244c1fa3d40b7f42beda10ee6efb306d2f6f7d54e6474a7a541b0ae4fce4a75237ace8da782dcef311be8dae8b36b598b862d4b76ec667330b1a75d60acdbfba7baec37fa9d929e8c1a1fc28bf824aa0832c0023b11e0ae06562dca0a005a6c3443f1ac4b24c3e0c9adc6b051e39a0fd31071b314e3e5487affa00e120fb54b281214f9a4efda18f90b7e44737a1a52a31d84dedd097a2095b2c0d9ba5b1a7ec5c6ca2a92a324622c3865b66357302cd2db3dacd897f18135c1c12aa765fcea49afabcc96133a0a7fb44c378c296788de8d7d9ed51c63ea28203eb198b3adf624b210fd54cce4993b2c01acdaef11223ca00d937019a7d5f2b1b6885e06013ce98d2514788830403e3237dbf1576d07673b6e03165de16ab6a6ebabc5e16aab7111e3674101fd23b8a1399255bb8b32ffc6d2e687550defa06bef40c0c5ca46082c3890dea9753091474aed5b2e6f73d6be4d37031ea721e0df05fb4e280a3714d46bcff92a652d19c7df221f974131b4b0c140ab5532e2bc893654158ae936925896788d7e695f0726187b145350abf8acd39275eaa1640e89e6855ba8d16de561dc014eafa91be7e6f7e61de521dfd41a3ab5052391e36b76c583b992cc3f3da5fd8b3417cb5201c5a5a142a630af35be3a5866c973d861b0949568cba700691cb593f6c7ef2cea781bdfc89728590334be552421197ed48dc0af319025869269aad83b1108b3e1c5a6b8ed766f1c9b9107c0158b15a888e137b11b06bc69b9eeffc079eabf4fb82b9e9f37d08c5083c9a9597040e50cf0d4fa2e83bc9635d9a831dd418b6e9cb9c7b060897465cdb38bc26dd5d6fef9a11911023561e83d93db2e623328f2d8580f82592c77fe6b730c8669a4b08cf6b336520096e095ce67c2391254c1b006c5ac58c24056597b9fb5d1607eeb7378af3ac7cdd41ba0862bd26dd85892c7ee4077bdee38458f8a22daf0548a42d600578934bc9ecc96fde3c3b21105ae7831c6b1a63b7e9b502e49c5287ac547f1caf759fee30b955d450b372f4d28845fcc1da8ce2d3b6be3b4dcb5ff3ff1b76bb27bccc2f170f1abc75b07887944737d056076bfe93a3a07ef1e0765c848ca7bbb449995a3d77cc3b569625f83800faeda40a0d68ed413b9641ab5cc3a4619cbcdbcd000ea9c4c168783650bedae4dde3bf12ddc9b5e1860ab8c9004f828702fa702e8e906d0f15a7e9c838de6b65f028e09ffdb25f0884a35c98288286a7542e69d30575622c344c3e1759603891bd9e97c28cd3a3dda31d2f68555e3c865e26f5c448d53250d15f7a7090a08abdd9f0e32c735a59c09a45dcbc6131a5b6a4433b19abbf9d40d08a86246de1d3991abcc28d90fdb3a40403fffa7ea3f0281a1135847c38a9b2a79cfb87cd3a794174cc8db16ae3f401341759cc0cfb46e02315aadef210fe54a79483cdf98ab9a43f68b5d4a450c924ae4b2693e553a3b4b00db6d36c8431df2134980a9c15c930911fdd1298f6d08a388cc671c6c23c06f1ff8b1d369652958b4e5c2679b44af31d966cc92dd69e5e64f6243e49d76fe7dc8db2172b3d754395decdc2fd6dfcc78affbfcc89039db8ec9ba8bc41e5ccabfc3e35e5f04ce468fc1983fe028c5c7f6d81ca0a13643cf9c7342a39f2de3c5f292abab78e7b1272a06b4c1b6b58ff15bd185cc926c76cd38b93f879e5f1b595a16183a35bea5aaa2df156c802c67b59c3dc8f01c5e65c958a2573b1432df7ef9ef94d6f63fa1e544cbd47a9e1caeced7eabbed2d498b881b9e35aadf2ef1dc33b302f7dd9852b56f889754fc0b3a5dfb6aaf8e8be5f437d7b890adfda86d455aed9d4018fce184435e17911fbbaa3672956331d20969150c3ef2da9ae88f14aee58ce4c4903fbe481b4433a9d3f44a7eb0cffe29c43cfe2113078da411197ad0ccc6d6b9f9bbe25eef0a474c91bfddc079c97627d5a6d40b2d39d057a407a81db9648bf10dc3b641ae1be8da6b9fc3d3a976ffda74625a9d039dfc54112c6977e17bbedd640f20f80eb4e52b9568dbc9f6865ada1a8c9120d0cf58a609e1e86eb680d48561c8589fc4f14bee4974225d8bbf39b31506aad26a2a3a4e5c010d6414619c749ed3922e077824df953b858eb04705cb8fd2aa4fdbc5062b2a9ec39efbcc6862c8f5a27057cf51610da923d4756699cf91dcc092e13e9ff17aa4f56d5c6fc48cfc92214c42f196c06e912902597d4b68ffd7ad1c19aac3aa3a61eb6280c3adfe18396fa511cdc8f0df62c9286ce5984dbbf8261c470f02d86188193f7f0bcccc06f9c5f9183e626b11c7a030f5b82a902a9474bbfb2c896c13c9a2c22eb480191d435169c4f178b23fd2450bb3e69f7647330e73dacb6bf234eed7bf37de79dbf78bd5cd3d5f47de52fea707e4cd22578ccf437dc9fa9f7f9e2bca036dcde142b050f2735635d38b20b1f61ba349652b67b55cc6f04bbe7ac31e5ca0e1fa1b9b613d09c18221c3d74b8a0a5364dfef012b050385165187b940770dc5760f0b22f31c5e84ecde171ae16263728bdf311bc61c1de96457ea793dca10da2cc91f779b0fe60df5d4ae84024dddbef5d463774aaaa2c3b48fac51097ca1f0daa37f9a449986555b4c077f9b1f2017ce7d9f32fccb9029fa4057562f2c4472d14a1871971a567b77195c8491b4f6267d8c7989e07961770489313c8ac71955b6e11f271acdc8a167a4b63239b2759ab5f46ff03e41fb131477fdd03eccdf59f6e9820af95d3e92e03f8640f4b26a1e7a2ce8ae07f9e2ef383f34f0268f3bfbe02fa0c906bf14e91a9e9051f29bd94eb0d40da275e2ae52e516a8736bc85cb341498123b008f0f154da51e59c2b280d9daac2b37fc7f6986c0627d3ffa4b8ebae819c8617f9bd27bebaaca1a065cff2c061b4e14a3bb95af758cdae381e0e0f684b3160d9c7b80522cdbae4e0a11e4d448588ffda8bc09a134f9dcb1d74dbfa9ad95224bfecc53fa3e6412908f48666b66c512e8e39f666025b66cf92e13eecfe08654cbc31db916187b49b435aa43423e19133fb7450975c0583fce03bf6316e22b1cf73203fa4e67225c7012443dc1965c4154c5b5472cbad70b6a573cf40ed9f002ba30787f5d80113082a8b6923eb85b6e284c70956267c87873f13fd9935e3bf23ee7f48a4a0588cbefdcfd0f9061655a9a13c94a11d9eefb59d9a3033339482fc7cdd2761ea018b6044d5bb5af769197de3aedcbee6f93ecbee5a90252d231493368a713532f3d3feda67ff73062307c258a19938c8f70ecdfb5b3f969370b905587b68806cd33f43ed8d78e3440041580e042c9fc1250264da7733a4ed0d4307d080f4b450222ef6010c29f619703a0184fbc1829d415d95d46f79b36e5b3a842e25a58e1d5321b384b978a9f8bab8f097a6b8e3799eaac6dcab39132f23d973b4bfd1628d15151f645928a6c9a8248341d9471d3ae9d8ccf130b385bfa1f06be44d11a92f03baaf90fe1d023256c072f15831e09add169a000782b37a412a2cf61081f71e8aef00272ae5bdfccf0bb41ace76b9ea8b2818aea8087ae17dfc6a38cd37bb50efda1f9f30b6df854d6a9b735baf267eef362589cc17c18dda5e539251bf4f7900031177bd95a21509bddc492780073edc76e92b6b0c702e1504a54c2e169628dfbc8594459949310b36c714808a377e8b7f287b8dbfb1e4cfe5ef2585d553add26e0f74778c29775e1cf6cf798b3f5445f587fec95b1271697d056f766d33e1c06ebd7b87c15b52c2597193d37998b29f761d7a4385860b5fbd4651d1d9ae137b7f3fe15022ba1ccd6502b0dde84db7428b9fb1922c379e11ac5163e93f399595b039a631fe36b1ff18022febb4095a6a1b2392c780b86c225d0aab9f614b5bb333ef246a5ea4d5836afc5b0e843df2a28ddc313eee943513587f70ea5f437add0a4f63305427a75d040a5b58eae8b0cb5e9fcdff4180177ccf061609eeebe4ded89386bab2e5a260249b9fc18ca6ed7bb86ecb8eb7a8aee1e6ec934b6a34858eeecd8384a7b93d8e88d63362b297b7a1c0b2917b4dc1da5d6bf0241df7322b8f52441c063ba5cae4641cefb28c44a48577c13c195968776002a0b4f34806c162b9380f1dc18f3cf1c3ad7d6e285f319fb9e3a191fe5523e3626b521abb5db5162a39877a3e540d7982a5be424d15270f6f36b63982b4a06c9f8486867a226babe9f291357883457532d235be6fa0ad34749af441a492e2729ba0dc4fc58999270985dd296e277bd5785c63f171917e0abb2254391e53dcad946266d6c679632aa34a532bf28e4c9756e988a7991f186d40cc5de7c85c09aba97ed676209e2d2d62735c4566211607dc95c7ac5b239cdaa85f5c8f21f9b407db2b5a69efc3e61bf7d81e4ab0d7b12b3e46f1bd7255b7a25da20f271f148e49c4260c0e8511e1cb861f91ebf18680f4584ae5b99f7f857de2d3dca7bdda4a7a42c19579333eab05f196b0bfd243b60d1a9b1427e27a13d70c962bce9ecfe5994cde0fa07ea83608a431d16d055b77698444ad3949023aebd8d09bb62245b52b2462cc0fe9eb9ebe6ac5fca1610769e7607f31dcdf6268283c258971cbed70966f8247f5f2135d2ca69752938d7ca9555829b728206abcf1a434ac7554c4273687f35ac27638708aca2d05dc1488a6855cccd8fa62f329a15794eae06c09e2699c81a7bf195ce6f4877ce46b114e36805acdcf2eab999a9048532caeb7604d89c053974647e8128d5486aa3dd2c78f61e7eff74b42246d77ec5b50959f9bccaf7611b7c2d4835dcd65bcde2c01f88767b68abc51c5bbde5c9a12701cbf97ebbf5155448c0ec1a570e386df08799d318463664850cbc11a6361dabbb9a60187020aaf2cfda7d2eab90a731981428854fc879a014d066ee97da29987060f5f2ed6af383033454c3e494904cbccc602aa635ee616ceb3400c6d55cb097caa71f22fedc416099006eb221ec2c28560dc8ca03053c46a4efaa107fd4efc992bbe412e62f226df3f4f7d0f5fb9b579fad059a0220c55df1d5a952ad154092e7f4626dd900a80bfaf0434caea85a3040e741acae73cdff22943d6296baeb253320260626c2c6e1d5e59a8691ffe0f61541dbcd62af6e1997aa094baf180692f647aaeb90ea65fa9ced14a5b5f4de5cf9154ad1f20682ce1d53679d840661885feaa66beda4758fb5afac3ce6e71516159633b63ec1df09675f052bded3e30c57d4b5e332a58e3e6eba106fbc7f3780ba764d2d45a50af4db3ba82c4929cb81a8e70b980b2274cbb948f05129e1727d0591847815588963a3425a68d6516ec8b44e2295289ebd524b90a0120c874620d3f4c5fb45123d18c1bd797fabb3d2d5059ec56de0de2cb8d57d984c3459c6e47d7cc3f15f2c9ac9f77b22adfc869ad166d05aea36ce6c79b86b9d6a7d0b3a3a72f4ea389ec825a082ec94e5146372bd38cc4e15b1d018bb91be598c0698f51017c43a1cbb9fc467d1730cc923ed2bd3af5b6cfc0d50e1e4f831e5190cc1d70d0d02151e14bbca801c75c07b7dbcf1ea0c4cd9e1a666c7b703c2a7e5753da025fa3ddcade0bab78afd602ceb8c23476077ee80ff5b90834692854b3bb5bc69d1d13eba4f59e766f30c1c56442593546d91c65d5eb691e9deaf3dea9d2adce2e9654cfee7dd22986fedf83ea0afd55be9258e9b66de73f8590db3ade710946e9403bc62d12ffe84bf02586f4acaf204c534c7e34f294294984c1078d3719358c57ed1d7733927cc61a2006175f44d46152f79fa2cd8959c3fd976afef4b930f808de09bd29c81b7375f8a3f5f35de0cf6fc28080e14677326a606b1daed2d1f0c9a860822bc89b187daa92e89aa08a9ec324aa77bce2c664c80bfcb3e4af7d073213654176ec5302211c82e44800bdb823adba28abe575b60cabb4d8f10abb2e6bc43e0fca9c0181cbeabae29c77efe2308f618952db862bc7f798f6d55e9a1d11a0a48473199995f422fecff901a0244342ae299d61d4132a7a3959c30121ca9cf9185f467a4abb634d030805858b4330953c5056e218739df581154f528153a3ddbde129e30caaef74f620d04ba61f994d67a0d5afa1ddde33f832bb6bf98ac5237a2191a2eaf0ccff93b7a874539d1e1f89c4b060fe8cf03ff8da092930f2dcb9c21e8bd078e894c467377f1197b8e07813acddf4b25587fc727cbd291edd44230eec8874d8a09c5e07edb6b954a490a4a5a8e0dabb56c2dd24b426c742ef041784799bd9b17e6f4e27558bbdd055afb9a67da341fcb4cad3c6f92a98bfcc1220845efce2d2fbfcf172628f0a89372b13f7fb5f2d005f609abdbaa3412ea2644f7c0117e3b8a398cdb55d65c65bbfcdba359dc991e0ce0651d0ae9346e6eb00a36f41c103b9bea000a72d7a270677e8e393f9d2209ae09bac74bdf7821551659e4858b8373e388eefb0e5f193cb33e9c1dc6213680d008ee722825f8566ddec377a66e881d23b617283234d9d108693935d97a5347b56961ee46ea3f87f2fd7e2c650cc02180d24edc3614fc5eb908fbce1dd326a047254f8096739e2d7dff02cf2fd80d81d561ff20e20bec3c36eb36fab73126d73b7efbbf40798bca1498fe197c26f41a9fa9327df0fcda6f61bd7dee3a248f0603c041c14c3117084eb3d0864345a495786262542b60b310fade5e32536503b65e2549eb0536582224c3d2e3e5cac9c82f8deb03fc506235e1acd730cf9c30fe2051ca6cb9cc323ceaa6afff0d81e17d748120facf31a97b48e0dab755725cfa2b763dec5f86fd33c955a8ca7d78e8b01289adc04010e41c897426427f4e34798a2c0709621543c984239905068b63e628228ca8974a19610f1ee3c7a39874cf560444f2bf97766137d2be0a03e8e9f5ab8a6503ed7586135ceda95b80b7358f4d5b0ce55c7dd43912b02c34d46493742f04ce9978442ec6acdaed0b7a48190f590c9b9209905d7056c882603d8701d9cc17f60640c5f377eca6c4e667538e2d36980a20c25fccec3068b987773115a6cf2f26274945f133f95bbc43657fbd48899f5cda0e7364893405de6707c53332b6af9f59abe656c2ae2bcfa2d68474b078c0dc2286536c571ed659ea1dd96c00870878b610790e91456505f405cdc0cde9ae816cbf60852051132920d40df54a31eabfe5a878913f5747c9efd2b0da82e714265b4b7e81f53e0366c12670ff09d2407cc266b7e3e4ecfdb282906e56f00b99a5ac84385be285ad73c52af919319c85cd54d775defb8cd47368bbf60a5f52bec893c8b08e3ee279700af5a0a7701908ab820dfcc613cba29ba5acb2a09af55e72370f449f8e54b1a273639658b6f7aa6863af4cbb7bad6b777229b2338cc1fff9653d4fc67ede8b4569eed70b2e307970b64a70feff66fbd63414fbeea98a83f51dc331dd4e91013f70d6336d2a32f1c06958f10bdda683b4f109454e69ee6481b9ffcb4fde03a1d4c3e6900877c809c597bda98032a27c76af91157bbed01a5869a9c4160f8e49b875f69d742b182644fe670d7930290cb1588be0c39518dfc40d9e4b3751ad6f7a78a81ff5dc6dc3f923fd0b9a6b2d3edea91de131b6b276cc84e990acd556427ed2fbec6b639678524afbb2f9276424a22a993bec13ef35b784367e68c8e949b0538be5ece27bd3e5057d5b98234e52682646cbd090b50d9e52dacd1bfd1c229e7095e3743b07cc6afbc2388f8fa7244f3c8d79f5d4774aaec11443f106e56121808fd3f9166d249484e930078794520a9a7e8b72ae06af725c16b6cdf748c7fb6efbc787b4ff0744bad09fede726a98813a18320138122f863b3c63f7d55a7ff94f4d2a64bafa7b446eb06ff29d629ec4e68df8c49937fe62186cca60ec2649b900092d4424b00104259c2f45157b9ba1b4c43325f87aabaa8cd99e6679831400e53d65fcd23c0d83c6b1881abe256b539333543759096ae8dd68b0c1b1817fb30213ea36c58b0ef5fe5448c87d3e8b16781fce833b6a4ba89c2eb30b7fd232b8d75c3b3d58437a3cebf3559cc47bf3c6fa1cdde150f473975150482f87ee609e689f77ac14cc4a2f36382014567a629f7577684d521e38562303351900fd22f9cbeeafa70029497b5eb6559bbbe38bf16faa0d16b491ba330a406476961b81c9b4c3e734d42de1536efa92746f035e2eee94a2e719aa457e418bdd088979276c9059a91c5d5ae025415809e4126e2d710db318290e64b71ad373c1829b98f7f78232447b2df5428b1bba460c5cc1135b0239e406959c5cb5446862246c538ac46d2cfdcbdf8b81daf75d188dc6d1a49e989a12ec3bb5f96b63eb1fc91123008cee6d5fbf120fe4adb942dd95a87aebacb0067974a0b05d9d5031c941b58dd27bf9742463bb27cf62803a5c21ca42047b8d211ff2c19e4f81e258ce41d2b75d422a62e54c0c7b2e78b00a05b7f0bef12558177273a9c419d3d91e275cbada52c162912b323e887adaddbb274b88c3534cf810914717dd97426b0ee10f96c5b21dc1a6157f00b1e1f6d3449d02eecc2c6f823ab10c5de8ec8f4b100ea7c4647190a2b8321461529e88b38a1858f0b4895d679d13076d9a6289027f426579b8f871b11a75149bb1ad4b6612d990939ec71ca92098ece3f85c98f228057ac1247ad174a246031ba5969ecd1c453d5f0f65e31b20a27f9b9f27507075d7c5e0ded8b1e8ee50877da3938c67432da1bb9afa2ed9179f868f164568ceef49e8d2f2776cb270ce87bfa1cacd497ec20473688bb56d9c979d2251ce81fda6336f58d90785fc450f4a9a072c8190bfbb8cd30dbf933fa227b87ca90a1eacdb22a3ab04b05fa2465b928237583acd56f125c39f05882c1a655f2413418afd2c365b2c1376b801f1ab0dcd5c744e58641fb06171874c1927032d5792bf5636820dd61912a1c58f19d1ef8d9f14fef66bd61736e4dd2cc951b9951bc84256770cdc001d95bc18f00d075c3b8d4c7ba4701c568cc9636bf8827b982e396340d605c465f9dc5e80a0e599818278745e6d49d96e4b4dff5eb977596f342d92c045ac9095a86c6e32d0d6ba16e2ae140661407dd2000a45f71ee0be2cdc5cd2e4eb09e779a33d5241d7fe96f74ac93a734ad06a3da2aa816e0b77ff809c1572ab401dff72186976df445f972165ec3014e677b32dcebcdce5e212bc3d6752307f3717103b7739097ca12426945fc6d9e31819c5b556075b614db31b27da453d54aee0fff395e4fdfd5f0dbbe8c719a4e13128ad3e2b17bc1db4d35d6b9bd74902926d0e8bb6398a542b38e46745876ccbb942b673e60584ec8315e99a7432ff71fed0766f15559fe6c5e535149a210ace0627fbf59df74a270f07209e55fea44c80c744ffbfec76b113050de36748bd3514287c6fd836589283aa25e8b47f1ddb64b6eea5c2e60f6273097b206c30f1a5c55bd24b01f0d54da2f76d167c4d250bc1d96c94f3596bce0430c6c4898ad5264d8926367f661a7c5561974a81eb0107f3c7e4e3c584bdb7a549eacb51c590356fd3eb217c6d9a234aa50a0a98e1c54338a73b5a817b7e6c2e9088d4972c420b8a3b3b69d504e6c40b209898e77565d935c8305164dff6a8d6d4bb8ac2e99f86a48b20542b205278a514622a036ecc28865493ba47c8d476a7cd142947fc48818e6901fbe730ce470b82b23a3d27b89f65b2635a8e7ecb7e68f6930d319293de21972b8be7970e3ec0d8610917124e2e7d78819f09081c5ff22ac499b65e111f91879eb4a66d5a6f9897107fe575fbfd1b8017cfc5339f415a8ca1c73f6c38a35abf4f2e2a5d50dd2e46ab054a6288101a3b657813e0556afaddd6d6251268565ca92e887e55bfcf4c31f2f8983516fab5f0cc60df2294948677799bf5b6add297a02ce687a33305c87bbe63b73874586847b24abfbdb2a7c87f7fed75fc699fe27190aaaebb62b9720ddee43b857e14979f85674c740135e741724b99c08faee86b1bb9c60ff31acf01fd03c3c885362e1ed4aae1dc697e5f1032e7a9702f28aff8c76cc73cea44ad5a59457abcbcd6fe91d08fa743d5b6c40b88e6f8764bc3abefeba0c355b8e7893a9f91aa1f1b4acdd935fdbea9be959d408737571d1a82ceeea608a9aeccf911c3e07354dc3df4e146eeb982f83b76ced310b88fa6c1433d7ab63b4ebf69ddd01a8b20f0d6d86a5d8c8086da2f18beef1b2f771f80804449049d38b29eae391002f273a5093be790744eb9103999394e96f76cebbf7e4373478fd9bb61f79e5d7865102f14fe1754e54ca611ba2dbe13155d6d797b003cc33f3a0f5256c19832ad756236e312926ed2c39743c745b8a614bd003fff59d1e5c2e2fdfcb3d12046249d3cdc4f53f0f9462d2035ef4f9a0558c69d4ae7f3296ce564e7aec27be7e8460ff0dd948187786d8ade9aa3ce90e1cad419cd4746e197efec78b86717dc3dd80b62136d58b5edfe474aee36a682b7774b78c68c92beb0498ed860a165d54231050630c7c2f47a549fbaaeab24d5b6062cf8775bd550a227efd7260872969d62600959a2db68f8d0c1c61c0f79026eef9b38190e403911b872467210ac9b3dfb0611e36e7d5b882a340d299eedeed6e363a9161248912e9e066ce45e0233a0ac55098dc45ecb85ffe6e8824e1ba8eb8313bcca53d4b1213e51e1285f8a27107edc9971f64f47f56662c5d9cdd70fc7e208e545da45fdfd537a858c4aac602ef158cb020eb18dd74361e9888de601dc7bca4325f18e6a6cd7eab17fbf2a3f476300d5393788793c5d5c1278a9f35fbb86630b9112776f1ab0d546a4028434ec50efc2f97aa772d5aa37e886ff799283f90875c987bdb2ea5fa9db6eb01c1e6b11d2ebf7629069d3baa0377c295507bb58dad09044a89ab24ad48e740af15a13d9db6d4f453606f37b8e97750635570838a358ec9d2b5c141c4532c8b34cb299bc9d5a2e09c7deeac21071d4bda246cfaf7851131320f464db5f9d4e5592af69c33d10e8cab17b186920ae86c3e94bb31419153ea7619780cb63a740b5755ec74053f732c3b167f75e9b81912a12ba98e52ceb07878ff2736a2f91245d1b4da93fc7e3d2ea1cd27712bedd3b7abeb1b0393fc597505137bb33c25358bfbb0b05f16cc4c7cebc799de2c469fbf3bc99baf38855f8b7180fef79139fab929adbd4f6f93271ba83787494506940563d072fb032f4162ab8667eacf208c8472f0e33eaf2c90c330d76db06da314d639cb32420509d6c48b5a22f68b2c5eb493a85df768d968ed60b449ce7c3be0d6a80e25dfca6a569db2b04aeee108682531b15ceb5ba678a86e9654041c7ead40871c7303126c13f1607d3812aedf2635b1cdcab174b63a22293ac79bf7c7885de73067cb6493adb84c20017cea80955330de5e50f3dd15aea836b73b39f2798a160971329234f126b50881cac1f66735e055a6217643279061be1387c68c4fdc5c524d420f908804bb563b91a7f60353b09933866075c8c4e81b059d70d505fece3b186034b716abbd67e71ce32703f5ec2f579ff6237ae8bb36c609b00d86582c018504785e4747e5c5b4d83a60f2bdb4b618658f27aeaa6ba619f46e8275a6147acc1182d1d7f66317a4b7d2e63bb63455891450aba66e987c72ed6d413feb080c6bca8259b145711db0541b7026c927819af8078b4e021b40e87c1a12c7ecaf90a39de95864a24b9fe3c255867f1aac589b252d134fdd1386ebea1807ff298cf87a2a9a9492a3479b53772e8fb42da5d2896375203d4f977e5aa70990f982cf994aa8560e3c5a9c76acb6d0858019d04af4e7c8836829254b7633fc1e397e8f5f8167d1edd991f427a299a23de5c08ed4c85b2a1da3f932c924a2f872af889b615e86ac23d774ae7bc85021379c3fe499a47addb338489751ea5f4ce362842ed15cba60c9bdd45f3b7cca8e20676b187eedb4c1c21f31f8b6c86d492703f6cfd869cd4b478f87b78d17602964fd4743624bc8fa2f128b5e99262f874085b8ee1178336447025916027604549e8f224644e8a15fec9b890dacd5edf7518bc92a7ba302fdbd2d24c303d67330ef370d105745a2a70a4c976c9d1cb444c86f2fefa0355c00293cf2aa27e7f18aab2d6ee6dc835ec819eeafba6cf344d1cb3dc10ab34357608232108cd16f4d4af579a919438b77f3279937ab2d3d1e3a306e6e2f05f4f4c0410c0d070665a5ce9e54cfb9f53362ada3654a73216c053bb4ed44ecd4c1f92a4ef100fdfabd6324e58629c61dfd3ce3dd2be95b39d2556b005d2daf73a3a375462b363860eb131c036321ae35943c28fb673fe0645f384360db359678e8333db70c57ac58ad6f73eb42521b9328d1f866bbfeef80ea53864d01c347ae4852ad0709795b97839ad6b81423c53d64f2bf52604639947e46393432decab9434a3b1bb11151334d04998de2c9203e1bccb97d768c6c9e9c426b04fe599c4dba6054602af80b6ba0dc505b2f1450a40c8288ee447c10c93bc905da85911ce851110a5ec53421e52ced673c29b670916998221ec81c8f615a28738199d8ff81e25327d11dd7c412e9ef9054a9d9394c20953c19f6f786b362a2624fcfc236a5c4a3863d86938c68ec3071a6611db2fef4a53612e2318b7b8442665b457e8cb3c8d60024c4fe7ad6d21df0cf03b350fd10bb5887c52b087ceb29ef03962e45384b2541972247847701b02dbff18d15c67c4b2401200db2b6125075fd8e6a26b1b685cc1431e4c2472500fa83eb00387babd41a024c229ad932288230d0be546238b7384670fe196a6e69fb371f4565c6460b909e610340794342bc38c1a45697a99d5ce207596be608d39f980454418d00b2665f5140bc3731ec191e58f23c74c608fce1f7ae5786152b0ac1e3c7d4f1d00aa792d366ad292641882f51eb555025ee46a4519fedea5ef821113ab9bc1ff338f07aedade1695a67af925dc3d92ee2ba6e7e1227aa1f6e91dc0223db8b7994bf1f1fe50fe188b1491e9ced49bf874c3a69e4b4708fb0cf078050c3002d98e520ce9de2e70c08f2b34a8824915cb0f79a2752ef31fd7bb45cc68515d680295d5ec5a66d610f95e4d105a586439598fcb44fcade8207d6d16e93d2923c6fc1462fd9b18b7c0915b7473c27dc29f728248dff4416bd99a9f59fb4a2cc5316ea83a883b7307f70c721a2e2535ff88a5ef0fffcf9bfbfbb83cc0b1f5a3fa7b1c01e74a8654e9fb662e3c4862e4bdf4b2df81cdf458234f7ce52ec6a5a5783483b6ce0439a55129a911151e8b61c5b68f8f3dcaa27fe215ff812a4dbb672318d22da87201a81415ab5f3c46c2b4d42b1912e1568c1db81c54bb09f9efbab69ea505ad70122aeed941a829efccb8f70ee4f8c4e868a15d7e630381ecd2e64801e69da4a70bfe21d299fc317061475e4e7ebea955626326c50ee2b0584f7595e3ffcf59d6f678a7cd8c91a0951cfa7da5b6ed94f8befab9dfc06d4dcee93a8c95f30f51e9a5711caa31e5202d80b76eb298fb22563bf17c05190a8ce9fecf31496b67c137e9e40b3b77ba1f541b5e83d0786fc3e89e9177c374eda7b4b60a3b8e99e2428e73d08997d0c151d90847f3f8add830144eb1ee89d8e8ecef09c105972513d01c60658217ad357adff40aac25f109d7c6c7a9ff74265a0a6f0711cae29f25fdecb239fe2bf974e688806c548257a9cd1b24a611efc80184d99275fcf10f6ba70920ee60508026e07269766111bd5cbd3a3dd1db87f539b05517a00be37497bd809947dfe7094c0a8ea2c20fde02c997f1f6e83a00f1eb423aef736af0f00ce850f10a2ca3121915aaf5f2db9209e54e1a10ff32c6751b435831b4a6c0883d225ab9cfed0e30f7ba4f3d5987b6b7fac9b4c51f5cfeb3c7049dbd7d609783540e318d8b27e3b4fcf2cb0b31381a7c95e8aa97f8b7108629b3dcd824b7c29855eacb53d895e28c77609ca310fe284ad652cd8e1351ac2a1f15c4b9df411ef7630765533c2738b9951ae14c90c85af573af73697b4d6922b766ef89c06d6e8559af90a81e2dcf03f509b2d626847a72e6070f274f0a3aa570bb6c20895ac7c7be19340c7c79c1eea310d76d656d845dceb80cd51c32b4b19b2d70804edb0249ff4184cb791c8047f95dd061cde1295cd9664dcace7849114ac3224f1cbe997c5435ad91ee73c9f78cace112fb9bab705064b107ea19866cbbe06625860f1672d40a712a0499c118a4e1ebe3c670aab9b7ae438d1e26c009fc57c860547b4127a5cf19acc24039c15a54d454fe52474626db4580c2831c7156cc390beafa0ca204e95b6d88be00c6db15fe14175f11d1fe90f0b05c9e905aff628282c435ff09110adfc402dbab27c2107e2366fca64cf7977ae1d05efe13585844fc49d7627ab339cb88c562d4fce15021615897c5d28cace6a836219d24ccff2f1c5be296374c0a05506e3e2619129f2080663d13566f6cc59b94935b8fd86582e5bc9040973815223aa3650372f6f86883464b6d0eb21fa6184f83bf5bc5c9672be666665474cb8b04079c05997b830aa743e2b3634cb4bf42cf08a38e766c4430d9584813f90b439693cb84fb84d80ccfe4ff4608e33ac298726c3d1f9c3f893c22180d64a222129622b4345651a39f7b6481eef250b12208976e15b5397c4e680a9db3877852cb4734d5e90e386ab92746e11ebe8863e8d5bc286d145e5472aa2243189d9139c092febfc408233ea72b42b7c726b31d211471e60e2f49723c4478a11f9d87633bd1bbb9172adfecda376770ce53b201f630696636c527214cfe813dc15da269db8bb40118d710ad63e988ce833419f0724124e205da0053a38aee1110f2b38ecbb8e58d9fda08003c432423aec885f15e759e68cae0ed840a0c828a15ad13855edfc218153f6474dfb4e539c2986c1c592d46de7811b1dd4dd882ee23162697f843f36200f01daa409d7a570e0ba01ef009d73259c7d25407e0bd0878466e65920a09581e65dda5d4038b367566a535cac75f43764b94d4c5a02c3668d432b5d16150edab8b5a800ef882d56be12413434b93b09f69b0f63fd8843db06ed5dc76cd42dbc284802e58519bc6b87841bfced2428d0b103fd0881341f1926b8d3a688de0a5508b9b3489a38daf5a09dd942d28c1d7abcf90e7c9be49bf2d9879b0840a1266b4ea883808bb759325f2991bbbe4c74bcd491464add18183c1e0d0047985cb2ec9e163910b98a6dd192e934e65d4ff44a732a35462ed2dc583f51f2cddde71279dc289f621b350241322cb8e1a4dcc601b6d0288e73799a3b992fd1668c62acd0b1571e0df3de3139fc835817801127828f1127e4526977f1afb6fc2571574ae967c29a52b192b7d4e9277ff17413e0e90ab80c1acd645384d4db658c047cfa18b53c96bd5fb978d85c5ba7778809d16e3b960fdc52d17120a31bda001065e77d514e92d9214e46e1b54664d7f26238f6a07ff7f670adb38921d6caca9aab977ca5f1ff96899db3b7821a6bfe99f21e6ddc9a79baded688f1b0e847534b3637f47de1fdaa4fe09c93776d018631b96ee055f50ba622341dd408c810655254263ca6f45f638cbc7e25867130354006144fb8f852434e9332d351c177a229b918d8c8d2778360881b278101e2e88007c3cd30f2276cc7b802aaaa13cb3c9ac5d2a0253f5ad98464f23f406a361ef34fcf0d8dae619668aad74a3187b526460623fdda423c48ae5054bff8ba929aae98ae22ee760714639a17dc5a58fc23517099e6ea28db087cb26b9fce070a71d244f41aa74eda8f4ffdc057de316cd74da72e45950c2a3d4d15b0bcc5dee5ccdcd3a1ee91b507274bdaa3916c1caf556b445988ee7c97759128b215bc29fbe109ea1c500e74f926e43633e00c29d04608418dfb15f3116823044457c77855aa506618c6fb8cc2370db738fd3bc133fe0f7e2377523c0c69d375d75b4449484d2e8ddcf97d33c9f7b2ec3ab636ccc513dccdff2604e21ae6fa44e18a4e7235324fc59565825f9129aebe0ae9a9eebca65d74891b3546ce601cd3e599a0dc28bcf8b9e90c5042d7242ee57bf2f6002dec358c2ed2572f8d20b301f6dde84f94212d8ef2a0a3863f424724c7e5274a0397e240d0f0cd135114914f129ba2a1d468b64b46adb44b299287442d9481750f137f11d4897e7677a437de71a0d251055da7a1e1a73b77e519aad715426e9d0d7e8777ec140cb0b63d6f0f52c06671b0e56e5dd13f66ea48c796377f99287bfc4108e4843525579e0d328eaa997431198c47deb6709b72334e28fe474c3745eb1fbffaff583bb40cc8e0bef1e540dff1fb1af0665b0aa01b4a7f22f0ee362d30955fd70c959db0cdc673b9d036ce3bc9d491b52da6c9feae3db8721b2042586dc1ac3656fcbaea19956e137ad3904a55d7c97ec8a5830a56a6ef6956c7519a99d51ab85b0a26b218a3f882d5fa18f7f6713791b738c33e14dc92bc9004714a3315f32bad0685035b7d366d10952b944e5139a85d2f3deaf854a573bd5be85c9a20380d98bba6ac4c418cb0504ccc2798b5b2fcb3825d4bc69666aae5297f475be1962988be88e270b933a65de065ae56decf5540e521aa4fea351c5a74a5063ab82d085959becafef5843fd6b6a4bac9681ecb9b98dad7ccf6c29889d5a0d6eb49be314267debe50f805eeb8736adb052b3b36ce843c44b62a82315b2d1b23dd250133499dfec05502fbe879f8ff0e443cf01106e937a01a470c45f5ce4b038902653b465a1d86fde64a2f7b5fbdd890af3b1f35bf125fbc7cdb4f0d7b9c61d50449ac42d2744e654c50a9b6097c517e94f6d21b0e196ef77c5e3a503a112e1b8f6c7c8157a1a8638f727446137a9613d6abb008e0b7a6de7a6595b8bdb4ada38173b66ea6911d4d6ea06c48bfe15f94e9358d45a823dea19c3232acfb69085db205be878c61468af945a631fbf5cc4fdb6a5469bf62971a3ded00bff0a2f5d195fd1cf14c7984121ca32be185005fb5754712fd3dc291b3f53228ed32324c699b26acf8e4f3c11ab4e1c233361b88d299d2c6c12715e645e41fe0c3620e73fc86d31eb16c98e22675e95d21c52f60c2c3567c323240712847977d098a5de88ad28c8114b61501f3f52c83263d63e454fea531afdcd78ee7560577296bde9ac9851b911a6578634961dec41bcb6e84efd556f4ffd6f8a19a3949794e7e69a181bc01f58428c60611f90746e5c87d97e25e26c714f71c69cd33604cfeb65448d1e927f4dbd4bbb18d5e95ce82f134e374040eccafe0fef07521de70c61fd0fc6e3aec8ffb8f53e766d00dc47bed869f64c8d408c6fab9ec88bc4590305433bfaffdd30890ba0d8e1c354d1146fe4ecdb89f78e9672dbe5aa93c02cee838d095299ae7d0a42a9aabcda4fcdd821ae44008f20615ee6f776e82f47f5ba37e0955c708ce4633d4f4dfd0620e9dd884544b9e27ecba7c7cd1d63cd974315fc0fdcdca77946f83f9fb661e9690d8d83cb9980854791a2ae8fbf59651e8b22607e164f05bed2af9045c62e6ebb6f61c42628d3459a2e75155f44b55bf12030842886ff47562aa16dccf75c3110223b4302b3ae46b4287fd0269b13646ece9c8592e6f6ee28e1a04c853e7599eff1fcbb32332362c5eed5b727df1376c54347363e6b1f54f4e6ace45d7a93849f8e713cc6c261fe17e018c7d1ac82b8f86ab6466e07d0c98677e0ed4f0b07bd938f2b61669a7177379cf14cab2ef93a75f997629f5d5c2206c19f434e7e936d3b98fb1e3b5b98e3215165126cdef8d2370b34f9ba552bca88112fb71df8c5d2161fe57eaa0728148deeb1e4ed2880ab33f1c2b11690eac662ed908c1fd16385bab4b735f041c895a5bd6bdfcd8d24c9dc0bb961e5ee44347380ee3c59fea817815fc731d1a22509ccb2a064aaad3d42c1e304ad82828239eff0ea2487ab9f4de91305031e984d28646cdfb4b61ce0d52ecd62309dc137870d80a95e1fcbde2248f0d888ab02805885498b5a16ce1cabb51d3ee945aa5113d4ff37d325beb1d4778795974b7f12eb89cf9bc23a203ddd50a0af1381a55ae9579584739ad7ff69194f8e04bbae75a49bb43a94ebe5a75c8495307731af27a521201fe0a9825405bbfbecf11248b560374a2be084de37f29400d3ef71c8d1bba127bee1f74c3e217767b8cfae3d275c7ec2bfdaf1ad5033237b8cfc45b27dfed47c9bdab52a4800bedbca7f821cba55c85b1ed3008ffb939c0e93dcb05d83402c49ab9199177efe651cc68a5cf50295284af1923e0f0a79356f9ceeaeca8923c9853975fbae83ea1b0e9adb15eb3ed117eaa716e06bea0bba54ba2ad8a03758fc18ade6385302fac3c77e20ab4600c25d2dd9e262e9b95e895e07dce2090c21372a830c2fbc22be4ad5696748c4c60a98b766c26cae0ea0435d3cdffdebdafd0d05099d810b371923db95e7ea3f900f2301b3727b14a3b3f984711f61c3e0a38ef70e8b60554b77195a18bbc7ee1322c3ae7d116fcd3acc9c4c5809cec10fb3226435aa02ea8bbd9409a89fa398cc68a63e2f1a392734f50fbf9fe93cfc0e0ceb7825bafdb409bcaae962c8258906212ce91d5cb2d7200f361bf8edda8dcbf83a85ac574c753bcad7b8d5e2bbe4aea8722a678c7a5911e63862788364ba228c31a78a63507ed26672628e5ad3ee55d89849ee611509e725ffbd77f8a521c90b80826b9c69888a4256cc74e863d5c0c75bed7b5d0c795c3e9bc55a89fcc94663baed0fe36c73a545c3f063486c4ee34e84fe7457964844db62b2f0751ddf69e643c562b17c13b3206e1b1096fcdcd6b61635e077725d3f53736e0b42b6f107cc642a32d7fb334c50941d7e657686443c2db6f921156598fef9efc50870973ed3bddfeb125ddb4b85e82574a3235f6e017180983888976790bacd60d29aca55125b2a8e14d6cd0e05f4c0d6b1bb68ec65b8af05c49e966dce6d5e5c851257e638b24058548ed775be91fda025caac843ba0491c584dd59508979d1b2cd792fcf487c283ba30118e46257d928a7bdc2084dee1f450f72e209535430f62afe9c3d4a96080105b22756fca3d0454cb83636779713b29a0f806c4c68e9f3d96a8a7ba00c8da18c48b07b7e54d647a9fc85b6b18163bbebdb94617c053c143b1875aa704bd105df0dcef39e107d0cec6e62fcda75d57015853bd8d157c01bec8621d2a48c535fb365a50ee0ac1f1e2fbd2ecd772975c3bb13ba59083776859cac06e3ca051bd400b2628017bcfe41bf48d5d805166902c9462527603e3e7e865275f42208bee8d82cfd34e9d64b6c916d784c196776ff434d400a0941266163e297e2c55de391b27dca062883fc5246efef17769e531c91a30997c8bcb918d2d7fe857fcc0802bb3032209922ff43b4a8075d6b5111475d2f10085e60999911c8fbf4763824cbae36adb91d8545db733cd154d1febb4f1c36a670cdb82c6337eb5fd7b577bf6ac41d8d938d3a43c634d648a72b8a1482ccbbc741d070a630ab4e20f122d0bf0653c503beebfbdf6013469385629f9708cba0bbe5076805630eaf6ea80edef3a8e5a4ca3b40ea326ec41cf4c0745ed3d3dd3be3e1e72044d4ba1d16f73229f3b0b759471bbf2db9e89643711edd730b2bfea893c74107d6efeeda856a028c7d17fe2f293baae3eb4e9a073ec5f62175b2285a3583c0bce9d48d34270056baba655b17a41a62ce88b4e0812bb4b3ad98b837f99f4a252c86ccc4ac5058a5b2550bf1b69c46c0175eaeb2304d38cce97e62bc206fdb9d3ad7047584068e7a9f43e79e853a4183e9e79db533ef89ebe5086603ecff38cfa4f0997fbc2d44402ba18476a485235c15a21c92ee1c3f1a825bf672e66cf7dfeabb93ac18848aefeb5eb483c67eb87529330e7c3130257fe011581467204f0f554804eba606bf2986ab1b96e278670390d32e1edbb6c72ed447bec96afcaafc1edb74a18351aaa5c164f6a0e6a630ed946603e1f639194488046d08adc2ad22f9b9f8d988fb7a44f4fc8bfcb1e9253530ae7d52f4d3444c17f37f35824ba3eafec18112df9eb1fbea3dfb52f6bc1a14ce571b49680d88b0a19f0fb0b9b48706f94f818517382ee361068f81abf2837b25b5ab408d7e38f8abf405c81dc35573deb444374bce1cdbeb040e6c2fca8f8a8cdb5e2f0a991f7881aa38d5921ecaa1d5fcf0e967cad1e08cc2cb709eecce94f81ca445db1680bb77f0763a63c00171f5addf192d14ea473b7015a96b4bc55713c79a5d706413b9a4b050c9562dd69aaa3736c277373fabedba75d7b9ce1fa0732b22ed4d40ed60c72f60d270cc3df68a8ea5d81a3882d4ecc2bda3a9d95cec2e39acfd338e0bdd38bf9fa12566413c561cbd4c813ff2b169ad98fbfe4d7b780afa04c16f94e40375f4f218cd467576b3a0c80ad430f485f98b9c4ea70eabb7041641e048f74e2254254805bf4e4945b7bc76ababc87dfcd8209bc3e7c62487e8c2a07de0194683f4d756cb6d463aee0d933d579b6d671ef7ab6e939f8ed81c2cf1e5fe58f119f3172176d4edfdce059f7d47176be098448e26edf1c186a16083e7e23579788d4592fc023df9280e347c6efd92c3bdf6b514972a92729802d307444fa1a592d97acc9c548839adb23c295e92825e8dc8e79e719492165b0d8296107fc97b18201b7e05e1df649183823d447995d7536cfb6168f8102b9c2415e6024762e6139391fdec06e5c744469dee333bc5cb857be9ba22b8ff1e1f61fca1a0f49069d43a64b70df7a502a2a2e3cabcbbbf6718766153f6ce4159996025be3831887d1c5bc21f7e37dbebc6839bf0ca353389a1bc1a1581c50fbc09254e87c4046333254087e4c970072e789df702eee04a7f19ff6eb510d72a2ea39d6688a8dae4fa24ce691cefc4772f037c37d7597ff8d2c76087875f81b02ebc4d95974b15c8ff4043fda78146cc9e26dc33f2feff2d0f5cb60f7b05379c45be4c741374030bd53d066ceeba27ab13a06f83621584556c80465817042b024915198a46ff2371d0cb00867e95a2bf3659d9dd2a77dca8a5ff85a90598a71ac80395242aebde950fb79e6a00f92a340d5b2d02d833affcd5bd46d4bf632473e6b6ee779116179306f5fdcc993c56fb5991d64411b576d8d30f6c717d453e74ce6216ddcb9a0240b9890900e24e344d4c51a3982fc28161bba487ba8e3aee2dd009df0ffb06cd2f230be86c42a775f7f4ae6ea298ed804300f3d5bb39655dfa06c1bfa6efc620c87f556621d9238684cb7d7e6cf2e129b5e0d44036ce6bf59e0bfa7bcfd5a366cd1b27aa5f9e1281e31aa6b1f574457c4731a0b75f9012a79dd60a4c37a3bf32f6a6e0d837b134b899836d65129beae7d88a02816314245d1a4d5a3b172da9786f49315cd42fe773f7bfb9b40e628085dc6701e6a26840a44f406553e9274e4b4f689549abad1b71fb43d9ef0e17441e11eb94483da1369db06e1a9cc342944a9186e021ed791ad0856c0f5e4dc8fedd3c85c47e55f851330e9f996685939f47c12141e98b55e95e3a0831b56bafbc0b45deea45a5b94c5180c09821d93c0d221944d7b959d2a048179bedc6ba4a7a713c9f03d9d0e1a4c84f4a01306d4a1df58fb8946537dbaefaa0d8ad85d079281d6cf574e0b49b271c7501ade0b7e1422cf90d530efeeb308bd2340981439d6fa34b86d9c00a73bbad8f43f5ade961a1b5a9feda7d9a30d43d50be2c9f71afd1206f05e06bf4846705d9e483afda4638e475d6d228b26527fd404b686797b8231c50ab656a1f24bfc7067631b53714d92955e21e54f73e9e2de48c2950b49d42a277a5e7a898136eae265206633cba0ef3001ec4712bc3dd00a31fe3523a7c34ca33065318cc319b6d0f16a53848d2fc08f955a04a0f243a68cb3eac9dff52fe76b4cf39973c7f48c005d0c054bef05c33f88a5519afe8c76199ede61cebacb2d954d186402d411eb0999890b014c5966b3687541f59c30357634a5ee4347aff3b3d1a9059dbf5bb408635c1adbd1e109a32c55d11c0d41f112ba0293090a003d81aa91ab2b31c6ee1326c44c7d0cef7ddb8b9ff614928987fba9b8e7491e9c8ab674ce8245b6b8dce81e3f940bd7a982f694cc4e0e88e679b5d9e3c124c010b9867e76b6026cf36e5350245ea57e5af01c7edee0d1926a7c849e19f8e8b36f89df5f45a6876cfb93f899c6212537634be85ca8320865060fb519b817f564c70d3034a5473682b3b0acaa9309d0da5144cd7beb2eda5599cd10d173517689fcce740789a1f40b237170176df22dfdfb934116913eb53dda3a4149d3ac15912486f28edee57a13faa1db123d7ee204edb8a8117f3476b18e0e6f31b0cc59d08af9393497d4a0a843d91bf00f759030ac6254bff6202d24fa5d252888cf3e25d71b70e05234fb62800f12df384c49deb5e2bd485c66680c443b31c6a16982cf7c196c1e367942413023d42e5f53619546954ac10cea30375bf88ec0b651a30f0ee7544061077b801b3fca6ed5d1e64b6208648a38a6f21b11bbd2c0b60e229f2e91516ac0a5a17ba32a4c3e503341cacf23c1b09b9e618e946b2689406752bcf61686e83faa6b25e5d3f0a2ed715395c7bf7081d0d4ae0f10929e99806ef9107a9b6129933e0339b481552e955188e9a7d3aa730ba29fd415551b8514169895ccf88812d455986e5186edab84fcaf2c3f906e50bd8db6a66e5da2febbdf37e44854b607b787e9418758e15b157103519f0080aafabff206385aa8bd8f8c3ca42cabec1c4db574ad068be886990a39d3e9d93a7bdf1421ad08adee4500e21131a32b81a9e39b8037202a566fbc3f3d3c0ffccdde53de6a744d0d0e435f96bd6b9680d364a33c07ab0ff4a7af3510966b49842841773cfc6a1aa3d5021363f8db3f74ba859a604b5ff2eb5b170e97a1363350b5bb2ed827e29c4d5af6b9aebd6fa7503b72810351501c7d66fb6eb6f3c49fadd58371b76f42fce211559ac5c1b8069af4460c43a858981def84f9ed1206aa6c7e5b9cced530190e8dbf3ad61108ef27d79137e3b7041318de1eea9d17981d904eef3f8f152a55f0b17abdead96f66e76109faa9560436cfa61f6c4aa5dc3a5051115d6b92c84370831290726370b1ddb7a88d0d4ae9c6155c5156d993b42c9f157cb480de8bc84f4c2820b76e83d566e0ead03316abb172ee1bc78598be0b9859f921929385951f11a9cbf099b277b51c5d07dcd81ca6b66c579a3fc77eeceab99f790f6c2af959f1185b25fc7df629df1180e1b2cd714269fb21db7a22189d50ca0341dca784ce0317e8d32f8f9be44ad8a6742386a12b37387fb653a84b2459e54aea5e7f4f5f04c4566fe6afb15732156808c7158af06a9761b0e67f97ed5cf219b3680c52a14b37c5310bc9d5a5b889ee1761c5c316b52612ae6f8e9e20ba28a6a68833e309062a781c070ce5dcdfc5a2076bf11ba1d633c0205782aa99184f58871c61c3905c18a02feb55e729e1ea71e1e1f447858df073f540183a160f5e97593f780eb3a5537c43a9b3bf64fa0504143804cb07089afa8009bdbb1e7792f4d967606d885aa080191e4751bd356322df98a26f9fabcb69c5f1a4d659a9a34ee168071afb9dc05ca4a8e694e634758fa913c4858620b73a8764fe958a2214e3082e48f282ec1d841c2bf35f483b474016e4829660f34721d9dad32408ff23b7c1d9d4e395002071e9b6a5e324e6f27ff1cd1af35e5c5c81a659b0d6da4324c545392ace154f8b15dd73017b38cabba70087838f2cf3c8dec7c05e5398988840989fbe6ec8589d7814947db77254287a3a023c7c7636d70248acc118e5bf71a09006dd5dcdaebee6adb99b8aa5e7bd8dcea329458da0b0d362f5464cd13a13aa422deef92a45cb6027159cca198458fd8fce5f36ff1e9726c3a7f9508d05947220c66842fe59f27f8437d55c05b78da8f0b929acfe813174e82b2d64ea3130ddb711e53b5b0834d71dc3cbe8d6152fc5e5d620dfd69de66334d20910d43d91b4f8ac0b5fa1d906f3e0379d715617a6b13338588e03776e7835a81dee60b097b899a114e61a3b0ce2cb8fefdfb372ab9d65a320e01dc9fd78a771921682e2895207bd6c8c3be85aa89601555d89aed31fe067651d9593d4a29da768acc7ed5559668f900a6b5cd0a6ebb97a6824c4652fdd4cca6168c5eff2e9e43dcc8cd75c8787164d897699b7b4d4d0d093011a24a61473b54b15070a9dfe6293918e383bcc8818e48ad3da57393af62f55183ba2e2d1a7cbfc0d8cea4dd867b92c203cb9c411c42552c518df8d34739c3fe8e62816b271ec156fbd2da81b01829281b36364c8870cea31c43c96faf61b0dfe3086e455789dee26156f0ab784bfbc8ef34577ebc3717608242d580d7f6b8040904cdbdff47fdf1aa82a63eb3012a38429e2097a43051e7e5016600bca101d659ee5ef06a54bed7e385777bd3017107fbc31ecd2792fcfeaf919551ad3efb560120acab0fcf18103eee0c3bc3790d58084fa2e5febc8b3498a164ecd1316762e3f45b12417382185538e78531a58e98b1f1daad02ef12889c70e8d17034f315e61f1f161a22c0e1f33978ea60142cde82343d1511ae36adb609d6ce99f41c08b62fd9f1d44ec6208e66ec4914bc0707072c4c82644229f4c4e20427431764503322636b2792217c7fa6f9e699e530184644ff8c00d95c6a6a9ed431047ef8b101e7a8532596c4a179f76c823cb85ce6451f142a2c8cb533a34bf1fa08554d5f465864f552c26c09db3c0e814835826322b43c7bc5f2ba571a2f67f25404f53bdeeab99e141161c677ce54fc24a4b30964efb841c3891f8e5530791857015b8fa038ec3191e1f0cbabff2320af949a63bef0dafe8571e496a7d5d6ffd5e4b69e5567de0a817c316f4da886380c08e22ae24c35d51157ff4d5f856ea66c9ef7efac93d98b4c805a286ba0b8651b78cfffdd5308e6df0a991724d75629ddb5b2e88cdd7e383d5e62d2663ef580999a6cfe90de374623e9e28d403e6015c790ec278a8a13ef492f548d84b8a4413f47fa6a1d55d7ee7043b3cb392cccfa6200ffdce264fe6563ab2e5ace5843aa83bafb3ddfb0832378e3976a5be482bd16a374e02af293c91948e88db733f91f8283fbdea043240154981425f2c7484eb5ad14641f6f0b5c8860fdd8e0484761aece9ae5de730cbdd9089e5c5695e9a581cc16d238aff6646e0e2aed0d5d95b028c66079d1790720ba4c8186839caf596b3533b6347d2146e154f76468b81f9071460a3127f3b5be2cfccabecbe8adc0fd7f456473b61a18e168732299dc3920257b66245f74412f705d95691361f42d4d1a37c6ded55d707426ff969f4ecb9a0a150357ad66dc164a7461eae28a317c965adf2d082acc5e3d43b76f83ebc275f21ad3bccd4b3bc159ebf79d16f693e179f9bf00527c6e94209990f9d5aa36d078323c7d8405111767727b3d0b44bfe81b02a11f07adbe31330ed236c655fc5ee206fcb6f233817db6e91501f29cbb17525eb8167db2cce3f11e7e61eea45f1f88088a1e2b969e77121c1355b4099b161ccec944684e9767fd04f761bcc0fc2285307c973c936263ce6fb950fbd0622f0da526e043d0f1c94a1f9cd9469d17aad8d1c9a7e07536709534693ad7832a8c76ea6aee3bbe0da00d80fa08ce58d648cbd80be043e912dbcef6f3948e256e38af024942801351dfd122ff26fd2f7a6ea70955dfbdcc4ba46500970976238259a560bb3296c644a2375c4a1e3d04fce80f0f90639ad0870c7b0a4f8e15a71c4c9ff0a140508e83d88ae616cc06b0138d8ebdbfacae2582dcc850a66b93e7049fe3eb073bfd3af1fc74e896dab8c057e044d13e61555ee33e545a404784dc4db1ed6e6cbbf8ec489a3ace42712c46694e8d046a2205f4c5bddad9363f2621bbe9479fb2cc0bb2cf5a5a0943e99e98b6a29eabb578553aba860ce36213d901fe6dcc0905a1ca95160673fe287193a51ab9198de26b5948feebb3919106dbca831c7b6cf22ef8d9eba9f4b45e6da71f54a6c80d0204346db01dc75bddd15cc9c9064b5e434274ad9b08dc2c6dc43eba1d6712392aa5f60e491820935ad9a6a96942a7d31e1149f51dc222c39c70fa390e4206bae9bedb9ee2c3f3303df929f66d49b7784826c04e679533bb91f5ec4f87c8388fd66fda50f24145f28035bc6099c824aa6a97ba54a1b2eb63d24a18cca4c3b57bb4573368165203e0b2eddaf4ee281498eeac54a3325a9d9fe693a1c8bfa5f122620365564d9002f26e1e30d1fa252c0f610fc9a630b70df72872a369adb932d40219b9df7ebb8e1c7f09d6eaf580fdea95bed64944a5eb6bb7f0e61823dff9d73834b0088654782f21713a714884cfc79ff5fdcad13c97b776aaa3c3cc8d891c345eff75854cbc994a275ecad58bd400ced3e3a6e9bc50b1eff61dfa639342a9c9c7f044df5bea8186081d79e0a42d1d744ed1c42f40f65f497187399136e1b44d23a484943393c975d0d3c978e2196802a50c95c2e574f0943f06e7688daa62b65a8a24ef63961d6cd4a240706570831d5bdc71f6b430a48ecdf4896b0d80bf5c671a9a3acd3a51c9a861e2dfb7dfd257e6bb5c11f9e752ba8673dcfe60f8b4a039d37b563a40ee5fb7496d3d98bbc286bb179223c9260bffdd30cfdb3767909718a00d875df471b895a148d1c7eeda23de02e2c7c6af58f58acd08770d5736f5cd50676b3793e66250bb89930ab1b4b6022a3012c46cf6f31df9a7628eca8fe1634ae98a24fad9fb0c228d07255f5f7d3d63657c2723b158a6a7d5d8371d69885256809d9e8b5fde8151e6b9de473aaaaeba974b2c083f638ff4bdddb2b6d54fefb524c35f97392f68262ddf477ce79f03cbe1fbde30f02183ae671631c3c4ef3d50f6591f29ff829abaf0b2812d5acf4f9796bf307e2eb9ec7558adb951be8cf07d00ddd6c82d439a220cc61ca9ea1a851f45f3f3ac632e7c10dfd3fa9968ea561ca91e3e5a9c79f40b15c3f3072e31c2845e6774de39eefff765fcf168966d1f5075fb94b55d434343bbe77682def004b06d4c8e05ae939bcf3e8acb78df4313e6743a4cc8edb967bb347c0f7e3d91af7c3c6b1a7f68e1066fe5cd92bcbf00e3b388627da19c5818552df8d882e8bc005a45de7b1f17615fe91cf5c686bc211b8ce3c9fe436fa8649ce031946413d46166b4c338560fc248e06c91e7f2f59d37ff6af373060b560a8d9704bb085b5b783c2c41293f78d730c9f2e8cd213e9480d829eee86ed8ed11f937ba85e3c3978003274d84349b19efe6503b2a62abd8ae8d5a4f536e4e2c664f40dcbfd8d96d595818f141e642bcd840ffa0e7c9ccb2c036418271e36ae9bc17a4f8e9cf2eb40a2f1bd71ab7ec1649a140d4c35cdccf89bd5aba110d1c6b56246b93a8d64a23e56efa7be7dfe26af9092cd00fc373ff357d92c72aa0a3d466eaa9e3f88e2b883eb4df28497b4ab80516a4720a5e20df23e1462242e9eded3b13d40a4f67657a54443d9e0b3c5be52204b2c8dc5059d9f5b5264df530d6a5c0f68a5baa83882261c0f8dc0045a32c0c3b95ddb3188fcf85b479f13f419a7797b2488717e5e1823acf6be6c0a9e6b56f672e0b284f7aaa9b46b016685d98a920384445a03b6a914b5cf15a69dbb2a54ddf0115f0aa887747dee72145b876383460ab96c57fd7142321c0eff728e4faefbe4c9879a0b1ce2c61eea683512447e4bac2ebea7c139186e443442bee7b69bba15f8dea7990249fd15f5160c8d56337e601f97da12c875d9887fe92283d89f5ccd72a03d6d867aad09e211563e9cd09be69fb1a0f50c5f853063062a2bc8b66db5f645d82653d4d3407fbb89ca5d28fc378ef25f6e50eb9af9f7be48a7316221ee5a7b23e717dd0baa8722053d04d259c39a2f65d4ae36c40f939c0bc66f8dd866aec75f421de655b6c9be8321970304dd5c72e24718518a47dfc36f25f934fd9a1a7d13a6d3a43f8530416ceb78fb7de4a4ce2f0906c454bd70f754dcc5982b8d311bfc7a5f70404cf27708445229e3583fbe84346ffad7ec133a5987ef371fe3813ab0560d291436afaebfad56fb6276a5551332d33d6280fb2b19fb5948cc84bd2bc6ae0b927089a5ccfcee87b29f2e9ddd9d0c2edc8d6bfacdf70986c838937640a3d3a25d35856eafbb1522621c8ea179212c4ed84c17b2e3371bd122bc0337e52f876f4e58af566742e7ae7f996ab4edebf370c82d99fe9c1074b81bd7d024e2638f2e085419d33620a5ca5d92867ac60c964a379f6544c3903828207770cf6bcf37d4d3d21bd7e2d2fea443769133f24f21f6c097fbd5bee549ffc6328158cefc22318541560f6d8926fb925cb7b5a38d86bcdbff4c82665b24943c21d12fccb9c1005451f1961be39acd3ab1eb679a2a95d060ee37ec3b8d999b018ef12a94464c9ed751e7e98199200f864475a3cef922c9d99c6189aac922be008a744441b7ece9127368d67a7b24faaf1a95ef676a3a90113a4cc94f966bc57f3d8fe06db197005c22987ac136b39948a85b2edd086acc50fb8268dee966d152122ae3f1279329ccc4d6f3cbc616c20ceb463a159a1a3116de346a3f2350999b2eaf185e2f6a088cc2aa71fbd6b64453f9aeda11183c4895e940938f3959134f37bfa26b66a105a7f79a8d9cb5494c1c244e0f09920aea28fd2f9f67d17f617f0164b69e435e1a0522c3251508508933049e6f80b14bf1f048517403894df090691bc167c13b590581e6e3700823f2febd1e00935a8c41af668fea5ee5c944167685cd79168047d1d7472ad388e0515ac169b934c69173dcc717e8b7a134e8325515cc5b128cc98254fce862b0eb8eaab418d9e7fb6b7f13965489d5686d37f803cd3168bc013656f8cdaca72bf41f037e20f7d9ac3c14c12174a080db646811e991ba37f74675de3e86fe57944c5bbfe6c4e34c70319109dd8fc0fe5a9a735f228610560fe2d147424616bd07e49f641f8bc02d6d5172a53702ac39b23e33dccd471f7b0ee2caa5149ef3bc9c9eddc95878b8781a7afdb62ded02a1c149c6569bedb94a1476f91f0da54a714cb71af89c8629152d54e1b1099a4d4bbfb5db21565b6e403a510c87c5f03267e776ddd88ebfc2be542d8b4b049fe34ec41e29d11cd4e29c112772dd9f0ba8c505999d032766a26f86d0b7a74d349894cfebf8de0fb8a6b8445e36a62ea12c85a58a66826f5c49a21e22d9a6620905d970ab4d686827eecb5fb07003c5f33f70e92e440926bb378214a46f0a01f8fbe1ab2b22398f9d4f9675015124ad56834920b3478fb79a0b791e407c5c0d3cd6a93b51b8d88cab4650c29e80453d4806a254df6021eeb4390836fd262c62e736208cd754d4e1bc4f125758a43018374240ea3f4bfc0692f8626051a3d7ff2720c9c2f64125412944642ae54355e15c08a5edbfeb902105fd7931f385f457f7dc3e845a71cf25df4363b50f8d44cf1748939e33a036296f06890e59f81632825376f0502115be807678cb87a974de71f0a22d11511734d201023456cdae6cbc606bbefde633151788bfb6e9528710ae85bf36c88acf0bdaf74ad0c3ca94f5c7bbd5d9608a5ef566e2f07402f26f044a404a1aa7873fff13d890d5f83194f11424d4315bbcf3c97cb0ccc70a09af459c61fcb2ded9bd6ba84942f553f6b0f9a4e3a058bce71d77a6384927ccf6bd5a4e2ff58766f98c97a55e00801a9e4c928d83fcfb7e143a4f18c316ac52d44ac901f3682a0a17e841b5952c16430d7310e94f40b5c9f1cd3445a97d46bc58ff4f0c55d9e67a95edfac968ce5786e157cf7e8f3556f26779068c9eea5d62e45c00ecbf4b31ce91b82ac7cc53bc2bc9bc126481fe511637e3a0bd203637e72afbd6a9d3a74a05a2e88bf238f77ef5a0321a0288ba098136699a8e70b6d5bcf949a43afd7cc38f34658b84951fbb7b12c16b553faafc6dbee81484ed7a210fcd814f6cfee63eadd174451697156b89c43de32cbbb45eafd539b290f1afcfe3e4240fda2f7b8009141dd479de573fcf31f0f43fdc8fb0fc271c6a7bbe15ca983be14baee64720407ba5b0fe0b3b07fe21f6404179ed5d03171390152232656abc71ddf839c2cb0fb523c3adeff3ccbdacdbca147a0439f40776269b9bccafa4fe8c50341d748b89e6f1ba725ba1b7eb8c1f42b8ffda195ab0b01339ca077b4e2e5fa040aa4282e0a0eab7b9a1cd9b304f6f0b5ae3b07e7ce70f8c99ea23273ad056d6ee62115a3f67bb999c0bc078e24920f6b02e05356caee801dfa8e10666a23522e247e153deb00a591fb94ee1e981e658ae348ce556ebf3bc2e8d7008fb454babf031123b9ea7fd64f08eac4495c2506dc026bd60e994f25cd8e1783142936bf31d8851ff8a0ce9a313e960d70a29f309043026bb3a13dd1a4bc5554f8e13fd943e2a9cdc9f0d9ae8d8f9ba2000b8cea383b70a7cc585795ab38d3b65faf3e94aff0c3c912578fa16bdde1debe83caf6c06d85b541dc624f508eddd7c8fb0aad5594e74308952bb0317b6fcd573e892b5c311c293b45f7ad8d198e28f8d7aef5f670dd47b8fca7763360a4b2f0005ab17b49e1b26e7481a161e4c61eeb546b2efd6a06fb13f240a2ae4892bc750c523e447cd2ce4705f01f47fe59c28860a7e8f1abae26d9b9e28bf25e68c719e0faf3382f96009cef75e15807e352d594064b4421e131e0e0eda709f5c6d69180d4c764c65ebb79cf2d05873f3581758aaba7ebc187ed2f8cad6fd01f477295e06d2fd62ce951f344314bc6bbd730f7b001f262d766682e02b948e77a9c55c8c2bfa33f0c613a086d8a872471cbf8cb8fa599bd2684f1ec095f6b064f92add66fae49369d00b15f346dedad87229bae7bf11c32663725856e795fc00d2b7f5298260d8fa0143a495d292359119eda9e3b037b4f4938eceff3d15ed0a00563ed51292e06c9e414a943d7f437dafa5d248139e9158fb5d0aa0d5e0555818b6081fee075a0119dad81252afba5ddf8c8b4acd91c122ed8beed152ae4612da4d271a50f6259013df3d1a13a4e85879a1b848003fc65f5bfa403f092a5a3faff1dfb2a9032e7f270122c72545e6694decd76c23c2ea3889cd3d4bc38d75aa0f191387cc57e6b68ab3016c0eb8b16648f0843cc2dce9b237e78f34fdc381069b35da47eda7d9cbef98ca232859ec13ae5ae99818599268e25d2a534cd3db6940782b56cf2f7556bbbd184451f246174da5224b7cab47239e5a1cd634348cdf1eae3db5df5e605b380bd6212754ee117512fb0417a60870ec748d2917de87e0ba83f1dd19eaec831e3979ff580808bd6697a2204ee83cd48d3cca44311c69aece3f0b6e532e11d8a3b6a3b31fdcd72022108065991188cdf20ef812e380ff0fa102a018538932f81e1f589628045df4725ce2046135561439af06ac74602bc85b768c494739148f67700f04d13840d20a92fed77e6b6cbc56330bce3df9f84f6ededaee46cf14ae180135f9ccf22e4943de7a6a3789b62be12179273b17510fc4001f03cac2da6771205b0a215436b15aa3a9cf34d0507e2d98e72f796d3a7348f60983f272ed29733f06ff2f9967bcf2e84ea1260b8c6df21d8a89462a0513098a8af991be1c3ceb5b750b748a17b6ad083875c8b96fdc63ff507f0c47bfe4c8838022d9efdfbf6ece55481c0d9cb16ba4b0fcf8eb6a62f6bbe8d1c9e84f044346fa2245f27386110bae0baf4d6666ac4c55ee41114acaddecbecfff8afd22c388e24f074869465b756d8503d6de6cf3b87e9ca4e54b9c52960b0b16aa2b3e792038163407c8e3e4c4e47ef9e9331a3ca64f4bc2ad6d1f00538888702c74624098dac4f82636d247f08fe1bc3cc5fdeb2733e12e1b3e4967db2d41ecafb33d374f31aaec5c581d4471ccdc03f683e8f66981746505954202ac3eb1b738af20f9b78820f1b19b627ad6be4f35ee6fae33b782baaead7f355790e953eba8e045e000d9341b4e1cce0992efb9b357cde5fbe654ee15797d58def023d76be4d5b3a2ca0bd7d7cb0f020f6f87a720c51d93b2fc747788b6fbd9d610186d6aa42567ea7265dad49a2e62637ccae6c79ec544081616db20744d629dd305788f469f7649b008490706d702c05c5e26e7ccee0fed81fb83511a1b13bb31ea943d970824daf71b43f1e5bb30dbb73c37e5f6c52f21d6c5c36232778a5b29be209838a012a9fe7510e46ec2075f94ace725370b23d545484139a36608e3968248127b13c8140ae7dbe25fd61c4af293f899db311bd949b28eb591795d6a5424925ca73f13771a5e1d9d74120a739ccebcee3dae14dbfb7f6a38d95655d069aab5bd713cd69896e11a90b135518caaf6feaaf8c3d9d9ff4a84dc987d4457c333c03b67202412afb70d061f90d0c768af54c8470c201761f92c9a21fee9926c98d153ba5ed059168433bfefdcdf1782a2d77cc7fef23b95393d2244013e4efc810b4342cef16588eebde1b68df6adbd8307b792c5d48dd2a9afd99f4eb6f28df58ba4d551c899609e2ff302182f0dfc079e60a3a7d8ae5a06b9166e9663a231cc9d7c8f61f1c512455a921af2ed5a73971f46e8f1e8019a32904a5b4fba0a73a30bf303c4bb6ea21633cdd3bb24643ae97252e225fc3fc1f333195154d54e2ecdb3d0ff0ab7aba9958c7c4c0736a35a48214e34a2c4d94c53db9b78e86fcaf2f17820696ac17c3c9af122a4b4e1e67d9999f7fde71651348e48d3af753ccccceab85f6b3beffdc0cc9666c446d4c7759ca1a6b282a6fc7c4e1910d83be85e1ddddd3a5035756c52afc0806e1d44a889eca7c5bc812d65c7e89d0e2c80488410829a19800eaccec2f6b3f6caa50085955e8b71a0e036f581ac30c9799d3ffc1f0ed8ab97b2a9affa420b6148c8ec3965bf7826071e7d1484f1edced93e96e97ae60190adc88b7942042d7b7f16b8424e0ee9842bf89b2f9277d5affad10462225c78003d7e754343fbf1ed6e71906b66302e5e5ded6ead7241ca22daa9eeef48b7679c8d3eaf9356e2571f7f256c4e9a45c70eda8fd6b4c2a58ef1f97aa49155f643fddf3e36d944931d22711f1fc13bbb5105308cc739911f5006e90a9d7fcd9e83e06ca42951b61ad186b9c95b0593841e61e5b757420e669e174d6b8da43176ae9f8b8b431397682a69511ade075c161767a6fa715ef3c8562f6a9c9756699871e11717a3c8d0a3d0745cd65f453c56ecf6d46c590ad646b0aec8da4a692abacca79a026c964e66aa298a44ff1b31059ae0b69089152a7ac49fdb08eec5e8fe48216d03c45462909658f9f8a80c2274a1668068e11508352c017e3046fee71156bc4b5a49c61af47351f76918abfdd4039eb0e458884e12b53ca8ffa149a589139b4e6edfdedcb373bda3fbbf445e63999761fefcf0b0d07e6cd6b414362d98dec30af6e228ce5714bbf009cc4e83746af2969d50ca2f6a587190279cc189dabe93b41ecbde221c8614ff35a64af7912d1072d7998a7ea6e2e02bd815ec6ee17378492bce79ce1783c9dcd17d2209adf991ec85dc5a9bfbd52211ef1dff5b67daf60db9b27a8935b5ee12c4dff94da4769efa27105662b83ab22dfd09dc328348e33eab0b178d52ecbfac71ccf19564821f30742a5e43422f446fd83d360636156ecd0bf00cabaefbc95c454eb72d2a4fd4796e8be2f80fd028007736699d63b871fd4624d0bcc353e82a2a052757f82627600b98786534e610abd344c9c7cc5d7a56d7c59104198dbc25737f2c1b290ea9c2b77eefcab73dc269bf6542b846684177f8156b898d8d39b38b52932f4a0bddf587f08cd0a055799b65323c3d67821a1895efd59a3d71718fda1d79c77c3feb6d535ca8bb25c913f12e591754f70ad9841291c082d2be794e0f729411d226ca8bc7fcaeb72054a170efadcaf45e518f5bb9b325606547b7cf7b23ff85e987b2da3ce70b6a56a29dabe8dc287a0a9180f9ffc83ec757a99466167a00bd7a206a45e0a7940df2138b14a1fa5ae19afa0b6914aaf0a365a753af2e7d7e80cb6227aeaa81f26932ce3ff84182a16bcb347015a64c6726b6502e9b5fd9b1aa011942642803d99cdf254e87d140c23b8d95f89c2cbbf8fa132aa3ad4ff3f4be73c05d0059c327a2b5a1efd926fb5c53e1199c4896d9ccb6956ecb15669a6b0d74780ba40e63145aa9d05fe3e5d073cf043d13138368aab351e94d2d92fbe3a1146981b4549341863bc5dbbbf8266dbc265d1ccd9db74db05e12a8cfe9ac03158c7a94097fcc7841243b1ecf167f060258bd201ceb37f66d9c94fda317ec1eb49e98e67bf151fbed0f15b0f49f38152d8de84c913b97c76648515f15dfa8cb90267a07f914a1781cb1e53ebcf6f717f0dcc590d80713aa93f80d6e46f7dc18cfd000b87424b31670ab65b987ffe9c7649fc4a8efb4abd3b5b75c6499c16a9fccc2196825e95e399f89d7eb939e72cde10ff6689347eb30ae72535fa012f0301c72c60672f3854651f94116b3dcc532f0dda970d41f9d4e947314b14d44a82e473c94ec6ee21d611af13f708cbf6553eccb5115812380e836b3bd53ee73ccb0dff35bd5f9ef8048a65a86f9b18dad50f515cec2636a6efe56ee0cedb3cd8658abd9bd80c62f05b92bc990ae7ff47497af90ef687aac7e8a87e4f75d13050601710f1acdf4ee82a931d66c597e42663167ae8756815ac8db3caea6a63979b83c471ce4a00b854a3c68f258f7524eafe16d739d5b43765e5a2b59eea754a20ba4c49b845258dba06009cec0910e74486b20eddf6870e8366aaef90eb1de9929ec6f796888937ae9218143e63c68fc81ff4d5a112a2afdde2c094ca44c783546dbd3c1d712b01e0fc2e8c6dff80f98b865bec6076669613f5d8db4d2689341ce238dc485e9b03839a2e0d59524a929c4f6c7995074ebc35544233f9744bc670bd287b2b1a46d9401f189986c3f7578b9edef26401ea6f5ce73c64f3a11c07d1889235d8190c9a546edfd2fa061b5c758b2a8c4d260f9343473162bba0c117d41d953bc28a5f1c5172f4cd8b8c167d285cec843ea34cd420759fa61624c4a9271f8d211ee06153c59696baf3c284a2628ae39743a726d00b70c04f5ed18232ec0c8989f9e638491400b0cd029a6a3d839bb6c8f26aa0e68a4ad3a5c7662b2a366e2b638d264df15e5938dab7f921fa1868da51de64a68ecacc32299d8cd357fc8aa4764168903262fe3f5aa8646e507fbed1c14b5e703fad3fd94242ab56b03f5c8e48de5988b1651ab9598e001a6d80e5b259a0bdd57d697138345dbf4a5cd6d17c755ae506d52fbe6d16cb9fdca640cebd1d3834ca11e510ac2d17cd8a1e98097bfe4406cce4801fbd03cec3eb4d90aceea97f6b3418ad997c5ebc9830e85cbc38bf42cd2bda4740ba6fd29d504b373c23db4c17fc7d1a6a7dbbb88f47156de305afb9e2fcb90f362a76b8479acd5c6e07243bd8b4f5569b29c02cdf83ab0eeca60253fef8d2d4690f8a126de336286982c3b2f8869be403028e43f695dc75fa3ac3351fd7d33a37b15d6455693a5c2a2cbb061d1081510320cd4fdda47ac83694cf09208c2b40a72d5d23b7e75e95407afbec1fe7e24ef0adb5953a8c70cec5054119f683c60341524aff88a32b4586cb0e26684d95e88ee6be9aba82350a8e64a80bcf8f0df6565d0a6026d244873c3f71b5d4a551ac20e9265e141a09b59910ecd3389e36cf2b8a9f2c2da9e3d4c5ba3c24acbfab8f0effac0c1038fc3a966f90571e36bbbc78a2f10bf5a5da1ad6fae564e2018fe48a44febab85ef0a8023a7308385f3d90c1764de41bbd29a529e100c4c99599bcda54e1514ecd388adec95cd147ca6574f7dde27386de02c391275aeabaf0832ca7ea914fa2abcc68ee567ee1646f06542e7efbcdf40b4aaaabf5f750dcf75c942da551f45aa7421b461f25ba22e36992bf51f09df1747dadaac0213635a1ab5da625199fa9890a1ee1f29082fe863ceb3cc8a4eba6ade6d4312ee29ede0b4913f12ba33b7421ce01443af67d892ec58b0eb9b55ed9b11b90c741f7155f8f1661c5c12ac6e523bfa13f2faf42cbcd298e70ce484e1afd19c803e52dfb8fd24c7b8decdf8120123774ab68899c4671bb9c7fa8d639d1fea71716377b1f3d0714e20f82a8b1735109bc07c787ebda59df55db83d5c8705948a0b1f3775d78fd6ad757d02664d577274b2a0d2dac8a069ec45719e5877e813451668fa0d8179af648d719ef27bf44533432e69fcc38cc059b31a9ea34822b8f97dc47a6786e4f3ed76f4c4eec4551f4887acd4078f5cf6d8129f7e6a2d13e69235d370dacdb0188ac3a4639451f65e1f3839a37958fc6bab644513ef9a2008001b14687f2f63df7c0e640ff4136503b0e09db8a7200df7b2bc1359430222b2c80ec5b157dff14d01b679053965045d84e1da86cbb92b94c6e89b6a5be60cd4ef333bf23e0659a47025dcd63e4a1137dd359ae478537b9c077c36c7002b07550e9c70ae9b34104516b45fccd102376ec80336b2c47e4c35011b046f66f9503d7c5a8c275d404fe8a3307842a90cd7e998c6d8e11cdf56186c26457f10571703197792638e8b2a62ce8418478eb93482e8e21c89a14b3e07eeb54d5d8476aa0b9beec795a4a3356fc4923b238749e6fb81a6010442f3a3aeec98be629f0601d2c2cfde8ce5c42aae1bd9e4072a178f66f5fbcdc675f588336b83cab6d7a269d25f1077d12611b0611e2f24a9c74f1016af7fd007bf4938228c7aad4082247231a5017412d870fdc1ca529e3eca1382c01c352d1c165b19ff170b3023ae51ed333ca4f67aee031ef12938b634e9782537133505168a58970e0513b576cc82b6b18ad2c8499f2aa4cc0fea6212d82c2c0a54905400bfe3f241eae0b804c9a39d601d65df803ab4f093e6a654d9057c933337907eef412e074eba7eeb12cfd527d560bf4b8039842f73ad92f6aff4af50a511683532f69bbf1a7de1957a5f69c34606fa4c4a27502fc3126016ac96293d4fe929da8e632530b8299ce3c8e05acc6f83fd0fb5b2f1f68b659b6d5bf7f49419f20386048708d20fc5e172942dc268d051dcd9cf3b616085753dbf08bf6d65363fb5b8f125a29f224cba48a911ea9d0d184ce92ad295ef163deca72065930a1fc942ec437fb9b973bee201bfd38b20aafa75ef108fddafdd8f87a879d0986240f3a3279fecde31cb6b809213a177ce78cef083943d87cae9897d8dbe3b548d3872166b6d14c7c2c9ad78f664c6b087c6a450f493586c64c4c751b840f141c02c1e1b53d0aa00fc43b54baf57accdf7a1a878aca7b13550af53e9e5e8873884024d9cfb5955f958963bcb606ef8aea13975382ee69b939fa3a62f5df86c99b5968a625535b421fcbbb8c45c069c5e6dc8b0f20296e2319edd60d747bbb6f66195fe0060fdfe7536a3e3cb1cc73704e9ed3fe657c3a9d3af40222d7a27a85b54e717bb87828cdb8bc349e84fac60762429b7bbd36f5c0f30af456dbe0a63b33dec653714bfd802f790dbee718cdb9ab6829fb9947d850e4f4da11ca50ae2143a6370a3d4ee1933bad0d3277a4f219287b92f354ae4ddfa6f5265fcdba8807e6ef9e39311cd7e2415fefadc79a1050739afbb443793b7881db2e8d3173887a290eefd372682d12d06ada0dfdd3b2d10a2e14aa6e72c0b7bacd914f01bb63d981a7aa742e99758079b5eb1db9bebd6a28900d45a192b88b437c70f944f6c1ae5265983378c7ddafbe1904f2a051c22b71dc1a2b7ac3d50e1bf64815d1c40ec5422a7ed5329e33cb8f529b917b01ffb0b0b271dd9b0598bb2a56166112b3bd6f2ca54fc54216ea7a44cff93778dc5474fadaa26be821d8dfd978e8f02c0f8d61cb130ec0f8eecd1093f970a351b11d9afd31a84a5db400c84ce04b45bc7c977af07bc055fecac43db383d7ca928466111682b60667600e0a2f2ae3bc9dc3c8bf3159db0f1f3c604a87f619194f82dcb49f0a3f8ee25f7a78f8abbf89ba657d1eba1ec57382fa9b24c1aa9ef45a29243de322c894e3a975491ea7f87c6afd8e8a4c70a9c2bd4b30b46dec9a17fdb06397c532de66bbc7c8a0ef3af4d8bc2c56e8f1c5dd8f8da082705cf8e691406522afe2cd32c819f1fece696d8e8653161d8bc3db665dc9145fba4af8832ccc797de92ccccbc85423c352aba8acb48c36fc8a9e239a424c6435b23ee253565dbceaa7247aa6813c25978702a2f1a0b8f985b3adba60a9e1b249536fea6629110ada69f95a7cddc4ba922e241ec64bd77c2e6edb0963375a718e1b2709dab9d6abdb1dee8032648b8d6d9ff8870c886ad8ea25fc1668b6b01911981a0a49f7a87606eb0423ca4dfc94101523a38b15a2db51b5ef565d603f3acf2fdbf59ec083797520918da09226af17689369fd62cf4791bf51b43843d58a8ecfe1fe8143ec726211f87ffc1d4da6256991b3d6e8e56b053dbfacdbe87b508b5172f205f628dcfa875f7e87ecbe66f194ce885fc2685e5a91a3c2d7a8d0465f100610022ad6498c35c325ce882975465accde8ddcf840ee551bad18a8a4f7ea37944fa139786c01d0a13eb2aa65947a3b893ea5ada29e32d3e196f7a204b9845f37c5ec7c0285242d78ad6540c0ff7c8c708a85a95d602b5a9ff877b008ac7f490473f9d18b2652aeefaabd9be596967dd447801cb12d42a2c011436096781a38677be9871bc54a5695608a705b8670e45ce531f6268d1be108432cddfb55991126b250192e495ec36e9e6f15bc691188110cb99c72522454aa2e1dcc1d05c7fba92e7871e0404d44b43fc2decfed7ef5f288326d183efdb26eeea0db8f56840843d0e46113530c666582e69657c72a041f6de19995e8bd761dd987a6b0f2e957a9d498d7e830b6854bb4b97a10585938b792ccce56a471b02124177ed56cfbf81d99bc91231c3bb17518c9ebe9199c8607dbc4dd9684b1996ab74619257d795f7a795c066daa0ecdf82b0210b51c0f8344e67e3476db1afaffc168cec518726d3a9dcb2eb98478d0209f2ac91c4a725de3b8fdaf0c6e77c9cd417319f1770030f9cc937bb63ce46898932582b04aa46a97864e7b38c612a50469abdb3ef6c41bfca409b454954b147eb7dfb021f51382ab9838c8335cc6f11d44896dccb7bcd26a00bcafb6dee580132f93b01edbc47263a49ba023e43a89bed0d5bffd86840b830535f8a0672ca2098753e196267712cd9068893bebde4a50b8f8b3d0466e274cac591fc7c53e21dbbfd74d4b58a43a38e41ab9b310a385064e7fb14d2552605bc28fbc9e645e1225822008c980629c8b224a1222cb0ea133aaf2f259bfc21b91be5053a76a561cacea103c0cbb1f10ea66e7f1d5cef384e2c696d852654494e03e0791afed5e7d7e095c3525378bf21bb59b7903937b8cb5ffe20490617f4fab93851bcaf86bba6c74cfaee65a58cda69a0d8eaf69b3fd61c3440793b3b4d5b76d419090edbf34c21f89b3df12f2f883e47019a390881cb710e24ba0a57b1bfe5f28ea7ebae1e82d0f6888e5fd9cea962507434ccf973e158536601ec8920e588e99352b437cc738cac80f8e6b705954608d18ce4c72dca2cd2dd6d847446153dcabe6bb0e006ad923b71dfb38187de8cdfe5fa80c889471c2372cfd58cd03e4ca06266137710117889d94a9bcf0dae7932ef820872ea045d393634d6af1ff1f59c0f9213890c27e5fce298d9c6be395134bed5fedffd6da78096f8cd9f2f881a58d0592148a7ab12eaa9807861dd17ceaac3ad554c743769771874f043be1ab67b2215408c27b66ffcfc5cc481e26c9f53771de4a65fd01780738259ba6a5d88f2259998a30042916425fcebf2b7bd453c4d82c926f05274c53ea80dd4a64d29efba33b9d288015215a374f1cc03a83748b3cdfdbff92692d2aa468529ac6552483f2ca8ad42d5cf8a1a847f1c6a42df53eaff000cb7dc890a878f4dc08bd29b164ad6660b31096478f4e28400fd058efd591dd42bf515b5aa70017853938fb96483c34799341bcc823ee905cc066e6c11fc8b4ac9ee4b54532357ed40243375624ec2335645d55d77c8a88dc244cae5332f6c65af8cc8e9b39629233c1a5cf6de6fbd2b752af41ad920fda9294bc16ef24aeddca5005d7010eeda41a5d8f0f8882a75724713fd5b282af9e065c3cef82d4b94c8430a9b19871855e07d85c6ed0b0a53e934e6cedeb0f0d84da20015ae7bff756b2fe79de62db39a78104dec5f1c9692fbe8a041d28aad08a92bfe3cff5488967e8e697196332e2f8c2d056aa9dfd6c2d1a6d118463275ee6c3db89dcafbe1185e1fdbc30039736697d00030e7da8c950e40e82ba051fa2dd826f97eeda6e26beda105da3377e7b148ce2b200b74f365f1e8fb349f519c0539ad328f39fddd278931b0bf029cfe48902179596a5afb0e6096c92cf6092ea69f7841573a3fb7922ae94857db11074e1f68663497037b8e201b8676146514b4e876dd20abff8e1d64c0edd1ba7222c4e0d231ad39c11f40032629684260d4d1051a4ef12346a2ed00db2418792ca0d3c7a0dae4f57889fd5a43de14afcc97d5e360b5fb147745105093d609259b98a4f63e4aadde09c27a653ae614d1e82ad2af2ff3610fb22a54e1805af38a895f667327c30cecd62418323ce4807057b43676fce6a5cc1f04ccaa1a0c7e48c7d244075f3f9e56a13758c747bb6379bdcd8d49195039966b21e18ffd6c2a37128f7f3e60e0eb8dd3cd235124efca7b4923b3bc41a9cfe0010858fd5261b4356c381db47cbda45977bf30a61a550d93836bd627276692eb0a2fbf4a0767c0bffa432f31379a65d751568908f8c6094296ea68e619a906224eebfb630fcfbc247f75ed8d9e62e10a2f6ee82f70fd024573b1d57359d10d08f2b1e4a02206b8a0cc17009e7004713cdfad2e0a0596c5aa57cc5fe0b5df6bb93cb559b87272a8d697f93138dfc9e35dd5aa7e43617f067f23198974cbdc6289f704f64d2b371eea48bb556dcb80283645e3e403b4e02f8bdb65ec8872baa3bef68ccf740318aedf50957764fe0a3ea9637ce793b1a33880e86c992538376ab9ea68e4b600b02cf44a4eea34072c05c403d142dc8cb10ae5c07d37cb490db539c6e34111b1dca9b299528dc98de9c3db9675ee1f63f11c4f2b4e4bfbf4ca2ebd10d1d48d9ad55e5ffe9330df65aa1e144333893c1c4793191bc87b14f1cd64643c7f00d6a0c0ff60b478fb243b761d9de9e8e15dfa55addf6673afdf32454674309307eab62abf695721dfe181edfec94ff338ba890ecb2f6063deb41456c806f6ecf907f162e316e70c56fc586e062cec54b8035c7a6b91ee62b50f321d981654bfb06927d80276b033634961cb75108c19453653c2d9ae6f8217d0de4f71b8cb09d226e61ee83e24a261a4ae047fb8208a693250cdd8b81d3daef63d7c432a5988a3e8e51fcb9e16a318d1f8e563c1a40b1fbdfc8b3fb19cb1f9ac3e7c7af280065ed50419725d04d5a217aa6cff834f81a05f3fb794434636eef08b47e0b54dc71a71d881c0b3dca207b57631f5bf8a5e93bd19510aa52c0377286324a8ebc8c29d85a4c7e5d0598fdc5c44789cad547065c503c7389c682aa49cc6641fc0938f658ff822c1cf1ade9cd8ec28de5f5981434da86eb7b4e762aa35194308b5db82f95469f61c8a89ec35451a923e80514e6a74878df26d4b78031c3b664460ce89c09c217cdb3154eb0218d6bc4fa59bd7478348a2c85d445790cfbfe5efdc29255d192c6dc03f9e32856fc47234a98bbc096864bb310f827d5b16a07793db8c4c2ff6bba8f25ebb2b7768ff708089a1d777a8b7d0080bf50058b71b05e00e58e7c0ef9e4e95466e19095d2f53f86943ea3fd8110ea385f32c8e4ec063523b163c68cd65dcf2c27b0a98776b664be9a34e912ef61856ca20ebde7e74b597a8a6a3515c8a43220d3d997a50ef4fdc25f9ec5a73452905ca5559596b685778847fb356705f4b7e3845a4f1d634aabfe7ad7d421b1a5c956b077c454b2cba3008f02599fcc16d3cfcbec7eb4df5c85ff1b53ebc94e98bd8c43e3d0ae9422943920c23677151927b1fef6939f4024cbf6d8634405e1806bf783689ee193765e79bcd9d8d5e9346b5b482e18ccd65a5b236d8264500428517ccddf68f666e2475e9daeaccc1121517ae0226c9393f0532b6ca98defe74f79a35757590cfe458994675e64d3ef953919eab72098f406c4a4e33532f7e48f3853a5f84646e32b8da4a1e2c1ceeb7c343ded53a202db019fd570d70ec0288e103c3b27d23955811a50781f3a4497f090b843cb79ab600c90d870f1eca2199f85d263588cb83523df3f49158a3ec329b345d271754f869ecc0fac8767772d16f8603939122805bbafd9b5b2668932b57562fdcec4b6dd47df4ad330287152d321e58c3d5b97c639c5fb27cb08d75426b405837d353ff088d58e814a9ac03082cc5195589a8f764e2a816408f800eca22861dcb6d1b58296be85c0191f6d4c235a9ca209c8fd979919e240ca809931e9592392f82a0a623db98417e69ee5764b466e944359150be2737c9b789859350ea0993a67ad9baf47030e4e83328d299c5111368565cdd9143325d73eb1247c7630fd662e7fbe9c4c258e14937790b209bd64a7a635f7e258840eab8069aecd00724f66c1bc5ee74d6067ce485b1ef959a93e8770b3131b3691780477c7067d94f24d40295c1a7407f5204f76d3142571a252714adfca66ec4bef4b7e8992fd032738ef97bee60d3d09fcb18dac7f99cca735e11c6edf633e6049a1bcc319860b85bfb5116c3896cfebc7d65522955cce4c90ac7a7ee207a2c28957c58117fe01815ae0444a45220c6b35abe76dfc17855d4b806976872f419dd5c2b1d8cc4340ecb944e4be8bea654eca54f82d8654603978f3d8361fc21aeb169ec696e70c9c4578be6d57981853712b8a461a9c0bca26ec982f95a7e18fc8db96925f803269221ea7c013d12cf809c4f445fe15a37c2a8ea6e8cc0b163c8f819e2fa6b7cb521a8af1a8efa407523cc342e28e2c3344cb8ec898d727488a92b4a37de387f7f20d108949933f5b650572f0b422bdd517dabce5df98196c8ea634b5a897bca1d40850e06f3346f8d76d9ba7794486a5ca6611c0f5a9a40b27bbe1aac757a4ac52c228054c6434fa14aad8480c451aabc9d593694f4a49c82fc0ce2d1a764f72189cd27106d9dee84d6cb5f943bf82a84a8c517f89a959477adefed4f7b35ef0ab4e8cc3319e50dfd0437aac402c26341a6bd0df88aa3e0d5848097b3b36d809d00f2c913dd0061ee39218954a28aca5cab07bc260cac1889a99bb053370fbf5c5b94bd425f0b96af765ba24cc1291d1312432efe49604c749255c8a39aa435e08bd45864e8deb74fcb438f58560aa3c85e91d545eaf6c4cf9ae944ace8a08fbf4be7d0999fa36e1d0d1588bb62f5f210662eabb57578a58f2b1ef32042243c3f0cae563245dc2bdb6a6532add324997006dfca4891ac6a7263b04871657598b6f68061325ba18902b49de4b2a25feb5bb8b6c2ef5f3f783dfc268193e1140e8db1b18df41072438f7e4bc5eb4e9777d4a063041e376aba6ce77ab66a20a5d9cd707181e5e4c082c117868dc07f3449f3757654006a92c0dbb5aa16ed4600d4e8c00cb00e4b538f7143d77a9c8dace4a8a33deb217df5000930d580056b87d677a5bf5560f47e07d12c51c6374d62df31f534a29f7daf605699957e06526dab6acb26665bace1e00178c5be8ee188f1a7f6eabe71f200bfd7423880292714fa635c9df33ecdcf8c6463d30a9d4bdc0c903631e1f09dec0920cd42f587221a69c3612dca2cb25e408bef38bab6114f9b045d45f1c1ebc1906a16e373e90ffeb34fa58f0b54189675346da6db63a970099a911ca1897b5dbc5e29a6ba23149045332274bfc88a3369a0d4f6d4c7e9085f187644905b33a4e60c3fa281959bc74fe64a259196bcc01b9b3d187d261cf6c9f2a20cfa976f97d12bfe24c6c5936025bfd6587669330f3584909cc45fa6a397e59e8d33c71535eac36bf8e2738b0ca8a59c2f0ff1fe61387ade93765259b1837d73401a68fddf6e38d0ace4764a6d60eee81558ebe4aeef2c639232c7e96625e4e4406c8759b514a8fe2e741cd9cd899037bc9b374e327281f69cc413629c1b6df128d2f22887c13f788f2765cd4378e716ee41ccebe9cf8f090eedb553aecef83075bc2365175d85b15762236cd1c61acfd5104fd0ac23db894640355230a92de685824b6ca40cedf28daf4478f46055514b1779b6e08ac938af743d70a7f4381303cdc441a5200fbad8524f2bf0f682a9b0a62af00768bbe0ac3e7d8983315fcb69c8ecbb3dd3098c0484f419e7f2c272c8b4ea0edf8621c56441e7fa72a7e76eeb2065694db66f5b54bf78b1b89ad2d797d5ffcd5f6d86167f56f20b2ed2a59b38f3daed81ff90e7422fb57da3992701e10b0b59b5ea6021d0dd16704d4cebc8074902963f70781f3a628b99a341e1fe756163fc64771229d875a77705f9e12db5488516763d0bcea74dca0137100c19eb7e21a9228b373fbd5bf521b7728881eec2be8f8b23f4dd0110510cea6650c9f408cb6c26488133fbe2410f4aab004896e668cf600fa2d6cd2fbffc71b8d57f2493e255e42d8de1b8afa9055cd092f06ec0c7f4bfc1fdac5f58c9ee4f5bb4244bfbea21f97a8c9c97edee29fb2d3d3765aa9a5db05c93010ce927d01509a0780439847ea6b5ee385f7ef58664ce4fd356cb556b59a90272ceab6e9a493af1a103e7048e066f27d9845a9c6ee076eca72d7cf95b3b571bcd52fc1ff9063d9b499005dd6b046852a66af49b7d72015dc78ca10dc9a6e9405583702372a3791a466251041c1a9d6999a7a89d34108f9a862e0cc39e0df7657c910992e1b95951b365789bfb4a0aaea8699ef6ab53c27388e3f30ca0ca0fb3fd0ebb8650a6ee4f97a984376a7f9b8c3bb96c8bfba5c81ea79ff7fd0e31d9e77e4b96f938362a4e7d972adddfe44dfd972543a512aac12e7f2697df056081bb2d93e65485435a0b5aafea8b55da9154827a79a7aeba988894ee7cefb174f8c239fcd917ebb180d269fb9e4d1e3bd19b5f72a6ca294623ee49f408cccd9c3bfc2ecd3736441c926a6b79de761b1f6cf192eff1e1673b57668a77dd9ec5ad34eee4ab0167ab6022a1a7c7acb2573577896790ae1ac7ffbe910f235149b004364cdc834c768c23b966817012fa67efe6a9cd6e6c5f5421f451d87be33c9eaa2be0bce34fd6cbd2db34c7c6464bd88913eea20ef13ccbc0b052af29f3788a43cd32cfa484d519b088d4d3cb97076bf04e9cf4fe272091d108dd05a68cf2cc5b60cb72df1f4e9265b6338b874231ec0ff19efe22f1da39b3a66b70034a96a4b354df0fa188eabade37e0ecb305498c6ee465bba2315c9618662bf5f2de29863912225ef968c3d5373b75b0818bbf03b210fdc778f34d85d1e96d27dadb8d43361c7130269026075b7da1364f00df7d87ed905766ddd6f190101ce4b743959caddeecc0fac333b293a6af231000a3df52534a4ed6a7f0b413849b786f8fa84fdc9a0cd54549696a8f7eb0e8dddd9915752d3fe1d9a607c17586ec8188b2ca978c80ec1bc38951e1002fb1c3f04567dc7426b19f8fac75d9ba15ca351706af89aae98c643595197074ef6e4ede3460ffcd353b03ec39b93f4e99604dc7281c8143cfd89d5686e824fc5ac82ac08b4ab35b30f0efdac3624f8b09ac50ed00c7eb7bc4c8caf0c39329c72707fb9350aca5055ddfee059105da3e6c54de0b51bc8ba91af37d0d2d594e2e34372670e1f5f29265ff3c3a8c2748b14bb052266fcc4e39b20b7318beec955aea29955c5ed466666a961ec0fb43f4167201a6c900289986d49cf595480a6812d8b6d678ad8595e9c896b72369267ad5be231e966d186dbfa5bd744a3949f9c3962180f61f271db4a623c4d3b7ff4927febb222efe79e02a4644d3b6d0292d18b754260a9f9da548249b78f403893f20936f74e7af32f7eeea90aa5b678ecc7450b0bbe8e3281d89f7aebc7ed6079fdd5292b89108fbf513185f80e04bb58163155198b5547082e64b08c428c021967c2b09cb39a524bcab36772904143da96ef19d1b96d5a735a94bc088a0902b943cbd8cf9d35cc463f31e8d7f79ff5b9d86cb91317bb45e613000dae1fe774210ecc2599eeb0a0d0521b33990150f98d625273c5e293e9c27c0a6944949aa334893d168486c562357b343de27231f3519d81313e04065c2642c9670b3df4d2695334dc528a61d5c4fab8fbf6f097c4bbe9be8246df9d922a439a1e8802a91f57f21f7678e57f57d383707f892f98cce6c12b43d9f0f7719466162c032de7d3e0d97a41085ae7125c2a33a80e5655dcaefc79ebbb91acfea55f955e944d2df63238bdcbc339c931e1d01031705953970daea568594cd7a949b252b3a02d06ea85d294fb708128ef0c9da63a8fc1b0421ee2167ffec8708a923204eb48b7bc0cc39d303a73d90e1b42c1fc4c53e86a3940fc531788be499d7360a9fd9937029268d00841c02f8ac89c52dde07a91d990c6f179556611b321d7b43ee179133a4ad91471acd54da9a9f53c2bfd1f2b7b50bec6696162eb17ab424566604ab6222548e84b57e5c6837de52ac0ce05503abd19e2f2bee6a72c946a103fcd3bd2d3722be983ea5cd9c2e10cfa25b6fbbf21a3113c5dfe8bc1f6909570496905f51716db0d18a7dec475952aa400e4662a6b7cd369a518e315185f224a0b5780bd087989c122bcbc823966752a316adcdb86de7cadbff695604b39ac10237def037818514f1ab23b31a031ed10cd3deb9091e02e405bb07445ae40e7469e8cbf12021154bcdfbbc7abe4a5f73f668830d0e9ca886b3470fe45bad3d5bb5d49e159172bfe321dc149f84a1ec68a4a5ff7e6d8372f98f29dec984222ad46d9b4bb7aa8cb94a4ef822ff9a49c82d25483afb422643587d025a71a0e79bf62a5cd50952e746cb8bc6c42841315eaccab63d70a01aa184e5be21d8373407f86d028b92c2eedb1179952e7dff37d1f2bb48e97f59f13950cb4752b23610d628c159c2b3e2ae91d85ec524a8c835e75e71c846cbf058a037dbbb61e0d6e69f50c335029c89c7f5a9489f79a832ee8a0f077d1f240a80db89d19251ee2119506a9c3d8fccec4d9c737bb50c1e20efe4aca87c02ba5a99eebbac0173a5360a560477a978c75f0e53896bd94d6e5bd5322d52b323032e7d3cc23cb5a0208acef3ae5ffbd123674910d412d480edc11329e8005cca92c03e7e9a506cc1ce73a05a6699441a68d6d1e2f872c63e4d4324feef4fa4689cbc3dbae83eadce3c668a62f25a4d64a754d491fd36d8f3045c40c8985d9090dabfa8294121cc2a7cf5a24804dfcc7ef12c8f7d6ea058cb1a437771bd231eece9191d9cfe05891c354232e5605393237cd806ec1a862e31a7a4e7670a52d6ab33ba130befce94ee270bad5c5dfb568d1646bb553c726edaed5256ec5341fec95ae991f47e000b962b90ce3bc1ad198d34a2566c3d76e0dd85134b05fde511f0caff6633e158ba2136c6eb91f370337378732b3eae912b841feeb46fff92b085632a48d99589cf98e19e44a78155d1cf9711307851300e5dc303732a88235d2d4d642fd4d5b6b9dcb1f15773dad0a9568ad342e65cf59127fe2a31a97284b45d597fa954785142914798fababc4a35d0b4fce1227e5dc7290dafaee221d7ad999b729fb6942d97385d723b640a96ee3667008ef302d4d9488693534ea0ca49961250b53ba7720c704e57587c22ec1a95fe011814fce2b48e153cc63a23a9d8cb766267eb7a130711cc6b82e8a084c4fbf14cc58b9a5d1ab4cca921242624d0ade5c956d2d92fd746a847d37407c5243214b85826c82cb644ad511a13a7dc5f30d0206fe226e063f91310f2436fae10fb95534df2921daa02c93954e4ecc31b79261b3749b48e890ce3fc2e74e93f69c59dd920121f191cd36b1a03cd87ebc94ef9ff879ffb39c6601a8f06c1161cd6c63aeaeaaaf0ef27ad84d29cb78d867f36ba855c969fb29f885a8372ce4c4d3d3babd8ff7e626c8466e4e60e0d7900cc38a07f6c945771be3461411661cf143ba0b00274b965a85a4fb5ae9b2e5a8fd25369376c3370b6ebcd3022da39ffcceed60101266f9f2dca823bbf46a34ad90decc2a9c1cada0e7cd30552e330c66d9426110cd8f22953694be86040020d02e0f1a0dd3e5e4c9c7a01c905f641a563e9476d2a3d2769128cb90b63229f94a59b870c7abd18754ea9ab9dc88861459103c468bacb02b28805488a26f05637ed1e14bdd3b8c185e4d7f36c4e82949d4e82d61139f34e11854adabef468938008033db2167a2d37c928f3c33c722367316b66b5941535eec2734079c4a5621c926395c021744a45a845033ed60920353ea374e19d1f389ba3bedac144dd822c98096f7a461688224a7d8c7c37a55a79f43e2d108b98b742ffcdb8503b7ede7e6bdc15fc89740a6fccf04d4c640f907590704979a46fd4019a97fbc1e1e1efe277361f044786860f6d857670f3a32b08c8cb878b3f4d9f3bc60295f4b5d0b70a44644995ea87ee285e1fc379393ba5007926c6dd85af004deab7fb5efa5512f96adfaf499b2d9c45fb1635f377eec1bf9a109d3cba142dbaf61da92181385a88acfa6620907166e6254f61f26f5bf08cc09f85281c8a6682a32773b739e9b6175442bde47f1acdc9434461dc791043f552174aac7b343b3a3dd41b6eb49841a48356d52cb9e885e473ff8405997f16efc2655f9c5fb3f41d9fae183b31f66c32445154675983d8f3d92fe6af61c58a7bc9b00466eb49d941d2397584eb63a7c49085c483834a433b9c3d6e6bad9f6869d6102a649414b4a01f09be5a0489ab39588d992db620d04cb1150161e817c69130ec92a9ff24e851b280887657abb4b8426b5554a2a7b420462d9417ef2e02070e98882b2c437b9d4498d93e27e3315ef5efbe8f5ba72ed4d6b2e8d0aa8cc35b8d340e1fdb768d15d6ea6fac999f841814395aedc7b567dd39a7358e659ced61ce3fd06a315305955d8e628751dfe517e41c83c1366bf4c4c3e735dfb72f54c19c67fffb4908bde3f0970bbb5d719bd8f5c64645050ab8af90ea8d71a72b9963d3f455ac7b3680fd582326a186fbdfd362ff83bcc3b171e3786758d0f05eb726726fdb290e2a231ac4a4f96c76c81b158c2540bb27917ff86ce2df4757bd5578ac4b6d519bb15057a0128eb0357fcb80b9d57b7a0e85f1c232067b49835af1e134cc162274d56990c5de59e68dae86251bb3044bde3b8642fd153b565e08938ef046d4663146139bb5d9852c4c9e2e57089b784b70c8944628f640bd8a4027ae23e3c450f6eadb2ebd0a6733632b610caf231c6de6ff6c180783421c9c3678c312efb7896bad6a65a244e63114bc29a28be78795b3cb9f9805bc5e4b183f70041fced1172487bd32e8d7f08d1029fec6800bf5ff898fd18a57a20d9c638be3927160f323672e1785373cc37533fe7a9fc3546ec119502c562bdfc4db0f6d7cf0106f8cb5ed3769372fd257ea11e6d1b2b213cfbc6fd4e67614c8f6b16a0090f79de20ece22dd5a314bda699ae4dda310e6dca3c571b6be34ddd3915753b106457cf1b9f2976ec932fa8e07ec0c81b4924d4ffc08b75a2941395f778be96ac84183dadbe2a10fd3fd206b1115b6152035e512e6e39a901891e991a80ffd6bb40b3bae964aa03c91e37375fd1c7945046d5499643761ed81bf8bbde46c65825bc9665292604923703e18c32ec1327c3a5ca351e96de648e77968007e00ea7ccacc871aa5576f0dcc5ae1d7485d28e4583a74c7bcd0aced1365a15c7a78b63d23422c14509d8686deb647d010e3927ea7b00a49f85911060b3e5f1918a7512892ecd90dc9f16380f3006074ea70059eb44600689268a926788e1b77ea5b436cdb9de76ab6acf288a6f2b00d7f4f726248abe630a1c55a4c5032299f46c85d11106211a102fe7a0ad1fff256f3e141259a7403cec62f034effe2a703c2e75b0c8127e983b2ee1618c5fb9e864d9e11fb973d03885b897a15b440d9f0b094af9b817b2ac2e310b4d4b5a048f80ebdc45d9821205d1d1b9d5aa33ac58d4f5d4f46a5c69457d125789e6a3f0d19975e19d133186dbae81eb927881a0906ee2078cbdf25ab18d74201804c1a73d24ed65cde002b8528a1879655f019048b98354ba9e92bd217344020136d35b8a3303af5ca24f2ccf7c54a390e47a9cccfc464803c5f7eeba8481d203255e9ba6edbc72d7a01d25ea027eadf68eb2b9f51024680dba7500dda2fbe87478b489ba476f8e8f46fa283fe9dc6c61af54ed2261dff9ca4fa66ad1c1f865926d3ad04c9b3f5954004876fbb3d77b5324eefcc70fc91dbaa4a4bc6820783b5b0d57c5c180f56b4a69b6461cc1b94fae49f2f8419630959f2e5ef1cacf2a13bb9b65232502fe26559036af12d617f655127d0cf017ea2b303585a99efa95c2f66b46b90e8a8cf3cfadf0c9c8c38463a457aad9d379e5cf7da608ee35b7603ecef95f404f99f2f4946831ce0705ac71991cdbe3176d00852176352f314870fe74ceb480a0c2920160f863e3ea5793a5e43f186b00e4f9d2f788055747a04ea9dcbc45b5d932f6494d286e01c991c253d5474e59d67381dfa58237ad8416300484559af26f0a5272ce32af4e3dc61357da011bec9ffa0780b7f63aab7298c5cd9dc3b17d9d78ebc7624858a694ce6c33be2ae0a8b2e3691389802be68b7c54d52db935bf88feb081b087612b0bf2d0ae3dab6cb5c03429183a5982edec92d32cdc2a85f5aaa48de950f86ab35793bed5d1805dabaee4ec7de90f52f434874df3a0ef0e273f521007698e6f3c4dcd9def50f0e9225308d1ea273d489fb77500c59d2d2ce1a25863bf93f772fbdc26a09dc51f26ae29d7c3ca62081fd49448e46ef88a93b8cf2a721fb470e1008aa2054af5fb31f72d758d6510cd45460e6c81b600a5b2cfd213be1ba866ee6688cee0e45bb67bedba645c768db146abf79bdfee1ee3f7b39e22f56c0792cb16c0396a437fce77b01de824af741ec402d467ac81a9430fd5a0dca12072f3e54b2e29ba253c45c87e6f96beb9b305a5b1ae07511bbbe9358f55afe2343312c7b43056536f1defbf4646a3e6f45b6b90276a7aee1af9c9279f5d37a67413cf73ade24e29ccaa52f1ae3505bdb269659983f4d0752176dda82fa2c610336e34276b7d0ec4741d08e01a80af250521a857eb58e90f75d61e92b0c656d19753dead77f95bb21ff47f42c949aab3ce4196dd13e8ce6136e5e9e26bb50ceb85f4b59a62f7f56a324d062deedfa9466b58b58baf6ff545ec97d328f9eff289b17349d2747d02bb2a77d737499b53e2fc3b8cabb8773cd6be6113afd91572576b9793c3e4ee85bee572f321a3b376dcb2bdb18351b7f18e5ce2812d6a1b55f14924432c6135fb187d95d6faf0da355264762b47a614282c1339dab9c9bd774b50d5b335c0d13660ff27c8fb8d6161f42ad9042a9924705b2a2e0b3ba9870b5c6fbf2b6356b6ad76c0e76bded80f62d300a4df1a6d4fa4ee6597b24745d6dc848080157121ee6411889d808fde97621c3e728d61083d2664da08d05b37fb860c835113822b55bc5956d8e10b1d588481fc55d6a13d8218b56a97e2147ee9199b3830664ed509f10ddbfc610cbd57ac3cb6865d30c4724e0b794b011a53c21fed25af58c8d08293a7eacaad3a124e24adbff6095bde634f85e53dcb749b904d38868bf3f3f14b0e4bb3169a30181f7b5694d6e3f2bbd9c8490fd00fe971a6bce758ac605dd351c185db0d8b811015a725ccddeff530ab330ffd88cb914fd54fb40ccf77b04a09cf550bcff108dff47359fa35d0e30f742d90462e7e94b1bcab12468fda79956bd4c4bcdcfe1a052022409bc231bb762b7a3bc3b901d21a18e1de0cc5e0cbfb8731bced424ced9981c8717db7417ebbeaa2230feeed4ea2c8b7e07e65204dee8a4147641c7e7f08b14a8f939d1938049d301c9b17af646541639dbbc279352bd26817edb43f7430377f04c22c3cb2a0c4004fadda405db97c3fee5cece8e73865023ef4d4dcd9b0de7938aaada7b8a58a16ac106d964167fa287522c766b33cbd5d3a5fd94986c49feeb9a17a22921ae7cefc45c57c595ad78d789ef920e49b152078ed5af47cc33ad603915791ba57e4ed3b26eefc96a948dd0f46c52a468e2948d51620fb1715a31c9548269c734015e2949907e499508a4fa62593f521d1713606679267b5e2861149c5a780f8fae54aefa8a353c4f0bdc6996f4b07248067821c704e38f0789d0d8976145593ba09863daffa32e7142abe74c8b46edcf2d196bad1b3af324e4c7c4cb005d861cb79adb9b1c773c0c646f1bbeb794de7bae9ef87c8d2c5c456339f947558a0132acbf2b38766e327bc7ddc61900d8029158d3f5f943299fee931f1582d592b3dedd810e5d2d9fe6e0e660892b79b6969f6808a79bac139d7b74db8cc26c33c91a8d21e71917963aa5fa74651d27313200a02b434a3e63802232614df401212d8d4d349a608c5f8346831d459764d72c282677b793e0a902e48c2349761aa14d8a52c3732fb2c64f8a63c2b59be23d8c588679e1310e1e14966d9dc9125e83cc0471411c77a259bd4de8c4b0832adb8cf48f66864a9a1811e1502680aa70bcf92d69639291e7793e33d643764d1a909616660252c2629e902d469610427e644f913a85d91d954648449705f35668f0c5a6aee848775b7d5e09f50e7784811a61a76878675070f5460cffd782fc167f0a4f99dac60da63af6e282e8d3d55efaf74ac1240791a25b1da543498cd9ff0974ddfb006656532512e9f5be814178f247253d5854b2ebc0649a1ec183c296891709bdd32f6a7feb3669da51a2c7515cc52a3cb4d8138a8802280bf3e28da63f8190e4f01b64633b41f1ef202b4d77a84fa6a682e7a1544ef2cbf4546acf216e885e953ea93a5057d7b33ea14da3c3a42cdebd54fa54f8daebd42da2630c4aa3e3388411f6ed278982f3160c1d8c8b09503366ad3a8a50bf2a01cb4cb535e05c262a049c3246d6550d8aa016e4117ae89f0175387e6c5981da76e38e1caac595f1e6527eb79f4f7739cacd727445e10de4727676589e4c10924d4832feb0c208403a879ff560b4821a38c4e14fa2af7fb7dfbe35131ea68f92682a3aaf082b6bd2c28be6be144fb83e2b4946bddbaafc75625cf6d3f4d2814eda067f4b442602a81b7b990142fc92d97fde6640b4b1f1abc26bd54885b76f2f370d7c7d14f931980833ebedf3e89d89d689d5360d51d82c631285682023f7be62180210b9a877969ce410fcef208794cf03872dc3a1e6194468a87847b7d6d04d23df37ab72c390a5d957939de2c9b313c182ace0715a216161256ac5489fd61314f3d3d40061bc3f2f2c58be5e9b600ce356aebb65b7f99ad8dc54c46bd363920794b8aa1f7306af7c2fbad9f19e7f2b6b2ab0ad17d1d9c6404f8b1ef712fa3fc55eb3c9664e9a894ff62c3e45c2b9b3d7bc9f95dcb52666df7c8199483ead29866da231d023a5042372ff99a3f4c099802ea88d635d338225cc3f7e32db37d408250b179d4d37dc9c3a2366ed5e7837d0c5d5293df9a62d0e26606ca7da6286aba42f27568f5fc839d79e6c04d63f3e00109c3768c47359cb5a8267029d4ff22cad5797cd712ae9ae66ae5195332b3b2305db8a60c40b40bc50c4954edd87371d27e79f5945c90f0ee9583e95813d893dabf64a7b65121472fa8e2c4ee2708e4b1390bfdbf857a316120d553887ac284486688186f851d7aef63ac5271f48f3be4a7e5536ae0df6fa73ac4d4f730fcb0d958a0da75c70bb17ac7e02c21245f3aeea89199dc1f57fa8ec3f824bd65b9ab26d637c80b5b554fe72f175846b2d6accca179555660d571310c900c2e5fbb8ed20517a474a0636483c37ca958131387a6ad4bfcd786899c844f127216e307c88b61d750528581ecd2f7f8a9ab10dd7b7af4f625fa0dbffce2df56db03db63f994a11369664893f0b034ac32ffc1849c77dcf9fd568fc537f216a8c9b03f90256f6be02aceb9e2030f97448325032e5bcea42ba04a7441352ad342beecf45a4e706197d333496456e6829003aede5e495dd628fda8bd239dba192e7119074cc10d6334f1f6470f9ae8007b30a41118c83ff50f384ba0b78a86bea4bf68e6e810f84308b0a220be0bd39e41f71dc50b911285394652fb33afea0b2134e950d7c27187120ca8d8d34db269676190d888d0e8eb9907160aee549df02df1f98cf282a605add4937547836f06b1a44be7b70bfe455ca40bae69998331bf6e359af5830139a998a84b600051424618ae47bffca62385403a14916bc24d88c293c74769316d7226dde9117b040b20fc31457b6dddf8344116284fe4c98c2221fd1313acd3442c42f580835cbf555aef39a43668ef3c4722d2f942790ce669436ed63fd4f54a0703ea6752c31c07ec680a358ec0d70ad8107d6e4d6fc80bc10588d457a9ce3a481b3e06c6742626bf7a7cd14c533b2b49547a63d292f60323b69af05ea3904909fbd75ace01aa6cb32f1bf71a85c6eafd3221121ae08dad9fe130d70f847245e9bdb747e49ecf021c1204da8d9a5566e98664a5434f50c6586ff0ec53478021036d7ec86d819d3447e572ae01902ab4314600ef7187889555dee9ff50154643dbe21615f1a28e58f06416421831da7ccb8762e1749f5b0bdd4e36a1d84a5686a6406f8dc04dce79e94298f64313e0d51ebcbc83e025d9b62553baa04f6583f93ebc750e377134f1719cfa2acf831f9ec8d762d4802070468a8c7fb0291db0d270968be091bfa6be55b44fc9286fa54867dbe11eba34d82eaf2da27a6752d1fd0ee03d48940a271ce04546a0829bff4c13c07c50e32738dd9e10b24f58a7e1924824e0a473e79092e7f56c44a776698431c67a2d26ccbf19d560605b054466f6c8bb7de387ce0b3737deb6d2332390009039e8b0e7d4b295c5a812212060daf496a5570cc339123b7ba1b3d43b936b866c49ebb8fb6b8e56544eb167c99330c90afc2f9a91b6bb7946b19159bba519effd83498006ad242c767b85e381cff42f2bb7738bf29e01ad3793b0f361316ea2fcf241eb69da77507b07134a0b491b4f2ba2ae9e2f4b2182fe2fd4efbbcf327606c05b308a129da463fe02b16512f09a55710fadeb99f7b924e83526f546cb8d1d6a261df9228327bb265a376a185f477413d645dfffe042450ac0f8786c087102d8e6786af313631dc0824d389b87d5a799ca318a5d63c85ab0d2b9d691f0eeee42d4d4f54750c33798d4115efc1892894b6cd8b487460bdcc2d0c68850a51a285db4349da38adcaf94166c7b90024901ad6981ebdf0f7608baba61f6592f807bea1fa2774472a729f6ac9117a7ef14478bcf65de79f707432ef5af3f9bcf6ecb098c2671d8a581ca91d8e2ecb55519dc960a379fc59b2b1047ba9faf62d678a3fdb28e883b9807dd40b0d14bc1d36e50d2ba714312638340864e98ebc5cb171de8b2d9781192ffd45ffc27885fa8c46dba09a28345d17ae4235f64858341b6b49c65a50e0eaed38332fac00ac12d05ce2a8cd7756c52c52f4269b75cf35368d5d26f3534513a7d168fdf6c352e0c537ec18ac783e1dab27916ee9f6ea69d59914ad2f5f08c2cd10a2d08c2449cd6afb907b6b4c612b66236208df7f3fccb7e74575042801a0d81cfc321c23445ca9f0e40683f37dd1b9799c93560ae168ca0c300d5290f5b76e0ac5fae3e6e2e94ed7d9665f35af5f926a7c32eb25e804a231c2e83a9bf09b9e29afbf51279692081721db2fc8d0b05236d2a5f903c674d0fc0cb397fe17ef99850716e45220f3040279d1dc874a9d4c26171cd5180fe4c97597623731a2808a1a813f911e9a3fa0846f85a533ce441e905aec9dfdcc271f41eafad42e0ffd50ddc59c342845e8414a65fcee8fc902db434caeee9906ca92848c14e716308b4fd4ab88de7ab264773a7c8c30b5d318eb26d4adc610c0c98e260e212dd660ceddbe19a70d3560ed2509f338a139c84afe34b801c5ef2e682a66423b4948a2e54707ceb4bd733381543d22e6771f8838ee9ccf412c45d7dc0433b8dee54ede8b4cc229ec4048775b3e33bfc7a56674c44b508a8ae29ac12716a2c3d1adce96690009422e9ed1a99aa211c562f1af055406571559687916fe76bfee004f668a6a7e3dfb6e86b7e33d367623762d93c9e5c90e5861ee820e311f8d65685736dff483603bfda24ec62d6358d64e32f40c5cd51686b911a72271a7e1ae077bc3908d3a19d71ee760325fe0ee425b9dd34cd7b9e06101ae32b80e39db170d2c27f6ffc5bbd165cb7f313d4aecdc30df2ab0eb7d03fa0711a7f535af4f3bd26448f06b947aaf8ee5fe9e094916187f8ff62ad2624570382a0845212191e1a452cd2e8d22ba37e98f1046b57444ed5153aaa4926db252c000276ffbb3bf0e8fac9d51e55740c96c877fd8629556b448d10e0f059f7b49a25940ed1b29f0140f18f5768299385f0bae0e57c889168da9bc493d47132f153cb8694b57d057197aa660d9d5419965d4673bb154b1d1167a523e274095da20cb76525d0c421ab78cb34a1947e273820035c58e9df87726930c758df4215cd9a0dbaabce62972765fe11978db1d2e7907f28ac733d863605e1aa880549b5cf142aa83f08fcbb76cae08a3e24eda649173360b51408301d569f54d74ad908d88cf5864da44ea19ee42cd877d7bc98c678285d0899c7fe2bb2423a53dfd17f44a7d93c10c2e77ab274102bd93d5222f86d42c25b7a22ca460e3ad6ca05846fb2afb033607441a80c195de1680d90bb44d1bdbd4d7b34fbbc5e8e8364bdb1cc789a20fcdc4b3c0a7e9c892a049875a82167720d6421ba15999625b7c3664d8669cff1e9559b4564d9286fc73cc71f621c0ee492ad5da496d3f862f79d4696e2b12d8de2b14b83c484fe73393b9c61a850e71a73fc2c6d325f7da49451556bdedc45af7e7d1c93e442e3083840ffff081fe8980b791de5eb5364169c40620cb9a652d19e82693857543d0a0f177d948096384a3b684d8d0115ace0d8b872fd18dfa6bd5185aea9e922bef43e7a51436de58093ae85d77a5b6f423e1a689626e0b88ebf147ae40b70e35363b9ea1799599282bce90726b2e104fd4e245aabbe9874c0f00cee9567302090002c0d0a3a71f63b1c7f10e7dd01bd65b5bd8360c9b0e2c50b4e77b23453984605a964e827e52d450c98b75d980c3d7a93dbe7784efdfec9cc64be9126d39fad4103f55692b2f32824e75c3a8371eb68527503b211b0335dcfbc993ed27bb33abe2fd2b7a8b7c1a40ca6577325f54255edf620f6a37d222aefcfb8a1dbf24ca1aed627783e73d3af31608ac9c2b9d169b4398db8fd5fa68395a7fdcf45d80057a31ce425e1d7e6da47db2273fc431957d1bde14b36cb1b7850bd9095b5ee5ef66b3406485219cf3aebbc4315b9eea947a71577c615040da24121ca88f8952f427ff3ca01db6a4c5d4a9a32bfcd59814eb341235d2b5642d71d5980845a49f47379e51d7e67b2c51cd1e4dbaf26f3c371285b6867e66f579d18003300a615ad425e0e0e65a4f72451ffc204b63109c4a81b46bf1b8d4efa3e06f066fbc16087f85b2e7f8bc7be5f17e2210dfff1f851762bf17f04a2419041899fcd69e843378cc9ca1832837343d13cb076ab7ebc76e8c0244557f8c3dd114320dd4e4c372a1b71f16756ca49701c2ebf6c0f7e813b057fb4a303a88f62afc4929638e0bc452a984e2a159d7e4323e21defea984df6a751197ea914ef6ed0dce523d713b22546741547cbe915372dc18c19e7b39078020d7f70cc0498236aa87150905953617dc8a0915b84e02623e9d477529254c981506bcc115a077b022982070aa4cfa1cb32c30d760c850e7a809bf3b3bb3e0193a925e4b24186b86dfd19d14e68bc1897c7339186db1126c31ebb28c4575fdf9edefa9ac92e27f164388b3b80867751a317f899208ad0cd12b98182a7b4210db325ebe5e28b60c3dad4a9927671472ca2d4897cb4450d7752826c648069c4231f5fce52bb8ee452da1cfc8640bd5e94ac1dd7ba4679fc101d294b6add2c33e484f06103b99293de2af5b8c2e8429d631396884538cb1d3d8b5997a7eca5302b4b9e118fc8d56a35b4353540b8dc65c27dbaa1517527f0ef8cf97a5cce126698a54a6eaec33cae046be5ef18c5c16860a2855a4d8c9c2c9ae993e1225e437684deac106a6bac8d32c4c9446cb4d8d87486851f584f725f85633bb2462ad0073978a92b1932399ac9afdf1dee5a4d07603b2dcdca22d9f8e31a58c83d7b6d8bde37fbd159998a3d3b232a0e25449dc76c04885fb2d4b1cb1a8dad5311b6e23f6c1e2f83f702fee06f8b69b6ae5fb32c367194a09aeb30e46824fc8be0581ae91c82f4874a5e17762578641ebdc577b00be4adb03b128c9e19d72ed72b7035247bf4e916889e099ea231a81638b736c5052dace1eb25ce163d86cacd01e363ffb87168fd5787d8baf624742ee4300021091646afa51b68a7ab4108679b1b7508838e535f0e57582e88afeac9c0d66cc590e260299ddca6f845530624e26029d8b06ec53ea05e962d46819b74480c82d532a18b9f2de6f7b7b270819a226dfe461840269525a3bed90565ad92642251c473848560f723e0be91a7d29b902cf7461d1c17068915e182c3d36dd5c672bcc7d917fbc1063393bc202adc5fc8c38cb72508736a534046201b2e7aaa6fb3210d9bc24680e8795ebe0cb85c13973bf02ae1ded0f57d99708fce8c9005e2f7b9bfb4a984f9a31a4d911df6e195f66a236cf8d7e0248d80a74ab878410b1555e72f197932e6f694aa319ae2baa7ee5a378f39a68edb02a6cbe70eabd749f727699b61d76a79ca39a97b036a689b47c113111254b30f32fd504b272100d64185f3a8dd40a09022ada80a0a7aa51fe4cbf4b1dba68bed7c61ad00295e7baf074916e6293c2077e83efbff9d71312dcf3596b104d98cabc4916e96efba9080be657199617d00b22d77304cd9b98f1ba80206adb1905a72414f9391f9a72836bd6f3d36f03d3d144c0d9ac51a4e326a28689772cb8c8d2b9ef9a0de0ccd886a7b12e6d6b53f390911675515b6952b0a87a163e7bc1e29d5d5078198dc8d554dbabe094890450eb2f5015858aca17bbac0011ab2588a3d46c7a8efcf09b62d2cc32c65a871f17cebb92dbd72c842508e6f08f4c06777dd22b9cc103c0f8c0cf8ad38a8d944eaf8c0e8b4a13f9c5a28ca43cdf607288aac7e01e75cdeaf364986b103cbd4c9d7313fbd4dcab4ece155441b98de0ee3fa576fb0a8a5a5494221dcd614cbc28171d601daabd01ed7d3006f67e32aeed08c34fabfcf56834ffc5cf533c51cb319bbc61bbd0fe472d8cede76ed608105738461744d481a5a333e7b604e706361ce7d09cf21503756ec17afa339dd339bfbca506459c460f21ffef57d686d6294c437ca6eb8d262910fa3e9899679c31b4ff4c8270b10a58533e690e1ae4f01e7ed60bb61f98dd5de60fbdaccaea71717ea03e87518cf6375fb1cafec5de0ccef40121b75e47d17c0b7b413a465c98b1ea7bcf54269073c41952a164bd32ff0bbafb651af429e3c61978fb8636104219e72b8ea74c4b7fb7f038a8f67df15b5428cabf65d204b9b668ad5cae4757521b03b0f8d8f76192a86ea247d2037a234d74fde887ef4343edde2394e79020db1ba6358fea904729e96992424c4fc3d446870d86d89c2b76628529066fe9b40f9adcd1e0b42d48fd29eb78bbe635a39e7e4e2ba828e3145b8764b1821982d2f1f206291384d0b5e0727e96d575c8d4f89ec65aac33764ccb0d0b8e27468d628d124c45877407608ed0d3057ac0481fa0333bf9ee371102af187d22af4b809f244f44c0ad79a582e5fec188dd179835c378740a2ef638da0a356b894d65da2766494db06783efc307d956312c83c7d138c4f0171a239f5d7fc241565a5f105d8d57ccd03a29b57737f567445c3a14233fecfa19b5346f656840cf484ba7c735e954323e956d3e27cf1ddc77fb82afa6fca3601a9ff3d56d0db6ceeaea13429bf839b0bfcef03fc2639f09078f4975b76c50a99b35ada0115a3a494343e0891948d9b428e46101d7a3194462a59006d7f1707de70d1cefe539f0969d15240dfa56d5c5c989c3744577f9104cdba44b9e7079c5565c06c52623d5bef15950b8c6c7e9532c9575bfc86ad95267ab810904069f16eed90336e6d6720f65b03bfff55163c97305229a894df855faa68609486ea05bbd91e7ec0d4c77debdbe4e6c2aeb187092069eada69b59268bc91ff41bb99753bc224dd135a053c8bf80b097f7ba5d855196d1c070e62aabd052f518cc6840d2dd39fbd6812674d0610c2d6886c02441456d02a9a1d304aa74c91e2936c4398d1111ba332a23b5e92ea3dbc6317a1cd94d69f9a150c4556207a3d086db1d5da1ef6ffaab7663174d2c879290c5093fb3a8da75af9e97dff376d2cab9c23d219ee4d6d6e4c6659b9492f754599c82d8a6547c1a846f7a496cd89c24b74c31b64edf3ebc48b2534f6f6a70985ee2cf8e620873a8c24d87130632aacdc827700cd48941ce4e1180725f8edad2a1612bf91c71adfd7ebb49649078aed2e9931f994e6ab0cf9ae18da39f3a93528432e59b0b6f28ce50c06d86362bdd8bbe6ee88acb3726aa17ff6955c4d20466c303e7a42dde027b043a9bceeac170de5c4314841aae7206038eb1d0947e88b38c8f218e48a7b7162792d202de940bf31f3af4ba62865d37096adfbe64370d42e3bf695fca4ef6d395b8969822ae6122e931f6224f9772597204ae4d448abf7f505d8313bbb808c9e19ca0c079aceba707e3b9b97f2d1055804e5a043ac0d229a337f9ae7eee252d22e9a7056b0c4cc4ecc3a6cafd7e48bb3137d30bf639ee03ab4df18368775ef6d243b41597a97817e754695d6122c4d060962533b8bd895e4d0dff6081f6b953e142d7af931ea663c9737ee4a8f85b7f983f7dcf1dc78870035f4a776e74c8e47ac391fff74414303c5f47b9b2fdcc42f5ffe2e4ba994eee8ca1f3972eb5e8fa3d56a7bd285071e8272e2bdf73697260582d5228137190b7be3c2fea51d5b368bdee0f325852b0aabae9879cd2d2171d809e0006a129737f31606bebe8d1cfa1cf1e1625a9eaab1f502d9cc61627997854ee2ed088416d5d6d5b02ee96bd7074665e65aeca8de221b39a30a187d1c49eca64726c4f8ebf5e0471a1694b8fd33205966cb56aa312687f463949d6b88514bbb146212dd5799b6a190f9aa3215427f58191b0b556928a1558526bdb5a879e7a3cbebc720a9a81f63698bdc9416c9b89f6283ebcdb0720088e1392d3ef33933fc00a27607ea9152fdd8326644c7ef7c98cc3360478c9556b9558e033de87ee16ca6556b499cb9f207319e34815ec7053bcdc5ca71c058a14da83ca9815deb962b363f927c5115a82a867fe4dfb9b95c3cf2db2c1abcbc9d650ba06349fd6efff0c5bb9016d1eefb006891c3580baac3b3d856d2159ecb76b5cf5d6da6aac1f50a4a135635cf98e80f47a1eec06e70ab211569038197dd114d6741000b8a19e273fbd45bf5b6a18a2e0349a03a492396575919cb7093c8bdabcdced01a51da22ca17737742f351410befd7b8471e99a39517e4c3d025613cff46f01c1686051028b4876c663206b41019b551d680752671168e8fd2e971a791d477af49b3587bbadfe3d0d980c43245ce90df29349bd7a9932d76fe57f17b5b2715be596016b2e538ac8e6608335bc82cd972544cf5cbcecd82e9e74e1695a05b78545bd2302e12b29e1c6c1e01ec23749a2a0d47307fb539f1b2d7710d631f9690b99b1a4d3202290d8d6edc8d108afde9ea6a77488a654385364cabb9a52f87330ccce85120b667b85791f92fbb9388b27a01bffa41d66974608ad7272913075e7086c9be60657c146fb33cb1e5e35a1670fb1c1284bcfd3d116c2186889d878c161b2022989ad0752e4722cba54376695083b7a532c98864f092428d86588605fc5cc8c85c546924519d42fa104a8f4eee3e24d63e669983b85654eb5a15bbb6f0d819da3b9b89898597abd80f820865558b564ac790ab309f24137b57e166d5307ccf10e869692df99c34f4774be4d2bf9fb03dd734761316a83d67916f4fd0c6a9c55e142144f313459ab2edc569419741729a3aa70c968d0e5706e6089f87cfdc3d9d8238a2f969707698999d55cf0bf0ec2b79d28364efa4837dff87f198e0e9c58ff304c37cc815c65aa0bfd72144bf29823dfe5e22f696a8b8a21483c68caec4e73ba9480a960743a071ae620b81a937e9d18fea9644b11246eef43b93e09ba84593cc92a8deab526fe7f6631a67c22766190e6d09df9ff2d764ef596905d6bd48f0761a692d783520c99b5fcb58fb743a3ccd1eba674cfc6614574e19f58af2b7b40b0db9974fb201a6e7a9b48d4de562fccc068cc6e48c0b346f8426a769c9faf13c32380d2e459c2799d8f491f0415cd28cf3c8df8bb2e5490a72ff6035a4874ad9045e9c3f73c6355d7c467687221e199811077d2631fe615fbbfd69751cee4c47dd960919fccfc6a797e7caab2a73bed33b952080c7c68778ff3318783d55c10b80ffc9e2680271d4797092cb5b1917aa368e89b66f69cdb7c0ab0e8af2faccafc48b5478cb0962fd39b67df0f70886487b35a091048596351d429add96bf5304a6615ae94785bc4abce6ee3272ac2e4206294bc7a39b04ea155199e616f193501395ca85cf912f9eb83a439b0ec3c686adfbbde1ea895385d5ba8c43448ce9a35c34fe9fcd3549d9f572c90d87b4e35ec799509b29150c5d4e41f5ab5c308c05430878f652c51ea0694d6bf4a8a9e39b19985cc77d9e849a351f1fba60436ddbc7e90988dc38f59640de0b7fea4b60ad9936255ff550ec5b6f380ed2b944b6438f1e93f2f4ee3ed2b857823c2cca97b196b40c56d5b168f1a3174512cc49a6c45b719e94383506ec5be847dc05e806320c64ccbc05b930ad853c79007c126b33fe98a4b4b2c88ed6d221caa02ef2dfb5c370979197ea19f3313f1a107437c29f427e23d49bad26e2ab675f6e010525decdce0eacbeedade03205717d7c25e7d1ba6b367175f0c1c5ac1c74be94932bbbb8249a5ee5e4cd7dab384672cc0b96aa6792cc235522d11b8ade48b1f093b4556f10c0bba0297564fb4bd77fd089f80ae97abe1f0f07f9569e4cead4c9a877b693006ef0cda9a282095dc6a42bca36f8d898d7d752d660373b536e4a61db60fcaba2dc087e29138cdea850b3ea931b6240cede23d752e77a5bf1af12482a868bb05043d218e6d5094717f1951142d587712b439c3a57e16580127b35432b5874068289e4fd2ab00a86f476d0b00e874b65a6bab84a71dab48debd840934cde2a32fbcb5afd78717b54b07bbe3285df506a0273baac6e9081554f687745ef16385aac63b0db59c9ecaa899cee1fc221b2820107110cfd4b8c927e67a5753f6c1d76057cfe0ad7bfc55e7e1b7220e83b3c9ce0363cd2fafb8800289946e4a670625edc36a4067d87bd9766f774e436e2f7443058f97010fe5e167edd84be707fce290bd4d94b6407d0a3584800e0905e74cb60a027fd65484808804f928a1316c3ab7b3f76dcccfcf49d11b703612902a623c703bf4d7ef5a241be875338da57ed58ca0e16536087615d225b6f54e075d31095b8477ec4f9dc370a7eef5f2a8df9a84d3af2a667ae27db26402d79fb9cdc9e431c5eb04514b5cf754ff323a891a03f12eadc61980f52c0e2961837a7e51e137753ca674a0728b9f0fc4bc598e9908a642358dc56d88caa06622231d5bc7758f2c31bc26c9ab8fd6e74c34feb4fc147e84421bdaf6faee9579f47e0b078d98f092cd4efd78142c7a156a721b5e405cdd442dc2101ed567d52364013684d1d1bdb257d9a22a3e45646be12b825da79dfa5c7db1e200ff0b01962d7b2c927baf8686e76b015ff66ef0ef5f0125b95d46efab19a180f108dd68c3b254540ac146303d94163b490b26e05ee84fa8e6db9afc4f3404ae5472f2851110e125cb551412dceb41d8295b377bb97520fec298914299af076ccccfc1f119c97e64c8ee5eef6185181dc34fff18d4d3b3c775c99d78dfd868e830b388710666f029c6dc6d51f30ba2f2394bb8c1d5f1e14b513441af512a9171b0756448a0964e5b362e4af20091792d359f16c7a24c0446b9c3c906866bb1776906cc3f054fba6dfb1262449703ccb06f923cd154b823b3fcb1a4432e745b7508ac0d7dff913ffa9e372b7f73113986498172ca9e554241a282e498627ef95e541c3185a198c1448159147d9f76e5f13ad342838048461e725c29655213a6e6f5e3d4cc5d08c1e9f6bc78dedb4f65219d8dbb658fd0d40168ab7727c1d3923791a05f57fc6fa20485aa25a0a88ac0d889ab761ab11c69293c063506cf83de5433baf162a24f84920b1fd67924a8eec6e3c0f35c6f36b06c05274d88f0427ef097545eb5ca23706f17bd0e15a3b35c90f1a37d0870fa788046ed873ecf46fb62b6824f76111e4e122f222c29da552fd9e2341d17868c15601498283f87488433eb6a2dbdfc8dd32af6579334a634763b8c3fd9645a1eb0f2e4fbbef81319566cdd3c38637ff98fd87b146bbc618a3e344a6a1172c67c70d5966cb93ed40bdc615704956302458b2aac28bc0db77d3222d0a1e2fd6d802b890b5b1b3c1fedc4a4c54cfc59ff087bf1a12db67db3d0a30f9185b2a10fe3b6202a48386d6e7da28161ca3190953af288b5b303574aa71d84596e629767118bb7363f7169acf679c35c625747ab88f4c6e0641202753f3068ce613772d3475c701718587fd4c55591a3c549f27fb6b881c22af03ea643912c5b1bb6954c4d6259c97b03c67bb9e4de15730cd000c47a9b213b03da50c0e8404a6b47c1b0d526ff9b7f888d55cccf63b9ec9f333f3a49c14a76329be91a180926adeaee324d24962ecd045f6aef9162ebd29ffe63c50202dc84bcef08fbba85e950e9adbbd9b6e6293353302eb16de6e2fc49abe21d4c6e326ba361d74f92da638287891142c047a86bd21129aa8e9f177909a9af5972a70fedbde0d0ccd2a93746e8b44cbfae6bbe33cf945eeac585cd1fb56410827c9d8f1ee677af23cbd6504b00a83da200c923446ba4437523c37a6a5f8a2ac5ffac96f8dc6a58262e498a13fd7b2416e175ba24cecab2265580fa216292f3da08d1be8e563761151fa3ecaa4ca550769bf4b7e8991847971ec48857e1783941bae7825ffedd97a74028a03b3defcb6a047e47c16a8a64718ae8450e2e8c9bb0ee020be4e5e281610ae7c8b784aa2fe591055374f0596e6c804441f5fd2fadb36a168159b57dbcfc6f15236299a8f4bb17fef77bb6e41a662acf5d363e2d49a1e207d901fe82d83a4a8b4a38293f88b279b1d7634247fc7afdc4e1a21e7934639e60736e949b39c2a59a3763288cbf142a15c3b68ca688a93430685c2d418d9dfd920f6c43ae2c8d515aca8a98bafeada5b6f10ea258d21a9e70ff3a1cfb948c9908d21488b9700f3d2fc7b86727ea8a5675460d042d705b01bc96c09b9b7be2d2160c039ded04c915016315052354b103689f4fccd2e63bcfd0cf823e96de80c9b0f86eca642e221cc8b1342293bba0ea616dc4baa963e5ebd4ff47b8916620c2c82a69c94b5dfb6b8f5c9b9fdb775d82d83fa269e7595b2f0979462f05aff152a7b374b0ecb7bd5a804614a73e8aaf78e1da43c8902bea8afa570eb80d9b52c7eb5dc1b710afcaf9a6589593cac964d73f676e8e7e2e0bc6824435b3b53b8ac6f27add5e73f9d0478dbc554c3b5f00a02c13e7117c6e6c391c92ed2a28a08ff2014677ed8ead31600821258aa31004a9d61a3c1a0e32de4b22318a261fada21c5daa8486eef82db24eaf29c921d4cdafd28e6bcd3e4e36bc742c128273172f645c849e53f952b90fd0d7bd132872d219e9c96c08945dccd7763ed40d8ca96d7a454e9e43f044654887f55c1a2e318803176f5c363a394eecdae8b89cb933d0dcd36fe203d59ec294f089b1ebada82fc0d76bbdd51b73878de7e9e61939ec6d68136b828b2e10cd83a26ba7784d76abe5516b735cad61681a5fe598841ac6f04cc5fa1273d1b9ee84629f358bc07d2bc6cd55017cd2996fd3a328ec5f5ade70ceb726506fad6cf5acd28afacf42200bc0e467c4c9f05966ba2328f9455a7a5c29b5380fd948674bddde8c4beabe771147a86e5d39e9a164508ea16e70d8a7201dc233c0a9b57ea002e8aed1349b3a92cfd62d4db57d5fe3f838e14fc2e63a589679b1d8f250810ad6e44b0b6e87934bb8b98b58d76e698dcffbbd8adad49dd4efb0c9f5043e5d31dc04deb3e4ce726ff2eb2c664f229b3a977940aa937049fd6a7ee7ba8a3f6ced3e53287f1f34c9ebdb0393e48948e31355d39b671b474c19b7e324e8ef552dae7b7f6852fae3a17ca2165c9c4885ff5bcbe07c6c9ab8ed117ed179f3037914d004f7ba3d57c2acbe0caf618a21cf9d6934d1c8a7eb96766edfd9221757a0334d8f2ae1c4ce847b134dda12fdb431e2e8d5b62e08595041940995bcaecf8b46aba08bb3076fc200af00ab6562f1bcf9c4da99fb9e7f1dfb44970ee2f84a63ba6f425d826954938fb47affd1fac370fe49f412d5294070ba4bfbfe704cae4d4dd0902aedc783ffc1f7248b30324dbbfc19f9fb1d80b0810a214e779964ddaa0f049433abfc89cd575d987a17a5e33b6f998b6ff1a896a808b8527f1a4aa8ba0efafd46461850f89685a2f13f37a757cbb3f64afb25bd8d88dcf74cb3cb15a20b864a3c9ac8f24b55e16ed5352690d262614b33fac343e4a5fd6665199c84146b499522e220a81fb85bf5f4e0e188c728cf42a1e9a60fb43f873f16547d82f1c743375d9a12f092df6bb420a17017f69e578365f385c8f1fbfeb27f00808d010147deacc9ed49c0ee6ef9fd4ea02d3aa99d74a4ec9e13f85a2739dabb3bca8b3944a2f48afad56f87d0c34c03c3670bdfec5c7ac926df94b6259c9b008b513e9f00f8fd562ba350f03a7dc63b4e15ebef7591a2b149ad3e46e7b5b11f7b350b647664558c0fb0c174a623058def97271139555a4999db131554a3b40b2b9731a8105a0014eafb3b92b31f96e5f69d01c4551d129efab530687706f71875ef511190d6bfcf2f56f88bc674e4b7449a6cb1cced3b81f94e601e478b8eb48e815e22526432c729dacfecf1582ec8c1cc81e153df0c4e063a1ae0f9601d6089f801289ffa8e3631a9515db74c383e241489d989b380f8dfd183403b189a0f137f494429564b72f1b1859fdf10b673f18b9c07a0d8b3ad407392974831fcaa72f7c2e0d3fbd1a6d804c358a3a6d79310f796f37c14c0bff7309324c7e35b0e987a0b925f1c2dd8e28f4952486820ad919fc94fd520392bc4968fdf47296484cc08275d57a925b101494394610e72bd560b8d182dd59a71161232730bad0fac2806cab695dcf7d4b2c4bdc32f724003b43162559215f014836ab881d26ee87495ee7feb0e3eae4aafe5dc712dddc6f1e3baadae12d538633ca18a5185a549a6ad2edc99aeac820fb0f6334adfbf912d9958b664de8c579de695b2148eb02e0d371adfbea43c9cdc54431eb0738e69657f1a5ac84ec50422c60891e670361ffc7ebd48cd6c5dc67b85c54b260f1e536f7144a82709abcf3a1c1a7b6f847c3571b4226fd20248931cb3b98da232119b6c2b21d070edc80b0ebc9617678348921f49eeb5ce8ea3e7b5c6daf909ead802408452d77c18f86a71fb1f4b8494b6c0fadfe3f10d5a953e4381689a012e6ac5d526689de2700f55be104df37eaab06173c41221d8c60d148ba5411caebf9ca731fcfd893d2f32ba75ddf8fedc94503018e08f2b40af54860c8555a3219ba419c619130e11216134fe8d02549862b65a815e2349fcecc2c58a95039532289a3ca69c61d696e73561e982c82c6a80de16a9e41c6fac1cc7b77d6d677c62b0180e2b3afee5aa7c128048179c0b852921a4bb9623bf17de4ba94437bbe8947ef80374d04af30ec99153fec7ea0768925f20ee2616b99952b3852ce10f940288e1439afa8667ade2fba958232b5d543c46e01aa727c75ae5e94d190bbcf55748ef9057f6c652f5c75627976a20eec744766c4249b4812dbc54bc0faa5b8ff54e3e14761d494df535bbf6fba27f8854a8dfd402c8db10f165e4bcf461c43cfea97f57bdc3eaa834c761b8326fca0a412508dc9db5387efaec466cff53baa11e510ec1cad557af7d06e046ff50eac0b0f2d5bc580973e8b8a7683c9bd9c60e0a5e6474f2c2abbe8e8deaf44730a37c13523ecafe8d64ebbf23e17277b7757e94d88413f03fe3587ed5413037d11d51723a1637ad1d725f41ed2929a840af384aa03dfb27615d3260d04f4c27c954419b9b36686b12729eab936ecafe61063d681aaf2a8f4e2cfe075270ce0e88fa80042b0d24b69b33e6626600fa34e43f634d3301b59da889284c4c763f4410d7695c97f77722a927ae39a4f7f94bd5288bdc1cc9463c1c482fd912d98d0d57c9f724b532ef7457d76cca0a3ee279c325f1387d2838fb2fb98be6faefaaea86d679a8330e0bb1fd2fa6969ef993096e86c52639ff3307c70b9eb399c172b4379526c0d090250c07611e5bf01d2e6227909fea542d7fbb9f1e4503c8acfaa2aee460a2d862d76466febaf06b3c01fd426083b35a01012e07a8f791c9ae64a8e453095535920a19364c304a6807828feae0884b91072dc174fe4f4ca51639b1b6d2ab7a829366e60346dd58549b9105eef73997d4125406f702f406835db27c3f99b011575638e7eeb208871876213e098ed8ab6d98b1bbc2527e2b8f0158a7e6eab29677460348b67d8ac5bb42f7e7f7bcc6e603d4370239c051b06c4a43953399078f8f1f9def17c8b8a4ee159abc691ec664a7d2c7e98b711a00db73691d7b484da4630d9269ce64aaefd96975b7da4c18d0d8d2a16ffb9d9e7936f026d34ad6bab2dc19fae5d9aab8cf90f273b4ae35a28d7ba11e18f29fc07f5b68f8682f5a3fe9a8b9f56fa83955316e12fe18499ccaf907f40e17705c259fc64020ef47d0e3ac3d64371b382b86978dba4b953185a45e080d1bf038ae9c9e2a01e6e10c403d169dd43e933513433c59a46856ccc57ccd1153af61ea2cca9fbe674bc1b36c4708f17591f6739f9509c7514376f30d37d74c257a6da36cdd6b24e9d27cfead94ce36716f6bf3abca9ef465b01a9d513bf31816382f5d66bec564c492deae40581fbffe93565ce2a9ce0385155cbb4e4c53fc676b540fa4d382335d7e3b2d89b94c714a095a95909c16ee74f43b45c38aacf886f6e42fd0a97a0bdd0df68d8e8ba35d5d417286b4515372bfe90debdedb9b80435f1004be65db582ea201df0e48b8b523a539adfb0f343c552c105c32921b05421e24862461a875ccb58c51998e9aaa02ad97ed7c58ad50457777a91ccd31e7a4040c6fa57e20ed60c1c5843b179d3b611f9c97e5d3a1cc6684c0e24018685f01cee6f475d98d1cd439998c73a093f25a9bf42598933db0f86e406bea3a3704170c94cfee148b7a9a3f9251492069b39708c38a6eda0486b65d1fd93d12a5afe3b1be491a04fe2ea15d792ead083bdb2f70e8698e5a420bc7f2ba513fd00c8725d4c7090d340c273fb975da6717d2f81d0ce426202a25159a665be31b339c1039072e2db67b45bca97c9d39884b48d36e100693d3070cae61c8543fed8531a6ed7858427728814a42ca106245f5256f20d62a13f2e874cf71968ff9b531e653b3fd93300adc06a8092de88b4e9ae2f776988495d8bab47bf382a9f6a466705e5a7ed6ad8ba02926e2e5ff1d701394675590c2f62d7bbaf0d6ed035744ceff1d06050955802a9e035a48c03fdf7b5f12e438dc2d6cf1f038da2ecfd0ed283d36cdaaa28524b778e8df8dbc36f628bc623c308c88cc727d8d14fbc4cbece6afe43a1cd12e4d8f628c497395a4869bdcda69536b57caee4b4b20aa5a38993591aaf773afdd4ba9f037f2c5bc48fd22aecb54e2847374c9f0f2336897ee54400f6ba9d9c516fe5797584640f15d7ba32d9e0d8f48ea8e49b588911e6ba4aac6ab8b54aac0b7ff7096287ed8e20ae2ad60d5ace2379b25ea38cc7db60ddd61d502b7370fa7585abbbb02f7ac51d84ceeaf6c857d8e5add638fc24af90f1134a59024ead53c10959942d33b7748ee8bfeeea4c04ae43ff2183dd29531701925140cb0bac6714f01ac7a29a50f410053609de7a1f2d391c3f946dacc0984ea93a283ad319a9ed77524e51db02c034b734665ffb7a6a9c9f675548a0c4a9d05cdddfa0c1d53e7061ad32ebcd632122242df3be7e3e4a9829eebf4e96c6501164c755256a802c3d8605694bf8c8b8765087509c81d419b988c7b22abfa5b3b9a65391af671db11100509065bfab7c836ac59e97b20e1b363611aefa52ac940324733f330f25f0021eed95c095a5f001b42319a18060441d9ae4c319753e430e150213678a3e26056c742640668c168b574d2ea00cb85aebb4390baf699f60b14eef8340e060222b34a04d5bc33aabff29f44abdba25d67ce9179ff954499e1037bad60f24204aca379bb169282f43e2880a21cb42202adbb1384e1b26707b4c35147871a1153444d7bc515bc02c1e791eedd8c71f96c8da5e2c5cb8861802912283994e215aa15523e1180b419ec4289e9b08a80b282a1fd3eb2b8149cb7842e561b8ddfec497bd33e33eec12e3b5be0a2153c010937d4e41b0a380ea9eb3e3fa7e1b8b6926d59213c799e46a8f1e8524151408fb88ceb560a32450a3aa593457d9ffe0bfd33305bc1c234f093b4bdcb05abe481fe437e3f6d1001cce12e22aa6ff5602819250044534ed5c0fdb35236a572848ea695daeb37cc05dd4c5915c985a1df6faba58d5890d9dfe2ea03744724d305fceff69fff555b63be31026abe687a3afe42688326ebb6ed104ea0070ad387fc244db91c397409d61c105ef0ea5d05f8536c8a39734c120e562c9f059939924eb4f2cd7f997d273c3decfcd642eca718e6c2560ce1c8f8856af564222eef8a6ceebe21b9be81565b8bc587e87561a02792f717a3ba940129ff7d4f10710d1fa339ae5c3860f9e978457e957f38e570e3b446fd75f81bfc734064b9aa38095572ad20e0b19b26a35b01c8a5707163d5e016335585789fbe63bf5153586eecef0ab226b6d795887bf7c5079de467c4dab2c4d9913e5a6ea35bf7e5f09f81e7e5f6b15913627194ef3f497c5431b5f3967859166c75628e1c77bb0311be8563e85ceafb4a0aad9b0054a4ee7d85ea77865b59e333e6c2ce26558440aee773c2664bd30babe7d377686b1d96b65921dc3d4d57307bcad9ef4bdd8b110de9d87a68913d8cadb9996f92b88632b5239246cacc1c09162794c11ebc431435a6ccd88ed40bbf0376242d9d8113903bcdad5de75d153310dcc29a20274f8ccf46082d6ee1bf22ec83aa5790d57b55eb23eba56b8d6053311ff892de6b00eb702291d203521c40cd69171745fd88f9fb889534d9aae949ad1b644a216b9a02b633b357c52297fe0ec042eae319fd995d43a5ece3f3fdc44da8fe0604d4e2e959dfbdee2b7e96a209522435fb86db6e766fa14b3dfcf614265b49b2e8e4f1252ae50cb99dd195177e6f0df9db836ddb08b18c345a1a057f21d7715c8e2d02d7382bdfe2bc830cbe7f22da226f36f9307beab97e8c7fd474f91d411dd73e3453a66dd16ab4470251da5cabaabf6d5590156c551dabe46049e82a811e0cd83649e4bf6a119e1ad13cb4648584598219d1c3d3410d4c2bd230873226f28b695001e6bada187eb4079cd60d6bd4dede5af275692cadc937c929088641db071d29c481dbf02bdafae9db09b4f23f859a1b3c64729034fd238e5b01fcad41d9608ab05b1260a92f9b3003c728d7df805f86feec5f91453e429990e24665d066ff71eadc13134f661782137c7bccdc23458281d40470fb82e969954f4c7e023bcfe78b844af41ddf65aa85587815a26a3fa6b5214c4eed5706cb6efacd8636b7a2da55cdc850ace527639bd9600d7a905207a9289bba41088362e637f534af070522608a6c8e8f64653ab919520ce90b8e45f7310407d38731e680154fdc7b89b64242beff2ed23da5863282553a63aa8c67acf60838b6c22345e85aad7281d9a97bbfe068b7c683889143f29e5034e7f833fcb192ade1e05befb2409913e565f3703741d69e6a84f8882038033dee4f34922ba77c7782ba31dd821e8987efd4d5a35f444d42b9e795433bd53fc2abf6fdc4366a289a892fa8a060bd255f64e742af12069fc4cc3c4befa3b57254c6318b87120d96a5300ffaa25b21f34494a5e794bc40f5c4edf120ae34322856a77b25386b7d647ca0a1879788b1c8b2d3ab781ec3604dfbf411c705609a00c4c22cc207a3f1c0dbd4decb357a763fa764a187db0eac37e8ac01e246b7c26d3acf4ec4c8e307d7472f23bedafd37fa970f9609298fcd363d72c4f1a5edc3a77938acfab40b190b6fd96a5ddd57dbd8e8cec00cdbf6f3b91a01fc7b6095a93f85e8811ebf9a03a4e97c064f93554c10e9f63a32cfcafacc0d5f5821728140757a52de379dbb3dfac15fc25b557e214a43f176e95906b87c0f9b33db85922d309205a682ecec3d854d778ecf8b53060d3fd57a22960b8a8e02d435ad69b43b68a9b1f48e563e49c7bd5afa1327f5597f28c43f7dfeed3688dd98a8817a08f26e097bbf1efe961caed24654bdff0baa959f57440fa66de5078c8ae4da78e40c7ea122d66db3b359634f4679813652d4f2dba9203aa36b04999a9ec55442f41332cf8576e69b8cd92bd3ef088cd103510a07efeddca73daff4f5d389a0b13a8578835bad96fe5cd348663d26d560f892c87fea6a48f3fe24787676f3ff991f2eedc2914525c867c33efd906003cf16ac745041d886db0653f900c24bc440f797e7628c8415d83d353d792a9850410dad9994cb41739e8cc85c70aa8315ab5dbd926069c3cf27b4441c91365f9e2cbb5ad83edb7580b974b82f17e5c101d4d9943b902937dfaea2d7dc73c2ba0e22afff3e7b4c42805928abce50a895271e44e5c0149f88b75c131d25bba5b761e4c7f87da852f630074b50ba6a4a9035fede82e17954e104a84aba643aa255a7049e69e9de4b82b78589dcb60fb9978d6818bf1ade33b0a4ca8a30abc7e142838e18ca43f5672dda7b3f7a6fad4aabe4caeb9e664b9e65cba2f3d1bfb2e5c894b0fbcbd189558512fcc17ab1a9b1aad4d6b7f080c6fd6aedb15ad1227f5f878b1416e113e018172d7ea7f8cd4e14691aafda0df39d571b85e4bc77b09131c593c833296aa5b762ae5b92a0e2cdd8d0ed461a741893e1f7f2626718598f01f7324f050760d8ab6000cc1e21bc8fceaf52a558b522cb0eebc6c3a63b7768248f1bec9ee2910e6583117e6448edd964b891f604b76f34c7141f3a41d63742b67287aa77ce243c450055bda02bdf3cf587bc65c87d2683ecc0c264bc4a092bd994e78372f6476b9bbbac451308442f08a5ec4b128f42a46fbfda892674042d26cd71f356bf9265fda6167c30b3d50710bcdfb4a1eca531e080e545c4b22e3bb9334f19a302171e82996b49cd291cdc7e442d78a3b01715c0fe8c823f0a20e049611745e4499278827ced09f3aca963c9eb9741093643628776e43d403d9c7bc52e49fa9e440dbf0b37bdf440710af1cff80e03743371b81459df43cfa1100b0334e929f356a2b36a553b22b1f75447ee321c8d38fb7b9354ced2c3d44edcd8333a95cfd0d30b83ab4ee1d5c2fcc06014459c831b317796d7366556e302eeab7db88b4c66e6414bf87b15cbfe974e3ed61d16fca7cdc5f74f8b52f0c4d019314eecde0da5a03d40bb57fa74f412a5f43aa7cfd8ec3d45b2a5bab86f1185aad66d75041dd5faa0fb62b22390e9be81e02cd8a9d2d8ce80ca81645946624cb96f2322d8d025056378c273b0da40ff09e3a5015cb30d4e0cb47f4a71a1e310fa92fb873b590277512036df981eab8724e40a786a33e9bf4d7896df653022c4712924d0486f77505b0ffba001c7626e870dcf70a5a7ad12d29944d80450e9b71d15d7d8ca45c925e9af33ff3e32e73a3cc98985951b81fafb87953da2c7674541f1bbd96cde1c846bebf72807385ba17c35aa39d2a276c5fc17e5d735ee2332d6cb0b2cb6e2b8e159eb23fb1d2237cbf15828f352746ed565b2fd31b8</script></div><script src="/lib/blog-encrypt.js"></script><link href="/css/blog-encrypt.css" rel="stylesheet" type="text/css">]]></content>
    
    <summary type="html">
    
      Here&#39;s something encrypted, password is required to continue reading.
    
    </summary>
    
      <category term="BigData" scheme="http://yoursite.com/categories/BigData/"/>
    
      <category term="Data WareHouse" scheme="http://yoursite.com/categories/BigData/Data-WareHouse/"/>
    
    
  </entry>
  
  <entry>
    <title>职业规划</title>
    <link href="http://yoursite.com/2020/07/01/%E8%81%8C%E4%B8%9A%E8%A7%84%E5%88%92/"/>
    <id>http://yoursite.com/2020/07/01/职业规划/</id>
    <published>2020-07-01T07:03:13.000Z</published>
    <updated>2021-06-14T12:03:41.185Z</updated>
    
    <content type="html"><![CDATA[<div id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <div class="hbe-input-container">  <input type="password" id="hbePass" placeholder="" />    <label for="hbePass">Hey, password is required here.</label>    <div class="bottom-line"></div>  </div>  <script id="hbeData" type="hbeData" data-hmacdigest="14d602c993698899ec8f7dce7c0fffcd6feb9d11df9c94077396b1501d8350c8">49f7eb9bea6cd6a47e660ee8aad95e5f92bbfa9fa31ac4f0dd4c2609ce47fa2b9ac4820bcb0d20b13024247a24dbff74b4e1bc10854b2dcdfee53f3b8d596d3be45db846157e2926e065c5170bafd8420bc9ee8ff2f044cc90d0a6a1c0defe47b2b66a6bfc00481f4a3d425366e4bd87fa08ac706fe7fe9320915f17a6e3ffccbca5a6991393cab717accd0f50d508e807f16110e1174c5c1eebee69211eccfc894957f4b8e1468aa049332478c8428315199c1eafa504e8616898ec7da1d127bda0562374b4bcc3a177c8f003557970f910452c0354f329604fa7720d01dce2af1ee024c6d94ad65e01d721f8530196507bd83dd462d60fd4d5b33a81295c6612f4a9db22b3619d23fd54d071e825578fcb7cf1d854a5ef60806bc98d877b366f197e90f4c2697b4424aa52204ebca7547cdd821c16422ab79f8ad90c1952431bdf0019bbd3d8c455689a4948b03ab6fd49ea22a3bcbd7a35c564761f08a10728b47e2771cbae6def78b22e39cb592a79ef81f252466140195514703e3c10db6e71922c4f82b7ffefb64babb29fc2ce4abbdf7f7ebba6da244b90b270065729733e48feb4e59c868471aa25fb5908ba837e866ac0f858c85fa2f122e448df2b9bb9aa2aa57b9c07e6fee94a6757d0fcc1977f43850538723e2291e707be145241a33050d7a5c74ed82514997413f164b099de48dd20a9fe12da6f57c7cbd1b16045ecb6f804c9f685534abce1f692e9f7b0e36f738f8799c5fb121055264ca2e67d82767cfc679423d64b6ac2af863a7353befb4cf10b23f808ddc359f80f0053124b8bd68371d1e030f5d840ca147834324c7b07c9ec9a5d5d4e4ca4128563da70f4e22bf6d85c169a9f79724a2eae77dd86745921becfe8fbc610069a5edf549128cd031a832c7c74dff1f06231574a29971f85a5444515803044858653e5cdbdcbc6eabeb7172822f33de99a2fe94e0576a42480e1bf97876d24a7dd7ab20446c80a92068054dc0caaa9bc0b152901a8415431b09841c9d2feebd76835536e3c2384cb5d856339d25aecc33626d6378ba5223b67eff48f3c450dd0534e6f2f602ab908d923ee9210adc4143abc4ceb7b679bd86cd8f9b181a96d590c07d7d629d79d36ceef3611f331815b2cf837a1da4fd42470850cbceb8b2c46acdc1a986ed920feff61c43f52263e674c1fd57444a58bc840985caead1068fcd1f077ad50c38fb4bb9dfb8590da0faa2f494e714d2b98865f792c1288b83e1f1058e89a7193712a849b151453d80196f68345a0e6bab402e6a8cecaa8925d7b9a04cda116cd4a11e54f9160ed2f1cd70c70b83b0723e16fbc0dd602fef1ff7e0df205d821da35c16d11de6b006d3c6ce45f45a1fd5fe0395edb6bf84184d5b9e34052aaead6e9d2821ce671a8ac55770b69239e85c9692183075184ee08c498c475cea0aa36c759fab82dd23de1084cb91ccbd6ca73900b0bd946fb22ac73d6eaaebca06914a9f47131feb9f94a2ea2bea330cd53758e23a8c3e6ee8ace1f5db45f8ba6f8f627691e95b1eb765cd52cc102aad3a590c3f6e7cf5b3cb09698a9f39fea21bb87826afc39a07742a311ae1cf839</script></div><script src="/lib/blog-encrypt.js"></script><link href="/css/blog-encrypt.css" rel="stylesheet" type="text/css">]]></content>
    
    <summary type="html">
    
      Here&#39;s something encrypted, password is required to continue reading.
    
    </summary>
    
      <category term="随笔" scheme="http://yoursite.com/categories/%E9%9A%8F%E7%AC%94/"/>
    
    
  </entry>
  
  <entry>
    <title>Hexo常用命令</title>
    <link href="http://yoursite.com/2020/05/24/Hexo%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/"/>
    <id>http://yoursite.com/2020/05/24/Hexo常用命令/</id>
    <published>2020-05-24T02:38:00.000Z</published>
    <updated>2021-05-24T05:53:55.340Z</updated>
    
    <content type="html"><![CDATA[<p>使用 Hexo + Github 搭建个人博客的常用命令，在此记录下。</p><a id="more"></a><h2 id="init"><a href="#init" class="headerlink" title="init"></a>init</h2><p>新建一个网站</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo init "文件夹名称"</span><br></pre></td></tr></table></figure><h2 id="version"><a href="#version" class="headerlink" title="version"></a>version</h2><p>显示 Hexo 版本。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo version</span><br></pre></td></tr></table></figure><h2 id="new"><a href="#new" class="headerlink" title="new"></a>new</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo new "新文章名"</span><br></pre></td></tr></table></figure><h2 id="generate"><a href="#generate" class="headerlink" title="generate"></a>generate</h2><p>生成静态网页</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo g</span><br></pre></td></tr></table></figure><h2 id="server"><a href="#server" class="headerlink" title="server"></a>server</h2><p>启动服务器。默认情况下，访问网址为：<a href="http://localhost:4000/" target="_blank" rel="noopener">http://localhost:4000/</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo s</span><br></pre></td></tr></table></figure><h2 id="deploy"><a href="#deploy" class="headerlink" title="deploy"></a>deploy</h2><p>部署网站。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo d</span><br></pre></td></tr></table></figure><h2 id="list"><a href="#list" class="headerlink" title="list"></a>list</h2><p>列出网站资料</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo list &lt;type&gt;</span><br></pre></td></tr></table></figure><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://hexo.io/zh-cn/docs/commands.html" target="_blank" rel="noopener">Hexo 指令</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;使用 Hexo + Github 搭建个人博客的常用命令，在此记录下。&lt;/p&gt;
    
    </summary>
    
      <category term="Tools" scheme="http://yoursite.com/categories/Tools/"/>
    
    
  </entry>
  
  <entry>
    <title>Git常用命令</title>
    <link href="http://yoursite.com/2020/05/24/Git%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/"/>
    <id>http://yoursite.com/2020/05/24/Git常用命令/</id>
    <published>2020-05-24T02:37:42.000Z</published>
    <updated>2021-05-24T05:10:01.093Z</updated>
    
    <content type="html"><![CDATA[<p>Git 命令比较多，会经常 fork git 仓库，fork 仓库同步原远程仓库的操作，也会经常忘记，特此记录下。</p><a id="more"></a><h2 id="新建代码库"><a href="#新建代码库" class="headerlink" title="新建代码库"></a>新建代码库</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在当前目录新建一个Git代码库</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git init</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 新建一个目录，将其初始化为Git代码库</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git init [project-name]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 下载一个项目和它的整个代码历史</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">clone</span> [url]</span></span><br></pre></td></tr></table></figure><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>Git 的设置文件为 .gitconfig，它可以在用户主目录下（全局配置），也可以在项目目录下（项目配置）。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 显示当前的Git配置</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git config --list</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 编辑Git配置文件</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git config -e [--global]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置提交代码时的用户信息</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git config [--global] user.name <span class="string">"[name]"</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git config [--global] user.email <span class="string">"[email address]"</span></span></span><br></pre></td></tr></table></figure><h2 id="增加-删除文件"><a href="#增加-删除文件" class="headerlink" title="增加/删除文件"></a>增加/删除文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 添加指定文件到暂存区</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git add [file1] [file2] ...</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加指定目录到暂存区，包括子目录</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git add [dir]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加当前目录的所有文件到暂存区</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git add .</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加每个变化前，都会要求确认</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 对于同一个文件的多处变化，可以实现分次提交</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git add -p</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除工作区文件，并且将这次删除放入暂存区</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git rm [file1] [file2] ...</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 停止追踪指定文件，但该文件会保留在工作区</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git rm --cached [file]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 改名文件，并且将这个改名放入暂存区</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git mv [file-original] [file-renamed]</span></span><br></pre></td></tr></table></figure><h2 id="代码提交"><a href="#代码提交" class="headerlink" title="代码提交"></a>代码提交</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 提交暂存区到仓库区</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git commit -m [message]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 提交暂存区的指定文件到仓库区</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git commit [file1] [file2] ... -m [message]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 提交工作区自上次commit之后的变化，直接到仓库区</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git commit -a</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 提交时显示所有diff信息</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git commit -v</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用一次新的commit，替代上一次提交</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果代码没有任何新变化，则用来改写上一次commit的提交信息</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git commit --amend -m [message]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 重做上一次commit，并包括指定文件的新变化</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git commit --amend [file1] [file2] ...</span></span><br></pre></td></tr></table></figure><h2 id="分支"><a href="#分支" class="headerlink" title="分支"></a>分支</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 列出所有本地分支</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git branch</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 列出所有远程分支</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git branch -r</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 列出所有本地分支和远程分支</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git branch -a</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 新建一个分支，但依然停留在当前分支</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git branch [branch-name]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 新建一个分支，并切换到该分支</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git checkout -b [branch]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 新建一个分支，指向指定commit</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git branch [branch] [commit]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 新建一个分支，与指定的远程分支建立追踪关系</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git branch --track [branch] [remote-branch]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 切换到指定分支，并更新工作区</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git checkout [branch-name]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 切换到上一个分支</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git checkout -</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 建立追踪关系，在现有分支与指定的远程分支之间</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git branch --<span class="built_in">set</span>-upstream [branch] [remote-branch]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 合并指定分支到当前分支</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git merge [branch]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 选择一个commit，合并进当前分支</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git cherry-pick [commit]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除分支</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git branch -d [branch-name]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除远程分支</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git push origin --delete [branch-name]</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git branch -dr [remote/branch]</span></span><br></pre></td></tr></table></figure><h2 id="标签"><a href="#标签" class="headerlink" title="标签"></a>标签</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 列出所有tag</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git tag</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 新建一个tag在当前commit</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git tag [tag]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 新建一个tag在指定commit</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git tag [tag] [commit]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除本地tag</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git tag -d [tag]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除远程tag</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git push origin :refs/tags/[tagName]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看tag信息</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git show [tag]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 提交指定tag</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git push [remote] [tag]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 提交所有tag</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git push [remote] --tags</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 新建一个分支，指向某个tag</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git checkout -b [branch] [tag]</span></span><br></pre></td></tr></table></figure><h2 id="查看信息"><a href="#查看信息" class="headerlink" title="查看信息"></a>查看信息</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 显示有变更的文件</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git status</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示当前分支的版本历史</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">log</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示commit历史，以及每次commit发生变更的文件</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">log</span> --<span class="built_in">stat</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 搜索提交历史，根据关键词</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">log</span> -S [keyword]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示某个commit之后的所有变动，每个commit占据一行</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">log</span> [tag] HEAD --pretty=format:%s</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示某个commit之后的所有变动，其<span class="string">"提交说明"</span>必须符合搜索条件</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">log</span> [tag] HEAD --grep feature</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示某个文件的版本历史，包括文件改名</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">log</span> --follow [file]</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git whatchanged [file]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示指定文件相关的每一次diff</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">log</span> -p [file]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示过去5次提交</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">log</span> -5 --pretty --oneline</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示所有提交过的用户，按提交次数排序</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git shortlog -sn</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示指定文件是什么人在什么时间修改过</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git blame [file]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示暂存区和工作区的差异</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git diff</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示暂存区和上一个commit的差异</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git diff --cached [file]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示工作区与当前分支最新commit之间的差异</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git diff HEAD</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示两次提交之间的差异</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git diff [first-branch]...[second-branch]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示今天你写了多少行代码</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git diff --shortstat <span class="string">"@&#123;0 day ago&#125;"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示某次提交的元数据和内容变化</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git show [commit]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示某次提交发生变化的文件</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git show --name-only [commit]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示某次提交时，某个文件的内容</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git show [commit]:[filename]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示当前分支的最近几次提交</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git reflog</span></span><br></pre></td></tr></table></figure><h2 id="远程同步"><a href="#远程同步" class="headerlink" title="远程同步"></a>远程同步</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 下载远程仓库的所有变动</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git fetch [remote]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示所有远程仓库</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git remote -v</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示某个远程仓库的信息</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git remote show [remote]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 增加一个新的远程仓库，并命名</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git remote add [shortname] [url]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 取回远程仓库的变化，并与本地分支合并</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git pull [remote] [branch]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 上传本地指定分支到远程仓库</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git push [remote] [branch]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 强行推送当前分支到远程仓库，即使有冲突</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git push [remote] --force</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 推送所有分支到远程仓库</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git push [remote] --all</span></span><br></pre></td></tr></table></figure><h2 id="撤销"><a href="#撤销" class="headerlink" title="撤销"></a>撤销</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 恢复暂存区的指定文件到工作区</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git checkout [file]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 恢复某个commit的指定文件到暂存区和工作区</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git checkout [commit] [file]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 恢复暂存区的所有文件到工作区</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git checkout .</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 重置暂存区的指定文件，与上一次commit保持一致，但工作区不变</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git reset [file]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 重置暂存区与工作区，与上一次commit保持一致</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git reset --hard</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 重置当前分支的指针为指定commit，同时重置暂存区，但工作区不变</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git reset [commit]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 重置当前分支的HEAD为指定commit，同时重置暂存区和工作区，与指定commit一致</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git reset --hard [commit]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 重置当前HEAD为指定commit，但保持暂存区和工作区不变</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git reset --keep [commit]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 新建一个commit，用来撤销指定commit</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 后者的所有变化都将被前者抵消，并且应用到当前分支</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git revert [commit]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 暂时将未提交的变化移除，稍后再移入</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git stash</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git stash pop</span></span><br></pre></td></tr></table></figure><h2 id="fork仓库合并原仓库"><a href="#fork仓库合并原仓库" class="headerlink" title="fork仓库合并原仓库"></a>fork仓库合并原仓库</h2><h3 id="merge-前的设定"><a href="#merge-前的设定" class="headerlink" title="merge 前的设定"></a>merge 前的设定</h3><ul><li><p>进入本地仓库目录</p></li><li><p>查看远程仓库的路径</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote -v</span><br></pre></td></tr></table></figure></li><li><p>将远程仓库设置成 fork 仓库的上游代码库</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote add upstream 远程仓库.git</span><br></pre></td></tr></table></figure></li><li><p>检查本地提交<br>执行命令 git status 检查本地是否有未提交的修改。如果有，则把你本地的有效修改，先从本地仓库推送到你的github仓库。最后再执行一次 git status 检查本地已无未提交的修改</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git add -A 或者 git add filename</span><br><span class="line">git commit -m "your note"</span><br><span class="line">git push origin master</span><br><span class="line">git status</span><br></pre></td></tr></table></figure></li></ul><h3 id="merge-的相关命令"><a href="#merge-的相关命令" class="headerlink" title="merge 的相关命令"></a>merge 的相关命令</h3><ul><li><p>抓取原仓库的更新</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git fetch upstream 远程仓库.git</span><br></pre></td></tr></table></figure></li><li><p>切换到 fork 仓库的 master 分支</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout master</span><br></pre></td></tr></table></figure></li><li><p>合并远程的 master 分支</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git merge upstream/master</span><br></pre></td></tr></table></figure></li><li><p>推送 fork 仓库的修改</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git push</span><br></pre></td></tr></table></figure></li></ul><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 生成一个可供发布的压缩包</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git archive</span></span><br></pre></td></tr></table></figure><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="http://www.ruanyifeng.com/blog/2015/12/git-cheat-sheet.html" target="_blank" rel="noopener">常用 Git 命令清单</a><br><a href="https://github.com/selfteaching/the-craft-of-selfteaching/issues/67" target="_blank" rel="noopener">Github进行fork后如何与原仓库同步：重新fork很省事，但不如反复练习版本合并</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Git 命令比较多，会经常 fork git 仓库，fork 仓库同步原远程仓库的操作，也会经常忘记，特此记录下。&lt;/p&gt;
    
    </summary>
    
      <category term="Tools" scheme="http://yoursite.com/categories/Tools/"/>
    
    
  </entry>
  
  <entry>
    <title>Flink源码剖析-flink-streaming-java_JobGraph</title>
    <link href="http://yoursite.com/2020/04/22/Flink%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90-flink-streaming-java_JobGraph/"/>
    <id>http://yoursite.com/2020/04/22/Flink源码剖析-flink-streaming-java_JobGraph/</id>
    <published>2020-04-22T14:29:49.000Z</published>
    <updated>2020-04-22T16:55:36.000Z</updated>
    
    <content type="html"><![CDATA[<p>本文主要围绕 Flink 源码中 <code>flink-streaming-java</code> 模块。介绍下 StreamGraph 转成 JobGraph 的过程等。</p><a id="more"></a><p>StreamGraph 和 JobGraph 都是在 Client 端生成的，也就是说我们可以在 IDE 中通过断点调试观察 StreamGraph 和 JobGraph 的生成过程。</p><h2 id="前置调用"><a href="#前置调用" class="headerlink" title="前置调用"></a>前置调用</h2><p>从 StreamExecutionEnvironment 中的 execute() 方法一直往下跟：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Streaming 程序的提交入口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> JobExecutionResult <span class="title">execute</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"><span class="keyword">return</span> execute(DEFAULT_JOB_NAME);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 生成 StreamGraph</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> JobExecutionResult <span class="title">execute</span><span class="params">(String jobName)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">Preconditions.checkNotNull(jobName, <span class="string">"Streaming Job name should not be null."</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> execute(getStreamGraph(jobName));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 生成 JobGraph ，提交任务，并响应 JobListeners</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Internal</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> JobExecutionResult <span class="title">execute</span><span class="params">(StreamGraph streamGraph)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"><span class="comment">// 异步执行</span></span><br><span class="line"><span class="keyword">final</span> JobClient jobClient = executeAsync(streamGraph);</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="keyword">final</span> JobExecutionResult jobExecutionResult;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (configuration.getBoolean(DeploymentOptions.ATTACHED)) &#123;</span><br><span class="line">jobExecutionResult = jobClient.getJobExecutionResult(userClassloader).get();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">jobExecutionResult = <span class="keyword">new</span> DetachedJobExecutionResult(jobClient.getJobID());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">jobListeners.forEach(jobListener -&gt; jobListener.onJobExecuted(jobExecutionResult, <span class="keyword">null</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> jobExecutionResult;</span><br><span class="line">&#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">jobListeners.forEach(jobListener -&gt; &#123;</span><br><span class="line">jobListener.onJobExecuted(<span class="keyword">null</span>, ExceptionUtils.stripExecutionException(t));</span><br><span class="line">&#125;);</span><br><span class="line">ExceptionUtils.rethrowException(t);</span><br><span class="line"></span><br><span class="line"><span class="comment">// never reached, only make javac happy</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>下面我们详细看看 StreamExecutionEnvironment 中的 executeAsync 方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据 execution.target 配置反射得到 PipelineExecutorFactory，拿出工厂类对应的 PipelineExecutor，执行其 execute 方法</span></span><br><span class="line"><span class="comment"> * execute的主要工作是将 StreamGraph 转成了 JobGraph，并创建相应的 ClusterClient 完成提交任务的操作。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Internal</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> JobClient <span class="title">executeAsync</span><span class="params">(StreamGraph streamGraph)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">checkNotNull(streamGraph, <span class="string">"StreamGraph cannot be null."</span>);</span><br><span class="line">checkNotNull(configuration.get(DeploymentOptions.TARGET), <span class="string">"No execution.target specified in your configuration file."</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// SPI机制</span></span><br><span class="line"><span class="comment">// 根据flink Configuration中的"execution.target"加载 PipelineExecutorFactory</span></span><br><span class="line"><span class="comment">// PipelineExecutorFactory 的实现类在flink-clients包或者flink-yarn包里，因此需要在pom.xml中添加此依赖</span></span><br><span class="line"><span class="keyword">final</span> PipelineExecutorFactory executorFactory =</span><br><span class="line">executorServiceLoader.getExecutorFactory(configuration);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 反射出的 PipelineExecutorFactory 类不能为空</span></span><br><span class="line">checkNotNull(</span><br><span class="line">executorFactory,</span><br><span class="line"><span class="string">"Cannot find compatible factory for specified execution.target (=%s)"</span>,</span><br><span class="line">configuration.get(DeploymentOptions.TARGET));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据加载到的 PipelineExecutorFactory 工厂类，获取其对应的 PipelineExecutor，</span></span><br><span class="line"><span class="comment">// 并执行 PipelineExecutor 的 execute() 方法，将 StreamGraph 转成 JobGraph</span></span><br><span class="line">CompletableFuture&lt;JobClient&gt; jobClientFuture = executorFactory</span><br><span class="line">.getExecutor(configuration)</span><br><span class="line">.execute(streamGraph, configuration);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 异步调用的返回结果</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">JobClient jobClient = jobClientFuture.get();</span><br><span class="line">jobListeners.forEach(jobListener -&gt; jobListener.onJobSubmitted(jobClient, <span class="keyword">null</span>));</span><br><span class="line"><span class="keyword">return</span> jobClient;</span><br><span class="line">&#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">jobListeners.forEach(jobListener -&gt; jobListener.onJobSubmitted(<span class="keyword">null</span>, t));</span><br><span class="line">ExceptionUtils.rethrow(t);</span><br><span class="line"></span><br><span class="line"><span class="comment">// make javac happy, this code path will not be reached</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>executeAsync 有涉及到 PipelineExecutorFactory 和 PipelineExecutor 。<br>PipelineExecutorFactory 是通过 SPI ServiceLoader 加载的，我们看下 <code>flink-clients</code> 模块的 <code>META-INF.services</code> 文件：<br><img src="flink-clients%E6%A8%A1%E5%9D%97%E7%9A%84META-INF%E6%96%87%E4%BB%B6.png" alt></p><p>PipelineExecutorFactory 的实现子类，分别对应着 Flink 的不同部署模式，local、standalone、yarn、kubernets 等：<br><img src="PipelineExecutorFactory%E5%AD%90%E7%B1%BB.png" alt></p><p>这里我们只看下 LocalExecutorFactory 的实现：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Internal</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LocalExecutorFactory</span> <span class="keyword">implements</span> <span class="title">PipelineExecutorFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * execution.target 配置项对应的值为 "local"</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isCompatibleWith</span><span class="params">(<span class="keyword">final</span> Configuration configuration)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> LocalExecutor.NAME.equalsIgnoreCase(configuration.get(DeploymentOptions.TARGET));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 直接 new 一个 LocalExecutor 返回</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> PipelineExecutor <span class="title">getExecutor</span><span class="params">(<span class="keyword">final</span> Configuration configuration)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> LocalExecutor();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>PipelineExecutor 的实现子类与 PipelineExecutorFactory 与工厂类一一对应，负责将 StreamGraph 转成 JobGraph，并生成 ClusterClient 执行任务的提交：<br><img src="PipelineExecutor%E5%AD%90%E7%B1%BB.png" alt></p><p>LocalExecutorFactory 对应的 LocalExecutor 实现如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Internal</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LocalExecutor</span> <span class="keyword">implements</span> <span class="title">PipelineExecutor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String NAME = <span class="string">"local"</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> CompletableFuture&lt;JobClient&gt; <span class="title">execute</span><span class="params">(Pipeline pipeline, Configuration configuration)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">checkNotNull(pipeline);</span><br><span class="line">checkNotNull(configuration);</span><br><span class="line"></span><br><span class="line"><span class="comment">// we only support attached execution with the local executor.</span></span><br><span class="line">checkState(configuration.getBoolean(DeploymentOptions.ATTACHED));</span><br><span class="line"></span><br><span class="line"><span class="comment">// StreamGraph 转成 JobGraph</span></span><br><span class="line"><span class="keyword">final</span> JobGraph jobGraph = getJobGraph(pipeline, configuration);</span><br><span class="line"></span><br><span class="line"><span class="comment">// local 模式，本地启动一个 Mini Cluster</span></span><br><span class="line"><span class="keyword">final</span> MiniCluster miniCluster = startMiniCluster(jobGraph, configuration);</span><br><span class="line"><span class="comment">// 创建 MiniClusterClient ，准备提交任务</span></span><br><span class="line"><span class="keyword">final</span> MiniClusterClient clusterClient = <span class="keyword">new</span> MiniClusterClient(configuration, miniCluster);</span><br><span class="line">        <span class="comment">// 提交任务</span></span><br><span class="line">CompletableFuture&lt;JobID&gt; jobIdFuture = clusterClient.submitJob(jobGraph);</span><br><span class="line"></span><br><span class="line">jobIdFuture</span><br><span class="line">.thenCompose(clusterClient::requestJobResult)</span><br><span class="line">.thenAccept((jobResult) -&gt; clusterClient.shutDownCluster());</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> jobIdFuture.thenApply(jobID -&gt;</span><br><span class="line"><span class="keyword">new</span> ClusterClientJobClientAdapter&lt;&gt;(() -&gt; clusterClient, jobID));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> JobGraph <span class="title">getJobGraph</span><span class="params">(Pipeline pipeline, Configuration configuration)</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这里调用 FlinkPipelineTranslationUtil 的 getJobGraph() 方法</span></span><br><span class="line"><span class="keyword">return</span> FlinkPipelineTranslationUtil.getJobGraph(pipeline, configuration, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>回归主题，我们看下 FlinkPipelineTranslationUtil 的 getJobGraph() 方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> JobGraph <span class="title">getJobGraph</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">Pipeline pipeline,</span></span></span><br><span class="line"><span class="function"><span class="params">Configuration optimizerConfiguration,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="keyword">int</span> defaultParallelism)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过反射得到 FlinkPipelineTranslator </span></span><br><span class="line">FlinkPipelineTranslator pipelineTranslator = getPipelineTranslator(pipeline);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> pipelineTranslator.translateToJobGraph(pipeline,</span><br><span class="line">optimizerConfiguration,</span><br><span class="line">defaultParallelism);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> FlinkPipelineTranslator <span class="title">getPipelineTranslator</span><span class="params">(Pipeline pipeline)</span> </span>&#123;</span><br><span class="line">PlanTranslator planToJobGraphTransmogrifier = <span class="keyword">new</span> PlanTranslator();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (planToJobGraphTransmogrifier.canTranslate(pipeline)) &#123;</span><br><span class="line"><span class="keyword">return</span> planToJobGraphTransmogrifier;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FlinkPipelineTranslator streamGraphTranslator = reflectStreamGraphTranslator();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 其实就是判断当前的 Pipeline 实例是不是 StreamGraph</span></span><br><span class="line"><span class="keyword">if</span> (!streamGraphTranslator.canTranslate(pipeline)) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Translator "</span> + streamGraphTranslator + <span class="string">" cannot translate "</span></span><br><span class="line">+ <span class="string">"the given pipeline "</span> + pipeline + <span class="string">"."</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> streamGraphTranslator;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> FlinkPipelineTranslator <span class="title">reflectStreamGraphTranslator</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">Class&lt;?&gt; streamGraphTranslatorClass;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">streamGraphTranslatorClass = Class.forName(</span><br><span class="line"><span class="comment">// 因为这个类在 flink-streaming-java 模块中，FlinkPipelineTranslationUtil 在 flink-clients 模块中，</span></span><br><span class="line">    <span class="comment">// flink-clients 模块没有引入 flink-streaming-java 模块，所以只能通过反射拿到</span></span><br><span class="line"><span class="string">"org.apache.flink.streaming.api.graph.StreamGraphTranslator"</span>,</span><br><span class="line"><span class="keyword">true</span>,</span><br><span class="line">FlinkPipelineTranslationUtil.class.getClassLoader());</span><br><span class="line">&#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Could not load StreamGraphTranslator."</span>, e);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FlinkPipelineTranslator streamGraphTranslator;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">streamGraphTranslator =</span><br><span class="line">(FlinkPipelineTranslator) streamGraphTranslatorClass.newInstance();</span><br><span class="line">&#125; <span class="keyword">catch</span> (InstantiationException | IllegalAccessException e) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Could not instantiate StreamGraphTranslator."</span>, e);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> streamGraphTranslator;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接着走到 StreamGraphTranslator 的 translateToJobGraph 方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StreamGraphTranslator</span> <span class="keyword">implements</span> <span class="title">FlinkPipelineTranslator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 其实就是调用 StreamGraph 自己的 getJobGraph 方法生成 JobGraph</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> JobGraph <span class="title">translateToJobGraph</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">Pipeline pipeline,</span></span></span><br><span class="line"><span class="function"><span class="params">Configuration optimizerConfiguration,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="keyword">int</span> defaultParallelism)</span> </span>&#123;</span><br><span class="line">checkArgument(pipeline <span class="keyword">instanceof</span> StreamGraph,</span><br><span class="line"><span class="string">"Given pipeline is not a DataStream StreamGraph."</span>);</span><br><span class="line"></span><br><span class="line">StreamGraph streamGraph = (StreamGraph) pipeline;</span><br><span class="line"><span class="keyword">return</span> streamGraph.getJobGraph(<span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">translateToJSONExecutionPlan</span><span class="params">(Pipeline pipeline)</span> </span>&#123;</span><br><span class="line">checkArgument(pipeline <span class="keyword">instanceof</span> StreamGraph,</span><br><span class="line"><span class="string">"Given pipeline is not a DataStream StreamGraph."</span>);</span><br><span class="line"></span><br><span class="line">StreamGraph streamGraph = (StreamGraph) pipeline;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> streamGraph.getStreamingPlanAsJSON();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">canTranslate</span><span class="params">(Pipeline pipeline)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> pipeline <span class="keyword">instanceof</span> StreamGraph;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="StreamGraph-到-JobGraph-的转换"><a href="#StreamGraph-到-JobGraph-的转换" class="headerlink" title="StreamGraph 到 JobGraph 的转换"></a>StreamGraph 到 JobGraph 的转换</h2><p>接着走到 StreamGraph 中的 getJobGraph() 方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> JobGraph <span class="title">getJobGraph</span><span class="params">(@Nullable JobID jobID)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> StreamingJobGraphGenerator.createJobGraph(<span class="keyword">this</span>, jobID);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接着走到 StreamingJobGraphGenerator 的 createJobGraph() 方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 传入 StreamGraph，生成 JobGraph</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> JobGraph <span class="title">createJobGraph</span><span class="params">(StreamGraph streamGraph)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> createJobGraph(streamGraph, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> JobGraph <span class="title">createJobGraph</span><span class="params">(StreamGraph streamGraph, @Nullable JobID jobID)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> StreamingJobGraphGenerator(streamGraph, jobID).createJobGraph();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 核心方法</span></span><br><span class="line"><span class="comment"> * StreamGraph 转 JobGraph 的整体流程</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> JobGraph <span class="title">createJobGraph</span><span class="params">()</span> </span>&#123;</span><br><span class="line">preValidate();</span><br><span class="line"></span><br><span class="line"><span class="comment">// make sure that all vertices start immediately</span></span><br><span class="line"><span class="comment">// 设置调度模式，streaming 模式下，调度模式是所有节点一起启动</span></span><br><span class="line">jobGraph.setScheduleMode(streamGraph.getScheduleMode());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. 广度优先遍历 StreamGraph 并且为每个 SteamNode 生成一个唯一确定的 hash id</span></span><br><span class="line"><span class="comment">// Generate deterministic hashes for the nodes in order to identify them across</span></span><br><span class="line"><span class="comment">// submission iff they didn't change.</span></span><br><span class="line"><span class="comment">// 保证如果提交的拓扑没有改变，则每次生成的 hash id 都是一样的，这里只要保证 source 的顺序是确定的，就可以保证最后生产的 hash id 不变</span></span><br><span class="line"><span class="comment">// 它是利用 input 节点的 hash 值及该节点在 map 中位置（实际上是 map.size 算的）来计算确定的</span></span><br><span class="line">Map&lt;Integer, <span class="keyword">byte</span>[]&gt; hashes = defaultStreamGraphHasher.traverseStreamGraphAndGenerateHashes(streamGraph);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Generate legacy version hashes for backwards compatibility</span></span><br><span class="line"><span class="comment">// 这个设置主要是为了防止 hash 机制变化时出现不兼容的情况</span></span><br><span class="line">List&lt;Map&lt;Integer, <span class="keyword">byte</span>[]&gt;&gt; legacyHashes = <span class="keyword">new</span> ArrayList&lt;&gt;(legacyStreamGraphHashers.size());</span><br><span class="line"><span class="keyword">for</span> (StreamGraphHasher hasher : legacyStreamGraphHashers) &#123;</span><br><span class="line">legacyHashes.add(hasher.traverseStreamGraphAndGenerateHashes(streamGraph));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Map&lt;Integer, List&lt;Tuple2&lt;<span class="keyword">byte</span>[], <span class="keyword">byte</span>[]&gt;&gt;&gt; chainedOperatorHashes = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 最重要的函数，生成 JobVertex/JobEdge/IntermediateDataSet 等，并尽可能地将多个 StreamNode 节点 chain 在一起</span></span><br><span class="line">setChaining(hashes, legacyHashes, chainedOperatorHashes);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 将每个 JobVertex 的入边集合也序列化到该 JobVertex 的 StreamConfig 中 (出边集合已经在 setChaining 的时候写入了)</span></span><br><span class="line">setPhysicalEdges();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. 根据 group name，为每个 JobVertex 指定所属的 SlotSharingGroup 以及设置 CoLocationGroup</span></span><br><span class="line">setSlotSharingAndCoLocation();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. 其他设置</span></span><br><span class="line"><span class="comment">// 设置 ManagedMemory 因子</span></span><br><span class="line">setManagedMemoryFraction(</span><br><span class="line">Collections.unmodifiableMap(jobVertices),</span><br><span class="line">Collections.unmodifiableMap(vertexConfigs),</span><br><span class="line">Collections.unmodifiableMap(chainedConfigs),</span><br><span class="line">id -&gt; streamGraph.getStreamNode(id).getMinResources(),</span><br><span class="line">id -&gt; streamGraph.getStreamNode(id).getManagedMemoryWeight());</span><br><span class="line"></span><br><span class="line"><span class="comment">// checkpoint相关的配置</span></span><br><span class="line">configureCheckpointing();</span><br><span class="line"></span><br><span class="line"><span class="comment">// savepoint相关的配置</span></span><br><span class="line">jobGraph.setSavepointRestoreSettings(streamGraph.getSavepointRestoreSettings());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用户的第三方依赖包就是在这里（cacheFile）传给 JobGraph</span></span><br><span class="line">JobGraphGenerator.addUserArtifactEntries(streamGraph.getUserArtifacts(), jobGraph);</span><br><span class="line"></span><br><span class="line"><span class="comment">// set the ExecutionConfig last when it has been finalized</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">// 将 StreamGraph 的 ExecutionConfig 序列化到 JobGraph 的配置中</span></span><br><span class="line">jobGraph.setExecutionConfig(streamGraph.getExecutionConfig());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalConfigurationException(<span class="string">"Could not serialize the ExecutionConfig."</span> +</span><br><span class="line"><span class="string">"This indicates that non-serializable types (like custom serializers) were registered"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> jobGraph;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;本文主要围绕 Flink 源码中 &lt;code&gt;flink-streaming-java&lt;/code&gt; 模块。介绍下 StreamGraph 转成 JobGraph 的过程等。&lt;/p&gt;
    
    </summary>
    
      <category term="Flink" scheme="http://yoursite.com/categories/Flink/"/>
    
    
  </entry>
  
  <entry>
    <title>Flink源码剖析-flink-streaming-java_StreamGraph</title>
    <link href="http://yoursite.com/2020/04/22/Flink%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90-flink-streaming-java_StreamGraph/"/>
    <id>http://yoursite.com/2020/04/22/Flink源码剖析-flink-streaming-java_StreamGraph/</id>
    <published>2020-04-21T16:06:00.000Z</published>
    <updated>2020-04-22T16:55:36.000Z</updated>
    
    <content type="html"><![CDATA[<p>本文主要围绕 Flink 源码中 <code>flink-streaming-java</code> 模块。介绍如何使用 DataStream API 进行 Flink 流任务开发，<code>flink-streaming-java</code> 模块中的一些重要类，贯穿着介绍下从 DataStream<br>API 到 StreamGraph 的构建过程。</p><a id="more"></a><h2 id="DataStream-API使用一览"><a href="#DataStream-API使用一览" class="headerlink" title="DataStream API使用一览"></a>DataStream API使用一览</h2><p>使用 DataStream API 通常有以下步骤：</p><ol><li>如何创建 Environment(Local、Remote) 并设置属性</li></ol><ul><li>setParallelism(int)：StreamExecutionEnvironment</li><li>setMaxParallelism(int)：StreamExecutionEnvironment</li><li>setBufferTimeout(long)：StreamExecutionEnvironment</li><li>enableCheckpointing(long,CheckpointingMode)：StreamExecutionEnvironment</li><li>setStateBackend(StateBackend)：StreamExecutionEnvironment</li><li>setStreamTimeCharacteristic(TimeCharacteristic)：void</li></ul><ol start="2"><li>如何读取数据？添加 Source 数据源获得 DataStream</li></ol><ul><li>fromElements(OUT …): DataStreamSource<out>   …</out></li><li>readTextFile(String): DataStreamSource<string>  …</string></li><li>readFile(FileInputFormat<out>,String): DataStreamSource<out> …</out></out></li><li>socketTextStream(String ,int ,String ,long): DataStreamSource<string>  …</string></li><li>createInput(InputFormat&lt;OUT,?&gt;,TypeInformation<out>): DataStreamSource<out> …</out></out></li><li>addSource(SourceFunction<out>,TypeInformation<out>): DataStreamSource<out> …</out></out></out></li></ul><ol start="3"><li>如何操作转换数据？</li></ol><p><img src="DataStream_API%E6%93%8D%E4%BD%9C%E6%A6%82%E8%A7%88.png" alt></p><ul><li>Basic Transformations<br>map、filter、flatMap</li><li>KeyedStream Transformations<br>keyBy、aggregations、reduce</li><li>MultiStream Transformations<br>union、connect、coMap、coFlatMap、split、select</li></ul><p><img src="DataStream%E5%9F%BA%E6%9C%AC%E8%BD%AC%E6%8D%A2.png" alt></p><ul><li>Distribution Transformations<br>物理分组：</li></ul><table><thead><tr><th>关系</th><th>表示</th><th>图示</th></tr></thead><tbody><tr><td>global</td><td>全部发往第1个task</td><td><img src="%E7%89%A9%E7%90%86%E5%88%86%E7%BB%84_global.png" alt></td></tr><tr><td>broadcast</td><td>广播，复制上游的数据发送到所有下游节点</td><td><img src="%E7%89%A9%E7%90%86%E5%88%86%E7%BB%84_broadcast.png" alt></td></tr><tr><td>forward</td><td>上下游并发度一样时一对一发送</td><td><img src="%E7%89%A9%E7%90%86%E5%88%86%E7%BB%84_forward.png" alt></td></tr><tr><td>shuffle</td><td>随机均匀分配</td><td><img src="%E7%89%A9%E7%90%86%E5%88%86%E7%BB%84_shuffle.png" alt></td></tr><tr><td>reblance</td><td>Round-Robin（轮流分配）</td><td><img src="%E7%89%A9%E7%90%86%E5%88%86%E7%BB%84_reblance.png" alt></td></tr><tr><td>rescale</td><td>Local Round-Robin (本地轮流分配)，<br>只会看到本机的实例</td><td><img src="%E7%89%A9%E7%90%86%E5%88%86%E7%BB%84_rescale.png" alt></td></tr><tr><td>partitionCustom</td><td>自定义单播</td><td></td></tr></tbody></table><ol start="4"><li>如何输出数据？添加 Sink</li></ol><ul><li>writeAsText(String path): DataStreamSink<t> …</t></li><li>writeAsCsv(String path): DataStreamSink<t> …</t></li><li>addSink(SinkFunction<t> sinkFunction): DataStreamSink<t></t></t></li></ul><ol start="5"><li>如何提交执行？<br>DataStream 通过不同的算子不停地在 DataStream 上实现转换过滤等逻辑，最终将结果输出到 DataSink 中。<br>在 StreamExecutionEnvironment 内部使用一个 <code>List&lt;StreamTransformation&lt;?&gt;&gt; transformations</code> 来保留生成 DataStream 的所有转换。</li></ol><ul><li>execute()：JobExecutionResult</li></ul><p>我们看下基于 Flink DataStream API 的自带 WordCount 示例：实时统计单词数量，每来一个计算一次并输出一次。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WordCount</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// *************************************************************************</span></span><br><span class="line"><span class="comment">// PROGRAM</span></span><br><span class="line"><span class="comment">// *************************************************************************</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> ParameterTool params = ParameterTool.fromArgs(args);</span><br><span class="line"><span class="comment">// 1. 设置运行环境</span></span><br><span class="line"><span class="keyword">final</span> StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">env.getConfig().setGlobalJobParameters(params);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 配置数据源读取数据</span></span><br><span class="line">DataStream&lt;String&gt; text;</span><br><span class="line"><span class="keyword">if</span> (params.has(<span class="string">"input"</span>)) &#123;</span><br><span class="line"><span class="comment">// read the text file from given input path</span></span><br><span class="line">text = env.readTextFile(params.get(<span class="string">"input"</span>));</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// get default test text data</span></span><br><span class="line">text = env.fromElements(<span class="keyword">new</span> String[] &#123;</span><br><span class="line"><span class="string">"miao,She is a programmer"</span>,</span><br><span class="line"><span class="string">"wu,He is a programmer"</span>,</span><br><span class="line"><span class="string">"zhao,She is a programmer"</span></span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 进行一系列转换</span></span><br><span class="line">DataStream&lt;Tuple2&lt;String, Integer&gt;&gt; counts =</span><br><span class="line"><span class="comment">// split up the lines in pairs (2-tuples) containing: (word,1)</span></span><br><span class="line">text.flatMap(<span class="keyword">new</span> Tokenizer())</span><br><span class="line"><span class="comment">// group by the tuple field "0" and sum up tuple field "1"</span></span><br><span class="line">.keyBy(<span class="number">0</span>).sum(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. 配置数据汇写出数据</span></span><br><span class="line"><span class="keyword">if</span> (params.has(<span class="string">"output"</span>)) &#123;</span><br><span class="line">counts.writeAsText(params.get(<span class="string">"output"</span>));</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">System.out.println(<span class="string">"Printing result to stdout. Use --output to specify output path."</span>);</span><br><span class="line">counts.print();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. 提交执行</span></span><br><span class="line">env.execute(<span class="string">"Streaming WordCount"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// *************************************************************************</span></span><br><span class="line"><span class="comment">// USER FUNCTIONS</span></span><br><span class="line"><span class="comment">// *************************************************************************</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Tokenizer</span> <span class="keyword">implements</span> <span class="title">FlatMapFunction</span>&lt;<span class="title">String</span>, <span class="title">Tuple2</span>&lt;<span class="title">String</span>, <span class="title">Integer</span>&gt;&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">flatMap</span><span class="params">(String value, Collector&lt;Tuple2&lt;String, Integer&gt;&gt; out)</span> </span>&#123;</span><br><span class="line"><span class="comment">// normalize and split the line</span></span><br><span class="line">String[] tokens = value.toLowerCase().split(<span class="string">"\\W+"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// emit the pairs</span></span><br><span class="line"><span class="keyword">for</span> (String token : tokens) &#123;</span><br><span class="line"><span class="keyword">if</span> (token.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">out.collect(<span class="keyword">new</span> Tuple2&lt;&gt;(token, <span class="number">1</span>));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="源码剖析"><a href="#源码剖析" class="headerlink" title="源码剖析"></a>源码剖析</h2><h3 id="StreamExecutionEnvironment"><a href="#StreamExecutionEnvironment" class="headerlink" title="StreamExecutionEnvironment"></a>StreamExecutionEnvironment</h3><p>StreamExecutionEnvironment 是 Flink 流处理任务执行的上下文，是我们编写 Flink 程序的入口。根据执行环境的不同，选择不同的 StreamExecutionEnvironment 类，<br>有 LocalStreamEnvironment、RemoteStreamEnvironment 等。如下图：<br><img src="StreamExecutionEnvironment%E5%AD%90%E7%B1%BB.png" alt></p><p>StreamExecutionEnvironment 依赖 ExecutionConfig 类来设置并行度等，依赖 CheckpointConfig 设置 Checkpointing 等相关属性。<br><img src="StreamExecutionEnvironment%E7%B1%BB%E5%9B%BE.png" alt></p><p>这里再补充说明下 StreamExecutionEnvironment类中的重要属性和方法：<br><img src="StreamExecutionEnvironment%E7%B1%BB%E4%B8%AD%E7%9A%84%E9%87%8D%E8%A6%81%E5%B1%9E%E6%80%A7%E5%92%8C%E6%96%B9%E6%B3%95.png" alt></p><h3 id="Transformation"><a href="#Transformation" class="headerlink" title="Transformation"></a>Transformation</h3><p>Transformation 代表了从一个或多个 DataStream 生成新 DataStream 的操作。在 DataStream 上通过 map 等算子不断进行转换，就得到了由 Transformation<br>构成的图。当需要执行的时候，底层的这个图就会被转换成 StreamGraph 。</p><p>Transformation 有很多子类，如 SourceTransformation、OneInputTransformation、TwoInputTransformation、SideOutputTransformation 等，分别对应了 DataStream 上的不同转换操作。</p><p><img src="Transformation%E5%AD%90%E7%B1%BB.png" alt></p><p>每一个 Transformation 都有一个关联 id，这个 id 是全局递增的，还有 uid、slotSharingGroup、parallelism 等信息。</p><p><img src="Transformation%E7%B1%BB%E4%B8%AD%E7%9A%84%E9%87%8D%E8%A6%81%E5%B1%9E%E6%80%A7.png" alt></p><p>查看 Transformation 的其中两个子类 OneInputTransformation、TwoInputTransformation 的实现，都对应有输入 Transformation，也正是基于此才能还原出 DAG 的拓扑结构。</p><p>Transformation 在运行时并不对应着一个物理转换操作，有一些操作只是逻辑层面上的，比如 split/select/partitioning 等。<br>Transformations 组成的 graph ，也就是我们写代码时的图结构如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"> Source              Source</span><br><span class="line">    +                   +</span><br><span class="line">    |                   |</span><br><span class="line">    v                   v</span><br><span class="line">Rebalance          HashPartition</span><br><span class="line">    +                   +</span><br><span class="line">    |                   |</span><br><span class="line">    |                   |</span><br><span class="line">    +------&gt;Union&lt;------+</span><br><span class="line">              +</span><br><span class="line">              |</span><br><span class="line">              v</span><br><span class="line">            Split</span><br><span class="line">              +</span><br><span class="line">              |</span><br><span class="line">              v</span><br><span class="line">            Select</span><br><span class="line">              +</span><br><span class="line">              v</span><br><span class="line">             Map</span><br><span class="line">              +</span><br><span class="line">              |</span><br><span class="line">              v</span><br><span class="line">            Sink</span><br></pre></td></tr></table></figure><p>但是，在运行时将生成如下操作图，split/select/partitioning 等转换操作会被编码到边中，这个边连接 sources 和 map 操作：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Source              Source</span><br><span class="line">   +                   +</span><br><span class="line">   |                   |</span><br><span class="line">   |                   |</span><br><span class="line">   +-------&gt;Map&lt;-------+</span><br><span class="line">             +</span><br><span class="line">             |</span><br><span class="line">             v</span><br><span class="line">            Sink</span><br></pre></td></tr></table></figure><h3 id="DataStream"><a href="#DataStream" class="headerlink" title="DataStream"></a>DataStream</h3><p>一个 DataStream 就代表了同一种类型元素构成的数据流。通过对 DataStream 应用 map/filter 等操作，就可以将一个 DataStream 转换成另一个 DataStream 。<br>这个转换的过程就是根据不同的操作生成不同的 Transformation ，并将其加入到 StreamExecutionEnvironment 的 transformations 列表中。</p><p>DataStream 的子类包括 DataStreamSource、KeyedStream、IterativeStream、SingleOutputStreamOperator。</p><p><img src="DataStream%E5%AD%90%E7%B1%BB.png" alt></p><p>除了 DataStream 及其子类以外，其它的表征数据流的类还有 ConnectedStreams、WindowedStream、AllWindowedStream，这些会在后续的文章中陆续介绍。</p><p>DataStream 类中的重要属性和方法：</p><p><img src="DataStream%E7%B1%BB%E4%B8%AD%E7%9A%84%E9%87%8D%E8%A6%81%E5%B1%9E%E6%80%A7%E5%92%8C%E6%96%B9%E6%B3%95.png" alt></p><p>下面我们看下 map 操作是如何被添加进来的：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;R&gt; <span class="function">SingleOutputStreamOperator&lt;R&gt; <span class="title">map</span><span class="params">(MapFunction&lt;T, R&gt; mapper, TypeInformation&lt;R&gt; outputType)</span> </span>&#123;</span><br><span class="line"><span class="comment">// 将 MapFunction 封装成 StreamMap 这个 StreamOperator</span></span><br><span class="line"><span class="keyword">return</span> transform(<span class="string">"Map"</span>, outputType, <span class="keyword">new</span> StreamMap&lt;&gt;(clean(mapper)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PublicEvolving</span></span><br><span class="line"><span class="keyword">public</span> &lt;R&gt; <span class="function">SingleOutputStreamOperator&lt;R&gt; <span class="title">transform</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">String operatorName,</span></span></span><br><span class="line"><span class="function"><span class="params">TypeInformation&lt;R&gt; outTypeInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">OneInputStreamOperator&lt;T, R&gt; operator)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> doTransform(operatorName, outTypeInfo, SimpleOperatorFactory.of(operator));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接着我们看下其中一个比较重要的方法 doTransform ：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> &lt;R&gt; <span class="function">SingleOutputStreamOperator&lt;R&gt; <span class="title">doTransform</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">String operatorName,</span></span></span><br><span class="line"><span class="function"><span class="params">TypeInformation&lt;R&gt; outTypeInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">StreamOperatorFactory&lt;R&gt; operatorFactory)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// read the output type of the input Transform to coax out errors about MissingTypeInfo</span></span><br><span class="line">transformation.getOutputType();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 构造 Transformation</span></span><br><span class="line">OneInputTransformation&lt;T, R&gt; resultTransform = <span class="keyword">new</span> OneInputTransformation&lt;&gt;(</span><br><span class="line"><span class="keyword">this</span>.transformation,</span><br><span class="line">operatorName,</span><br><span class="line">operatorFactory,</span><br><span class="line">outTypeInfo,</span><br><span class="line">environment.getParallelism());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将 Transformation 封装进 SingleOutputStreamOperator 返回</span></span><br><span class="line"><span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"unchecked"</span>, <span class="string">"rawtypes"</span>&#125;)</span><br><span class="line">SingleOutputStreamOperator&lt;R&gt; returnStream = <span class="keyword">new</span> SingleOutputStreamOperator(environment, resultTransform);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加到 StreamExecutionEnvironment 的 transformations 列表中</span></span><br><span class="line">getExecutionEnvironment().addOperator(resultTransform);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> returnStream;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="StreamOperator"><a href="#StreamOperator" class="headerlink" title="StreamOperator"></a>StreamOperator</h3><p>在操作 DataStream 的时候，比如 <code>DataStream.map(MapFunction&lt;T, R&gt; mapper)</code> 时，都会传入一个自定义的 Function 。那么这些信息是如何保存在 Transformation 中的呢？<br>这里就引入了一个新的接口 StreamOpertor ，DataStream 上的每一个 Transformation 都对应了一个 StreamOperator，StreamOperator 是运行时的具体实现，会决定 UDF 的调用方式。</p><p>StreamOperator 的类继承关系如下：</p><p><img src="StreamOperator%E5%AD%90%E7%B1%BB.png" alt></p><p>接口 StreamOpertor 定义了对一个具体的算子的生命周期的管理。StreamOperator 的两个子接口 OneInputStreamOperator 和 TwoInputStreamOperator 提供了数据流中具体元素的操作方法，而 AbstractUdfStreamOperator 抽象子类则提供了自定义处理函数对应的算子的基本实现：</p><p><img src="StreamOperator%E7%B1%BB%E4%B8%AD%E7%9A%84%E9%87%8D%E8%A6%81%E5%B1%9E%E6%80%A7%E5%92%8C%E6%96%B9%E6%B3%95.png" alt></p><p>下面我们还是拿 map 举例，map 操作对应的 StreamOperator 为 StreamMap ，继承了 AbstractUdfStreamOperator 类，实现了 OneInputStreamOperator 接口：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Internal</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StreamMap</span>&lt;<span class="title">IN</span>, <span class="title">OUT</span>&gt;</span></span><br><span class="line"><span class="class"><span class="keyword">extends</span> <span class="title">AbstractUdfStreamOperator</span>&lt;<span class="title">OUT</span>, <span class="title">MapFunction</span>&lt;<span class="title">IN</span>, <span class="title">OUT</span>&gt;&gt;</span></span><br><span class="line"><span class="class"><span class="keyword">implements</span> <span class="title">OneInputStreamOperator</span>&lt;<span class="title">IN</span>, <span class="title">OUT</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">StreamMap</span><span class="params">(MapFunction&lt;IN, OUT&gt; mapper)</span> </span>&#123;</span><br><span class="line"><span class="keyword">super</span>(mapper);</span><br><span class="line">chainingStrategy = ChainingStrategy.ALWAYS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processElement</span><span class="params">(StreamRecord&lt;IN&gt; element)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">output.collect(element.replace(userFunction.map(element.getValue())));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>以上，我们可以知道通过 DataStream -&gt; Function -&gt; StreamOperator -&gt; StreamTransformation 这种依赖关系，就可以完成 DataStream 的转换，并且可以保存数据流和应用在流上<br>的算子之间的关系。</p><h3 id="Function"><a href="#Function" class="headerlink" title="Function"></a>Function</h3><p><img src="Function%E5%AD%90%E7%B1%BB.png" alt></p><h3 id="StreamGraph"><a href="#StreamGraph" class="headerlink" title="StreamGraph"></a>StreamGraph</h3><p>StreamGraph 是在 Client 端构造的。<br>了解 StreamGraph 之前我们首先要知道 StreamGraphGenerator 这个类，它会基于 StreamExecutionEnvironment 的 transformations 列表来生成 StreamGraph。</p><p>首先看下 StreamGraphGenerator 的 generate() 方法，这个方法会由触发程序执行的方法 StreamExecutionEnvironment.execute() 调用到：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> StreamGraph <span class="title">generate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">streamGraph = <span class="keyword">new</span> StreamGraph(executionConfig, checkpointConfig, savepointRestoreSettings);</span><br><span class="line">streamGraph.setStateBackend(stateBackend);</span><br><span class="line">streamGraph.setChaining(chaining);</span><br><span class="line">streamGraph.setScheduleMode(scheduleMode);</span><br><span class="line">streamGraph.setUserArtifacts(userArtifacts);</span><br><span class="line">streamGraph.setTimeCharacteristic(timeCharacteristic);</span><br><span class="line">streamGraph.setJobName(jobName);</span><br><span class="line">streamGraph.setBlockingConnectionsBetweenChains(blockingConnectionsBetweenChains);</span><br><span class="line"></span><br><span class="line">alreadyTransformed = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 遍历 transformations 列表，递归调用 transform 方法。</span></span><br><span class="line"><span class="comment"> * 对于每一个 Transformation ，确保当前上游已经完成转换，转换成 StreamGraph 中的 StreamNode，并为上下游节点添加 StreamEdge</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">for</span> (Transformation&lt;?&gt; transformation: transformations) &#123;</span><br><span class="line">transform(transformation);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> StreamGraph builtStreamGraph = streamGraph;</span><br><span class="line"></span><br><span class="line">alreadyTransformed.clear();</span><br><span class="line">alreadyTransformed = <span class="keyword">null</span>;</span><br><span class="line">streamGraph = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> builtStreamGraph;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在遍历 List<transformation> 生成 StreamGraph 时，会递归调用其 transform 方法。对于每一个 Transformation ，确保当前其上游已经完成转换。最终，部分 Transformation 节点被<br>转换为 StreamGraph 中的 StreamNode 节点，并会为上下游节点添加边 StreamEdge。下面看下 transform() 方法：</transformation></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Collection&lt;Integer&gt; <span class="title">transform</span><span class="params">(Transformation&lt;?&gt; transform)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (alreadyTransformed.containsKey(transform)) &#123;</span><br><span class="line"><span class="keyword">return</span> alreadyTransformed.get(transform);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对于不同类型的 Transformation，分别调用对应的转换方法</span></span><br><span class="line"><span class="comment">// 只有 OneInputTransformation、TwoInputTransformation、SourceTransformation、SinkTransformation 会生成 StreamNode，</span></span><br><span class="line"><span class="comment">// 会生成 StreamNode.</span></span><br><span class="line"><span class="comment">// 像 Partitioning, split/select, union 这些是不包含物理转换操作的，会生成一个带有特定属性的虚拟节点，</span></span><br><span class="line"><span class="comment">// 当添加一条有虚拟节点指向下游节点的边时，会找到虚拟节点上游的物理节点，在两个物理节点之间添加边，并把虚拟转换操作的属性附着上去。</span></span><br><span class="line">Collection&lt;Integer&gt; transformedIds;</span><br><span class="line"><span class="keyword">if</span> (transform <span class="keyword">instanceof</span> OneInputTransformation&lt;?, ?&gt;) &#123;</span><br><span class="line">transformedIds = transformOneInputTransform((OneInputTransformation&lt;?, ?&gt;) transform);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (transform <span class="keyword">instanceof</span> TwoInputTransformation&lt;?, ?, ?&gt;) &#123;</span><br><span class="line">transformedIds = transformTwoInputTransform((TwoInputTransformation&lt;?, ?, ?&gt;) transform);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (transform <span class="keyword">instanceof</span> SourceTransformation&lt;?&gt;) &#123;</span><br><span class="line">transformedIds = transformSource((SourceTransformation&lt;?&gt;) transform);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (transform <span class="keyword">instanceof</span> SinkTransformation&lt;?&gt;) &#123;</span><br><span class="line">transformedIds = transformSink((SinkTransformation&lt;?&gt;) transform);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (transform <span class="keyword">instanceof</span> UnionTransformation&lt;?&gt;) &#123;</span><br><span class="line">transformedIds = transformUnion((UnionTransformation&lt;?&gt;) transform);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (transform <span class="keyword">instanceof</span> SplitTransformation&lt;?&gt;) &#123;</span><br><span class="line">transformedIds = transformSplit((SplitTransformation&lt;?&gt;) transform);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (transform <span class="keyword">instanceof</span> SelectTransformation&lt;?&gt;) &#123;</span><br><span class="line">transformedIds = transformSelect((SelectTransformation&lt;?&gt;) transform);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (transform <span class="keyword">instanceof</span> FeedbackTransformation&lt;?&gt;) &#123;</span><br><span class="line">transformedIds = transformFeedback((FeedbackTransformation&lt;?&gt;) transform);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (transform <span class="keyword">instanceof</span> CoFeedbackTransformation&lt;?&gt;) &#123;</span><br><span class="line">transformedIds = transformCoFeedback((CoFeedbackTransformation&lt;?&gt;) transform);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (transform <span class="keyword">instanceof</span> PartitionTransformation&lt;?&gt;) &#123;</span><br><span class="line">transformedIds = transformPartition((PartitionTransformation&lt;?&gt;) transform);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (transform <span class="keyword">instanceof</span> SideOutputTransformation&lt;?&gt;) &#123;</span><br><span class="line">transformedIds = transformSideOutput((SideOutputTransformation&lt;?&gt;) transform);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unknown transformation: "</span> + transform);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> transformedIds;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对于另外一部分 Transformation ，如 partitioning, split/select, union，并不包含真正的物理转换操作，是不会生成 StreamNode 的，而是生成一个带有特定属性的虚拟节点。<br>当添加一条有虚拟节点指向下游节点的边时，会找到虚拟节点上游的物理节点，在两个物理节点之间添加边，并把虚拟转换操作的属性附着上去。下面我们首先看下 transformOneInputTransform() 方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> &lt;IN, OUT&gt; <span class="function">Collection&lt;Integer&gt; <span class="title">transformOneInputTransform</span><span class="params">(OneInputTransformation&lt;IN, OUT&gt; transform)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 首先确保上游节点完成转换</span></span><br><span class="line">Collection&lt;Integer&gt; inputIds = transform(transform.getInput());</span><br><span class="line"></span><br><span class="line"><span class="comment">// the recursive call might have already transformed this</span></span><br><span class="line"><span class="comment">// 由于是递归调用的，可能已经完成了转换</span></span><br><span class="line"><span class="keyword">if</span> (alreadyTransformed.containsKey(transform)) &#123;</span><br><span class="line"><span class="keyword">return</span> alreadyTransformed.get(transform);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 确定共享资源组，如果用户没有指定，默认是 default</span></span><br><span class="line">String slotSharingGroup = determineSlotSharingGroup(transform.getSlotSharingGroup(), inputIds);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 向 StreamGraph 中添加 Operator，这一步会生成对应的 StreamNode</span></span><br><span class="line">streamGraph.addOperator(transform.getId(),</span><br><span class="line">slotSharingGroup,</span><br><span class="line">transform.getCoLocationGroupKey(),</span><br><span class="line">transform.getOperatorFactory(),</span><br><span class="line">transform.getInputType(),</span><br><span class="line">transform.getOutputType(),</span><br><span class="line">transform.getName());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置 stateKey</span></span><br><span class="line"><span class="keyword">if</span> (transform.getStateKeySelector() != <span class="keyword">null</span>) &#123;</span><br><span class="line">TypeSerializer&lt;?&gt; keySerializer = transform.getStateKeyType().createSerializer(executionConfig);</span><br><span class="line">streamGraph.setOneInputStateKey(transform.getId(), transform.getStateKeySelector(), keySerializer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置 parallelism</span></span><br><span class="line"><span class="keyword">int</span> parallelism = transform.getParallelism() != ExecutionConfig.PARALLELISM_DEFAULT ?</span><br><span class="line">transform.getParallelism() : executionConfig.getParallelism();</span><br><span class="line">streamGraph.setParallelism(transform.getId(), parallelism);</span><br><span class="line">streamGraph.setMaxParallelism(transform.getId(), transform.getMaxParallelism());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在每一个物理节点的转换上</span></span><br><span class="line"><span class="comment">// 依次连接到上游 input 节点，创建 StreamEdge，在输入节点和当前节点之间建立边的连接</span></span><br><span class="line"><span class="keyword">for</span> (Integer inputId: inputIds) &#123;</span><br><span class="line">streamGraph.addEdge(inputId, transform.getId(), <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> Collections.singleton(transform.getId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接着看下 StreamGraph 中对应的添加节点的方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;IN, OUT&gt; <span class="function"><span class="keyword">void</span> <span class="title">addOperator</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">Integer vertexID,</span></span></span><br><span class="line"><span class="function"><span class="params">@Nullable String slotSharingGroup,</span></span></span><br><span class="line"><span class="function"><span class="params">@Nullable String coLocationGroup,</span></span></span><br><span class="line"><span class="function"><span class="params">StreamOperatorFactory&lt;OUT&gt; operatorFactory,</span></span></span><br><span class="line"><span class="function"><span class="params">TypeInformation&lt;IN&gt; inTypeInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">TypeInformation&lt;OUT&gt; outTypeInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">String operatorName)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (operatorFactory.isStreamSource()) &#123;</span><br><span class="line"><span class="comment">// 从传入的 StreamOperatorFactory 得知当前 operator 代表的是 source 流。SourceStreamTask</span></span><br><span class="line">addNode(vertexID, slotSharingGroup, coLocationGroup, SourceStreamTask.class, operatorFactory, operatorName);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// 上游节点输入流，OneInputStreamTask</span></span><br><span class="line">addNode(vertexID, slotSharingGroup, coLocationGroup, OneInputStreamTask.class, operatorFactory, operatorName);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> StreamNode <span class="title">addNode</span><span class="params">(Integer vertexID,</span></span></span><br><span class="line"><span class="function"><span class="params">@Nullable String slotSharingGroup,</span></span></span><br><span class="line"><span class="function"><span class="params">    @Nullable String coLocationGroup,</span></span></span><br><span class="line"><span class="function"><span class="params">// 表示该节点在 TM 中运行时的实际任务类型</span></span></span><br><span class="line"><span class="function"><span class="params">Class&lt;? extends AbstractInvokable&gt; vertexClass,</span></span></span><br><span class="line"><span class="function"><span class="params">StreamOperatorFactory&lt;?&gt; operatorFactory,</span></span></span><br><span class="line"><span class="function"><span class="params">String operatorName)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (streamNodes.containsKey(vertexID)) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Duplicate vertexID "</span> + vertexID);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 构造 StreamNode</span></span><br><span class="line">StreamNode vertex = <span class="keyword">new</span> StreamNode(</span><br><span class="line">vertexID,</span><br><span class="line">slotSharingGroup,</span><br><span class="line">coLocationGroup,</span><br><span class="line">operatorFactory,</span><br><span class="line">operatorName,</span><br><span class="line"><span class="keyword">new</span> ArrayList&lt;OutputSelector&lt;?&gt;&gt;(),</span><br><span class="line">vertexClass);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 保存在 streamNodes 这个 map 中</span></span><br><span class="line">streamNodes.put(vertexID, vertex);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> vertex;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>下面我们再看下 transformPartition() 非物理节点的转换方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> &lt;T&gt; <span class="function">Collection&lt;Integer&gt; <span class="title">transformPartition</span><span class="params">(PartitionTransformation&lt;T&gt; partition)</span> </span>&#123;</span><br><span class="line">Transformation&lt;T&gt; input = partition.getInput();</span><br><span class="line">List&lt;Integer&gt; resultIds = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 递归遍历转换上游节点</span></span><br><span class="line">Collection&lt;Integer&gt; transformedIds = transform(input);</span><br><span class="line"><span class="keyword">for</span> (Integer transformedId: transformedIds) &#123;</span><br><span class="line"><span class="keyword">int</span> virtualId = Transformation.getNewNodeId();</span><br><span class="line"><span class="comment">// 添加虚拟的 Partition 节点</span></span><br><span class="line">streamGraph.addVirtualPartitionNode(</span><br><span class="line">transformedId, virtualId, partition.getPartitioner(), partition.getShuffleMode());</span><br><span class="line">resultIds.add(virtualId);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> resultIds;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addVirtualPartitionNode</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">Integer originalId,</span></span></span><br><span class="line"><span class="function"><span class="params">Integer virtualId,</span></span></span><br><span class="line"><span class="function"><span class="params">StreamPartitioner&lt;?&gt; partitioner,</span></span></span><br><span class="line"><span class="function"><span class="params">ShuffleMode shuffleMode)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (virtualPartitionNodes.containsKey(virtualId)) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Already has virtual partition node with id "</span> + virtualId);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加一个虚拟节点到 virtualPartitionNodes 中，后续添加边的时候会连接到实际的物理节点</span></span><br><span class="line">virtualPartitionNodes.put(virtualId, <span class="keyword">new</span> Tuple3&lt;&gt;(originalId, partitioner, shuffleMode));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在实际的物理节点执行添加边的操作时，会判断上游是不是虚拟节点，如果是则会一直递归调用，将虚拟节点的信息添加到边中，直到连接到一个物理转换节点为止：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addEdgeInternal</span><span class="params">(Integer upStreamVertexID,</span></span></span><br><span class="line"><span class="function"><span class="params"> Integer downStreamVertexID,</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="keyword">int</span> typeNumber,</span></span></span><br><span class="line"><span class="function"><span class="params"> StreamPartitioner&lt;?&gt; partitioner,</span></span></span><br><span class="line"><span class="function"><span class="params"> List&lt;String&gt; outputNames,</span></span></span><br><span class="line"><span class="function"><span class="params"> OutputTag outputTag,</span></span></span><br><span class="line"><span class="function"><span class="params"> ShuffleMode shuffleMode)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 先判断是不是虚拟节点上的边，如果是，则找到虚拟节点上游对应的物理节点</span></span><br><span class="line"><span class="comment">// 在两个物理节点之间添加边，并把对应的 outputTag 或 StreamPartitioner 添加到 StreamEdge 中</span></span><br><span class="line"><span class="keyword">if</span> (virtualSideOutputNodes.containsKey(upStreamVertexID)) &#123;</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (virtualSelectNodes.containsKey(upStreamVertexID)) &#123;</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (virtualPartitionNodes.containsKey(upStreamVertexID)) &#123;</span><br><span class="line"><span class="keyword">int</span> virtualId = upStreamVertexID;</span><br><span class="line">upStreamVertexID = virtualPartitionNodes.get(virtualId).f0;</span><br><span class="line"><span class="keyword">if</span> (partitioner == <span class="keyword">null</span>) &#123;</span><br><span class="line">partitioner = virtualPartitionNodes.get(virtualId).f1;</span><br><span class="line">&#125;</span><br><span class="line">shuffleMode = virtualPartitionNodes.get(virtualId).f2;</span><br><span class="line">addEdgeInternal(upStreamVertexID, downStreamVertexID, typeNumber, partitioner, outputNames, outputTag, shuffleMode);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 两个物理节点</span></span><br><span class="line">StreamNode upstreamNode = getStreamNode(upStreamVertexID);</span><br><span class="line">StreamNode downstreamNode = getStreamNode(downStreamVertexID);</span><br><span class="line"></span><br><span class="line"><span class="comment">// If no partitioner was specified and the parallelism of upstream and downstream</span></span><br><span class="line"><span class="comment">// operator matches use forward partitioning, use rebalance otherwise.</span></span><br><span class="line"><span class="keyword">if</span> (partitioner == <span class="keyword">null</span> &amp;&amp; upstreamNode.getParallelism() == downstreamNode.getParallelism()) &#123;</span><br><span class="line">partitioner = <span class="keyword">new</span> ForwardPartitioner&lt;Object&gt;();</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (partitioner == <span class="keyword">null</span>) &#123;</span><br><span class="line">partitioner = <span class="keyword">new</span> RebalancePartitioner&lt;Object&gt;();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (partitioner <span class="keyword">instanceof</span> ForwardPartitioner) &#123;</span><br><span class="line"><span class="keyword">if</span> (upstreamNode.getParallelism() != downstreamNode.getParallelism()) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"Forward partitioning does not allow "</span> +</span><br><span class="line"><span class="string">"change of parallelism. Upstream operation: "</span> + upstreamNode + <span class="string">" parallelism: "</span> + upstreamNode.getParallelism() +</span><br><span class="line"><span class="string">", downstream operation: "</span> + downstreamNode + <span class="string">" parallelism: "</span> + downstreamNode.getParallelism() +</span><br><span class="line"><span class="string">" You must use another partitioning strategy, such as broadcast, rebalance, shuffle or global."</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (shuffleMode == <span class="keyword">null</span>) &#123;</span><br><span class="line">shuffleMode = ShuffleMode.UNDEFINED;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建 StreamEdge，带着 outputTag 、StreamPartitioner 等属性</span></span><br><span class="line">StreamEdge edge = <span class="keyword">new</span> StreamEdge(upstreamNode, downstreamNode, typeNumber, outputNames, partitioner, outputTag, shuffleMode);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 分别将 StreamEdge 添加到上游节点和下游节点</span></span><br><span class="line"><span class="comment">// 获取上游节点，添加 OutEdge</span></span><br><span class="line">getStreamNode(edge.getSourceId()).addOutEdge(edge);</span><br><span class="line">getStreamNode(edge.getTargetId()).addInEdge(edge);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>StreamGraph 是 Flink 任务最接近用户逻辑的 DAG 表示，后面到具体执行时还会进行一系列转换。</p><h3 id="类之间的层级关系"><a href="#类之间的层级关系" class="headerlink" title="类之间的层级关系"></a>类之间的层级关系</h3><p><img src="DataStream_API%E7%B1%BB%E4%B9%8B%E9%97%B4%E7%9A%84%E5%B1%82%E7%BA%A7%E5%85%B3%E7%B3%BB.png" alt></p><p>map 转换将用户自定义函数 MapFunction 包装到 StreamMap 这个 StreamOperator 中，再将 StreamMap 包装到 OneInputTransformation，最后该 transformation 会存到<br>StreamExecutionEnvironment 中。当调用 env.execute() 时，会遍历其中的 transformations 集合构造出 StreamGraph 。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;本文主要围绕 Flink 源码中 &lt;code&gt;flink-streaming-java&lt;/code&gt; 模块。介绍如何使用 DataStream API 进行 Flink 流任务开发，&lt;code&gt;flink-streaming-java&lt;/code&gt; 模块中的一些重要类，贯穿着介绍下从 DataStream&lt;br&gt;API 到 StreamGraph 的构建过程。&lt;/p&gt;
    
    </summary>
    
      <category term="Flink" scheme="http://yoursite.com/categories/Flink/"/>
    
    
  </entry>
  
</feed>
